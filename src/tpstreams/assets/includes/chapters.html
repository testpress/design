<div class="max-w-4xl" x-data="clipboardComponent()">
  <div class="relative mt-4" >
    <h3 class="mt-4 text-sm font-semibold leading-6 text-gray-900">Chapters</h3>
    <p class="text-gray-500 text-sm leading-6 mb-3">Break up your video into chapters for easier browsing! Add titles and start times (within the 9:58 total video length) to let viewers jump right to what interests them.</p>
  </div>
  <form method="GET" class="group" novalidate onkeydown="return event.key != 'Enter';">
      <div>        
      
      <!-- Dynamic input elements -->
          <template x-for="(chapter, index) in chapters" :key="index">   
              <div class="mb-6">
                  <div class="flex space-x-4 items-center" x-ref="inputs">
                      <div class="">
                          <input type="text"
                              x-ref="input"
                              x-model="chapter.starttime"
                              max="00:19"
                              x-on:input="formatTimeAndValidateInput($event.target,chapter)"
                              placeholder="MM:SS"
                              type="text"
                              :id="'timeInput-' + index"
                              maxlength="8"
                              @keyup.enter="$refs.titleInput.focus()"
                              x-on:change="handleStartTimeChange(index)"
                              class="w-32 block appearance-none rounded-md border border-gray-300 px-3 py-2 placeholder-gray-400 shadow-sm focus:border-blue-600 focus:outline-none focus:ring-blue-600 sm:text-sm focus:outline-none focus:ring-blue-600 sm:text-sm invalid:border-red-500 invalid:text-red-900"
                            >
                      </div>

                      <div class="">
                          <input x-model="chapter.title"
                              class="block w-full appearance-none rounded-md border border-gray-300 px-3 py-2 placeholder-gray-400 shadow-sm focus:border-blue-600 focus:outline-none focus:ring-blue-600 sm:text-sm peer" 
                              type="text" 
                              placeholder="Title"
                              @change="handleStartTimeChange(index)"
                              x-ref="titleInput"
                              @keyup.enter="addChapter();$nextTick(() => { $refs.input.focus(); });"
                              required
                          >
                      </div>


                      <div class="">
                          <button type="button" @click="deleteChapter(index)" class="rounded-md border-0 py-1.5 text-gray-900 sm:text-sm sm:leading-6">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                              <path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" />
                            </svg>
                          </button>
                      </div>  

                  </div>
                  <p :id="'starttime-error-' + index" class="mt-2 mb-2 text-sm text-red-600 hidden">Duplicate start time found.</p>
                 <div class="mt-2 mb-2 text-sm text-red-600" x-show="chapter.showError">Chapter time doesn't fit the video length.</div>
              </div>
          </template>
          <div class="flex mt-2 mb-3 space-x-4">
              <button type="button" 
                  @click="addChapter(); $nextTick(() => { $refs.input.focus(); });"
                  class="inline-flex items-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-1">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                  </svg>
                  <span>Add Chapter</span>
              </button>

              <button type="submit" class="save-button inline-flex items-center rounded-md bg-blue-700 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-blue-600 group-invalid:pointer-events-none group-invalid:opacity-30">
                  <span>Save Chapter</span>
              </button> 
          </div>
      </div>
  </form>
</div>

<script>
  function clipboardComponent() {
    return {
      chapters: [
        {% for chapter in video_chapters %}
        { starttime: '{{ chapter.start_time }}', title: '{{ chapter.title }}', showError: false },
        {% endfor %}
      ],
      addChapter() {
        this.chapters.push({ starttime: '', title: '', showError: false });
      },
      handleStartTimeChange(index) {
        const hasDuplicateStartTimes = this.checkForDuplicateStartTimes(index);
        this.updateSaveButtonAndInputStyles(hasDuplicateStartTimes, index);
      },
      checkForDuplicateStartTimes(excludeIndex) {
        const startTime = this.chapters[excludeIndex].starttime;
        return this.chapters.some((chapter, i) => chapter.starttime === startTime && i !== excludeIndex);
      },
      updateSaveButtonAndInputStyles(hasDuplicate, index) {
        const saveButton = document.querySelector('.save-button');
        saveButton.disabled = hasDuplicate;
        document.getElementById('starttime-error-' + index).classList.toggle('hidden', !hasDuplicate);
        const timeInput = document.getElementById('timeInput-' + index);
        timeInput.classList.toggle('text-red-900', hasDuplicate);
        timeInput.classList.toggle('border-red-500', hasDuplicate);
        saveButton.classList.toggle('opacity-50', hasDuplicate);
        saveButton.classList.toggle('cursor-not-allowed', hasDuplicate);
        saveButton.classList.toggle('text-red-900', hasDuplicate);
      },
      deleteChapter(index) {
        const deletedStartTime = this.chapters[index].starttime;
        this.chapters.splice(index, 1);
        const uniqueIndex = this.checkDuplicateAndReturnUniqueIndex(deletedStartTime);
        if (uniqueIndex !== undefined)
          this.updateSaveButtonAndInputStyles(false, uniqueIndex);
      },
      checkDuplicateAndReturnUniqueIndex(startTime) {
        let index;
        for (let i = 0; i < this.chapters.length; i++) {
          const chapter = this.chapters[i];
          if (chapter.starttime === startTime) {
            if (index === undefined) {
              index = i;
            } else {
              return null;
            }
          }
        }
        return index;
      }
    };
  }

  function formatTimeAndValidateInput(input,chapter) {
    let containsInvalidCharacters = /[^0-9:_]/.test(input.value);
    const cursorPosition = input.selectionStart;

    if (containsInvalidCharacters) {
      input.value = input.value.replace(/[^0-9:_]/g, '');
      chapter.starttime = input.value.replace(/[^0-9:_]/g, '');
      input.setSelectionRange(cursorPosition-1, cursorPosition-1);
      return ;
    }

    let value = input.value.replace(/[^0-9]/g, '');
    let videoduration = 3200;

    let formattedTime;
    if(videoduration<3600){
      formattedTime = formatTimeLessThanOneHour(value);
      input.setAttribute('maxlength', value.length === 4 ? 5 : 6);
    }
    else {
      formattedTime = formatTimeGreaterThanOneHour(value);
      input.setAttribute('maxlength', value.length === 6 ? 8 : 9);
    }
    
    input.value = formattedTime;
    chapter.starttime = formattedTime;

    if (cursorPosition === 2 || cursorPosition === 5 ) {
        input.setSelectionRange(cursorPosition + 1, cursorPosition + 1);
    } else {
        input.setSelectionRange(cursorPosition, cursorPosition);
    }
  }
  function formatTimeLessThanOneHour(timeString) {
    const minute = timeString.slice(0, 2).padEnd(2, '_');
    const second = timeString.slice(2,4).padEnd(2, '_');
  
    const formattedMinute = (parseInt(minute, 10) > 59) ? '0' + minute[0] : minute;
    const formattedSecond = (parseInt(second, 10) > 59) ? '0' + second[0] : second;
    
    return formattedMinute + ':' + formattedSecond;
  }
  function formatTimeGreaterThanOneHour(timeString) {
    const hour = timeString.slice(0, 2).padEnd(2, '_');
    const minute = timeString.slice(2, 4).padEnd(2, '_');
    const second = timeString.slice(4,6).padEnd(2, '_');
  
    const formattedMinute = (parseInt(minute, 10) > 59) ? '0' + minute[0] : minute;
    const formattedSecond = (parseInt(second, 10) > 59) ? '0' + second[0] : second;
    
    return hour + ':' + formattedMinute + ':' + formattedSecond;
  }

</script>

