<div class="max-w-4xl">
  <div class="relative mt-4" x-data="clipboardComponent()">
    <h3 class="mt-4 text-sm font-semibold leading-6 text-gray-900">Chapters</h3>
    <p class="text-gray-500 text-sm leading-6 mb-3">Break up your video into chapters for easier browsing! Add titles and start times (within the 9:58 total video length) to let viewers jump right to what interests them.</p>
  </div>
  <form method="GET" class="group" novalidate>
      <div x-data="{ chapters: [
          {% for chapter in video_chapters %}
              {  starttime: '{{ chapter.start_time }}', title: '{{ chapter.title }}' ,showError: false},
          {% endfor %}
      ] }">        
      
      <!-- Dynamic input elements -->
          <template x-for="(chapter, index) in chapters" :key="index">   
              <div class="mb-6">
                  <div class="flex space-x-4">
                      <div>
                          <input type="time" 
                              max="00:19"
                              :id="'timeInput-' + index"
                              x-model="chapter.starttime" 
                              x-on:change="chapter.showError = $event.target.validity.rangeOverflow; Updating(index,chapters)"
                              class="block appearance-none rounded-md border border-gray-300 px-3 py-2 placeholder-gray-400 shadow-sm focus:border-blue-600 focus:outline-none focus:ring-blue-600 sm:text-sm focus:outline-none focus:ring-blue-600 sm:text-sm invalid:border-red-500 invalid:text-red-900"
                            >
                      </div>

                      <div class="">
                          <input x-model="chapter.title" 
                              class="block w-full appearance-none rounded-md border border-gray-300 px-3 py-2 placeholder-gray-400 shadow-sm focus:border-blue-600 focus:outline-none focus:ring-blue-600 sm:text-sm peer" 
                              type="text" 
                              placeholder="Title"
                              @change="Updating(index,chapters)"
                              required
                          >
                      </div>


                      <div class="">
                          <button type="button" @click="deleteChapter(index, chapters)" class="rounded-md border-0 py-1.5 text-gray-900 sm:text-sm sm:leading-6">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                              <path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" />
                            </svg>
                          </button>
                      </div>  

                  </div>
                  <p :id="'starttime-error-' + index" class="mt-2 mb-2 text-sm text-red-600 hidden">Duplicate start time found.</p>
                 <div class="mt-2 mb-2 text-sm text-red-600" x-show="chapter.showError">Chapter time doesn't fit the video length.</div>
              </div>
          </template>
          <div class="flex mt-2 mb-3 space-x-4">
              <button type="button" 
                  @click="chapters.push({starttime:'00:19'});"
                  class="inline-flex items-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-1">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                  </svg>
                  <span>Add Chapter</span>
              </button>

              <button type="submit" class="save-button inline-flex items-center rounded-md bg-blue-700 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-blue-600 group-invalid:pointer-events-none group-invalid:opacity-30">
                  <span>Save Chapter</span>
              </button> 
          </div>
      </div>
  </form>
</div>

{% block script %}
  <script>
      function Updating(index,chapters){
          let saveButton = document.querySelector('.save-button');
          let has_duplicate = false;
          
          for (let i = 0; i < chapters.length; i++) {
              if (i !== index && chapters[i].starttime === chapters[index].starttime) {
                saveButton.disabled = true;
                document.getElementById('starttime-error-' + index).classList.remove('hidden');
                document.getElementById('timeInput-' + index).classList.add('text-red-900','border-red-500');
                saveButton.classList.add('opacity-50', 'cursor-not-allowed','text-red-900');
                has_duplicate = true;
                return ;
              }
          }

          if(!has_duplicate){
              saveButton.disabled = false;
              document.getElementById('starttime-error-' + index).classList.add('hidden');
              document.getElementById('timeInput-' + index).classList.remove('text-red-900','border-red-500');
              saveButton.classList.remove('opacity-50', 'cursor-not-allowed','text-red-900');
          }
          
      }
      function deleteChapter(index,chapters){
        var starttime = chapters[index].starttime
        chapters.splice(index, 1);
        var index = checkDuplicate(chapters,starttime);
        console.log(index,'index')
        if(index!=undefined){
          console.log('hey hey')
          saveButton = document.querySelector('.save-button')
          saveButton.disabled=false;
          document.getElementById('starttime-error-' + index).classList.add('hidden');
          document.getElementById('timeInput-' + index).classList.remove('text-red-900','border-red-500');
          saveButton.classList.remove('opacity-50', 'cursor-not-allowed','text-red-900');
        }
      }
      function checkDuplicate(chapters,starttime) {
        var index;
        for (let i = 0; i < chapters.length; i++) {
          const chapter = chapters[i];
          console.log(chapter,starttime,index)
          if (chapter.starttime === starttime && index === undefined) {
            index = i;
          } else if (chapter.starttime === starttime && index !== undefined) {
              return; 
          }
        }
        return index;
    }
    
</script>
{% endblock script %}
