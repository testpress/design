<div class="bg-white rounded-lg border border-gray-200 shadow-sm overflow-hidden relative" style="width: 450px; height: 400px;" x-data="deviceAnalytics()" x-init="$nextTick(() => setTimeout(() => initBrowserChart(), 100))">
  <!-- Load Iconify -->
  <script src="https://code.iconify.design/iconify-icon/3.0.0/iconify-icon.min.js"></script>
  
  <!-- Device Analytics Container -->
  <div class="relative overflow-hidden px-3 pt-0 pb-2 h-full flex flex-col">
    <!-- Header with Title and Tabs -->
    <div class="flex items-center justify-between mb-2 pt-1 pl-3">
      <!-- Title -->
      <h3 class="text-lg font-semibold text-gray-800">Devices</h3>
      
      <!-- Device Tabs -->
      <div class="flex space-x-3">
        <button @click="device_tab = 'browser'; setTimeout(() => initBrowserChart(), 50)" 
                class="text-xs font-medium transition-colors cursor-pointer px-2 py-1"
                :class="device_tab === 'browser' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-500 hover:text-gray-700'">
          Browsers
        </button>
        <button @click="device_tab = 'os'; setTimeout(() => initOSChart(), 50)" 
                class="text-xs font-medium transition-colors cursor-pointer px-2 py-1"
                :class="device_tab === 'os' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-500 hover:text-gray-700'">
          OS
        </button>
        <button @click="device_tab = 'size'" 
                class="text-xs font-medium transition-colors cursor-pointer px-2 py-1"
                :class="device_tab === 'size' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-500 hover:text-gray-700'">
          Screen Size
        </button>
      </div>
    </div>
    <!-- Content Area -->
    <div class="flex-1 flex items-end justify-center">
      <!-- Browser Chart -->
      <div x-show="device_tab === 'browser'" class="w-full h-[350px] flex flex-col">
        <!-- Column Headers -->
        <div class="flex justify-between items-center px-4 pt-2 pb-0">
          <h4 class="text-sm font-medium text-gray-600">Browser</h4>
          <h4 class="text-sm font-medium text-gray-600 pr-2">Views</h4>
        </div>
        <!-- Chart Container -->
        <div class="flex-1">
          <div id="browsers-chart" class="w-full h-full"></div>
        </div>
      </div>

      <!-- OS Chart -->
      <div x-show="device_tab === 'os'" class="w-full h-[350px] flex flex-col">
        <!-- Column Headers -->
        <div class="flex justify-between items-center px-4 pt-2 pb-0">
          <h4 class="text-sm font-medium text-gray-600">Operating System</h4>
          <h4 class="text-sm font-medium text-gray-600 pr-2">Views</h4>
        </div>
        <!-- Chart Container -->
        <div class="flex-1">
          <div id="os-chart" class="w-full h-full"></div>
        </div>
      </div>

      <!-- Size Chart -->
              <div x-show="device_tab === 'size'" class="w-full h-[350px] flex items-center justify-center">
          <!-- Circular Progress Design -->
          <div class="grid grid-cols-2 gap-x-4 gap-y-12 w-full max-w-lg px-8">
          <!-- Desktop -->
          <div class="flex flex-col items-center">
            <div class="relative mb-1">
              <!-- Background Circle -->
              <svg class="w-20 h-20 transform -rotate-90" viewBox="0 0 100 100">
                <circle cx="50" cy="50" r="40" stroke="#e5e7eb" stroke-width="8" fill="none"/>
                <circle cx="50" cy="50" r="40" stroke="#2563eb" stroke-width="8" fill="none" 
                        stroke-dasharray="251.2" 
                        stroke-dashoffset="125.6"
                        stroke-linecap="round"
                        class="transition-all duration-1000 ease-out"
                        style="animation: desktopProgress 2s ease-out forwards;"/>
              </svg>
              <!-- Icon in center -->
              <div class="absolute inset-0 flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 text-gray-600">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M9 17.25v1.007a3 3 0 0 1-.879 2.122L7.5 21h9l-.621-.621A3 3 0 0 1 15 18.257V17.25m6-12V15a2.25 2.25 0 0 1-2.25 2.25H5.25A2.25 2.25 0 0 1 3 15V5.25m18 0A2.25 2.25 0 0 0 18.75 3H5.25A2.25 2.25 0 0 0 3 5.25m18 0V12a2.25 2.25 0 0 1-2.25 2.25H5.25A2.25 2.25 0 0 1 3 12V5.25" />
                </svg>
              </div>
              <!-- Value on top -->
              <div class="absolute -top-5 left-1/2 transform -translate-x-1/2">
                <span class="text-sm font-normal text-gray-800">567</span>
              </div>
            </div>
            <h3 class="text-xs font-normal text-gray-700">Desktop</h3>
          </div>

          <!-- Mobile -->
          <div class="flex flex-col items-center">
            <div class="relative mb-1">
              <!-- Background Circle -->
              <svg class="w-20 h-20 transform -rotate-90" viewBox="0 0 100 100">
                <circle cx="50" cy="50" r="40" stroke="#e5e7eb" stroke-width="8" fill="none"/>
                <circle cx="50" cy="50" r="40" stroke="#2563eb" stroke-width="8" fill="none" 
                        stroke-dasharray="251.2" 
                        stroke-dashoffset="167.5"
                        stroke-linecap="round"
                        class="transition-all duration-1000 ease-out"
                        style="animation: mobileProgress 2s ease-out forwards;"/>
              </svg>
              <!-- Icon in center -->
              <div class="absolute inset-0 flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 text-gray-600">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 1.5H8.25A2.25 2.25 0 0 0 6 3.75v16.5a2.25 2.25 0 0 0 2.25 2.25h7.5A2.25 2.25 0 0 0 18 20.25V3.75a2.25 2.25 0 0 0-2.25-2.25H13.5m-3 0V3h3V1.5m-3 0h3m-3 18.75h3" />
                </svg>
              </div>
              <!-- Value on top -->
              <div class="absolute -top-5 left-1/2 transform -translate-x-1/2">
                <span class="text-sm font-normal text-gray-800">334</span>
              </div>
            </div>
            <h3 class="text-xs font-normal text-gray-700">Mobile</h3>
          </div>

          <!-- Tablet -->
          <div class="flex flex-col items-center">
            <div class="relative mb-1">
              <!-- Background Circle -->
              <svg class="w-20 h-20 transform -rotate-90" viewBox="0 0 100 100">
                <circle cx="50" cy="50" r="40" stroke="#e5e7eb" stroke-width="8" fill="none"/>
                <circle cx="50" cy="50" r="40" stroke="#2563eb" stroke-width="8" fill="none" 
                        stroke-dasharray="251.2" 
                        stroke-dashoffset="188.4"
                        stroke-linecap="round"
                        class="transition-all duration-1000 ease-out"
                        style="animation: tabletProgress 2s ease-out forwards;"/>
              </svg>
              <!-- Icon in center -->
              <div class="absolute inset-0 flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 text-gray-600">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5h3m-6.75 2.25h10.5a2.25 2.25 0 0 0 2.25-2.25v-15a2.25 2.25 0 0 0-2.25-2.25H6.75A2.25 2.25 0 0 0 4.5 4.5v15a2.25 2.25 0 0 0 2.25 2.25Z" />
                </svg>
              </div>
              <!-- Value on top -->
              <div class="absolute -top-5 left-1/2 transform -translate-x-1/2">
                <span class="text-sm font-normal text-gray-800">189</span>
              </div>
            </div>
            <h3 class="text-xs font-normal text-gray-700">Tablet</h3>
          </div>

          <!-- Others -->
          <div class="flex flex-col items-center">
            <div class="relative mb-2">
              <!-- Background Circle -->
              <svg class="w-20 h-20 transform -rotate-90" viewBox="0 0 100 100">
                <circle cx="50" cy="50" r="40" stroke="#e5e7eb" stroke-width="8" fill="none"/>
                <circle cx="50" cy="50" r="40" stroke="#2563eb" stroke-width="8" fill="none" 
                        stroke-dasharray="251.2" 
                        stroke-dashoffset="236.3"
                        stroke-linecap="round"
                        class="transition-all duration-1000 ease-out"
                        style="animation: othersProgress 2s ease-out forwards;"/>
              </svg>
              <!-- Icon in center -->
              <div class="absolute inset-0 flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 text-gray-600">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 12a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0ZM12.75 12a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0ZM18.75 12a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Z" />
                </svg>
              </div>
              <!-- Value on top -->
              <div class="absolute -top-5 left-1/2 transform -translate-x-1/2">
                <span class="text-sm font-normal text-gray-800">67</span>
              </div>
            </div>
            <h3 class="text-xs font-normal text-gray-700">Others</h3>
          </div>
        </div>
      </div>

      <!-- CSS Animations -->
      <style>
        @keyframes desktopProgress {
          from { stroke-dashoffset: 251.2; }
          to { stroke-dashoffset: 125.6; } /* 50% progress (567/1157 total) */
        }
        @keyframes mobileProgress {
          from { stroke-dashoffset: 251.2; }
          to { stroke-dashoffset: 167.5; } /* 33% progress (334/1157 total) */
        }
        @keyframes tabletProgress {
          from { stroke-dashoffset: 251.2; }
          to { stroke-dashoffset: 188.4; } /* 25% progress (189/1157 total) */
        }
        @keyframes othersProgress {
          from { stroke-dashoffset: 251.2; }
          to { stroke-dashoffset: 236.3; } /* 6% progress (67/1157 total) */
        }
      </style>
    </div>
  </div>
</div>

<script>
function deviceAnalytics() {
  return {
    device_tab: 'browser',
    browserChart: null,
    osChart: null,
    resizeListenerAdded: false,

    initBrowserChart() {
      const chartElement = document.getElementById('browsers-chart');
      if (chartElement && typeof echarts !== 'undefined') {
        // Wait for container to be visible and have dimensions
        const waitForContainer = () => {
          const rect = chartElement.getBoundingClientRect();
          if (rect.width === 0 || rect.height === 0) {
            setTimeout(waitForContainer, 50);
            return;
          }
          
          // Dispose existing chart if it exists to ensure fresh animation
          if (this.browserChart) {
            this.browserChart.dispose();
          }
          
          this.browserChart = echarts.init(chartElement);
          
          // Preload icons to reduce delay
          this.preloadBrowserIcons().then(() => {
            this.setupBrowserChart();
          });
        };
        
        waitForContainer();
      }
    },
    
    preloadBrowserIcons() {
      return new Promise((resolve) => {
        const iconUrls = [
          'https://cdnjs.cloudflare.com/ajax/libs/browser-logos/75.0.1/chrome/chrome_16x16.png',
          'https://cdnjs.cloudflare.com/ajax/libs/browser-logos/75.0.1/safari/safari_16x16.png',
          'https://cdnjs.cloudflare.com/ajax/libs/browser-logos/75.0.1/firefox/firefox_16x16.png',
          'https://cdnjs.cloudflare.com/ajax/libs/browser-logos/75.0.1/edge/edge_16x16.png',
          'https://cdnjs.cloudflare.com/ajax/libs/browser-logos/75.0.1/opera/opera_16x16.png'
        ];
        
        let loadedCount = 0;
        const totalIcons = iconUrls.length;
        
        // If all icons load quickly, proceed
        iconUrls.forEach(url => {
          const img = new Image();
          img.onload = img.onerror = () => {
            loadedCount++;
            if (loadedCount === totalIcons) {
              resolve();
            }
          };
          img.src = url;
        });
        
        // Don't wait more than 1 second for icons
        setTimeout(resolve, 1000);
      });
    },

    generateAlignedGraphics(chart, data) {
      if (!chart) return [];
      
      const chartHeight = chart.getHeight();
      const gridTopPercent = 5; // from grid.top: '5%'
      const gridBottomPercent = 15; // from grid.bottom: '15%'
      
      // Calculate usable height in pixels
      const topOffset = (gridTopPercent / 100) * chartHeight;
      const bottomOffset = (gridBottomPercent / 100) * chartHeight;
      const usableHeight = chartHeight - topOffset - bottomOffset;
      
      // Calculate height per bar
      const barHeight = usableHeight / data.length;
      
      return data.map((item, index) => {
        // Calculate Y position: start from top offset + half bar height + index * bar height
        const yPosition = topOffset + (barHeight / 2) + (index * barHeight);
        
        return {
          type: 'text',
          left: '87%',
          top: yPosition,
          style: {
            text: item.value.toLocaleString(),
            fontSize: 12,
            fill: '#6b7280',
            textAlign: 'right'
          }
        };
      });
    },
    
    setupBrowserChart() {
      if (!this.browserChart) return;
        
      // Add resize listener for responsiveness
      if (!this.resizeListenerAdded) {
        window.addEventListener('resize', () => {
          if (this.browserChart) this.browserChart.resize();
          if (this.osChart) this.osChart.resize();
        });
        this.resizeListenerAdded = true;
      }
        
      // Browser data sorted by value (highest to lowest)
      const browserData = [
        {value: 845, name: 'Chrome'},
        {value: 623, name: 'Safari'},
        {value: 456, name: 'Firefox'},
        {value: 234, name: 'Edge'},
        {value: 156, name: 'Opera'},
        {value: 89, name: 'Other'}
      ].sort((a, b) => b.value - a.value);
      
      // Browser icon mapping for iconify
      const browserIcons = {
        'Chrome': 'logos:chrome',
        'Safari': 'logos:safari',
        'Firefox': 'logos:firefox',
        'Edge': 'logos:microsoft-edge',
        'Opera': 'logos:opera',
        'Other': 'material-symbols:more-horiz'
      };
      
      const option = {
        // Add smooth animation
        animation: true,
        animationDuration: 1000,
        animationEasing: 'cubicOut',
        tooltip: {
          trigger: 'axis',
          axisPointer: {
            type: 'shadow'
          },
          formatter: function(params) {
            return params[0].name + '<br/>' + 
                   'Views: ' + params[0].value.toLocaleString();
          }
        },
        grid: {
          left: '5%',
          right: '15%',
          top: '5%',
          bottom: '15%',
          containLabel: false
        },
        graphic: this.generateAlignedGraphics(this.browserChart, browserData),
        xAxis: {
          type: 'value',
          show: false
        },
        yAxis: {
          type: 'category',
          data: browserData.map(item => item.name),
          inverse: true,
          show: false
        },
        series: [{
          data: browserData,
          type: 'bar',
          itemStyle: {
            color: '#fef3c7',
            borderRadius: [0, 4, 4, 0]
          },
          barWidth: '60%',
          // Add animation for bars
          animation: true,
          animationDuration: 1000,
          animationEasing: 'cubicOut',
          animationDelay: function(idx) {
            return idx * 100;
          },
          label: {
            show: true,
            position: 'insideLeft',
            color: '#374151',
            fontSize: 12,
            fontWeight: 'normal',
            offset: [10, 0],
            rich: {
              chrome: {
                backgroundColor: {
                  image: 'https://cdnjs.cloudflare.com/ajax/libs/browser-logos/75.0.1/chrome/chrome_16x16.png'
                },
                width: 16,
                height: 16,
                borderRadius: 2
              },
              safari: {
                backgroundColor: {
                  image: 'https://cdnjs.cloudflare.com/ajax/libs/browser-logos/75.0.1/safari/safari_16x16.png'
                },
                width: 16,
                height: 16,
                borderRadius: 2
              },
              firefox: {
                backgroundColor: {
                  image: 'https://cdnjs.cloudflare.com/ajax/libs/browser-logos/75.0.1/firefox/firefox_16x16.png'
                },
                width: 16,
                height: 16,
                borderRadius: 2
              },
              edge: {
                backgroundColor: {
                  image: 'https://cdnjs.cloudflare.com/ajax/libs/browser-logos/75.0.1/edge/edge_16x16.png'
                },
                width: 16,
                height: 16,
                borderRadius: 2
              },
              opera: {
                backgroundColor: {
                  image: 'https://cdnjs.cloudflare.com/ajax/libs/browser-logos/75.0.1/opera/opera_16x16.png'
                },
                width: 16,
                height: 16,
                borderRadius: 2
              }
            },
            formatter: function(params) {
              const browserCodes = {
                'Chrome': 'chrome',
                'Safari': 'safari',
                'Firefox': 'firefox',
                'Edge': 'edge',
                'Opera': 'opera'
              };
              const code = browserCodes[params.data.name];
              return code ? `{${code}|}   ${params.data.name}` : params.data.name;
            }
          }
        }]
      };
      
      this.browserChart.setOption(option);
      
      // Final resize to ensure proper dimensions
      setTimeout(() => {
        if (this.browserChart) this.browserChart.resize();
      }, 100);
    },
    
    initOSChart() {
      const chartElement = document.getElementById('os-chart');
      if (chartElement && typeof echarts !== 'undefined') {
        // Wait for container to be visible and have dimensions
        const waitForContainer = () => {
          const rect = chartElement.getBoundingClientRect();
          if (rect.width === 0 || rect.height === 0) {
            setTimeout(waitForContainer, 50);
            return;
          }
          
          // Dispose existing chart if it exists to ensure fresh animation
          if (this.osChart) {
            this.osChart.dispose();
          }
          
          this.osChart = echarts.init(chartElement);
          
          // Preload icons to reduce delay
          this.preloadOSIcons().then(() => {
            this.setupOSChart();
          });
        };
        
        waitForContainer();
      }
    },
    
    preloadOSIcons() {
      return new Promise((resolve) => {
        const iconUrls = [
          'https://img.icons8.com/color/16/000000/windows-10.png',
          'https://img.icons8.com/color/16/000000/mac-os.png',
          'https://img.icons8.com/color/16/000000/android-os.png',
          'https://img.icons8.com/color/16/000000/ios-logo.png',
          'https://img.icons8.com/color/16/000000/linux.png'
        ];
        
        let loadedCount = 0;
        const totalIcons = iconUrls.length;
        
        // If all icons load quickly, proceed
        iconUrls.forEach(url => {
          const img = new Image();
          img.onload = img.onerror = () => {
            loadedCount++;
            if (loadedCount === totalIcons) {
              resolve();
            }
          };
          img.src = url;
        });
        
        // Don't wait more than 1 second for icons
        setTimeout(resolve, 1000);
      });
    },
    
    setupOSChart() {
      if (!this.osChart) return;
        
      // Ensure resize listener is added
      if (!this.resizeListenerAdded) {
        window.addEventListener('resize', () => {
          if (this.browserChart) this.browserChart.resize();
          if (this.osChart) this.osChart.resize();
        });
        this.resizeListenerAdded = true;
      }
      
      // OS data sorted by value (highest to lowest)
      const osData = [
        {value: 734, name: 'Windows'},
        {value: 623, name: 'macOS'},
        {value: 456, name: 'Android'},
        {value: 334, name: 'iOS'},
        {value: 189, name: 'Linux'},
        {value: 67, name: 'Other'}
      ].sort((a, b) => b.value - a.value);
      
      // OS icon mapping for iconify
      const osIcons = {
        'Windows': 'logos:microsoft-windows',
        'macOS': 'logos:apple',
        'Android': 'logos:android-icon',
        'iOS': 'logos:apple',
        'Linux': 'logos:linux-tux',
        'Other': 'material-symbols:more-horiz'
      };
      
      const option = {
        // Add smooth animation
        animation: true,
        animationDuration: 1000,
        animationEasing: 'cubicOut',
        tooltip: {
          trigger: 'axis',
          axisPointer: {
            type: 'shadow'
          },
          formatter: function(params) {
            return params[0].name + '<br/>' + 
                   'Views: ' + params[0].value.toLocaleString();
          }
        },
        grid: {
          left: '5%',
          right: '15%',
          top: '5%',
          bottom: '15%',
          containLabel: false
        },
        graphic: this.generateAlignedGraphics(this.osChart, osData),
        xAxis: {
          type: 'value',
          show: false
        },
        yAxis: {
          type: 'category',
          data: osData.map(item => item.name),
          inverse: true,
          show: false
        },
        series: [{
          data: osData,
          type: 'bar',
          itemStyle: {
            color: '#fef3c7',
            borderRadius: [0, 4, 4, 0]
          },
          barWidth: '60%',
          // Add animation for bars
          animation: true,
          animationDuration: 1000,
          animationEasing: 'cubicOut',
          animationDelay: function(idx) {
            return idx * 100;
          },
          label: {
            show: true,
            position: 'insideLeft',
            color: '#374151',
            fontSize: 12,
            fontWeight: 'normal',
            offset: [10, 0],
            rich: {
              windows: {
                backgroundColor: {
                  image: 'https://img.icons8.com/color/16/000000/windows-10.png'
                },
                width: 16,
                height: 16,
                borderRadius: 2
              },
              macos: {
                backgroundColor: {
                  image: 'https://img.icons8.com/color/16/000000/mac-os.png'
                },
                width: 16,
                height: 16,
                borderRadius: 2
              },
              android: {
                backgroundColor: {
                  image: 'https://img.icons8.com/color/16/000000/android-os.png'
                },
                width: 16,
                height: 16,
                borderRadius: 2
              },
              ios: {
                backgroundColor: {
                  image: 'https://img.icons8.com/color/16/000000/ios-logo.png'
                },
                width: 16,
                height: 16,
                borderRadius: 2
              },
              linux: {
                backgroundColor: {
                  image: 'https://img.icons8.com/color/16/000000/linux.png'
                },
                width: 16,
                height: 16,
                borderRadius: 2
              }
            },
            formatter: function(params) {
              const osCodes = {
                'Windows': 'windows',
                'macOS': 'macos',
                'Android': 'android',
                'iOS': 'ios',
                'Linux': 'linux'
              };
              const code = osCodes[params.data.name];
              return code ? `{${code}|}   ${params.data.name}` : params.data.name;
            }
          }
        }]
      };
      
      this.osChart.setOption(option);
      
      // Final resize to ensure proper dimensions
      setTimeout(() => {
        if (this.osChart) this.osChart.resize();
      }, 100);
    }
  };
}
</script> 