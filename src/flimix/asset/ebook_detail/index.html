  {% extends "src/flimix/layouts/sidebar_layout.html" %}
  {% block main_class %}bg-stone-50 min-h-[92vh]{% endblock %}
  {% block extra_head %} 
<script type="module" src="https://cdn.jsdelivr.net/npm/media-chrome@4/+esm"></script>
<script type="module" src="https://cdn.jsdelivr.net/npm/media-chrome/menu/+esm"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/epubjs@0.3.93/dist/epub.min.js"></script>
{% endblock extra_head %}

  {% block main_content %}
  <div class="space-y-5">
    {% include "./header.html" %}
    <div class="grid grid-cols-1 xl:grid-cols-6 gap-5">
      <div class="xl:col-span-4 space-y-4">
        {% include "./preview.html" %}
        {% include "./thumbnails.html" %}
        {% include "./linked_contents.html" %}
      </div>

      <div class="xl:col-span-2">
        <div class="xl:sticky xl:top-20 space-y-4">
          {% include "./ebook_info.html" %}
          {% include "./transcoding_log.html" %}
        </div>
      </div>
    </div>
  </div>
  {% endblock main_content %}


  {% block script %} 
  <script>
    var params = URLSearchParams && new URLSearchParams(document.location.search.substring(1));
    var url = params && params.get("url") && decodeURIComponent(params.get("url"));
    var currentSectionIndex = (params && params.get("loc")) ? params.get("loc") : undefined;

    // Load the opf
    var book = ePub(url || "https://s3.amazonaws.com/moby-dick/moby-dick.epub");
    var rendition = book.renderTo("viewer", {
      width: "100%",
      height: 600,
      spread: "always"
    });

    rendition.display(currentSectionIndex);

    book.ready.then(function() {

      var next = document.getElementById("next");

      next.addEventListener("click", function(e){
        book.package.metadata.direction === "rtl" ? rendition.prev() : rendition.next();
        e.preventDefault();
      }, false);

      var prev = document.getElementById("prev");
      prev.addEventListener("click", function(e){
        book.package.metadata.direction === "rtl" ? rendition.next() : rendition.prev();
        e.preventDefault();
      }, false);

      var keyListener = function(e){

        // Left Key
        if ((e.keyCode || e.which) == 37) {
          book.package.metadata.direction === "rtl" ? rendition.next() : rendition.prev();
        }

        // Right Key
        if ((e.keyCode || e.which) == 39) {
          book.package.metadata.direction === "rtl" ? rendition.prev() : rendition.next();
        }

      };

      rendition.on("keyup", keyListener);
      document.addEventListener("keyup", keyListener, false);

    })

    var title = document.getElementById("title");

    rendition.on("rendered", function(section){
      var current = book.navigation && book.navigation.get(section.href);
      const select = window.HSSelect.getInstance("#toc");

      if (current) {
        var $select = document.getElementById("toc");
        var $selected = $select.querySelector("option[selected]");
        if ($selected) {
          $selected.removeAttribute("selected");
        }

        var $options = $select.querySelectorAll("option");
        for (var i = 0; i < $options.length; ++i) {
          let selected = $options[i].getAttribute("ref") === current.href;
          if (selected) {
            $options[i].setAttribute("selected", "");
          }
        }
        select.destroy()
        select.init()
      }

    });

    rendition.on("relocated", function(location){
      console.log(location);

      var next = book.package.metadata.direction === "rtl" ?  document.getElementById("prev") : document.getElementById("next");
      var prev = book.package.metadata.direction === "rtl" ?  document.getElementById("next") : document.getElementById("prev");

      if (location.atEnd) {
        next.style.visibility = "hidden";
      } else {
        next.style.visibility = "visible";
      }

      if (location.atStart) {
        prev.style.visibility = "hidden";
      } else {
        prev.style.visibility = "visible";
      }

    });

    rendition.on("layout", function(layout) {
      let viewer = document.getElementById("viewer");

      if (layout.spread) {
        viewer.classList.remove('single');
      } else {
        viewer.classList.add('single');
      }
    });

    window.addEventListener("unload", function () {
      console.log("unloading");
      this.book.destroy();
    });

    book.loaded.navigation.then(function(toc){
			var $select = document.getElementById("toc"),
					docfrag = document.createDocumentFragment();

			toc.forEach(function(chapter) {
				var option = document.createElement("option");
				option.textContent = chapter.label;
				option.setAttribute("ref", chapter.href);

				docfrag.appendChild(option);
			});

			$select.appendChild(docfrag);

			$select.onchange = function(){
					var index = $select.selectedIndex,
							url = $select.options[index].getAttribute("ref");
					rendition.display(url);
					return false;
			};

		});
  </script> 
  <script>
    let ebookPreview = document.getElementById("ebook-preview");
    let maximizeBtn = document.getElementById("maximize");
    let minimizeBtn = document.getElementById("minimize");

    // Function to enter fullscreen
    function enterFullscreen() {
        if (ebookPreview.requestFullscreen) {
            ebookPreview.requestFullscreen();
        } else if (ebookPreview.mozRequestFullScreen) { // Firefox
            ebookPreview.mozRequestFullScreen();
        } else if (ebookPreview.webkitRequestFullscreen) { // Chrome, Safari, Edge
            ebookPreview.webkitRequestFullscreen();
        } else if (ebookPreview.msRequestFullscreen) { // IE/Edge
            ebookPreview.msRequestFullscreen();
        }
        maximizeBtn.style.display = "none";
        minimizeBtn.style.display = "inline-flex";
    }

    // Function to exit fullscreen
    function exitFullscreen() {
        if (document.exitFullscreen) {
            document.exitFullscreen();
        } else if (document.mozCancelFullScreen) {
            document.mozCancelFullScreen();
        } else if (document.webkitExitFullscreen) {
            document.webkitExitFullscreen();
        } else if (document.msExitFullscreen) {
            document.msExitFullscreen();
        }
        maximizeBtn.style.display = "inline-flex";
        minimizeBtn.style.display = "none";
    }

    // Attach event listeners
    maximizeBtn.addEventListener("click", enterFullscreen);
    minimizeBtn.addEventListener("click", exitFullscreen);

    // Detect when fullscreen exits
    document.addEventListener("fullscreenchange", function () {
        if (!document.fullscreenElement) {
            maximizeBtn.style.display = "inline-flex";
            minimizeBtn.style.display = "none";
        }
    });
</script>
{% endblock script %}