<script>
  tailwind.config = {
    theme: {
      extend: {
        fontFamily: {
          sans: ['Inter var',],
        },
      }
    }
  }

  function getAnalyticsData() {
    let initialTabs = [
      {"order": 0, "label": "Tabular Reports", "active": true},
      {"order": 1, "label": "Graphical Reports", "active": false},
    ];

    function filterByParentId(parentId) {
      let allStats = JSON.parse(`{% include "../../_data/subject_analytics.json" %}`);
      if (!parentId) {
        return allStats.filter(item => item.parent_id == null);
      }
      else {
        return allStats.filter(item => item.parent_id == parentId);
      }
    };

    function getParamValue(param) {
      var searchParams = new URLSearchParams(window.location.search);
      return searchParams.get(param);
    };

    return {
      headerTabs: initialTabs,
      activeTab: initialTabs[0],

      subjectStats: filterByParentId(getParamValue("parent")),

      activateTab(tabOrder) {
        this.headerTabs.forEach((tab) => {
          if(tab.order == tabOrder) {
            tab.active = true;
            this.activeTab = tab;
          }
          else {
            tab.active = false;
          }
        });
      },

      filterByParentId(parentId) {
        if (!parentId) {
          this.subjectStats = this.subjectStats.filter(item => item.parent_id == null);
        }
        else {
          this.subjectStats = this.subjectStats.filter(item => item.parent_id == parentId);
        }
      },

      parentSubjectChanged(parentId) {
        let newURL = new URL(window.location.href);
        
        if (!parentId) {
          newURL.searchParams.delete('parent');
        }
        else {
          newURL.searchParams.set('parent', parentId);
        }
        window.location = newURL;
      }
    }
  }

  function getPercentage(value, total) {
    return ((value / total) * 100).toFixed(2)
  };

  function createChartForSubject(data, chartId) {
    let totalQuestions = data.correct_answers_count + data.incorrect_answers_count + data.unanswered_count;
    let percentages = [
      getPercentage(data.correct_answers_count, totalQuestions),
      getPercentage(data.incorrect_answers_count, totalQuestions),
      getPercentage(data.unanswered_count, totalQuestions),
    ]

    let chartConfig = {
      type: 'doughnut',
      data: {
        labels: ['Correct', 'Incorrect', 'Unanswered'],
        datasets: [
          {
            data: percentages,
            backgroundColor: ['#22c55e', '#ef4444', '#f59e0b'], // Tailwind colours of strength 500
            label: 'Percentage',
          },
        ]
      },
      options: {
        responsive: true,
        plugins: {
          legend: {
            display: true,
            labels: {
              boxWidth: 10,
            }
          }
        }
      }
    };

    let ctx = document.getElementById(chartId).getContext('2d');
    new Chart(ctx, chartConfig);
  }
</script>
