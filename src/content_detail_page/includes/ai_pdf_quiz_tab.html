<!-- AI Quiz Content Tab -->
<div id="ai-quiz-content" class="hs-tab-content" role="tabpanel" aria-labelledby="ai-quiz-tab" style="display: none;">
  <div class="h-full flex flex-col">
    <!-- Create Quiz View -->
    <div id="create-quiz-view" class="h-full flex flex-col">
      <div class="flex-1 overflow-y-auto p-4">
        <!-- Quiz Card -->
        <div class="bg-white dark:bg-neutral-900 rounded-xl border border-gray-200 dark:border-neutral-700 p-4" style="display: block;">
          <!-- Content Layout - Left: Text, Right: Actions -->
          <div class="flex flex-row items-center justify-between gap-3">
            <!-- Left Side: Title and Description -->
            <div>
              <h3 class="text-sm font-medium text-gray-800 dark:text-neutral-200 mb-1">Create Quiz</h3>
              <p class="text-xs text-gray-600 dark:text-neutral-400">Create quiz sets with preferred question types, difficulty, and more.</p>
            </div>
            
            <!-- Right Side: Filter Icon and Generate Button -->
            <div class="flex items-center gap-2 flex-shrink-0">
              <!-- Filter Icon Button -->
              <button type="button" @click="$dispatch('open-customize-modal')" class="p-1.5 inline-flex justify-center items-center text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg transition-colors dark:text-neutral-400 dark:hover:text-neutral-200 dark:hover:bg-neutral-700" title="Customize">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-4">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 1 1-3 0m3 0a1.5 1.5 0 1 0-3 0m-3.75 0H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m-9.75 0h9.75" />
                </svg>
              </button>
              
              <!-- Generate Button -->
              <button type="button" id="generate-quiz-btn" class="py-1.5 px-3 inline-flex items-center gap-x-2 text-xs font-medium rounded-lg border border-emerald-600 bg-emerald-600 text-white shadow-2xs hover:bg-emerald-700 disabled:opacity-50 disabled:pointer-events-none dark:bg-emerald-500 dark:border-emerald-500 dark:hover:bg-emerald-600 dark:focus:bg-emerald-600">
                Generate
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Quizzes List View (Hidden by default) -->
    <div id="quizzes-list-view" class="h-full flex flex-col" style="display: none;">
      {% include "./ai_pdf_quizzes_list.html" %}
    </div>
    <!-- Quiz Detail View (Hidden by default) -->
    <div id="quiz-detail-view" class="h-full flex flex-col" style="display: none;">
      <div class="xl:h-screen h-[70vh]  p-4 overflow-y-auto overflow-x-hidden [&::-webkit-scrollbar]:w-2 [&::-webkit-scrollbar-thumb]:rounded-full [&::-webkit-scrollbar-track]:bg-gray-100 [&::-webkit-scrollbar-thumb]:bg-gray-300 dark:[&::-webkit-scrollbar-track]:bg-neutral-700 dark:[&::-webkit-scrollbar-thumb]:bg-neutral-500">

        <div class="relative pb-20 lg:pb-[10rem]">
          <!-- Back Button and Progress -->
          <div class="flex items-center gap-x-3 mb-6">
            <button type="button" onclick="showQuizList()" class="flex items-center gap-x-2 text-sm text-gray-600 dark:text-neutral-400 hover:text-gray-800 dark:hover:text-neutral-200 transition-colors">
              <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
              </svg>
              <span>Back</span>
            </button>
          
          </div>
          <div class="w-full space-y-5">
            <div class="w-full flex gap-x-2">      
              <div class="w-full">      
                <div class="space-y-1">
                  <div class="group flex justify-start gap-x-2" style="word-break: break-word;">
                    <div class="order-1 bg-gray-200 dark:bg-neutral-950 inline-block rounded-xl w-full">
                      <div class="text-sm text-gray-800 dark:text-neutral-200">
                        
                        {% include "./ai_pdf_quiz.html" %}
                      </div>
                    </div>
                  </div>
                </div>
              </div>
        </div>
      </div>
    </div>   

  </div>
  {% include "./customize_quiz_modal.html" %}

  <!-- Make quiz data available to JavaScript -->
  <script>
    // Expose quiz data to global scope for JavaScript access
    window.aiPdfQuizzes = {{ ai_pdf_quizzes | dump | safe }};
  </script>
  
  <!-- JavaScript for view switching -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const generateBtn = document.getElementById('generate-quiz-btn');
      const createQuizView = document.getElementById('create-quiz-view');
      const quizzesListView = document.getElementById('quizzes-list-view');
      const quizSkeleton = document.getElementById('quiz-skeleton');
      
      const quizData = window.aiPdfQuizzes || [];
      let currentQuizIndex = 0;
      
      if (generateBtn) {
        generateBtn.addEventListener('click', function() {
          // Check if we have more quizzes to show
          if (currentQuizIndex >= quizData.length) {
            return; // Don't proceed if no more quizzes
          }
          
          // Hide create quiz view
          createQuizView.style.display = 'none';
          // Show quizzes list view
          quizzesListView.style.display = 'block';
          
          // Show skeleton loading at the top
          if (quizSkeleton) {
            quizSkeleton.style.display = 'block';
            // Move skeleton to the top of the list
            const quizzesContainer = document.querySelector('#quizzes-list-view .space-y-4');
            if (quizzesContainer.firstChild !== quizSkeleton) {
              quizzesContainer.insertBefore(quizSkeleton, quizzesContainer.firstChild);
            }
          }
          
          // Fill skeleton with quiz data after 500ms
          setTimeout(() => {
            if (currentQuizIndex < quizData.length) {
              fillSkeletonWithQuiz(quizData[currentQuizIndex]);
              currentQuizIndex++;
            }
          }, 500);
        });
      }
      
      // Also handle the Generate button in the Quizzes header
      const quizzesGenerateBtn = document.getElementById('quizzes-generate-btn');
      if (quizzesGenerateBtn) {
        quizzesGenerateBtn.addEventListener('click', function() {
          // Check if we have more quizzes to show
          if (currentQuizIndex >= quizData.length) {
            return; // Don't proceed if no more quizzes
          }
          
          // Show skeleton loading at the top
          if (quizSkeleton) {
            quizSkeleton.style.display = 'block';
            // Move skeleton to the top of the list
            const quizzesContainer = document.querySelector('#quizzes-list-view .space-y-4');
            if (quizzesContainer.firstChild !== quizSkeleton) {
              quizzesContainer.insertBefore(quizSkeleton, quizzesContainer.firstChild);
            }
          }
          
          // Fill skeleton with next quiz data after 500ms
          setTimeout(() => {
            if (currentQuizIndex < quizData.length) {
              fillSkeletonWithQuiz(quizData[currentQuizIndex]);
              currentQuizIndex++;
            }
          }, 500);
        });
      }
      
      function fillSkeletonWithQuiz(quiz) {
        // Create quiz card with actual data
        const quizCard = createQuizCard(quiz);
        
        // Replace skeleton with the new quiz card
        if (quizSkeleton) {
          quizSkeleton.outerHTML = quizCard;
        }
        
        // Reinitialize Preline dropdowns
        if (window.HSStaticMethods) {
          window.HSStaticMethods.autoInit();
        }
        
        // Check if we've shown all quizzes and disable generate buttons
        if (currentQuizIndex >= quizData.length) {
          disableGenerateButtons();
        }
      }
      
      function disableGenerateButtons() {
        // Disable the Create Quiz generate button
        if (generateBtn) {
          generateBtn.disabled = true;
          generateBtn.classList.add('opacity-50', 'cursor-not-allowed');
          generateBtn.classList.remove('hover:bg-emerald-700', 'dark:hover:bg-emerald-600');
        }
        
        // Disable the Quizzes header generate button
        const quizzesGenerateBtn = document.getElementById('quizzes-generate-btn');
        if (quizzesGenerateBtn) {
          quizzesGenerateBtn.disabled = true;
          quizzesGenerateBtn.classList.add('opacity-50', 'cursor-not-allowed');
          quizzesGenerateBtn.classList.remove('hover:bg-emerald-700', 'dark:hover:bg-emerald-600');
        }
      }
      
      function createQuizCard(quiz) {
        const percentage = Math.round((quiz.completed / quiz.total) * 100);
        
                  return `
            <div class="bg-white dark:bg-neutral-900 rounded-xl border border-gray-200 dark:border-neutral-700 p-4 hover:shadow-md transition-shadow cursor-pointer" onclick="showQuizDetail(${quiz.id})">
              <div class="flex items-start justify-between mb-3">
                <h3 class="text-sm font-medium text-gray-800 dark:text-neutral-200 pr-2 min-w-0 flex-1">${quiz.title}</h3>
                <!-- Three Dot Menu -->
                <div class="hs-dropdown [--auto-close:inside] [--placement:bottom-right] relative inline-flex" onclick="event.stopPropagation()">
                  <button type="button" class="p-1.5 inline-flex justify-center items-center text-gray-500 hover:text-gray-700 rounded-lg hover:bg-gray-100 dark:text-neutral-400 dark:hover:text-neutral-200 dark:hover:bg-neutral-700" aria-haspopup="menu" aria-expanded="false" aria-label="Dropdown">
                    <svg class="shrink-0 size-3.5" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="1"></circle><circle cx="12" cy="5" r="1"></circle><circle cx="12" cy="19" r="1"></circle></svg>
                  </button>

                <div class="hs-dropdown-menu hs-dropdown-open:opacity-100 w-auto transition-[opacity,margin] duration opacity-0 hidden z-10 bg-white rounded-xl shadow-[0_10px_40px_10px_rgba(0,0,0,0.08)] dark:shadow-[0_10px_40px_10px_rgba(0,0,0,0.2)] dark:bg-neutral-900" role="menu" aria-orientation="vertical">
                  <div class="p-1">   
                    <button type="button" class="w-full flex items-center gap-x-3 py-2 px-3 rounded-lg text-sm text-gray-800 hover:bg-gray-100 disabled:opacity-50 disabled:pointer-events-none focus:outline-none focus:bg-gray-100 dark:text-neutral-300 dark:hover:bg-neutral-800 dark:focus:bg-neutral-800">
                      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="shrink-0 size-3.5"><path d="M19.5 12c0-1.232-.046-2.453-.138-3.662a4.006 4.006 0 0 0-3.7-3.7 48.678 48.678 0 0 0-7.324 0 4.006 4.006 0 0 0-3.7 3.7c-.017.22-.032.441-.046.662M19.5 12l3-3m-3 3-3-3m-12 3c0 1.232.046 2.453.138 3.662a4.006 4.006 0 0 0 3.7 3.7c.017-.22.032-.441.046-.662M4.5 12l3 3m-3-3-3 3"/></svg>          
                      Restart
                    </button>
                    
                    <button type="button" class="w-full flex items-center gap-x-3 py-2 px-3 rounded-lg text-sm text-gray-800 hover:bg-gray-100 disabled:opacity-50 disabled:pointer-events-none focus:outline-none focus:bg-gray-100 dark:text-neutral-300 dark:hover:bg-neutral-800 dark:focus:bg-neutral-800">
                      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="shrink-0 size-3.5"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>           
                      Delete
                    </button>
                  </div>
                </div>
              </div>
            </div>
          
            <!-- Progress Bar -->
            <div class="space-y-2">
              <div class="flex justify-between text-xs text-gray-600 dark:text-neutral-400">
                <span>${quiz.completed}/${quiz.total}</span>
                <span class="font-medium">${percentage}%</span>
              </div>
              <div class="w-full bg-gray-200 dark:bg-neutral-700 rounded-full h-1.5">
                <div class="bg-emerald-600 h-1.5 rounded-full transition-all duration-300" style="width: ${percentage}%"></div>
              </div>
            </div>
          </div>
        `;
      }
    });
    
    // Simple function to show quiz detail
    window.showQuizDetail = function(quizId) {
      console.log('Showing quiz detail for quiz:', quizId);
      
      // Hide quiz list, show quiz detail
      const quizListView = document.getElementById('quizzes-list-view');
      const quizDetailView = document.getElementById('quiz-detail-view');
      
      if (quizListView) quizListView.style.display = 'none';
      if (quizDetailView) {
        quizDetailView.style.display = 'block';
        console.log('Quiz detail view displayed');
        
        // Ensure all quiz content is visible
        const questionContent = quizDetailView.querySelector('#question-1');
        if (questionContent) {
          questionContent.style.display = 'block';
          questionContent.style.visibility = 'visible';
          questionContent.style.opacity = '1';
          console.log('Question content made visible');
        }
      }
    };
    
    // Function to go back to quiz list
    window.showQuizList = function() {
      // Hide quiz detail, show quiz list
      document.getElementById('quiz-detail-view').style.display = 'none';
      document.getElementById('quizzes-list-view').style.display = 'block';
    };
    
    // Essential functions for customize modal
    window.incrementQuestionCount = function() {
      const input = document.getElementById('question-count');
      const currentValue = parseInt(input.value);
      if (currentValue < parseInt(input.max)) {
        input.value = currentValue + 1;
      }
    };

    window.decrementQuestionCount = function() {
      const input = document.getElementById('question-count');
      const currentValue = parseInt(input.value);
      if (currentValue > parseInt(input.min)) {
        input.value = currentValue - 1;
      }
    };

    // Apply customize settings
    window.applyCustomizeSettings = function() {
      const difficulty = document.querySelector('input[name="difficulty"]:checked').value;
      const questionCount = document.getElementById('question-count').value;
      const contentType = document.querySelector('input[name="content-type"]:checked').value;
      
      let contentSelection = {};
      if (contentType === 'topics') {
        const selectedTopics = Array.from(document.querySelectorAll('#selected-topics > div')).map(div => div.textContent.trim().split('\n')[0]);
        contentSelection = { type: 'topics', topics: selectedTopics };
      } else {
        const pageFrom = document.getElementById('page-from').value;
        const pageTo = document.getElementById('page-to').value;
        contentSelection = { type: 'pages', from: pageFrom, to: pageTo };
      }

      // Store settings (you can modify this to send to your backend)
      const settings = {
        difficulty,
        questionCount,
        contentSelection
      };

      console.log('Quiz customization settings:', settings);
      
      // You can add additional logic here to apply the settings
      // For example, update the quiz generation parameters
    };

    // Topics functionality
    document.addEventListener('DOMContentLoaded', function() {
      const topicsSearch = document.getElementById('topics-search');
      const topicsDropdown = document.getElementById('topics-dropdown');
      const topicOptions = document.querySelectorAll('.topic-option');

      if (topicsSearch) {
        topicsSearch.addEventListener('focus', function() {
          topicsDropdown.classList.remove('hidden');
        });

        topicsSearch.addEventListener('input', function() {
          const searchTerm = this.value.toLowerCase();
          topicOptions.forEach(option => {
            const topicText = option.textContent.toLowerCase();
            if (topicText.includes(searchTerm)) {
              option.style.display = 'block';
            } else {
              option.style.display = 'none';
            }
          });
        });

        // Hide dropdown when clicking outside
        document.addEventListener('click', function(e) {
          if (!topicsSearch.contains(e.target) && !topicsDropdown.contains(e.target)) {
            topicsDropdown.classList.add('hidden');
          }
        });
      }

      // Topic selection functionality
      topicOptions.forEach(option => {
        option.addEventListener('click', function() {
          const topic = this.getAttribute('data-topic');
          const topicText = this.textContent;
          addSelectedTopic(topic, topicText);
          topicsDropdown.classList.add('hidden');
          topicsSearch.value = '';
        });
      });
    });

    // Add selected topic to the display
    function addSelectedTopic(topic, topicText) {
      const selectedTopics = document.getElementById('selected-topics');
      const topicTag = document.createElement('div');
      topicTag.className = 'inline-flex items-center gap-x-1 px-2 py-1 text-xs font-medium bg-emerald-100 text-emerald-800 rounded-full dark:bg-emerald-900/20 dark:text-emerald-300';
      topicTag.innerHTML = `
        ${topicText}
        <button type="button" onclick="removeTopic(this)" class="text-emerald-600 hover:text-emerald-800 dark:text-emerald-400 dark:hover:text-emerald-300">
          <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      `;
      selectedTopics.appendChild(topicTag);
    }

    // Remove selected topic
    window.removeTopic = function(button) {
      button.closest('div').remove();
    };
    
  </script>
</div>
<!-- End AI Quiz Content Tab -->
<!-- ApexCharts Scripts -->
{% include './quiz_apex_chart_script.html' %}
{% include './ai_quiz_script.html' %}
