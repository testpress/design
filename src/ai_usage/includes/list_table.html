<table class="min-w-full divide-y divide-gray-200" x-data="aiUsageTable()" @filter-changed.window="filter_by = $event.detail" @sort-changed.window="order_by = $event.detail, sortTable()">
  {% include "./table_header.html" %}
  <tbody class="divide-y divide-gray-200 bg-white" id="table-body">
    {% for item in ai_usage_logs.logs %}
      <tr data-s-no="{{ item.s_no }}" 
          data-custom-field="{{ item.custom_field }}"
          data-responses-yesterday="{{ item.total_responses_yesterday }}"
          data-responses-week="{{ item.total_responses_this_week }}"
          data-responses-month="{{ item.total_responses_this_month }}"
          data-responses-year="{{ item.total_responses_this_year }}"
          data-pages-yesterday="{{ item.total_pages_yesterday }}"
          data-pages-week="{{ item.total_pages_this_week }}"
          data-pages-month="{{ item.total_pages_this_month }}"
          data-pages-year="{{ item.total_pages_this_year }}"
          data-tokens-yesterday="{{ item.total_tokens_yesterday }}"
          data-tokens-week="{{ item.total_tokens_this_week }}"
          data-tokens-month="{{ item.total_tokens_this_month }}"
          data-tokens-year="{{ item.total_tokens_this_year }}">
        {% include "./table_item.html" %}
      </tr>
    {% endfor %}
    {% if not ai_usage_logs.logs %}
      <tr>
        <td colspan="5" class="p-8 text-center text-sm">No Records Found</td>
      </tr>
    {% endif %}
  </tbody>
</table>

<script>
function aiUsageTable() {
  return {
    filter_by: 'yesterday',
    order_by: 'tokens_desc',
    
    sortTable() {
      const tbody = document.getElementById('table-body');
      const rows = Array.from(tbody.querySelectorAll('tr[data-s-no]'));
      
      rows.sort((a, b) => {
        let aValue, bValue;
        
        switch(this.order_by) {
          case 'tokens_desc':
            aValue = parseInt(a.getAttribute(`data-tokens-${this.getDataAttribute(this.filter_by)}`)) || 0;
            bValue = parseInt(b.getAttribute(`data-tokens-${this.getDataAttribute(this.filter_by)}`)) || 0;
            return bValue - aValue;
          case 'tokens_asc':
            aValue = parseInt(a.getAttribute(`data-tokens-${this.getDataAttribute(this.filter_by)}`)) || 0;
            bValue = parseInt(b.getAttribute(`data-tokens-${this.getDataAttribute(this.filter_by)}`)) || 0;
            return aValue - bValue;
          case 'pages_desc':
            aValue = parseInt(a.getAttribute(`data-pages-${this.getDataAttribute(this.filter_by)}`)) || 0;
            bValue = parseInt(b.getAttribute(`data-pages-${this.getDataAttribute(this.filter_by)}`)) || 0;
            return bValue - aValue;
          case 'pages_asc':
            aValue = parseInt(a.getAttribute(`data-pages-${this.getDataAttribute(this.filter_by)}`)) || 0;
            bValue = parseInt(b.getAttribute(`data-pages-${this.getDataAttribute(this.filter_by)}`)) || 0;
            return aValue - bValue;
          default:
            return 0;
        }
      });
      
      rows.forEach(row => tbody.appendChild(row));
    },
    
    getDataAttribute(period) {
      switch(period) {
        case 'yesterday': return 'yesterday';
        case 'this_week': return 'week';
        case 'this_month': return 'month';
        case 'this_year': return 'year';
        default: return 'yesterday';
      }
    },
    
    init() {
      this.sortTable();      
      this.$watch('filter_by', () => {
        this.sortTable();
      });
    }
  }
}
</script>
