<header class="flex items-center justify-between border-b border-gray-200 px-6 py-4 lg:flex-none sm:px-0"
  x-data="{
    filter_by: 'yesterday',
    order_by: 'tokens_desc',
    updateFilter(newFilter) {
      this.filter_by = newFilter;
      this.$dispatch('filter-changed', newFilter);
    }
  }">
  <div class="flex items-center space-x-2">
    <div class="flex items-center space-x-2">
      <h1 class="text-xl font-semibold text-gray-900">
        Mistral AI Usage
      </h1>
      <div class="hs-tooltip [--placement:right] inline-block align-middle">
        <button type="button" class="hs-tooltip-toggle">
          <svg class="shrink-0 size-4 text-stone-500 dark:text-neutral-400 hover:text-stone-700 cursor-pointer" xmlns="http://www.w3.org/2000/svg"
            width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10" />
            <path d="M12 16v-4" />
            <path d="M12 8h.01" />
          </svg>
        </button>
        <div class="hs-tooltip-content hs-tooltip-shown:opacity-100 hs-tooltip-shown:visible opacity-0 transition-opacity hidden invisible z-60 max-w-60 py-2 px-2 bg-gray-900 text-xs font-normal text-white rounded-lg shadow-2xs dark:bg-neutral-700"
          role="tooltip">
          <p class="pl-1">Usage is updated every 4hrs.</p>
          <ul class="list-disc list-inside space-y-1 pl-1 pt-1">
            <li>Pages processed refers to total pages analysed by AI OCR.</li>
            <li>Tokens used refers to total tokens consumed during extraction.</li>
            <li>No of user responses refers to total number of times users have submitted responses for
              custom fields.</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <div class="hidden md:ml-4 md:flex md:items-center">
    <span class="isolate inline-flex rounded-md shadow-sm">
      <button @click="updateFilter('yesterday')" :class="{ 'bg-gray-50': filter_by === 'yesterday' }" type="button" class="relative inline-flex items-center rounded-l-md px-3 py-2 text-sm font-semibold text-gray-900 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-10 focus:bg-gray-50">
        Yesterday
      </button>
      <button @click="updateFilter('this_week')" :class="{ 'bg-gray-50': filter_by === 'this_week' }" type="button"
        class="relative -ml-px inline-flex items-center px-3 py-2 text-sm font-semibold text-gray-900 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-10 focus:bg-gray-50">
        Week
      </button>
      <button @click="updateFilter('this_month')" :class="{ 'bg-gray-50': filter_by === 'this_month' }" type="button"
        class="relative -ml-px inline-flex items-center px-3 py-2 text-sm font-semibold text-gray-900 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-10 focus:bg-gray-50">
        Month
      </button>
      <button @click="updateFilter('this_year')" :class="{ 'bg-gray-50': filter_by === 'this_year' }" type="button"
        class="relative -ml-px inline-flex items-center rounded-r-md px-3 py-2 text-sm font-semibold text-gray-900 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-10 focus:bg-gray-50">
        Year
      </button>
    </span>

    <div class="relative inline-block text-left ml-5" x-data="{ open: false }">
      <button type="button" @click="open = !open" @click.away="open = false"
        class="relative inline-flex items-center rounded px-3 py-2 text-sm font-semibold text-gray-900 ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
        Sort by
        <svg class="-mr-1 h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
          <path fill-rule="evenodd"
            d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z"
            clip-rule="evenodd" />
        </svg>
      </button>
      <div x-cloak x-show="open"
        class="absolute right-0 z-10 mt-2 w-44 origin-top-right rounded-md bg-white shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none">
        <div class="py-1">
          <a @click="order_by = 'tokens_desc', open = false, $dispatch('sort-changed', 'tokens_desc')"
            class="group flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 cursor-pointer">
            <span class="mr-2">Tokens</span>
            <svg class="h-4 w-4 text-gray-500 group-hover:text-gray-700" xmlns="http://www.w3.org/2000/svg"
              width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
              stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M8 18L12 22L16 18" />
              <path d="M12 2V22" />
            </svg>
          </a>
          <a @click="order_by = 'tokens_asc', open = false, $dispatch('sort-changed', 'tokens_asc')"
            class="group flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 cursor-pointer">
            <span class="mr-2">Tokens</span>
            <svg class="h-4 w-4 text-gray-500 group-hover:text-gray-700" xmlns="http://www.w3.org/2000/svg"
              width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
              stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M8 6L12 2L16 6" />
              <path d="M12 2V22" />
            </svg>
          </a>
          <a @click="order_by = 'pages_desc', open = false, $dispatch('sort-changed', 'pages_desc')"
            class="group flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 cursor-pointer">
            <span class="mr-2">Pages</span>
            <svg class="h-4 w-4 text-gray-500 group-hover:text-gray-700" xmlns="http://www.w3.org/2000/svg"
              width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
              stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M8 18L12 22L16 18" />
              <path d="M12 2V22" />
            </svg>
          </a>
          <a @click="order_by = 'pages_asc', open = false, $dispatch('sort-changed', 'pages_asc')"
            class="group flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 cursor-pointer">
            <span class="mr-2">Pages</span>
            <svg class="h-4 w-4 text-gray-500 group-hover:text-gray-700" xmlns="http://www.w3.org/2000/svg"
              width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
              stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M8 6L12 2L16 6" />
              <path d="M12 2V22" />
            </svg>
          </a>
        </div>
      </div>
    </div>
  </div>
</header>

<script>
  function getTotalResponses(filter_by) {
    let usage_logs = JSON.parse('{{ ai_usage_logs.logs |dump |safe }}');

    switch (filter_by) {
      case 'yesterday':
        return usage_logs.reduce((sum, log) => sum + (log.total_responses_yesterday || 0), 0);
      case 'this_week':
        return usage_logs.reduce((sum, log) => sum + (log.total_responses_this_week || 0), 0);
      case 'this_month':
        return usage_logs.reduce((sum, log) => sum + (log.total_responses_this_month || 0), 0);
      case 'this_year':
        return usage_logs.reduce((sum, log) => sum + (log.total_responses_this_year || 0), 0);
      default:
        return 0;
    }
  }

  function getTotalTokens(filter_by) {
    let usage_logs = JSON.parse('{{ ai_usage_logs.logs |dump |safe }}');

    switch (filter_by) {
      case 'yesterday':
        return usage_logs.reduce((sum, log) => sum + (log.total_tokens_yesterday || 0), 0);
      case 'this_week':
        return usage_logs.reduce((sum, log) => sum + (log.total_tokens_this_week || 0), 0);
      case 'this_month':
        return usage_logs.reduce((sum, log) => sum + (log.total_tokens_this_month || 0), 0);
      case 'this_year':
        return usage_logs.reduce((sum, log) => sum + (log.total_tokens_this_year || 0), 0);
      default:
        return 0;
    }
  }

  function getTotalPages(filter_by) {
    let usage_logs = JSON.parse('{{ ai_usage_logs.logs |dump |safe }}');

    switch (filter_by) {
      case 'yesterday':
        return usage_logs.reduce((sum, log) => sum + (log.total_pages_yesterday || 0), 0);
      case 'this_week':
        return usage_logs.reduce((sum, log) => sum + (log.total_pages_this_week || 0), 0);
      case 'this_month':
        return usage_logs.reduce((sum, log) => sum + (log.total_pages_this_month || 0), 0);
      case 'this_year':
        return usage_logs.reduce((sum, log) => sum + (log.total_pages_this_year || 0), 0);
      default:
        return 0;
    }
  }
</script>
