<div>
  <div class="text-gray-800 dark:text-neutral-200 prose prose-sm max-w-none flex">
    {{item.user_selected_answer.question.id}}. <p id="gap-fill-output"></p>
  </div>
</div>
<script>
  // Data coming from Django
  const questionText =
    {{ item.user_selected_answer.question.question_html | dump | safe }};

  const userAnswer =
    {{ (item.user_selected_answer.user_answer or []) | dump | safe }};

  const correctAnswer =
    {{ (item.user_selected_answer.correct_answer or []) | dump | safe }};

  function getGapFillHTML(questionText, userAnswer = [], correctAnswer = []) {
    if (!questionText) return '';

    const blanks =
      (questionText.match(/\[BLANK_\d+\]/g) || []).length;

    const parts =
      questionText.split(/\[BLANK_\d+\]/g);

    return parts.map((part, index) => {
      const userAns = userAnswer[index] ?? '';
      const correctAns = correctAnswer[index] ?? '';

      const isCorrect =
        userAns.trim().toLowerCase() ===
        correctAns.trim().toLowerCase();

      let answerSpan = '';
      if (index < blanks) {
        const colorClass = isCorrect
          ? 'border-b-2 border-emerald-500 text-emerald-500'
          : 'border-b-2 border-red-500 text-red-500';

        const displayText = userAns || '(blank)';
        answerSpan =
          `<span class="${colorClass} font-medium px-1">${displayText}</span>`;
      }

      return part + answerSpan;
    }).join('');
  }

  // Render on DOM load
  document.addEventListener('DOMContentLoaded', () => {
    const output = document.getElementById('gap-fill-output');
    output.innerHTML = getGapFillHTML(
      questionText,
      userAnswer,
      correctAnswer
    );
  });
</script>
