<div x-data="{
    active_popover: null,
    closeTimeout: null
  }" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 xl:grid-cols-4  gap-3 lg:gap-5">
  {% for product in ono_products %}
  <div x-data="{
      popoverOpen_{{ product.id }}: false,
      popoverArrow_{{ product.id }}: true,
      popoverPosition_{{ product.id }}: 'right',
      popoverOffset_{{ product.id }}: 8,

      popoverHeightCalculate_{{ product.id }}() {
          this.$refs.popover_{{ product.id }}.classList.add('invisible'); 
          this.popoverOpen_{{ product.id }} = false; 
          let that = this;
          $nextTick(function(){ 
              that.popoverOpen_{{ product.id }} = false; 
              that.$refs.popover_{{ product.id }}.classList.remove('invisible');
              that.$refs.popoverInner_{{ product.id }}.setAttribute('x-transition', '');
              that.popoverPositionCalculate();
          });
      },

      popoverPositionCalculate() {
          const buttonRect = this.$refs.popoverButton_{{ product.id }}.getBoundingClientRect();
          const popoverWidth = 384;
          const offset = this.popoverOffset_{{ product.id }};
          const viewportWidth = window.innerWidth;

          // Decide left or right based on available width
          if (viewportWidth - (buttonRect.right + offset + popoverWidth) > 0) {
              this.popoverPosition_{{ product.id }} = 'right';
          } else {
              this.popoverPosition_{{ product.id }} = 'left';
          }
      }
  }" class="relative">
    <a href="#">
      <div
        class="flex flex-col h-full justify-between p-1 bg-white border border-gray-200 rounded-2xl dark:bg-neutral-900 dark:border-neutral-700">
        <!-- Product Image -->
        <div class="relative w-full aspect-[16/9] group overflow-hidden">
          <img
            class="bg-gray-100 w-full h-full object-cover rounded-xl dark:bg-neutral-800 group-hover:scale-105 transition-transform duration-500 ease-in-out"
            src="{{ product.image }}" alt="Store Image" />
        </div>

        <!-- Product Info -->
        <div class="p-4 pb-2 space-y-1">
          <!-- Name + Tooltip Trigger -->
          <div class="hs-tooltip [--placement:bottom] inline">
            <div class="text-sm flex items-center space-x-2">
              <!-- Product Name -->
              <div class="hs-tooltip inline-block max-w-full" x-ref="popoverButton_{{ product.id }}"
                @mouseenter="clearTimeout(this.closeTimeout); active_popover={{ product.id}}; popoverOpen_{{ product.id }} = true"
                @mouseleave="this.closeTimeout = setTimeout(() => { popoverOpen_{{ product.id }} = false }, 250)">
                <h2 class="hs-tooltip-toggle font-medium text-gray-800 dark:text-neutral-200 line-clamp-2">
                  {{ product.name }}
                </h2>
              </div>
            </div>
          </div>
        </div>
        <div class="px-4 pb-4 mt-auto">
          <!-- Courses + contents summary -->
          <ul class="text-sm text-gray-500 dark:text-neutral-400 flex space-x-2">
            <li>{{ product.included_courses | length }} courses</li>
            <li>Â·</li>
            <li>{{ product.contents }} contents</li>
          </ul>

          <!-- Price -->
          <div class="flex items-center space-x-2 mt-1.5">
            <div class="text-gray-900 font-semibold">{{ product.price }}</div>
            <div class="text-sm text-gray-500">
              per user
            </div>
          </div>
        </div>
      </div>
    </a>

    <!-- Popover -->
    <div x-ref="popover_{{ product.id }}" x-cloak
      x-show="popoverOpen_{{ product.id }} && active_popover=== {{ product.id }}"
      x-init="$nextTick(() => popoverHeightCalculate_{{ product.id }}())" x-trap.inert="popoverOpen_{{ product.id }}"
      @mouseenter="clearTimeout(this.closeTimeout); popoverOpen_{{ product.id }} = true"
      @mouseleave="this.closeTimeout = setTimeout(() => { popoverOpen_{{ product.id }} = false }, 250)"
      @click.away="popoverOpen_{{ product.id }} = false" @keydown.escape.window="popoverOpen_{{ product.id }} = false"
      :class="{
            'left-full ml-2 top-1/2 -translate-y-1/2': popoverPosition_{{ product.id }} == 'right',
            'right-full mr-2 top-1/2 -translate-y-1/2': popoverPosition_{{ product.id }} == 'left'
        }" class="absolute z-[99]" style="width: 24rem">
      <div x-ref="popoverInner_{{ product.id }}" x-cloak x-show="popoverOpen_{{ product.id }}"
        class="relative w-full p-5 bg-white border rounded-md border-neutral-200/70 shadow-lg">
        <!-- Right Arrow -->
        <div x-cloak x-show="popoverArrow_{{ product.id }} && popoverPosition_{{ product.id }} == 'right'"
          class="absolute left-0 top-1/2 -translate-y-1/2 -translate-x-2">
          <div class="w-2.5 h-2.5 transform rotate-45 bg-white border-l border-b rounded-sm"></div>
        </div>

        <!-- Left Arrow -->
        <div x-cloak x-show="popoverArrow_{{ product.id }} && popoverPosition_{{ product.id }} == 'left' "
          class="absolute right-0 top-1/2 -translate-y-1/2 translate-x-2">
          <div class="w-2.5 h-2.5 transform rotate-45 bg-white border-t border-r rounded-sm"></div>
        </div>

        <div class="group relative grow max-h-72 overflow-y-auto">
          <div class="flex items-start justify-between mb-2">
            <span
              class="inline-flex items-center justify-center rounded-md border px-2 py-0.5 text-sm font-medium w-fit whitespace-nowrap shrink-0 gap-1 border-slate-300 text-slate-700 dark:border-neutral-600 dark:text-neutral-300">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="size-3">
                <path
                  d="m15.477 12.89 1.515 8.526a.5.5 0 0 1-.81.47l-3.58-2.687a1 1 0 0 0-1.197 0l-3.586 2.686a.5.5 0 0 1-.81-.469l1.514-8.526">
                </path>
                <circle cx="12" cy="8" r="6"></circle>
              </svg>
              {{ product.certificate_validity_days }} days
            </span>
          </div>
          <h3 class="text-lg/6 font-semibold text-gray-900 mb-3">
            {{ product.name }}
          </h3>
          <div class="mt-3 prose prose-sm max-w-none">
            {{ product.description|safe }}
          </div>
          <div class="mt-4 space-y-2 text-sm text-gray-700">
            {% if product.included_courses %}
            <div>
              <label
                class="flex items-center gap-2 text-sm leading-none font-medium select-none text-gray-500 dark:text-neutral-400">
                Includes {{ product.included_courses | length }} courses:
              </label>
              <ul class="mt-2 space-y-1">
                {% for course in product.included_courses %}
                <li class="text-sm flex items-start gap-2">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                    class="size-4 text-gray-400 dark:text-neutral-500 shrink-0 mt-0.5">
                    <path d="m9 18 6-6-6-6"></path>
                  </svg>
                  <span>{{ course }}</span>
                </li>
                {% endfor %}
              </ul>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endfor %}
</div>