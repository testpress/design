<script>
  function reportBuilder() {
    const generateId = () => self.crypto.randomUUID();

    const defaultGroup = (title) => ({
      id: generateId(),
      title,
      description: '',
      maximum_marks: '',
      minimum_marks: '',
      rounding_precision: 1,
      show_average: true,
      show_total: true,
      items: []
    });

    const defaultSection = (title, type = 'scholastic') => ({
      id: generateId(),
      title,
      description: '',
      section_type: type,
      show_total_score: true,
      groups: [defaultGroup('English'), defaultGroup('Math')]
    });

    const moveInArray = (arr, index, direction) => {
      const target = index + direction;
      if (target >= 0 && target < arr.length) {
        [arr[index], arr[target]] = [arr[target], arr[index]];
      }
      return arr;
    };

    return {
      report: {
        title: 'SAT Progress Report',
        description: 'Auto-computed projection using weekly practice exams.',
        course: 'SAT Foundation',
        state: 'draft',
        remarks_enabled: true
      },
      sections: [defaultSection('SAT Projection')],
      selectedSectionId: null,
      selectedGroupId: null,

      sectionModal: { mode: 'create', editingId: null, form: {} },
      groupModal:   { mode: 'create', editingId: null, sectionId: null, form: {} },
      itemModal:    { mode: 'create', editingId: null, groupId: null, form: {} },

      init() {
        if (this.sections.length > 0) {
          this.selectedSectionId = this.sections[0].id;
          if (this.sections[0].groups.length > 0) {
            this.selectedGroupId = this.sections[0].groups[0].id;
          }
        }
      },

      get activeSection() {
        return this.sections.find(s => s.id === this.selectedSectionId) || null;
      },

      get activeGroupList() {
        return this.activeSection ? this.activeSection.groups : [];
      },

      get activeGroup() {
        return this.activeGroupList.find(g => g.id === this.selectedGroupId) || null;
      },

      selectSection(id) {
        this.selectedSectionId = id;
        const section = this.sections.find(s => s.id === id);
        this.selectedGroupId = (section && section.groups.length > 0) ? section.groups[0].id : null;
      },

      addSection() {
        const section = defaultSection('New Section', 'scholastic');
        this.sections.push(section);
        this.selectSection(section.id);
      },

      moveSection(index, direction) {
        this.sections = moveInArray([...this.sections], index, direction);
      },

      deleteSection(index) {
        if (!confirm('Delete this section? This action cannot be undone.')) return;
        
        this.sections.splice(index, 1);
        
        if (this.sections.length > 0) {
          this.selectSection(this.sections[0].id);
        } else {
          this.selectedSectionId = null;
          this.selectedGroupId = null;
        }
      },

      moveGroup(sectionId, index, direction) {
        const section = this.sections.find(s => s.id === sectionId);
        if (section) moveInArray(section.groups, index, direction);
      },

      deleteGroup(sectionId, index) {
        const section = this.sections.find(s => s.id === sectionId);
        if (!section) return;
        
        if (confirm('Delete this group?')) {
          section.groups.splice(index, 1);
          if (!section.groups.find(g => g.id === this.selectedGroupId)) {
            this.selectedGroupId = section.groups.length ? section.groups[0].id : null;
          }
        }
      },

      moveItem(index, direction) {
        if (this.activeGroup) moveInArray(this.activeGroup.items, index, direction);
      },

      removeItem(index) {
        if (this.activeGroup && confirm('Remove this item?')) {
          this.activeGroup.items.splice(index, 1);
        }
      },

      saveDraft() {
        console.log('Draft saved', this.report, this.sections);
      },

      publish() {
        console.log('Published', this.report, this.sections);
      },

      openSectionModal(id = null) {
        this.sectionModal.mode = id ? 'edit' : 'create';
        this.sectionModal.editingId = id;
        
        const defaults = { title: '', description: '', section_type: 'scholastic', show_total_score: true };
        
        if (id) {
          const section = this.sections.find(s => s.id === id);
          this.sectionModal.form = section ? { ...section } : defaults;
        } else {
          this.sectionModal.form = defaults;
        }
        window.HSOverlay?.open('#section-modal');
      },

      saveSectionModal() {
        if (this.sectionModal.mode === 'edit') {
          const section = this.sections.find(s => s.id === this.sectionModal.editingId);
          if (section) Object.assign(section, this.sectionModal.form);
        } else {
          const newSection = {
            id: generateId(),
            ...this.sectionModal.form,
            title: this.sectionModal.form.title || 'Untitled section',
            groups: []
          };
          this.sections.push(newSection);
          this.selectSection(newSection.id);
        }
        window.HSOverlay?.close('#section-modal');
        this.$nextTick(() => window.HSDropdown?.autoInit());
      },

      openGroupModal(sectionId, groupId = null) {
        this.groupModal.sectionId = sectionId;
        this.groupModal.mode = groupId ? 'edit' : 'create';
        this.groupModal.editingId = groupId;

        const defaults = { 
          title: '', description: '', maximum_marks: '', minimum_marks: '', 
          rounding_precision: 1, show_average: true, show_total: true 
        };

        if (groupId) {
          const group = this.sections.find(s => s.id === sectionId)?.groups.find(g => g.id === groupId);
          this.groupModal.form = group ? { ...group } : defaults;
        } else {
          this.groupModal.form = defaults;
        }
        window.HSOverlay?.open('#group-modal');
      },

      saveGroupModal() {
        const section = this.sections.find(s => s.id === this.groupModal.sectionId);
        if (!section) return;

        if (this.groupModal.mode === 'edit') {
          const group = section.groups.find(g => g.id === this.groupModal.editingId);
          if (group) Object.assign(group, this.groupModal.form);
        } else {
          const newGroup = {
            id: generateId(),
            ...this.groupModal.form,
            title: this.groupModal.form.title || 'Untitled group',
            items: []
          };
          section.groups.push(newGroup);
          this.selectedGroupId = newGroup.id;
        }
        window.HSOverlay?.close('#group-modal');
        this.$nextTick(() => window.HSDropdown?.autoInit());
      },

      openItemModal(itemId = null) {
        if (!this.activeGroup) return;
        this.itemModal.groupId = this.activeGroup.id;
        this.itemModal.mode = itemId ? 'edit' : 'create';
        this.itemModal.editingId = itemId;

        const defaults = {
          item_type: 'scholastic', content_type: 'exam', title: '',
          exam: [], exam_section: [], chapter_content: [],
          max_score: '', min_score: ''
        };

        if (itemId) {
          const item = this.activeGroup.items.find(i => i.id === itemId);
          this.itemModal.form = item ? JSON.parse(JSON.stringify(item)) : defaults;
        } else {
          this.itemModal.form = defaults;
        }
        window.HSOverlay?.open('#item-modal');
      },

      saveItemModal() {
        if (!this.activeGroup) return;

        const isDuplicate = this.activeGroup.items.some(item => {
          if (this.itemModal.mode === 'edit' && item.id === this.itemModal.editingId) {
            return false;
          }
          return item.title === this.itemModal.form.title &&
                 item.content_type === this.itemModal.form.content_type;
        });

        if (isDuplicate) {
          alert('An item with this title and type already exists in this group.');
          return;
        }

        if (this.itemModal.mode === 'edit') {
          const item = this.activeGroup.items.find(i => i.id === this.itemModal.editingId);
          if (item) Object.assign(item, this.itemModal.form);
        } else {
          this.activeGroup.items.push({
            id: generateId(),
            ...this.itemModal.form,
            title: this.itemModal.form.title || 'Untitled item'
          });
        }
        window.HSOverlay?.close('#item-modal');
        this.$nextTick(() => window.HSDropdown?.autoInit());
      }
    };
  }
</script>