<form method="POST" class="mt-4 space-y-6" x-data="{
  recurringMeeting:true,
  recurrence:'2',
  endCondition:'no_end',
  advancedOpen:false,
  showPreview:false,
  currentStep: 1, // 1 = form creation, 2 = preview
  formData: {},
  sessionPreview: [],
  suffixType: 'number', // 'number', 'date', 'both'
  
  captureFormData() {
    const startDateTime = this.$refs.startDateTimeInput?.value || '';
    let startDate = '';
    let startTime = '';
    
    if (startDateTime) {
      const parts = startDateTime.split(' ');
      if (parts.length >= 3) {
        const datePart = parts[0]; // DD/MM/YYYY
        const timePart = parts[1]; // hh:mm
        const ampm = parts[2]; // A or P
        
        if (datePart.includes('/')) {
          const [day, month, year] = datePart.split('/');
          startDate = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
        }
        
        // Convert 12-hour time to 24-hour time
        if (timePart && ampm) {
          let [hours, minutes] = timePart.split(':');
          hours = parseInt(hours);
          if (ampm.toLowerCase().startsWith('p') && hours !== 12) {
            hours += 12;
          } else if (ampm.toLowerCase().startsWith('a') && hours === 12) {
            hours = 0;
          }
          startTime = `${hours.toString().padStart(2, '0')}:${minutes}`;
        }
      }
    }
    
    this.formData = {
      title: this.$refs.titleInput?.value || '',
      suffixType: this.suffixType,
      duration: this.$refs.durationInput?.value || '60',
      startDate: startDate,
      startTime: startTime,
      selectedDays: Array.from(document.querySelectorAll('input[name=\'days[]\']')).filter(cb => cb.checked).map(cb => cb.nextElementSibling.nextElementSibling.textContent.trim()),
      endByDateValue: this.$refs.endByDateInput?.value || '',
      endAfterValue: this.$refs.endAfterInput?.value || '',
      host: this.$refs.hostInput?.value || 'staff1',
    }
  },

  get formDataCurrent() {
    const startDateTime = this.$refs.startDateTimeInput?.value || '';
    let startDate = '';
    let startTime = '';
    
    if (startDateTime) {
      const parts = startDateTime.split(' ');
      if (parts.length >= 3) {
        const datePart = parts[0]; // DD/MM/YYYY
        const timePart = parts[1]; // hh:mm
        const ampm = parts[2]; // A or P
        
        if (datePart.includes('/')) {
          const [day, month, year] = datePart.split('/');
          startDate = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
        }
        
        if (timePart && ampm) {
          let [hours, minutes] = timePart.split(':');
          hours = parseInt(hours);
          if (ampm.toLowerCase().startsWith('p') && hours !== 12) {
            hours += 12;
          } else if (ampm.toLowerCase().startsWith('a') && hours === 12) {
            hours = 0;
          }
          startTime = `${hours.toString().padStart(2, '0')}:${minutes}`;
        }
      }
    }
    
    return {
      title: this.$refs.titleInput?.value || '',
      suffixType: this.suffixType,
      duration: this.$refs.durationInput?.value || '60',
      startDate: startDate,
      startTime: startTime,
      selectedDays: Array.from(document.querySelectorAll('input[name=\'days[]\']')).filter(cb => cb.checked).map(cb => cb.nextElementSibling.nextElementSibling.textContent.trim()),
      endByDateValue: this.$refs.endByDateInput?.value || '',
      endAfterValue: this.$refs.endAfterInput?.value || '',
      host: this.$refs.hostInput?.value || 'staff1',
    }
  },

  get activeFormData() {
    return this.currentStep === 2 ? this.formData : this.formDataCurrent;
  },

  proceedToPreview() {
    this.captureFormData();
    this.sessionPreview = this.calculateNextSessions();
    this.currentStep = 2;
  },

  goBackToForm() {
    this.currentStep = 1;
  },
  
  get recurrenceText() {
    const patterns = {'1': 'Daily', '2': 'Weekly', '3': 'Monthly'};
    return patterns[this.recurrence] || 'Weekly';
  },
  
  get endConditionText() {
    if (this.endCondition === 'no_end') return 'No end date';
    if (this.endCondition === 'end_by_date') return `End by: ${this.activeFormData.endByDateValue || 'Not set'}`;
    if (this.endCondition === 'end_after') return `End after: ${this.activeFormData.endAfterValue || '0'} occurrences`;
    return 'No end date';
  },
  
  calculateNextSessions() {
    const sessions = [];
    const startDate = this.activeFormData.startDate;
    const startTime = this.activeFormData.startTime;
    
    if (!startDate || !startTime) {
      return [{
        number: 1,
        date: 'Complete start date and time to see sessions',
        time: 'TBD',
        title: this.activeFormData.title || 'Class Title'
      }];
    }
    
    try {
      const baseDate = new Date(startDate + 'T' + startTime);
      
      if (isNaN(baseDate.getTime())) {
        throw new Error('Invalid start date or time');
      }
      
      let maxSessions = 14; // Default limit
      let endDate = null;
      
      // Set limits based on end condition
      if (this.endCondition === 'end_after' && this.activeFormData.endAfterValue) {
        maxSessions = Math.min(parseInt(this.activeFormData.endAfterValue), 14);
      } else if (this.endCondition === 'end_by_date' && this.activeFormData.endByDateValue) {
        let endDateStr = this.activeFormData.endByDateValue;
        if (endDateStr.includes('/')) {
          const [day, month, year] = endDateStr.split('/');
          endDateStr = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
        }
        endDate = new Date(endDateStr + 'T23:59:59');
        
        if (isNaN(endDate.getTime())) {
          throw new Error('Invalid end date');
        }
      }
      
      if (this.recurrence === '1') { // Daily
        let sessionCount = 0;
        let currentDate = new Date(baseDate);
        
        while (sessionCount < maxSessions) {
          // Check if we've passed the end date
          if (endDate && currentDate > endDate) break;
          
          sessions.push({
            number: sessionCount + 1,
            date: currentDate.toLocaleDateString('en-US', { 
              weekday: 'short', 
              year: 'numeric', 
              month: 'short', 
              day: 'numeric' 
            }),
            time: startTime,
            title: this.generateSessionTitle(this.activeFormData.title, sessionCount + 1, currentDate),
            dateObj: new Date(currentDate) // For sorting/comparison
          });
          
          sessionCount++;
          currentDate.setDate(currentDate.getDate() + 1);
        }
      } else if (this.recurrence === '2') { // Weekly
        const selectedDayNumbers = Array.from(document.querySelectorAll('input[name=\'days[]\']')).filter(cb => cb.checked).map(cb => parseInt(cb.value));
        
        if (selectedDayNumbers.length === 0) {
          return [{
            number: 1,
            date: 'Select days of the week first',
            time: startTime,
            title: this.activeFormData.title || 'Class Title'
          }];
        }
        
        let sessionCount = 0;
        let currentWeekStart = new Date(baseDate);
        currentWeekStart.setDate(currentWeekStart.getDate() - currentWeekStart.getDay()); // Go to Sunday of the week
        
        let weekOffset = 0;
        while (sessionCount < maxSessions) {
          let hasSessionThisWeek = false;
          
          for (let day of selectedDayNumbers.sort()) {
            if (sessionCount >= maxSessions) break;
            
            const sessionDate = new Date(currentWeekStart);
            sessionDate.setDate(currentWeekStart.getDate() + day + (weekOffset * 7));
            
            // Check if session is after start date and before end date (if set)
            if (sessionDate >= baseDate && (!endDate || sessionDate <= endDate)) {
              sessions.push({
                number: sessionCount + 1,
                date: sessionDate.toLocaleDateString('en-US', { 
                  weekday: 'short', 
                  year: 'numeric', 
                  month: 'short', 
                  day: 'numeric' 
                }),
                time: startTime,
                title: this.generateSessionTitle(this.activeFormData.title, sessionCount + 1, sessionDate),
                dateObj: new Date(sessionDate)
              });
              sessionCount++;
              hasSessionThisWeek = true;
            } else if (endDate && sessionDate > endDate) {
              // If we've passed the end date, stop calculating
              break;
            }
          }
          
          // If end date is set and no sessions were added this week, we might be past the end date
          if (endDate && !hasSessionThisWeek && weekOffset > 0) {
            break;
          }
          
          weekOffset++;
          
          // Safety check to prevent infinite loops
          if (weekOffset > 100) break;
        }
      } else if (this.recurrence === '3') { // Monthly
        let sessionCount = 0;
        let currentDate = new Date(baseDate);
        
        while (sessionCount < maxSessions) {
          // Check if we've passed the end date
          if (endDate && currentDate > endDate) break;
          
          sessions.push({
            number: sessionCount + 1,
            date: currentDate.toLocaleDateString('en-US', { 
              weekday: 'short', 
              year: 'numeric', 
              month: 'short', 
              day: 'numeric' 
            }),
            time: startTime,
            title: this.generateSessionTitle(this.activeFormData.title, sessionCount + 1, currentDate),
            dateObj: new Date(currentDate)
          });
          
          sessionCount++;
          currentDate.setMonth(currentDate.getMonth() + 1);
        }
      }
      
      return sessions.length > 0 ? sessions : [{
        number: 1,
        date: 'No sessions match the selected criteria',
        time: 'Please adjust your settings',
        title: this.activeFormData.title || 'Class Title'
      }];
    } catch (error) {
      return [{
        number: 1,
        date: 'Invalid date/time format',
        time: 'Please check your inputs',
        title: this.activeFormData.title || 'Class Title'
      }];
    }
  },

  generateSessionTitle(baseTitle, sessionNumber, sessionDate) {
    if (!baseTitle) return 'Class Title';
    
    const suffixType = this.activeFormData.suffixType || this.suffixType;
    const formattedDate = sessionDate.toLocaleDateString('en-US', { 
      month: '2-digit', 
      day: '2-digit', 
      year: 'numeric' 
    });
    
    switch (suffixType) {
      case 'number':
        return `${baseTitle} ${sessionNumber}`;
      case 'date':
        return `${baseTitle} on ${formattedDate}`;
      case 'both':
        return `${baseTitle} ${sessionNumber} on ${formattedDate}`;
      default:
        return `${baseTitle} ${sessionNumber}`;
    }
  }
}">
  
  <!-- Progress Indicator -->
  <div class="mb-8">
    <nav aria-label="Progress">
      <ol role="list" class="flex items-center">
        <li class="relative">
          <div class="flex items-center">
            <div :class="currentStep >= 1 ? 'bg-emerald-600 text-white' : 'bg-gray-200 text-gray-500'" class="flex h-8 w-8 items-center justify-center rounded-full text-sm font-medium">
              1
            </div>
            <span :class="currentStep >= 1 ? 'text-emerald-600 font-medium' : 'text-gray-500'" class="ml-3 text-sm">Create Series</span>
          </div>
        </li>
        <li class="relative ml-8">
          <div class="flex items-center">
            <div :class="currentStep >= 2 ? 'bg-emerald-600 text-white' : 'bg-gray-200 text-gray-500'" class="flex h-8 w-8 items-center justify-center rounded-full text-sm font-medium">
              2
            </div>
            <span :class="currentStep >= 2 ? 'text-emerald-600 font-medium' : 'text-gray-500'" class="ml-3 text-sm">Preview & Confirm</span>
          </div>
        </li>
      </ol>
    </nav>
  </div>

  <!-- Step 1: Form Creation -->
  <div x-show="currentStep === 1" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 transform translate-x-4" x-transition:enter-end="opacity-100 transform translate-x-0" class="space-y-6">
    <!-- SECTION 1 - Basic Information -->
    <div class="bg-white shadow-sm border border-gray-200 rounded-lg">
      <div class="px-6 py-4 border-b border-gray-200">
        <h3 class="text-lg font-medium text-gray-900">Basic Information</h3>
      </div>
      <div class="px-6 py-6 space-y-6">
        <div class="grid grid-cols-1 gap-6">
          <div>
            <label for="title" class="block text-sm font-medium text-gray-900">
              Title <span class="text-red-500">*</span>
            </label>
            <div class="mt-2">
              <input type="text" name="title" id="title" x-ref="titleInput" required placeholder="Enter class title..." value="Weekly Mathematics Class" class="block w-full rounded-md border-0 py-2 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-emerald-500 sm:text-sm sm:leading-6" />
            </div>
          </div>

          <!-- Set Suffix Section -->
          <div>
            <label class="block text-sm font-medium text-gray-900 mb-1">
              Append to Title
            </label>
            <p class="text-sm text-gray-600 mb-3">Choose how to label each class session.</p>
            
            <div class="space-y-3">
              <div class="flex items-start">
                <input id="suffix_number" name="suffix_type" type="radio" value="number" x-model="suffixType" class="mt-1 h-4 w-4 text-emerald-600 focus:ring-emerald-500 border-gray-300">
                <div class="ml-3">
                  <label for="suffix_number" class="block text-sm font-medium text-gray-900">Number</label>
                  <p class="text-sm text-gray-600">Adds sequential numbers to class titles</p>
                  <p class="text-xs text-gray-500 mt-1">Example: "Weekly Mathematics Class 1", "Weekly Mathematics Class 2"</p>
                </div>
              </div>
              
              <div class="flex items-start">
                <input id="suffix_date" name="suffix_type" type="radio" value="date" x-model="suffixType" class="mt-1 h-4 w-4 text-emerald-600 focus:ring-emerald-500 border-gray-300">
                <div class="ml-3">
                  <label for="suffix_date" class="block text-sm font-medium text-gray-900">Date</label>
                  <p class="text-sm text-gray-600">Adds the class date to titles</p>
                  <p class="text-xs text-gray-500 mt-1">Example: "Weekly Mathematics Class on 05.26.2025", "Weekly Mathematics Class on 05.28.2025"</p>
                </div>
              </div>
              
              <div class="flex items-start">
                <input id="suffix_both" name="suffix_type" type="radio" value="both" x-model="suffixType" class="mt-1 h-4 w-4 text-emerald-600 focus:ring-emerald-500 border-gray-300">
                <div class="ml-3">
                  <label for="suffix_both" class="block text-sm font-medium text-gray-900">Both Number and Date</label>
                  <p class="text-sm text-gray-600">Combines sequential numbering with dates</p>
                  <p class="text-xs text-gray-500 mt-1">Example: "Weekly Mathematics Class 1 on 05.26.2025", "Weekly Mathematics Class 2 on 05.28.2025"</p>
                </div>
              </div>
            </div>
          </div>
          
          <div>
            <label for="description" class="block text-sm font-medium text-gray-900">Description</label>
            <div class="mt-2">
              <textarea name="description" id="description" rows="3" class="block w-full rounded-md border-0 py-2 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-emerald-500 sm:text-sm sm:leading-6"></textarea>
            </div>
          </div>
          
          <div class="grid grid-cols-6 gap-6">
            <div class="col-span-6 sm:col-span-3">
              <label for="start_datetime" class="block text-sm/6 font-medium text-gray-900">Start Date & Time</label>
              <div class="mt-2">
                <div class="flex rounded-md shadow-sm ring-1 ring-inset ring-gray-300 focus-within:ring-2 focus-within:ring-inset focus-within:ring-emerald-500 sm:max-w-md">
                  <input type="text" name="start_datetime" id="start_datetime" x-ref="startDateTimeInput" class="block flex-1 border-0 bg-transparent py-1.5 pl-3 text-gray-900 placeholder:text-gray-400 focus:ring-0 sm:text-sm sm:leading-6" />
                </div>
              </div>
            </div>
            <div class="col-span-6 sm:col-span-3">
              <label for="duration" class="block text-sm/6 font-medium text-gray-900">Duration (In Minutes) </label>
              <div class="mt-2">
                <div class="flex rounded-md shadow-sm ring-1 ring-inset ring-gray-300 focus-within:ring-2 focus-within:ring-inset focus-within:ring-emerald-500 sm:max-w-md">
                  <input type="number" name="duration" id="duration" x-ref="durationInput" value="60" min="1" max="480" class="block flex-1 border-0 bg-transparent py-1.5 pl-3 text-gray-900 placeholder:text-gray-400 focus:ring-0 sm:text-sm sm:leading-6" />
                </div>
              </div>
            </div>
          </div>

          <div>
            <label for="host" class="block text-sm font-medium text-gray-900">Host</label>
            <div class="mt-2">
              <select name="host" id="host" x-ref="hostInput" class="block w-full rounded-md border-0 py-2 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-inset focus:ring-emerald-500 sm:text-sm sm:leading-6">
                <option value="staff1">Staff 1</option>
                <option value="staff2">Staff 2</option>
              </select>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- SECTION 2 - Schedule Configuration -->
    <div class="bg-white shadow-sm border border-gray-200 rounded-lg">
      <div class="px-6 py-4 border-b border-gray-200">
        <h3 class="text-lg font-medium text-gray-900">Recurrence Schedule</h3>
      </div>
      <div class="px-6 py-6 space-y-6">
        <div>
          <div class="grid grid-cols-1 sm:grid-cols-6 sm:gap-6 gap-3">
            <div class="sm:col-span-2 sm:col-start-1">
              <label for="watermark_type" class="block text-sm font-medium leading-6 text-gray-900">Recurrence</label>
              <div class="mt-2">
                <select id="watermark_type" name="recurrence" x-model="recurrence" class="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-inset focus:ring-emerald-500 sm:max-w-xs sm:text-sm sm:leading-6">
                  <option value="1">Daily</option>
                  <option value="2">Weekly</option>
                  <option value="3">Monthly</option>
                </select>
              </div>
            </div>

            <div class="sm:col-span-2">
              <label for="street-address" class="block text-sm/6 font-medium text-gray-900">Repeat every </label>
              <div class="mt-2 flex items-center gap-x-2">
                <select id="watermark_type" name="watermark_type" x-model="watermarkType" class="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-inset focus:ring-emerald-500 sm:max-w-xs sm:text-sm sm:leading-6">
                  <option value="1">1</option>
                  <option value="2">2</option>
                  <option value="3">3</option>
                  <option value="4">4</option>
                  <option value="5">5</option>
                  <option value="6">6</option>
                  <option value="7">7</option>
                </select>
                <span 
                  x-text="recurrence === '1' ? 'day(s)' : recurrence === '2' ? 'week(s)' : 'month(s)'"
                  class="text-sm text-gray-500 dark:text-neutral-500 whitespace-nowrap">
                </span>
              </div>
            </div>
          </div>
        </div>
        <div x-cloak x-show="recurrence=='2'">
          <label for="comments" class="font-medium text-gray-900">Occurs on</label>
          <!-- Button Group -->
          <div class="flex flex-wrap gap-2 mt-2">
            <!-- Monday -->
            <label for="day-1" class="py-1 px-2.5 relative flex justify-center items-center text-center text-[13px] bg-white border border-gray-200 ring-1 ring-transparent text-gray-800 cursor-pointer rounded-xl hover:border-emerald-600 hover:ring-emerald-600 has-[:checked]:bg-emerald-100 has-[:checked]:border-emerald-200 has-[:checked]:ring-emerald-200 has-[:checked]:text-emerald-800 has-[:disabled]:pointer-events-none has-[:disabled]:text-gray-200">
              <input type="checkbox" id="day-1" value="1" class="hidden peer" name="days[]" />
              <span class="flex shrink-0 justify-center items-center size-0 bg-emerald-500 text-transparent rounded-full transition-all duration-200 peer-checked:size-4 peer-checked:me-1.5 peer-checked:text-white">
                <svg class="shrink-0 size-2.5" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6 9 17l-5-5" /></svg>
              </span>
              <span class="block"> Mon </span>
            </label>
            
            <!-- Tuesday -->
            <label for="day-2" class="py-1 px-2.5 relative flex justify-center items-center text-center text-[13px] bg-white border border-gray-200 ring-1 ring-transparent text-gray-800 cursor-pointer rounded-xl hover:border-emerald-600 hover:ring-emerald-600 has-[:checked]:bg-emerald-100 has-[:checked]:border-emerald-200 has-[:checked]:ring-emerald-200 has-[:checked]:text-emerald-800 has-[:disabled]:pointer-events-none has-[:disabled]:text-gray-200">
              <input type="checkbox" id="day-2" value="2" class="hidden peer" name="days[]" />
              <span class="flex shrink-0 justify-center items-center size-0 bg-emerald-500 text-transparent rounded-full transition-all duration-200 peer-checked:size-4 peer-checked:me-1.5 peer-checked:text-white">
                <svg class="shrink-0 size-2.5" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6 9 17l-5-5" /></svg>
              </span>
              <span class="block"> Tue </span>
            </label>
            
            <!-- Wednesday -->
            <label for="day-3" class="py-1 px-2.5 relative flex justify-center items-center text-center text-[13px] bg-white border border-gray-200 ring-1 ring-transparent text-gray-800 cursor-pointer rounded-xl hover:border-emerald-600 hover:ring-emerald-600 has-[:checked]:bg-emerald-100 has-[:checked]:border-emerald-200 has-[:checked]:ring-emerald-200 has-[:checked]:text-emerald-800 has-[:disabled]:pointer-events-none has-[:disabled]:text-gray-200">
              <input type="checkbox" id="day-3" value="3" class="hidden peer" name="days[]" />
              <span class="flex shrink-0 justify-center items-center size-0 bg-emerald-500 text-transparent rounded-full transition-all duration-200 peer-checked:size-4 peer-checked:me-1.5 peer-checked:text-white">
                <svg class="shrink-0 size-2.5" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6 9 17l-5-5" /></svg>
              </span>
              <span class="block"> Wed </span>
            </label>
            
            <!-- Thursday -->
            <label for="day-4" class="py-1 px-2.5 relative flex justify-center items-center text-center text-[13px] bg-white border border-gray-200 ring-1 ring-transparent text-gray-800 cursor-pointer rounded-xl hover:border-emerald-600 hover:ring-emerald-600 has-[:checked]:bg-emerald-100 has-[:checked]:border-emerald-200 has-[:checked]:ring-emerald-200 has-[:checked]:text-emerald-800 has-[:disabled]:pointer-events-none has-[:disabled]:text-gray-200">
              <input type="checkbox" id="day-4" value="4" class="hidden peer" name="days[]" />
              <span class="flex shrink-0 justify-center items-center size-0 bg-emerald-500 text-transparent rounded-full transition-all duration-200 peer-checked:size-4 peer-checked:me-1.5 peer-checked:text-white">
                <svg class="shrink-0 size-2.5" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6 9 17l-5-5" /></svg>
              </span>
              <span class="block"> Thu </span>
            </label>
            
            <!-- Friday -->
            <label for="day-5" class="py-1 px-2.5 relative flex justify-center items-center text-center text-[13px] bg-white border border-gray-200 ring-1 ring-transparent text-gray-800 cursor-pointer rounded-xl hover:border-emerald-600 hover:ring-emerald-600 has-[:checked]:bg-emerald-100 has-[:checked]:border-emerald-200 has-[:checked]:ring-emerald-200 has-[:checked]:text-emerald-800 has-[:disabled]:pointer-events-none has-[:disabled]:text-gray-200">
              <input type="checkbox" id="day-5" value="5" class="hidden peer" name="days[]" />
              <span class="flex shrink-0 justify-center items-center size-0 bg-emerald-500 text-transparent rounded-full transition-all duration-200 peer-checked:size-4 peer-checked:me-1.5 peer-checked:text-white">
                <svg class="shrink-0 size-2.5" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6 9 17l-5-5" /></svg>
              </span>
              <span class="block"> Fri </span>
            </label>
            
            <!-- Saturday -->
            <label for="day-6" class="py-1 px-2.5 relative flex justify-center items-center text-center text-[13px] bg-white border border-gray-200 ring-1 ring-transparent text-gray-800 cursor-pointer rounded-xl hover:border-emerald-600 hover:ring-emerald-600 has-[:checked]:bg-emerald-100 has-[:checked]:border-emerald-200 has-[:checked]:ring-emerald-200 has-[:checked]:text-emerald-800 has-[:disabled]:pointer-events-none has-[:disabled]:text-gray-200">
              <input type="checkbox" id="day-6" value="6" class="hidden peer" name="days[]" />
              <span class="flex shrink-0 justify-center items-center size-0 bg-emerald-500 text-transparent rounded-full transition-all duration-200 peer-checked:size-4 peer-checked:me-1.5 peer-checked:text-white">
                <svg class="shrink-0 size-2.5" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6 9 17l-5-5" /></svg>
              </span>
              <span class="block"> Sat </span>
            </label>
            
            <!-- Sunday -->
            <label for="day-0" class="py-1 px-2.5 relative flex justify-center items-center text-center text-[13px] bg-white border border-gray-200 ring-1 ring-transparent text-gray-800 cursor-pointer rounded-xl hover:border-emerald-600 hover:ring-emerald-600 has-[:checked]:bg-emerald-100 has-[:checked]:border-emerald-200 has-[:checked]:ring-emerald-200 has-[:checked]:text-emerald-800 has-[:disabled]:pointer-events-none has-[:disabled]:text-gray-200">
              <input type="checkbox" id="day-0" value="0" class="hidden peer" name="days[]" />
              <span class="flex shrink-0 justify-center items-center size-0 bg-emerald-500 text-transparent rounded-full transition-all duration-200 peer-checked:size-4 peer-checked:me-1.5 peer-checked:text-white">
                <svg class="shrink-0 size-2.5" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6 9 17l-5-5" /></svg>
              </span>
              <span class="block"> Sun </span>
            </label>
          </div>
          <!-- End Button Group -->
        </div>
        <div  x-cloak x-show="recurrence=='3'">
          <label for="comments" class="font-medium text-gray-900">Occurs on</label>
          <div class="mt-2 space-y-3">
            <div class="flex items-center gap-x-3">
              <input
                id="push-email"
                name="occurs_on"
                type="radio"
                checked="true"
                class="relative size-4 appearance-none rounded-full text-emerald-600 focus:ring-emerald-500 border border-gray-300 bg-white before:absolute before:inset-1 before:rounded-full before:bg-white not-checked:before:hidden checked:border-emerald-600 checked:bg-emerald-600 focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-emerald-600 disabled:border-gray-300 disabled:bg-gray-100 disabled:before:bg-gray-400 forced-colors:appearance-auto forced-colors:before:hidden" />
              <label for="push-email" class="block text-sm/6 font-medium text-gray-500">
                <div class="flex items-center gap-x-2">
                  <span class="text-sm text-gray-500 dark:text-neutral-500">Day</span>
                  <select id="watermark_type" name="watermark_type" class="text-sm text-gray-500 block w-full rounded-md border-0 py-1 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-inset focus:ring-emerald-500 sm:max-w-xs sm:text-sm sm:leading-6">
                    <option value="1" selected>1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                  </select>
                  <span class="text-sm text-gray-500 dark:text-neutral-500 whitespace-nowrap">of the month</span>
                </div>
              </label>
            </div>
          </div>
        </div>
        <div>
          <label for="comments" class="font-medium text-gray-900">End Date</label>
          <div class="mt-2 space-y-3">
            <div class="flex items-center gap-x-3">
              <input
                id="end-no-end"
                name="end_condition"
                type="radio"
                value="no_end"
                x-model="endCondition"
                class="relative size-4 appearance-none rounded-full text-emerald-600 focus:ring-emerald-500 border border-gray-300 bg-white before:absolute before:inset-1 before:rounded-full before:bg-white not-checked:before:hidden checked:border-emerald-600 checked:bg-emerald-600 focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-emerald-600 disabled:border-gray-300 disabled:bg-gray-100 disabled:before:bg-gray-400 forced-colors:appearance-auto forced-colors:before:hidden" />
              <label for="end-no-end" class="block text-sm/6 font-medium text-gray-500">No End Date</label>
            </div>
            <div class="flex items-center gap-x-3">
              <input
                id="end-by-date"
                name="end_condition"
                type="radio"
                value="end_by_date"
                x-model="endCondition"
                class="relative size-4 appearance-none rounded-full text-emerald-600 focus:ring-emerald-500 border border-gray-300 bg-white before:absolute before:inset-1 before:rounded-full before:bg-white not-checked:before:hidden checked:border-emerald-600 checked:bg-emerald-600 focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-emerald-600 disabled:border-gray-300 disabled:bg-gray-100 disabled:before:bg-gray-400 forced-colors:appearance-auto forced-colors:before:hidden" />
              <label for="end-by-date" class="block text-sm/6 font-medium text-gray-500">
                <div class="flex items-center gap-x-2">
                  <span class="text-sm text-gray-500 dark:text-neutral-500">By</span>
                  <div class="flex rounded-md w-28 shadow-sm ring-1 ring-inset ring-gray-300 focus-within:ring-2 focus-within:ring-inset focus-within:ring-emerald-500 sm:max-w-md">
                    <input type="text" name="end_by_date" id="end_date" x-ref="endByDateInput" class="text-sm text-gray-500 block w-full border-0 bg-transparent p-1 placeholder:text-gray-400 focus:ring-0 sm:text-sm sm:leading-6" />
                  </div>
                </div>
              </label>
            </div>
            <div class="flex items-center gap-x-3">
              <input
                id="end-after"
                name="end_condition"
                type="radio"
                value="end_after"
                x-model="endCondition"
                class="relative size-4 appearance-none rounded-full text-emerald-600 focus:ring-emerald-500 border border-gray-300 bg-white before:absolute before:inset-1 before:rounded-full before:bg-white not-checked:before:hidden checked:border-emerald-600 checked:bg-emerald-600 focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-emerald-600 disabled:border-gray-300 disabled:bg-gray-100 disabled:before:bg-gray-400 forced-colors:appearance-auto forced-colors:before:hidden" />
              <label for="end-after" class="block text-sm/6 font-medium text-gray-500">
                <div class="flex items-center gap-x-2">
                  <span class="text-sm text-gray-500 dark:text-neutral-500">After</span>
                  <select id="end_after_count" x-ref="endAfterInput" name="end_after_count" class="text-sm text-gray-500 block w-full rounded-md border-0 py-1 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-inset focus:ring-emerald-500 sm:max-w-xs sm:text-sm sm:leading-6">
                    {% for i in range(1, 60) %}
                      <option value="{{i}}">{{i}}</option>
                    {% endfor %}
                  </select>
                  <span class="text-sm text-gray-500 dark:text-neutral-500">occurrences</span>
                </div>
              </label>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- SECTION 4 - Advanced Options (Collapsible) -->
    <div class="bg-white shadow-sm border border-gray-200 rounded-lg">
      <div class="px-6 py-4 border-b border-gray-200">
        <button type="button" @click="advancedOpen = !advancedOpen" class="flex w-full items-center justify-between text-left">
          <h3 class="text-lg font-medium text-gray-900">Advanced Options</h3>
          <svg :class="{'rotate-180': advancedOpen}" class="h-5 w-5 text-gray-500 transition-transform duration-200" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
          </svg>
        </button>
      </div>
      <div x-show="advancedOpen" x-transition class="px-6 py-6 space-y-6">
        <div class="space-y-4">   
          <div class="flex gap-3">
            <div class="flex h-6 shrink-0 items-center">
              <div class="group grid size-4 grid-cols-1">
                <input
                  id="show_recording"
                  aria-describedby="show_recording-description"
                  name="show_recording"
                  type="checkbox"
                  class="col-start-1 row-start-1 appearance-none rounded-sm text-emerald-600 focus:ring-emerald-500 border border-gray-300 bg-white checked:border-emerald-600 checked:bg-emerald-600 indeterminate:border-emerald-600 indeterminate:bg-emerald-600 focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-emerald-600 disabled:border-gray-300 disabled:bg-gray-100 disabled:checked:bg-gray-100 forced-colors:appearance-auto" />
                <svg class="pointer-events-none col-start-1 row-start-1 size-3.5 self-center justify-self-center stroke-white group-has-disabled:stroke-gray-950/25" viewBox="0 0 14 14" fill="none">
                  <path class="opacity-0 group-has-checked:opacity-100" d="M3 8L6 11L11 3.5" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                  <path class="opacity-0 group-has-indeterminate:opacity-100" d="M3 7H11" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                </svg>
              </div>
            </div>
            <div class="text-sm/6">
              <label for="show_recording" class="font-medium text-gray-900">Show recorded video to users</label>
              <p id="show_recording-description" class="text-gray-500">Allow users to access the recorded video of the meeting after it ends.</p>
            </div>
          </div>
          
          <div class="flex gap-3">
            <div class="flex h-6 shrink-0 items-center">
              <div class="group grid size-4 grid-cols-1">
                <input
                  id="allow_free_preview"
                  aria-describedby="allow_free_preview-description"
                  name="allow_free_preview"
                  type="checkbox"
                  checked
                  class="col-start-1 row-start-1 appearance-none rounded-sm text-emerald-600 focus:ring-emerald-500 border border-gray-300 bg-white checked:border-emerald-600 checked:bg-emerald-600 indeterminate:border-emerald-600 indeterminate:bg-emerald-600 focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-emerald-600 disabled:border-gray-300 disabled:bg-gray-100 disabled:checked:bg-gray-100 forced-colors:appearance-auto" />
                <svg class="pointer-events-none col-start-1 row-start-1 size-3.5 self-center justify-self-center stroke-white group-has-disabled:stroke-gray-950/25" viewBox="0 0 14 14" fill="none">
                  <path class="opacity-0 group-has-checked:opacity-100" d="M3 8L6 11L11 3.5" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                  <path class="opacity-0 group-has-indeterminate:opacity-100" d="M3 7H11" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                </svg>
              </div>
            </div>
            <div class="text-sm/6">
              <label for="allow_free_preview" class="font-medium text-gray-900">Allow free preview</label>
              <p id="allow_free_preview-description" class="text-gray-500">Provide users with a preview of the class content without requiring enrollment.</p>
            </div>
          </div>
          
          <div class="flex gap-3">
            <div class="flex h-6 shrink-0 items-center">
              <div class="group grid size-4 grid-cols-1">
                <input
                  id="bypass_progressive_lock"
                  aria-describedby="bypass_progressive_lock-description"
                  name="bypass_progressive_lock"
                  type="checkbox"
                  class="col-start-1 row-start-1 appearance-none rounded-sm text-emerald-600 focus:ring-emerald-500 border border-gray-300 bg-white checked:border-emerald-600 checked:bg-emerald-600 indeterminate:border-emerald-600 indeterminate:bg-emerald-600 focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-emerald-600 disabled:border-gray-300 disabled:bg-gray-100 disabled:checked:bg-gray-100 forced-colors:appearance-auto" />
                <svg class="pointer-events-none col-start-1 row-start-1 size-3.5 self-center justify-self-center stroke-white group-has-disabled:stroke-gray-950/25" viewBox="0 0 14 14" fill="none">
                  <path class="opacity-0 group-has-checked:opacity-100" d="M3 8L6 11L11 3.5" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                  <path class="opacity-0 group-has-indeterminate:opacity-100" d="M3 7H11" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                </svg>
              </div>
            </div>
            <div class="text-sm/6">
              <label for="bypass_progressive_lock" class="font-medium text-gray-900">Bypass progressive lock</label>
              <p id="bypass_progressive_lock-description" class="text-gray-500">Enabling this will allow user access to the next content irrespective of the progressive lock setting on the course.</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer Actions for Step 1 -->
    <div class="flex items-center justify-end gap-x-4 pt-2">
      <button type="button" class="py-2 px-3 text-nowrap inline-flex justify-center items-center text-start whitespace-nowrap bg-white border border-gray-200 text-gray-800 text-sm font-medium rounded-lg shadow-2xs align-middle hover:bg-gray-50 disabled:opacity-50 disabled:pointer-events-none dark:bg-neutral-800 dark:border-neutral-700 dark:text-neutral-300 dark:hover:bg-neutral-700 dark:focus:bg-neutral-700">
        Cancel
      </button>
      <button type="button" @click="proceedToPreview()" class="py-2 px-3 text-nowrap inline-flex justify-center items-center gap-x-2 text-start whitespace-nowrap bg-emerald-600 border border-emerald-600 text-white text-sm font-medium rounded-lg shadow-2xs align-middle hover:bg-emerald-700 disabled:opacity-50 disabled:pointer-events-none focus:outline-hidden focus:ring-1 focus:ring-red-300 dark:focus:ring-red-500">
        Preview Series
      </button>
    </div>
  </div>

  <!-- Step 2: Preview & Confirm -->
  <div x-show="currentStep === 2" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 transform translate-x-4" x-transition:enter-end="opacity-100 transform translate-x-0" class="space-y-6">
    
    <!-- Class Overview Card -->
    <div class="bg-white shadow-sm border border-gray-200 rounded-lg">
      <div class="px-6 py-4 border-b border-gray-200">
        <h3 class="text-lg font-medium text-gray-900">Class Overview</h3>
      </div>
      <div class="px-6 py-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="space-y-4">
            <div>
              <dt class="text-sm font-medium text-gray-500">Title</dt>
              <dd class="mt-1 text-sm text-gray-900" x-text="formData.title || 'Untitled Class'"></dd>
            </div>
            <div>
              <dt class="text-sm font-medium text-gray-500">Duration</dt>
              <dd class="mt-1 text-sm text-gray-900" x-text="(formData.duration || '60') + ' minutes'"></dd>
            </div>
            <div>
              <dt class="text-sm font-medium text-gray-500">Host</dt>
              <dd class="mt-1 text-sm text-gray-900" x-text="formData.host === 'staff1' ? 'Staff 1' : 'Staff 2'"></dd>
            </div>
          </div>
          <div class="space-y-4">
            <div>
              <dt class="text-sm font-medium text-gray-500">Recurrence Pattern</dt>
              <dd class="mt-1 text-sm text-gray-900" x-text="recurrenceText"></dd>
            </div>
            <div>
              <dt class="text-sm font-medium text-gray-500">Start Date & Time</dt>
              <dd class="mt-1 text-sm text-gray-900" x-text="(formData.startDate || 'Not set') + ' at ' + (formData.startTime || 'Not set')"></dd>
            </div>
            <div x-show="recurrence === '2' && formData.selectedDays && formData.selectedDays.length > 0">
              <dt class="text-sm font-medium text-gray-500">Days of Week</dt>
              <dd class="mt-1 text-sm text-gray-900" x-text="formData.selectedDays ? formData.selectedDays.join(', ') : 'No days selected'"></dd>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Schedule Details Card -->
    <div class="bg-white shadow-sm border border-gray-200 rounded-lg">
      <div class="px-6 py-4 border-b border-gray-200">
        <h3 class="text-lg font-medium text-gray-900">Schedule Details</h3>
      </div>
      <div class="px-6 py-6">
        <div class="space-y-4">
          <div>
            <dt class="text-sm font-medium text-gray-500">End Condition</dt>
            <dd class="mt-1 text-sm text-gray-900" x-text="endConditionText"></dd>
          </div>
        </div>
      </div>
    </div>

    <!-- Upcoming Sessions Card -->
    <div class="bg-white shadow-sm border border-gray-200 rounded-lg">
      <div class="px-6 py-4 border-b border-gray-200">
        <div class="flex items-center justify-between">
          <div>
            <h3 class="text-lg font-medium text-gray-900">Upcoming Sessions Preview</h3>
            <p class="mt-1 text-sm text-gray-500" x-text="sessionPreview.length > 0 ? `Showing ${Math.min(sessionPreview.length, 14)} session${sessionPreview.length !== 1 ? 's' : ''} based on your schedule` : 'Configure your schedule to see sessions'"></p>
          </div>
          <div class="text-right">
            <div class="text-sm font-medium text-gray-900" x-text="sessionPreview.length + (sessionPreview.length === 14 && (endCondition === 'no_end' || (endCondition === 'end_after' && parseInt(activeFormData.endAfterValue || '0') > 14)) ? '+' : '')"></div>
            <div class="text-xs text-gray-500">
              <span x-show="sessionPreview.length === 14 && endCondition === 'no_end'">More sessions are scheduled ... </span>
              <span x-show="sessionPreview.length === 14 && endCondition === 'end_after' && parseInt(activeFormData.endAfterValue || '0') > 14">+ <span x-text="parseInt(activeFormData.endAfterValue || '0') - 14"></span> more sessions are scheduled</span>
              <span x-show="sessionPreview.length < 14 || endCondition === 'end_by_date'">Total sessions</span>
            </div>
          </div>
        </div>
      </div>
      <div class="px-6 py-6">
        <div x-show="sessionPreview.length > 0" class="space-y-3">
          <template x-for="session in sessionPreview" :key="session.number">
            <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg border transition-colors">
              <div class="flex items-center space-x-4">
                <div class="flex-shrink-0">
                  <div class="w-8 h-8 bg-emerald-100 text-emerald-600 rounded-full flex items-center justify-center text-sm font-medium" x-text="session.number"></div>
                </div>
                <div>
                  <p class="text-sm font-medium text-gray-900" x-text="session.title || 'Session ' + session.number"></p>
                  <p class="text-sm text-gray-500" x-text="session.date"></p>
                </div>
              </div>
              <div class="text-right">
                <div class="text-sm text-gray-500" x-text="session.time"></div>
                <div class="text-xs text-gray-400" x-text="(formData.duration || '60') + ' min'"></div>
              </div>
            </div>
          </template>
        </div>
        
        <!-- Empty state -->
        <div x-show="sessionPreview.length === 0" class="text-center py-8">
          <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
          </svg>
          <h3 class="mt-2 text-sm font-medium text-gray-900">No sessions to display</h3>
          <p class="mt-1 text-sm text-gray-500">Complete the form to see your session preview</p>
        </div>
        
        <!-- Warning for end date conflicts -->
        <div x-show="endCondition === 'end_by_date' && activeFormData.endByDateValue && sessionPreview.length === 0" class="mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
          <div class="flex">
            <div class="flex-shrink-0">
              <svg class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
              </svg>
            </div>
            <div class="ml-3">
              <h3 class="text-sm font-medium text-yellow-800">No sessions within date range</h3>
              <p class="mt-1 text-sm text-yellow-700">The selected end date may be too early. Please check your start date, end date, and recurrence pattern.</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Navigation Actions for Step 2 -->
    <div class="flex items-end justify-end gap-x-4 pt-2">
      <button type="button" @click="goBackToForm()" class="py-2 px-3 text-nowrap inline-flex justify-center items-center text-start whitespace-nowrap bg-white border border-gray-200 text-gray-800 text-sm font-medium rounded-lg shadow-2xs align-middle hover:bg-gray-50 disabled:opacity-50 disabled:pointer-events-none dark:bg-neutral-800 dark:border-neutral-700 dark:text-neutral-300 dark:hover:bg-neutral-700 dark:focus:bg-neutral-700">
        ‚Üê Go Back & Edit
      </button>
      <button type="submit" class="py-2 px-3 text-nowrap inline-flex justify-center items-center gap-x-2 text-start whitespace-nowrap bg-emerald-600 border border-emerald-600 text-white text-sm font-medium rounded-lg shadow-2xs align-middle hover:bg-emerald-700 disabled:opacity-50 disabled:pointer-events-none focus:outline-hidden focus:ring-1 focus:ring-red-300 dark:focus:ring-red-500">
        Confirm & Create Series
      </button>
    </div>
  </div>
</form>