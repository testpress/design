<script>
  function reportBuilder() {
    const generateId = () => self.crypto.randomUUID();

    const defaultGroup = (title) => ({
      id: generateId(),
      title,
      description: '',
      maximum_marks: '',
      minimum_marks: '',
      rounding_precision: 1,
      show_average: true,
      show_total: true,
      items: []
    });

    const defaultSection = (title, type = 'scholastic') => ({
      id: generateId(),
      title,
      description: '',
      section_type: type,
      show_total_score: true,
      groups: [defaultGroup('English'), defaultGroup('Math')]
    });

    const moveInArray = (arr, index, direction) => {
      const target = index + direction;
      if (target >= 0 && target < arr.length) {
        [arr[index], arr[target]] = [arr[target], arr[index]];
      }
      return arr;
    };

    return {
      report: {
        title: 'SAT Progress Report',
        description: 'Auto-computed projection using weekly practice exams.',
        course: 'SAT Foundation',
        state: 'draft',
        remarks_enabled: true
      },
      sections: [defaultSection('SAT Projection')],
      selectedSectionId: null,
      selectedGroupId: null,

      sectionModal: { mode: 'create', editingId: null, form: {} },
      groupModal:   { mode: 'create', editingId: null, sectionId: null, form: {} },
      itemModal:    { mode: 'create', editingId: null, groupId: null, form: {} },
      confirmationModal: { title: '', message: '', action: null },

      init() {
        if (this.sections.length > 0) {
          this.selectedSectionId = this.sections[0].id;
          if (this.sections[0].groups.length > 0) {
            this.selectedGroupId = this.sections[0].groups[0].id;
          }
        }
      },

      get activeSection() {
        return this.sections.find(s => s.id === this.selectedSectionId) || null;
      },

      get activeGroupList() {
        return this.activeSection ? this.activeSection.groups : [];
      },

      get activeGroup() {
        return this.activeGroupList.find(g => g.id === this.selectedGroupId) || null;
      },

      selectSection(id) {
        this.selectedSectionId = id;
        const section = this.sections.find(s => s.id === id);
        this.selectedGroupId = (section && section.groups.length > 0) ? section.groups[0].id : null;
      },

      addSection() {
        const section = defaultSection('New Section', 'scholastic');
        this.sections.push(section);
        this.selectSection(section.id);
      },

      moveSection(index, direction) {
        this.sections = moveInArray([...this.sections], index, direction);
      },

      deleteSection(index) {
        this.openConfirmationModal(
          'Delete Section',
          'Are you sure you want to delete this section? This action cannot be undone.',
          () => {
            this.sections.splice(index, 1);
            if (this.sections.length > 0) {
              this.selectSection(this.sections[0].id);
            } else {
              this.selectedSectionId = null;
              this.selectedGroupId = null;
            }
          }
        );
      },

      moveGroup(sectionId, index, direction) {
        const section = this.sections.find(s => s.id === sectionId);
        if (section) moveInArray(section.groups, index, direction);
      },

      deleteGroup(sectionId, index) {
        const section = this.sections.find(s => s.id === sectionId);
        if (!section) return;

        this.openConfirmationModal(
          'Delete Group',
          'Are you sure you want to delete this group?',
          () => {
             section.groups.splice(index, 1);
             if (!section.groups.find(g => g.id === this.selectedGroupId)) {
               this.selectedGroupId = section.groups.length ? section.groups[0].id : null;
             }
          }
        );
      },

      moveItem(index, direction) {
        if (this.activeGroup) moveInArray(this.activeGroup.items, index, direction);
      },

      removeItem(index) {
        if (!this.activeGroup) return;

        this.openConfirmationModal(
          'Remove Item',
          'Are you sure you want to remove this item?',
          () => {
            this.activeGroup.items.splice(index, 1);
          }
        );
      },

      saveDraft() {
        console.log('Draft saved', this.report, this.sections);
      },

      publish() {
        console.log('Published', this.report, this.sections);
      },

      openSectionModal(id = null) {
        this.sectionModal.mode = id ? 'edit' : 'create';
        this.sectionModal.editingId = id;
        
        const defaults = { title: '', description: '', section_type: 'scholastic', show_total_score: true };
        
        if (id) {
          const section = this.sections.find(s => s.id === id);
          this.sectionModal.form = section ? { ...section } : defaults;
        } else {
          this.sectionModal.form = defaults;
        }
      },

      saveSectionModal() {
        if (this.sectionModal.mode === 'edit') {
          const section = this.sections.find(s => s.id === this.sectionModal.editingId);
          if (section) Object.assign(section, this.sectionModal.form);
        } else {
          const newSection = {
            id: generateId(),
            ...this.sectionModal.form,
            title: this.sectionModal.form.title || 'Untitled section',
            groups: []
          };
          this.sections.push(newSection);
          this.selectSection(newSection.id);
        }
        this.$nextTick(() => window.HSDropdown?.autoInit());
      },

      openGroupModal(sectionId, groupId = null) {
        this.groupModal.sectionId = sectionId;
        this.groupModal.mode = groupId ? 'edit' : 'create';
        this.groupModal.editingId = groupId;

        const defaults = { 
          title: '', description: '', maximum_marks: '', minimum_marks: '', 
          rounding_precision: 1, show_average: true, show_total: true 
        };

        if (groupId) {
          const group = this.sections.find(s => s.id === sectionId)?.groups.find(g => g.id === groupId);
          this.groupModal.form = group ? { ...group } : defaults;
        } else {
          this.groupModal.form = defaults;
        }
      },

      saveGroupModal() {
        const section = this.sections.find(s => s.id === this.groupModal.sectionId);
        if (!section) return;

        if (this.groupModal.mode === 'edit') {
          const group = section.groups.find(g => g.id === this.groupModal.editingId);
          if (group) Object.assign(group, this.groupModal.form);
        } else {
          const newGroup = {
            id: generateId(),
            ...this.groupModal.form,
            title: this.groupModal.form.title || 'Untitled group',
            items: []
          };
          section.groups.push(newGroup);
          this.selectedGroupId = newGroup.id;
        }
        this.$nextTick(() => window.HSDropdown?.autoInit());
      },

      openItemModal(itemId = null) {
        if (!this.activeGroup) return;
        this.itemModal.groupId = this.activeGroup.id;
        this.itemModal.mode = itemId ? 'edit' : 'create';
        this.itemModal.editingId = itemId;

        const defaults = {
          item_type: 'scholastic',
          content_type: 'exam',
          exam: [],
          exam_section: '', 
          chapter_content: [],
          title: '',
          scoring_type: 'grade',
          maximum_marks: '',
          total_classes: '',
          remarks_enabled: false
        };

        if (itemId) {
          const item = this.activeGroup.items.find(i => i.id === itemId);
          this.itemModal.form = item ? JSON.parse(JSON.stringify(item)) : defaults;
        } else {
          this.itemModal.form = defaults;
        }
        this.$nextTick(() => window.HSDropdown?.autoInit());
      },

      saveItemModal() {
        if (!this.activeGroup) return;

        const form = this.itemModal.form;
        
        if (this.itemModal.mode === 'create' && form.item_type === 'scholastic') {
            let itemsToCreate = [];

            if (form.content_type === 'exam' && Array.isArray(form.exam) && form.exam.length > 0) {
               form.exam.forEach(ex => {
                   itemsToCreate.push({ ...form, exam: ex, title: 'Exam ' + ex }); // Mock title logic
               });
            } else if (form.content_type === 'chapter_content' && Array.isArray(form.chapter_content) && form.chapter_content.length > 0) {
               form.chapter_content.forEach(cc => {
                   itemsToCreate.push({ ...form, chapter_content: cc, title: 'Content ' + cc });
               });
            } else {
               itemsToCreate.push({ ...form, title: form.title || 'New Item' });
            }

            itemsToCreate.forEach(newItem => {
                this.activeGroup.items.push({
                    id: generateId(),
                    ...newItem
                });
            });

        } else {
            if (this.itemModal.mode === 'edit') {
              const item = this.activeGroup.items.find(i => i.id === this.itemModal.editingId);
              if (item) Object.assign(item, form);
            } else {
              this.activeGroup.items.push({
                id: generateId(),
                ...form,
                title: form.title || 'New Item'
              });
            }
        }
        this.$nextTick(() => window.HSDropdown?.autoInit());
      },

      openConfirmationModal(title, message, action) {
        this.confirmationModal.title = title;
        this.confirmationModal.message = message;
        this.confirmationModal.action = action;
        window.HSOverlay?.open('#confirmation-modal');
      },

      confirmAction() {
        if (this.confirmationModal.action) {
          this.confirmationModal.action();
        }
        this.confirmationModal.action = null; 
      }
    };
  }
</script>