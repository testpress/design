<div data-hs-stepper-content-item='{
  "index": 3
}' style="display: none;">
  <div class="">
    <h2 class="text-base/7 font-semibold text-gray-900">Submission & Grading Settings</h2>
    <p class="mt-1 text-sm/6 text-gray-600">Configure grading type, maximum marks, and rubric or marking guide settings.</p>

    <div class="space-y-5 mt-5">
      <!-- Maximum Marks -->
      <div class="space-y-2">
        <label for="max-marks" class="block text-sm font-medium text-gray-800">Maximum Marks</label>
        <input id="max-marks" type="number" class="w-full py-2 px-3 border border-gray-300 rounded-lg text-sm focus:ring-emerald-600 focus:border-emerald-600">
      </div>

      <!-- Grading Type Selection -->
      <div class="space-y-2">
        <label class="block text-sm font-medium text-gray-800">Grading Type</label>
        <div class="grid grid-cols-2 gap-3">
          <label class="p-4 flex cursor-pointer items-center border border-gray-200 rounded-lg hover:bg-gray-50 has-[:checked]:ring-2 has-[:checked]:ring-emerald-600">
            <input type="radio" name="grading-type" value="marks" class="hidden">
            <div class="grow">
              <span class="block font-medium text-gray-800">Marks</span>
              <span class="block text-sm text-gray-600">Numeric grading out of max marks.</span>
            </div>
          </label>
          <label class="p-4 flex cursor-pointer items-center border border-gray-200 rounded-lg hover:bg-gray-50 has-[:checked]:ring-2 has-[:checked]:ring-emerald-600">
            <input type="radio" name="grading-type" value="letter" class="hidden">
            <div class="grow">
              <span class="block font-medium text-gray-800">Letter Grades</span>
              <span class="block text-sm text-gray-600">Assign letter grades like A, B, C, etc.</span>
            </div>
          </label>
          <label class="p-4 flex cursor-pointer items-center border border-gray-200 rounded-lg hover:bg-gray-50 has-[:checked]:ring-2 has-[:checked]:ring-emerald-600">
            <input type="radio" name="grading-type" value="pass-fail" class="hidden">
            <div class="grow">
              <span class="block font-medium text-gray-800">Pass/Fail</span>
              <span class="block text-sm text-gray-600">Simple pass or fail grading.</span>
            </div>
          </label>
          <label class="p-4 flex cursor-pointer items-center border border-gray-200 rounded-lg hover:bg-gray-50 has-[:checked]:ring-2 has-[:checked]:ring-emerald-600" onclick="openRubricModal()">
            <input type="radio" name="grading-type" value="rubric" class="hidden">
            <div class="grow">
              <span class="block font-medium text-gray-800">Rubric</span>
              <span class="block text-sm text-gray-600">Use predefined scoring levels per criterion.</span>
            </div>
          </label>
          <label class="p-4 flex cursor-pointer items-center border border-gray-200 rounded-lg hover:bg-gray-50 has-[:checked]:ring-2 has-[:checked]:ring-emerald-600">
            <input type="radio" name="grading-type" value="marking-guide" class="hidden">
            <div class="grow">
              <span class="block font-medium text-gray-800">Marking Guide</span>
              <span class="block text-sm text-gray-600">Assign scores within a range per criterion.</span>
            </div>
          </label>
        </div>
      </div>

      <!-- Additional Grading Settings -->
      <div class="space-y-2">
        <label class="block text-sm font-medium text-gray-800">Visibility Settings</label>
        <div class="space-y-3">
          <div class="flex items-start space-x-3">
            <input type="checkbox" id="show-rubric-desc" class="rounded border-gray-300 text-emerald-600 focus:ring-emerald-600">
            <label for="show-rubric-desc" class="text-sm text-gray-700">Show rubric level descriptions to students</label>
          </div>
          <div class="flex items-start space-x-3">
            <input type="checkbox" id="show-rubric-score" class="rounded border-gray-300 text-emerald-600 focus:ring-emerald-600">
            <label for="show-rubric-score" class="text-sm text-gray-700">Show rubric level scores to students</label>
          </div>
          <div class="flex items-start space-x-3">
            <input type="checkbox" id="show-marking-guide-max" class="rounded border-gray-300 text-emerald-600 focus:ring-emerald-600">
            <label for="show-marking-guide-max" class="text-sm text-gray-700">Show marking guide max scores to students</label>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Rubric Creation Modal -->
<div id="rubric-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center">
  <div class="bg-white p-6 rounded-lg w-1/2 shadow-lg">
    <div class="flex justify-between items-center">
      <h2 class="text-lg font-semibold text-gray-900">Create New Rubric</h2>
      <button type="button" class="text-gray-500 hover:text-gray-700" onclick="closeRubricModal()">✕</button>
    </div>
    <p class="text-sm text-gray-600 mt-1">Define criteria and grading levels.</p>

    <!-- Rubric Name -->
    <div class="mt-4">
      <label class="block text-sm font-medium text-gray-800">Rubric Name</label>
      <input type="text" id="rubric-name" class="w-full mt-1 border border-gray-300 rounded-lg p-2 focus:ring-emerald-600 focus:border-emerald-600">
    </div>

    <!-- Criteria List -->
    <div class="mt-4">
      <label class="block text-sm font-medium text-gray-800">Criteria</label>
      <div id="criteria-container">
        <!-- Default criterion will be added dynamically -->
      </div>
      <button type="button" class="mt-2 text-sm text-emerald-600 hover:text-emerald-700" onclick="addCriterion()">+ Add Criterion</button>
    </div>

    <!-- Save & Close -->
    <div class="mt-6 flex justify-end gap-2">
      <button type="button" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300" onclick="closeRubricModal()">Cancel</button>
      <button type="button" class="px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700" onclick="saveRubric()">Save Rubric</button>
    </div>
  </div>
</div>

<script>
let criteriaCount = 0;
let rubricData = {
  name: "",
  criteria: []
};

function openRubricModal() {
  document.getElementById("rubric-modal").classList.remove("hidden");
  document.getElementById("criteria-container").innerHTML = ""; // Reset UI
  criteriaCount = 0;
  addCriterion(); // Always start with one criterion
}

function closeRubricModal() {
  document.getElementById("rubric-modal").classList.add("hidden");
}

// Add a new criterion
function addCriterion() {
  criteriaCount++;
  const criteriaContainer = document.getElementById("criteria-container");

  const criterionHTML = `
    <div class="mt-3 p-3 border border-gray-300 rounded-lg bg-gray-50 relative flex flex-col" id="criterion-${criteriaCount}">
      <div class="flex justify-between items-center">
        <label class="text-sm font-medium text-gray-800">Criterion ${criteriaCount}</label>
        <button type="button" class="text-red-500 hover:text-red-700" onclick="removeCriterion(${criteriaCount})">✕</button>
      </div>
      <div class="grid grid-cols-2 gap-3 mt-2">
        <input type="text" placeholder="Criterion Name" class="p-2 border rounded-lg criterion-name">
        <input type="number" placeholder="Max Score" class="p-2 border rounded-lg criterion-score">
      </div>
      <div class="mt-2">
        <label class="block text-sm font-medium text-gray-800">Grading Levels</label>
        <div id="levels-container-${criteriaCount}">
          ${addGradingLevelHTML(criteriaCount)}
        </div>
        <button type="button" class="mt-2 text-sm text-emerald-600 hover:text-emerald-700" onclick="addGradingLevel(${criteriaCount})">+ Add Level</button>
      </div>
    </div>
  `;

  criteriaContainer.insertAdjacentHTML("beforeend", criterionHTML);
}

// Remove a criterion and adjust count properly
function removeCriterion(criterionId) {
  document.getElementById(`criterion-${criterionId}`).remove();

  // Recalculate count by checking the number of criteria present
  criteriaCount = document.querySelectorAll("#criteria-container > div").length;

  // If no criteria left, add one automatically
  if (criteriaCount === 0) {
    criteriaCount = 0;
    addCriterion();
  }
}

// Generate grading level HTML
function addGradingLevelHTML(criterionId) {
  const levelId = `level-${criterionId}-${Date.now()}`;
  return `
    <div class="grid grid-cols-3 gap-3 mt-2 items-center relative p-2 border border-gray-200 rounded-lg" id="${levelId}">
      <input type="text" placeholder="Level (e.g., Excellent)" class="p-2 border rounded-lg level-name">
      <input type="number" placeholder="Score (e.g., 15)" class="p-2 border rounded-lg level-score">
      <input type="text" placeholder="Description" class="p-2 border rounded-lg level-description">
      <button type="button" class="absolute -top-3 -right-3 size-5 flex items-center justify-center bg-red-500 text-white rounded-full text-xs hover:bg-red-600" onclick="removeLevel('${levelId}')">✕</button>
    </div>
  `;
}

// Add a grading level dynamically
function addGradingLevel(criterionId) {
  const levelsContainer = document.getElementById(`levels-container-${criterionId}`);
  levelsContainer.insertAdjacentHTML("beforeend", addGradingLevelHTML(criterionId));
}

// Remove a grading level
function removeLevel(levelId) {
  document.getElementById(levelId).remove();
}

// Save rubric function
function saveRubric() {
  rubricData.name = document.getElementById("rubric-name").value;
  rubricData.criteria = [];

  document.querySelectorAll("#criteria-container > div").forEach((criterionDiv) => {
    let criterion = {
      name: criterionDiv.querySelector(".criterion-name").value,
      maxScore: criterionDiv.querySelector(".criterion-score").value,
      levels: []
    };

    criterionDiv.querySelectorAll(".grid-cols-3").forEach(levelDiv => {
      let level = {
        title: levelDiv.querySelector(".level-name").value,
        score: levelDiv.querySelector(".level-score").value,
        description: levelDiv.querySelector(".level-description").value
      };
      criterion.levels.push(level);
    });

    rubricData.criteria.push(criterion);
  });

  console.log("Rubric Saved:", rubricData);
  closeRubricModal();
}
</script>
