---
view: Purchase Request Detail
tags: testpress
title: Purchase Request Detail
permalink: testpress/admin/purchase_requests/detail/
date: 2025-01-20
---

{% extends "layouts/admin_base.html" %}
{% block body_class %}overflow-y-scroll min-h-screen bg-gray-100{% endblock %}
{% block content %}
<div x-data="purchaseRequestDetail()" class="py-10 max-w-7xl mx-auto lg:px-8 px-4">
  {% include "./header.html" %}

  <!-- Two Column Layout -->
  <div class="grid grid-cols-1 lg:grid-cols-5 gap-5">
    <!-- Left Column - Scrollable Content (60%) -->
    <div class="lg:col-span-3 space-y-4">
      <!-- Placeholder for left column content -->
      {% include "./user_detail.html" %}
      {% include "./purchasing_product.html" %}
      {% include "./additional_information.html" %}
    </div>
    <!-- End Left Column -->

    <!-- Right Column - Sticky Sidebar (40%) -->
    <div class="lg:col-span-2">
      <div class="lg:sticky lg:top-20 space-y-4">
        {% include "./review_action_card.html" %}
        {% include "./review_info.html" %}
        {% include "./submission_history_card.html" %}
      </div>
    </div>
    <!-- End Right Column -->
  </div>
  <!-- End Two Column Layout -->

  <!-- Modals -->
  {% include "./approve_confirmation_modal.html" %}
  {% include "./reject_confirmation_modal.html" %}
</div>
{% endblock %}

{% block script %}
<script>
  function purchaseRequestDetail() {
    return {
      request: null,
      requestId: null,
      status: 'pending', // 'pending', 'approved', 'rejected'
      allRequests: [],
      currentIndex: 0,
      selectedRequest: null,
      approvalNotes: '',
      rejectionNotes: '',

      init() {
        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        this.requestId = urlParams.get('id');
        this.status = urlParams.get('status') || 'pending';

        // Load requests
        this.loadRequests();

        // Find and set current request
        if (this.requestId) {
          this.findRequestById(this.requestId);
        } else if (this.allRequests.length > 0) {
          this.request = this.allRequests[0];
          this.updateCurrentIndex();
        }
      },

      loadRequests() {
        // Sample data - in production, this would come from an API
        const now = new Date();
        const twoDaysAgo = new Date(now.getTime() - 2 * 24 * 60 * 60 * 1000);
        const oneDayAgo = new Date(now.getTime() - 1 * 24 * 60 * 60 * 1000);

        this.allRequests = [
          {
            id: 1,
            request_id: 'REQ-001234',
            status: 'pending',
            user_name: 'John Doe',
            product: 'Advanced Course Package',
            submitted_at: twoDaysAgo.toISOString(),
            submission_history: [
              {
                status: 'submitted',
                user_name: 'John Doe',
                date: twoDaysAgo.toISOString()
              }
            ]
          },
          {
            id: 2,
            request_id: 'REQ-001235',
            status: 'approved',
            user_name: 'Jane Smith',
            product: 'Basic Course',
            submitted_at: oneDayAgo.toISOString(),
            approved_by: 'Admin User',
            approved_at: new Date(oneDayAgo.getTime() + 2 * 60 * 60 * 1000).toISOString(),
            approval_notes: 'All requirements met',
            submission_history: [
              {
                status: 'submitted',
                user_name: 'Jane Smith',
                date: oneDayAgo.toISOString()
              },
              {
                status: 'approved',
                reviewer: 'Admin User',
                date: new Date(oneDayAgo.getTime() + 2 * 60 * 60 * 1000).toISOString()
              }
            ]
          },
          {
            id: 3,
            request_id: 'REQ-001236',
            status: 'rejected',
            user_name: 'Bob Johnson',
            product: 'Premium Package',
            submitted_at: new Date(now.getTime() - 3 * 24 * 60 * 60 * 1000).toISOString(),
            rejected_by: 'Admin User',
            rejected_at: new Date(now.getTime() - 2 * 24 * 60 * 60 * 1000).toISOString(),
            rejection_reason: 'Missing required documents',
            submission_history: [
              {
                status: 'submitted',
                user_name: 'Bob Johnson',
                date: new Date(now.getTime() - 3 * 24 * 60 * 60 * 1000).toISOString()
              },
              {
                status: 'rejected',
                reviewer: 'Admin User',
                date: new Date(now.getTime() - 2 * 24 * 60 * 60 * 1000).toISOString(),
                reason: 'Missing required documents'
              }
            ]
          }
        ];

        // Ensure all requests have at least one submission history entry
        this.allRequests.forEach(request => {
          if (!request.submission_history || request.submission_history.length === 0) {
            request.submission_history = [
              {
                status: 'submitted',
                user_name: request.user_name || 'User',
                date: request.submitted_at || new Date().toISOString()
              }
            ];
          }
        });

        // Filter by status if provided
        if (this.status && this.status !== 'all') {
          this.allRequests = this.allRequests.filter(r => r.status === this.status);
        }
      },

      findRequestById(id) {
        const found = this.allRequests.find(r => r.request_id === id);
        if (found) {
          this.request = found;
          // Ensure request has at least one submission history entry
          if (!this.request.submission_history || this.request.submission_history.length === 0) {
            this.request.submission_history = [
              {
                status: 'submitted',
                user_name: this.request.user_name || 'User',
                date: this.request.submitted_at || new Date().toISOString()
              }
            ];
          }
          this.updateCurrentIndex();
        }
      },

      updateCurrentIndex() {
        if (this.request) {
          this.currentIndex = this.allRequests.findIndex(r => r.request_id === this.request.request_id);
          if (this.currentIndex === -1) this.currentIndex = 0;
        }
      },

      hasPrevious() {
        return this.currentIndex > 0;
      },

      hasNext() {
        return this.currentIndex < this.allRequests.length - 1;
      },

      navigateToPrevious() {
        if (this.currentIndex > 0) {
          this.currentIndex--;
          this.request = this.allRequests[this.currentIndex];
          this.updateUrl();
        }
      },

      navigateToNext() {
        if (this.currentIndex < this.allRequests.length - 1) {
          this.currentIndex++;
          this.request = this.allRequests[this.currentIndex];
          this.updateUrl();
        }
      },

      updateUrl() {
        if (this.request) {
          const newUrl = `/testpress/admin/purchase_requests/detail/?id=${this.request.request_id}&status=${this.request.status}`;
          window.history.pushState({}, '', newUrl);
          this.requestId = this.request.request_id;
          this.status = this.request.status;
        }
      },

      openApproveConfirmationModal() {
        if (this.request && this.request.status === 'pending') {
          this.selectedRequest = { ...this.request };
          window.HSOverlay?.open('#approve-confirmation-modal');
        }
      },

      openRejectConfirmationModal() {
        if (this.request && this.request.status === 'pending') {
          this.selectedRequest = { ...this.request };
          this.rejectionNotes = '';
          window.HSOverlay?.open('#reject-confirmation-modal');
        }
      },

      confirmApprove() {
        if (!this.selectedRequest || this.selectedRequest.status !== 'pending') return;

        // Update request status
        if (this.request && this.request.request_id === this.selectedRequest.request_id) {
          const now = new Date().toISOString();
          this.request.status = 'approved';
          this.request.approval_notes = this.approvalNotes;
          this.request.approved_by = 'Current User';
          this.request.approved_at = now;
          this.status = 'approved';

          // Add to submission history
          if (!this.request.submission_history) {
            this.request.submission_history = [];
          }
          this.request.submission_history.push({
            status: 'approved',
            reviewer: 'Current User',
            date: now
          });
        }

        // Close modal and reset
        this.selectedRequest = null;
        this.approvalNotes = '';
        window.HSOverlay?.close('#approve-confirmation-modal');

        // Navigate to next request
        setTimeout(() => {
          if (this.hasNext()) {
            this.navigateToNext();
          }
        }, 500);
      },

      confirmReject() {
        if (!this.selectedRequest || this.selectedRequest.status !== 'pending') return;
        if (!this.rejectionNotes || !this.rejectionNotes.trim()) return;

        // Update request status
        if (this.request && this.request.request_id === this.selectedRequest.request_id) {
          const now = new Date().toISOString();
          this.request.status = 'rejected';
          this.request.rejection_reason = this.rejectionNotes;
          this.request.rejected_by = 'Current User';
          this.request.rejected_at = now;
          this.status = 'rejected';

          // Add to submission history
          if (!this.request.submission_history) {
            this.request.submission_history = [];
          }
          this.request.submission_history.push({
            status: 'rejected',
            reviewer: 'Current User',
            date: now,
            reason: this.rejectionNotes
          });
        }

        // Close modal and reset
        this.selectedRequest = null;
        this.rejectionNotes = '';
        window.HSOverlay?.close('#reject-confirmation-modal');

        // Navigate to next request
        setTimeout(() => {
          if (this.hasNext()) {
            this.navigateToNext();
          }
        }, 500);
      },

      clearSelectedRequest() {
        this.selectedRequest = null;
        this.approvalNotes = '';
        this.rejectionNotes = '';
      },

      formatDate(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        const month = months[date.getMonth()];
        const day = date.getDate();
        const year = date.getFullYear();
        return `${month} ${day}, ${year}`;
      },

      formatTime(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        const hours = date.getHours().toString().padStart(2, '0');
        const minutes = date.getMinutes().toString().padStart(2, '0');
        return `${hours}:${minutes}`;
      },

      getTimeElapsed(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);

        if (diffMins < 1) return 'Just now';
        if (diffMins < 60) return `${diffMins} minute${diffMins !== 1 ? 's' : ''} ago`;
        if (diffHours < 24) return `${diffHours} hour${diffHours !== 1 ? 's' : ''} ago`;
        if (diffDays < 7) return `${diffDays} day${diffDays !== 1 ? 's' : ''} ago`;
        return this.formatDate(dateString);
      },

      getRelativeTime(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);

        if (diffMins < 1) return 'Just now';
        if (diffMins < 60) return `${diffMins}m ago`;
        if (diffHours < 24) return `${diffHours}h ago`;
        if (diffDays < 7) return `${diffDays}d ago`;
        return this.formatDate(dateString);
      }
    };
  }
</script>
<script src="https://preline.co/assets/vendor/clipboard/dist/clipboard.min.js"></script>
<script src="https://preline.co/assets/js/hs-copy-clipboard-helper.js"></script>
{% endblock script %}