---
view: Purchase Request Review
tags: testpress
title: Purchase Request Review
permalink: testpress/admin/purchase_requests/
date: 2025-01-20
---

{% extends "layouts/admin_base.html" %}
{% block body_class %}overflow-y-scroll min-h-screen bg-gray-100{% endblock %}
{% block content %}
<div x-data="purchaseRequestReview()" class="py-10 max-w-7xl mx-auto lg:px-8 px-4 ">
  {% include "./header.html" %}
  <div class="p-5 mt-5 space-y-4 flex flex-col bg-white border border-gray-200 shadow-sm rounded-xl">
    {% include "./navigation_tabs.html" %}
    {% include "./filters.html" %}
    <div>
      <div x-show="activeTab === 'pending'">
        {% include "./pending_requests_content.html" %}
      </div>
      <div x-show="activeTab === 'approved'">
        {% include "./approved_rejected_content.html" %}
      </div>
    </div>
  </div>
  <!-- End Filter Group -->
  {% include "./filter_sidebar.html" %}
  {% include "./approve_modal.html" %}
  {% include "./reject_modal.html" %}
  {% include "./custom_fields_modal.html" %}
  {% include "./bulk_approve_modal.html" %}
  {% include "./bulk_reject_modal.html" %}
</div>
{% endblock %}

{% block script %}
<script>
  function purchaseRequestReview() {
    return {
      requests: [
        {
          id: 1,
          request_id: 'REQ-001234',
          user_name: 'John Doe',
          user_email: 'john.doe@example.com',
          user_phone: '+91 98765 43210',
          user_id: 'USR001',
          registration_date: 'Jan 15, 2025',
          location: 'Mumbai',
          cohort: 'Cohort A',
          status: 'pending',
          submitted_at: '2025-01-20T10:30:00',
          submitted_date: 'Jan 20, 2025',
          course_name: 'E-Course on AvSec Awareness',
          course_type: 'Mandatory',
          product: 'E-Course on AvSec Awareness',
          submission_type: 'first-time',
          avatar: 'https://images.unsplash.com/photo-1568602471122-7832951cc4c5?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=facearea&facepad=2&w=300&h=300&q=80',
          custom_fields: [
            { title: 'Organization Name', response: 'ABC Corporation', type: 'text' },
            { title: 'Department', response: 'Aviation Security', type: 'text' },
            { title: 'Employee ID', response: 'EMP12345', type: 'text' }
          ],
          approval_history: [],
          is_resubmission: false,
          rejection_reason: null
        },
        {
          id: 2,
          request_id: 'REQ-001235',
          user_name: 'Jane Smith',
          user_email: 'jane.smith@example.com',
          user_phone: '+91 98765 43211',
          user_id: 'USR002',
          registration_date: 'Jan 10, 2025',
          location: 'Delhi',
          cohort: 'Cohort B',
          status: 'pending',
          submitted_at: '2025-01-19T14:20:00',
          submitted_date: 'Jan 19, 2025',
          course_name: 'E-Course on AvSec Awareness',
          course_type: 'Mandatory',
          product: 'E-Course on AvSec Awareness',
          submission_type: 'first-time',
          avatar: 'https://images.unsplash.com/photo-1541101767792-f9b2b1c4f127?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=facearea&facepad=3&w=300&h=300&q=80',
          custom_fields: [
            { title: 'Organization Name', response: 'XYZ Airlines', type: 'text' },
            { title: 'Department', response: 'Ground Operations', type: 'text' },
            { title: 'Supporting Documents', response: [{ file_name: 'document.pdf', url: '#' }], type: 'file' }
          ],
          approval_history: [],
          is_resubmission: false,
          rejection_reason: null
        },
        {
          id: 3,
          request_id: 'REQ-001236',
          user_name: 'Robert Johnson',
          user_email: 'robert.j@example.com',
          user_phone: '+91 98765 43212',
          user_id: 'USR003',
          registration_date: 'Dec 20, 2024',
          location: 'Bangalore',
          cohort: 'Cohort C',
          status: 'pending',
          submitted_at: '2025-01-18T09:15:00',
          submitted_date: 'Jan 18, 2025',
          course_name: 'Introduction to Airport Firefighting and Rescue Vehicles',
          course_type: 'Optional',
          product: 'Introduction to Airport Firefighting and Rescue Vehicles',
          submission_type: 'resubmission',
          avatar: null,
          custom_fields: [
            { title: 'Organization Name', response: 'DEF Services', type: 'text' },
            { title: 'Department', response: 'Maintenance', type: 'text' }
          ],
          approval_history: [
            {
              status: 'rejected',
              reviewer: 'Admin User',
              date: 'Jan 10, 2025',
              notes: 'Missing required documentation. Please resubmit with complete employee verification.'
            }
          ],
          is_resubmission: true,
          rejection_reason: null
        },
        {
          id: 4,
          request_id: 'REQ-001237',
          user_name: 'Sarah Williams',
          user_email: 'sarah.w@example.com',
          user_phone: '+91 98765 43213',
          user_id: 'USR004',
          registration_date: 'Jan 5, 2025',
          location: 'Mumbai',
          cohort: 'Cohort A',
          status: 'approved',
          submitted_at: '2025-01-15T11:45:00',
          submitted_date: 'Jan 15, 2025',
          course_name: 'E-Course on AvSec Awareness',
          course_type: 'Mandatory',
          product: 'E-Course on AvSec Awareness',
          submission_type: 'first-time',
          avatar: 'https://images.unsplash.com/photo-1494790108377-be9c29b29330?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=facearea&facepad=2&w=300&h=300&q=80',
          custom_fields: [
            { title: 'Organization Name', response: 'GHI Industries', type: 'text' },
            { title: 'Department', response: 'Operations', type: 'text' }
          ],
          approval_history: [
            {
              status: 'approved',
              reviewer: 'Admin User',
              date: 'Jan 16, 2025',
              notes: 'All documents verified. Approved.'
            }
          ],
          is_resubmission: false,
          rejection_reason: null
        },
        {
          id: 5,
          request_id: 'REQ-001238',
          user_name: 'Michael Brown',
          user_email: 'michael.b@example.com',
          user_phone: '+91 98765 43214',
          user_id: 'USR005',
          registration_date: 'Dec 28, 2024',
          location: 'Delhi',
          cohort: 'Cohort B',
          status: 'rejected',
          submitted_at: '2025-01-12T16:30:00',
          submitted_date: 'Jan 12, 2025',
          course_name: 'E-Course on AvSec Awareness',
          course_type: 'Mandatory',
          product: 'E-Course on AvSec Awareness',
          submission_type: 'first-time',
          avatar: null,
          custom_fields: [
            { title: 'Organization Name', response: 'JKL Corp', type: 'text' },
            { title: 'Department', response: 'Security', type: 'text' }
          ],
          approval_history: [
            {
              status: 'rejected',
              reviewer: 'Admin User',
              date: 'Jan 13, 2025',
              notes: 'Incomplete application. Missing employee verification documents.'
            }
          ],
          is_resubmission: false,
          rejection_reason: 'Incomplete application. Missing employee verification documents.'
        }
      ],
      locations: ['Mumbai', 'Delhi', 'Bangalore', 'Chennai', 'Kolkata', 'Hyderabad'],
      products: ['E-Course on AvSec Awareness', 'Introduction to Airport Firefighting and Rescue Vehicles', 'Airport Security Management', 'Aviation Safety Protocols'],
      selectedLocation: null,
      selectedProduct: null,
      selectedStatus: 'pending',
      selectedSubmissionType: 'all',
      selectedDateRange: 'all',
      customDateStart: null,
      customDateEnd: null,
      searchQuery: '',
      selectedRequest: null,
      selectedRequests: [],
      approvalNotes: '',
      rejectionNotes: '',
      bulkApprovalNotes: '',
      bulkRejectionNotes: '',
      activeTab: 'pending', // 'pending' or 'approved'
      showFilterModal: false,

      formatDate(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        const month = months[date.getMonth()];
        const day = date.getDate();
        const year = date.getFullYear();
        return `${month} ${day}, ${year}`;
      },

      getRelativeTime(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);

        if (diffMins < 1) return 'Just now';
        if (diffMins < 60) return `${diffMins}m ago`;
        if (diffHours < 24) return `${diffHours}h ago`;
        if (diffDays < 7) return `${diffDays}d ago`;
        return this.formatDate(dateString);
      },

      get filteredPendingRequests() {
        // Always show pending requests when on pending tab
        let filtered = this.requests.filter(r => r.status === 'pending');

        if (this.selectedProduct) {
          filtered = filtered.filter(r => r.product === this.selectedProduct);
        }

        if (this.selectedDateRange !== 'all') {
          const now = new Date();
          const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
          filtered = filtered.filter(r => {
            const submittedDate = new Date(r.submitted_at);
            if (this.selectedDateRange === 'today') {
              return submittedDate >= today;
            }
            if (this.selectedDateRange === 'last-7-days') {
              const sevenDaysAgo = new Date(today);
              sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
              return submittedDate >= sevenDaysAgo;
            }
            if (this.selectedDateRange === 'last-30-days') {
              const thirtyDaysAgo = new Date(today);
              thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
              return submittedDate >= thirtyDaysAgo;
            }
            if (this.selectedDateRange === 'custom' && this.customDateStart && this.customDateEnd) {
              return submittedDate >= new Date(this.customDateStart) && submittedDate <= new Date(this.customDateEnd);
            }
            return true;
          });
        }

        if (this.searchQuery) {
          const query = this.searchQuery.toLowerCase();
          filtered = filtered.filter(r =>
            r.user_name.toLowerCase().includes(query) ||
            r.user_email.toLowerCase().includes(query) ||
            (r.user_phone && r.user_phone.toLowerCase().includes(query)) ||
            (r.product && r.product.toLowerCase().includes(query)) ||
            r.user_id.toLowerCase().includes(query)
          );
        }

        return filtered;
      },

      get filteredApprovedRejectedRequests() {
        // Always show approved/rejected requests when on this tab
        let filtered = this.requests.filter(r => r.status === 'approved' || r.status === 'rejected');

        // Apply status filter if it's set to a specific status
        if (this.selectedStatus === 'approved') {
          filtered = filtered.filter(r => r.status === 'approved');
        } else if (this.selectedStatus === 'rejected') {
          filtered = filtered.filter(r => r.status === 'rejected');
        }
        // If selectedStatus is 'all', show both approved and rejected

        if (this.selectedProduct) {
          filtered = filtered.filter(r => r.product === this.selectedProduct);
        }

        if (this.selectedDateRange !== 'all') {
          const now = new Date();
          const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
          filtered = filtered.filter(r => {
            const submittedDate = new Date(r.submitted_at);
            if (this.selectedDateRange === 'today') {
              return submittedDate >= today;
            }
            if (this.selectedDateRange === 'last-7-days') {
              const sevenDaysAgo = new Date(today);
              sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
              return submittedDate >= sevenDaysAgo;
            }
            if (this.selectedDateRange === 'last-30-days') {
              const thirtyDaysAgo = new Date(today);
              thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
              return submittedDate >= thirtyDaysAgo;
            }
            if (this.selectedDateRange === 'custom' && this.customDateStart && this.customDateEnd) {
              return submittedDate >= new Date(this.customDateStart) && submittedDate <= new Date(this.customDateEnd);
            }
            return true;
          });
        }

        if (this.selectedSubmissionType !== 'all') {
          filtered = filtered.filter(r => r.submission_type === this.selectedSubmissionType);
        }

        if (this.searchQuery) {
          const query = this.searchQuery.toLowerCase();
          filtered = filtered.filter(r =>
            r.user_name.toLowerCase().includes(query) ||
            r.user_email.toLowerCase().includes(query) ||
            (r.user_phone && r.user_phone.toLowerCase().includes(query)) ||
            (r.product && r.product.toLowerCase().includes(query)) ||
            r.user_id.toLowerCase().includes(query)
          );
        }

        return filtered;
      },

      toggleRequestSelection(requestId) {
        const index = this.selectedRequests.indexOf(requestId);
        if (index > -1) {
          this.selectedRequests.splice(index, 1);
        } else {
          this.selectedRequests.push(requestId);
        }
      },

      toggleAllRequests() {
        // Determine which tab is active using Alpine.js state
        const currentFiltered = this.activeTab === 'pending' ? this.filteredPendingRequests : this.filteredApprovedRejectedRequests;

        // Check if all are selected
        const allSelected = currentFiltered.length > 0 && currentFiltered.every(r => this.selectedRequests.includes(r.id));

        if (allSelected) {
          // Deselect all from current filtered list
          currentFiltered.forEach(r => {
            const index = this.selectedRequests.indexOf(r.id);
            if (index > -1) {
              this.selectedRequests.splice(index, 1);
            }
          });
        } else {
          // Select all from current filtered list
          currentFiltered.forEach(r => {
            if (!this.selectedRequests.includes(r.id)) {
              this.selectedRequests.push(r.id);
            }
          });
        }
      },

      openBulkApproveModal() {
        if (this.selectedRequests.length > 0) {
          this.bulkApprovalNotes = '';
          window.HSOverlay?.open('#bulk-approve-modal');
        }
      },

      openBulkRejectModal() {
        if (this.selectedRequests.length > 0) {
          this.bulkRejectionNotes = '';
          window.HSOverlay?.open('#bulk-reject-modal');
        }
      },

      confirmBulkApprove() {
        if (this.selectedRequests.length === 0) return;
        // Filter to only pending requests
        const pendingRequests = this.selectedRequests.filter(id => {
          const request = this.requests.find(r => r.id === id);
          return request && request.status === 'pending';
        });

        pendingRequests.forEach(id => {
          const request = this.requests.find(r => r.id === id);
          if (request) {
            request.status = 'approved';
            request.rejection_reason = null;
            request.approval_history.push({
              status: 'approved',
              reviewer: 'Current User',
              date: this.formatDate(new Date()),
              notes: this.bulkApprovalNotes || 'Bulk approved'
            });
          }
        });

        this.selectedRequests = [];
        this.bulkApprovalNotes = '';
        window.HSOverlay?.close('#bulk-approve-modal');
      },

      confirmBulkReject() {
        if (this.selectedRequests.length === 0 || !this.bulkRejectionNotes.trim()) return;
        // Filter to only pending requests
        const pendingRequests = this.selectedRequests.filter(id => {
          const request = this.requests.find(r => r.id === id);
          return request && request.status === 'pending';
        });

        pendingRequests.forEach(id => {
          const request = this.requests.find(r => r.id === id);
          if (request) {
            request.status = 'rejected';
            request.rejection_reason = this.bulkRejectionNotes;
            request.approval_history.push({
              status: 'rejected',
              reviewer: 'Current User',
              date: this.formatDate(new Date()),
              notes: this.bulkRejectionNotes
            });
          }
        });

        this.selectedRequests = [];
        this.bulkRejectionNotes = '';
        window.HSOverlay?.close('#bulk-reject-modal');
      },

      openApproveModal(request) {
        // Find the request from the main requests array to ensure we have the latest data
        const currentRequest = this.requests.find(r => r.id === request.id);
        if (currentRequest && currentRequest.status === 'pending') {
          this.selectedRequest = { ...currentRequest }; // Create a copy to avoid reference issues
          this.approvalNotes = '';
          window.HSOverlay?.open('#approve-request-modal');
        }
      },

      openRejectModal(request) {
        // Find the request from the main requests array to ensure we have the latest data
        const currentRequest = this.requests.find(r => r.id === request.id);
        if (currentRequest && currentRequest.status === 'pending') {
          this.selectedRequest = { ...currentRequest }; // Create a copy to avoid reference issues
          this.rejectionNotes = '';
          window.HSOverlay?.open('#reject-request-modal');
        }
      },

      openCustomFieldsModal(request) {
        // Find the request from the main requests array to ensure we have the latest data
        const currentRequest = this.requests.find(r => r.id === request.id);
        if (currentRequest) {
          this.selectedRequest = { ...currentRequest }; // Create a copy to avoid reference issues
          window.HSOverlay?.open('#custom-fields-modal');
        }
      },

      approveRequest() {
        if (this.selectedRequest && this.selectedRequest.id) {
          // Update request status
          const request = this.requests.find(r => r.id === this.selectedRequest.id);
          if (request && request.status === 'pending') {
            request.status = 'approved';
            request.rejection_reason = null;
            request.approval_history.push({
              status: 'approved',
              reviewer: 'Current User',
              date: this.formatDate(new Date()),
              notes: this.approvalNotes
            });

            // Clear selection and notes before closing
            this.approvalNotes = '';
            this.selectedRequest = null;

            // Close modal
            window.HSOverlay?.close('#approve-request-modal');
          }
        }
      },

      rejectRequest() {
        if (this.selectedRequest && this.selectedRequest.id && this.rejectionNotes.trim()) {
          // Update request status
          const request = this.requests.find(r => r.id === this.selectedRequest.id);
          if (request && request.status === 'pending') {
            request.status = 'rejected';
            request.rejection_reason = this.rejectionNotes;
            request.approval_history.push({
              status: 'rejected',
              reviewer: 'Current User',
              date: this.formatDate(new Date()),
              notes: this.rejectionNotes
            });

            // Clear selection and notes before closing
            this.rejectionNotes = '';
            this.selectedRequest = null;

            // Close modal
            window.HSOverlay?.close('#reject-request-modal');
          }
        }
      },

      clearLocationFilter() {
        this.selectedLocation = null;
      },

      clearAllFilters() {
        this.selectedProduct = null;
        if (this.activeTab === 'pending') {
          this.selectedStatus = 'pending';
        } else {
          this.selectedStatus = 'all';
        }
        this.selectedSubmissionType = 'all';
        this.selectedDateRange = 'all';
        this.customDateStart = null;
        this.customDateEnd = null;
        this.searchQuery = '';
      },

      getActiveFiltersCount() {
        let count = 0;
        if (this.selectedProduct) count++;
        if (this.activeTab === 'pending') {
          // For pending tab, status is always pending, so don't count it
        } else {
          // For approved/rejected tab, count if status is not 'all'
          if (this.selectedStatus !== 'all') count++;
          if (this.selectedSubmissionType !== 'all') count++;
        }
        if (this.selectedDateRange !== 'all') count++;
        if (this.selectedDateRange === 'custom' && this.customDateStart && this.customDateEnd) count++;
        if (this.searchQuery) count++;
        return count;
      }
    };
  }
</script>
{% endblock %}