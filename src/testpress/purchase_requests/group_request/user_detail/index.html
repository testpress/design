---
permalink: testpress/purchase_requests/group_request/user/
---
{% extends "layouts/admin_base.html" %}
{% block body_class %}overflow-y-scroll min-h-screen bg-gray-100{% endblock %}
{% block content %}
<div x-data="groupUserDetail()" class="py-10 max-w-7xl mx-auto lg:px-8 px-4">

  {% include "./header.html" %}

  <!-- Two Column Layout -->
  <div class="grid grid-cols-1 lg:grid-cols-5 gap-5">
    <!-- Left Column - Scrollable Content (60%) -->
    <div class="lg:col-span-3 space-y-4">
      {% include "./user_detail.html" %}
      {% include "./purchasing_product.html" %}
      {% include "./additional_information.html" %}
    </div>
    <!-- End Left Column -->

    <!-- Right Column - Sticky Sidebar (40%) -->
    <div class="lg:col-span-2">
      <div class="lg:sticky lg:top-20 space-y-4">

        {% include "./review_action_card.html" %}
        {% include "./review_info.html" %}
        {% include "./submission_history_card.html" %}
      </div>
    </div>
    <!-- End Right Column -->
  </div>
  <!-- End Two Column Layout -->

  <!-- Modals -->
  {% include "./approve_confirmation_modal.html" %}
  {% include "./reject_confirmation_modal.html" %}
</div>
{% endblock %}

{% block script %}
<script>
  function groupUserDetail() {
    return {
      request: null,
      requestId: null,
      groupId: null,
      userId: null,
      status: 'pending',
      allUsers: [],
      currentIndex: 0,
      selectedRequest: null,
      approvalNotes: '',
      rejectionNotes: '',

      groupRequest: {
        group_name: 'Terminal 2 Ground Staff - GRP-001234',
        manager_name: 'Rajesh Kumar',
        approved_count: 12,
        total_count: 15
      },

      init() {
        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        this.userId = urlParams.get('user_id');
        this.groupId = urlParams.get('group_id') || 'GRP-001234';
        this.status = urlParams.get('status') || 'pending';

        // Load users in group
        this.loadGroupUsers();

        // Find and set current user
        if (this.userId) {
          this.findUserById(this.userId);
        } else if (this.allUsers.length > 0) {
          this.request = this.allUsers[0];
          this.updateCurrentIndex();
        }
      },

      loadGroupUsers() {
        // Sample data - in production, this would come from an API
        const now = new Date();
        const twoDaysAgo = new Date(now.getTime() - 2 * 24 * 60 * 60 * 1000);
        const oneDayAgo = new Date(now.getTime() - 1 * 24 * 60 * 60 * 1000);

        this.allUsers = [
          {
            id: 1,
            request_id: 'REQ-001234',
            user_id: 1,
            status: 'pending',
            user_name: 'John Doe',
            email: 'john.doe@example.com',
            phone: '+91 98765 43210',
            airport: 'Indira Gandhi International Airport, New Delhi',
            organization: 'Airport Authority of India',
            department: 'Flight Operations',
            product: 'Advanced Course Package',
            submitted_at: twoDaysAgo.toISOString(),
            submission_history: [
              {
                status: 'submitted',
                user_name: 'John Doe',
                date: twoDaysAgo.toISOString()
              }
            ]
          },
          {
            id: 2,
            request_id: 'REQ-001235',
            user_id: 2,
            status: 'approved',
            user_name: 'Jane Smith',
            email: 'jane.smith@example.com',
            phone: '+91 98765 43211',
            airport: 'Indira Gandhi International Airport, New Delhi',
            organization: 'Airport Authority of India',
            department: 'Ground Services',
            product: 'Basic Course',
            submitted_at: oneDayAgo.toISOString(),
            approved_by: 'Admin User',
            approved_at: new Date(oneDayAgo.getTime() + 2 * 60 * 60 * 1000).toISOString(),
            approval_notes: 'All requirements met',
            submission_history: [
              {
                status: 'submitted',
                user_name: 'Jane Smith',
                date: oneDayAgo.toISOString()
              },
              {
                status: 'approved',
                reviewer: 'Admin User',
                date: new Date(oneDayAgo.getTime() + 2 * 60 * 60 * 1000).toISOString()
              }
            ]
          },
          {
            id: 3,
            request_id: 'REQ-001236',
            user_id: 3,
            status: 'rejected',
            user_name: 'Bob Johnson',
            email: 'bob.johnson@example.com',
            phone: '+91 98765 43212',
            airport: 'Indira Gandhi International Airport, New Delhi',
            organization: 'Airport Authority of India',
            department: 'Security',
            product: 'Premium Package',
            submitted_at: new Date(now.getTime() - 3 * 24 * 60 * 60 * 1000).toISOString(),
            rejected_by: 'Admin User',
            rejected_at: new Date(now.getTime() - 2 * 24 * 60 * 60 * 1000).toISOString(),
            rejection_reason: 'Missing required documents',
            submission_history: [
              {
                status: 'submitted',
                user_name: 'Bob Johnson',
                date: new Date(now.getTime() - 3 * 24 * 60 * 60 * 1000).toISOString()
              },
              {
                status: 'rejected',
                reviewer: 'Admin User',
                date: new Date(now.getTime() - 2 * 24 * 60 * 60 * 1000).toISOString(),
                reason: 'Missing required documents'
              }
            ]
          }
        ];

        // Ensure all users have at least one submission history entry
        this.allUsers.forEach(user => {
          if (!user.submission_history || user.submission_history.length === 0) {
            user.submission_history = [
              {
                status: 'submitted',
                user_name: user.user_name || 'User',
                date: user.submitted_at || new Date().toISOString()
              }
            ];
          }
        });
      },

      findUserById(id) {
        const found = this.allUsers.find(u => u.user_id == id || u.id == id);
        if (found) {
          this.request = found;
          if (!this.request.submission_history || this.request.submission_history.length === 0) {
            this.request.submission_history = [
              {
                status: 'submitted',
                user_name: this.request.user_name || 'User',
                date: this.request.submitted_at || new Date().toISOString()
              }
            ];
          }
          this.updateCurrentIndex();
        }
      },

      updateCurrentIndex() {
        if (this.request) {
          this.currentIndex = this.allUsers.findIndex(u => (u.user_id == this.request.user_id) || (u.id == this.request.id));
          if (this.currentIndex === -1) this.currentIndex = 0;
        }
      },

      hasPrevious() {
        return this.currentIndex > 0;
      },

      hasNext() {
        return this.currentIndex < this.allUsers.length - 1;
      },

      navigateToPrevious() {
        if (this.currentIndex > 0) {
          this.currentIndex--;
          this.request = this.allUsers[this.currentIndex];
          this.updateUrl();
        }
      },

      navigateToNext() {
        if (this.currentIndex < this.allUsers.length - 1) {
          this.currentIndex++;
          this.request = this.allUsers[this.currentIndex];
          this.updateUrl();
        }
      },

      navigateToGroup() {
        window.location.href = `/testpress/purchase_requests/group_request/detail/?id=${this.groupId || 'GRP-001234'}`;
      },

      updateUrl() {
        if (this.request) {
          const newUrl = `/testpress/purchase_requests/group_request/user_detail/?user_id=${this.request.user_id || this.request.id}&group_id=${this.groupId}`;
          window.history.pushState({}, '', newUrl);
          this.userId = this.request.user_id || this.request.id;
        }
      },

      openApproveConfirmationModal() {
        if (this.request && this.request.status === 'pending') {
          this.selectedRequest = { ...this.request };
          window.HSOverlay?.open('#approve-confirmation-modal');
        }
      },

      openRejectConfirmationModal() {
        if (this.request && this.request.status === 'pending') {
          this.selectedRequest = { ...this.request };
          this.rejectionNotes = '';
          window.HSOverlay?.open('#reject-confirmation-modal');
        }
      },

      confirmApprove() {
        if (!this.selectedRequest || this.selectedRequest.status !== 'pending') return;

        if (this.request && (this.request.user_id == this.selectedRequest.user_id || this.request.id == this.selectedRequest.id)) {
          const now = new Date().toISOString();
          this.request.status = 'approved';
          this.request.approval_notes = this.approvalNotes;
          this.request.approved_by = 'Current User';
          this.request.approved_at = now;
          this.status = 'approved';

          if (!this.request.submission_history) {
            this.request.submission_history = [];
          }
          this.request.submission_history.push({
            status: 'approved',
            reviewer: 'Current User',
            date: now
          });

          // Update group stats
          this.groupRequest.approved_count++;
        }

        this.selectedRequest = null;
        this.approvalNotes = '';
        window.HSOverlay?.close('#approve-confirmation-modal');

        setTimeout(() => {
          if (this.hasNext()) {
            this.navigateToNext();
          }
        }, 500);
      },

      confirmReject() {
        if (!this.selectedRequest || this.selectedRequest.status !== 'pending') return;
        if (!this.rejectionNotes || !this.rejectionNotes.trim()) return;

        if (this.request && (this.request.user_id == this.selectedRequest.user_id || this.request.id == this.selectedRequest.id)) {
          const now = new Date().toISOString();
          this.request.status = 'rejected';
          this.request.rejection_reason = this.rejectionNotes;
          this.request.rejected_by = 'Current User';
          this.request.rejected_at = now;
          this.status = 'rejected';

          if (!this.request.submission_history) {
            this.request.submission_history = [];
          }
          this.request.submission_history.push({
            status: 'rejected',
            reviewer: 'Current User',
            date: now,
            reason: this.rejectionNotes
          });
        }

        this.selectedRequest = null;
        this.rejectionNotes = '';
        window.HSOverlay?.close('#reject-confirmation-modal');

        setTimeout(() => {
          if (this.hasNext()) {
            this.navigateToNext();
          }
        }, 500);
      },

      clearSelectedRequest() {
        this.selectedRequest = null;
        this.approvalNotes = '';
        this.rejectionNotes = '';
      },

      formatDate(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        const month = months[date.getMonth()];
        const day = date.getDate();
        const year = date.getFullYear();
        return `${month} ${day}, ${year}`;
      },

      formatTime(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        const hours = date.getHours().toString().padStart(2, '0');
        const minutes = date.getMinutes().toString().padStart(2, '0');
        return `${hours}:${minutes}`;
      },

      getTimeElapsed(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);

        if (diffMins < 1) return 'Just now';
        if (diffMins < 60) return `${diffMins} minute${diffMins !== 1 ? 's' : ''} ago`;
        if (diffHours < 24) return `${diffHours} hour${diffHours !== 1 ? 's' : ''} ago`;
        if (diffDays < 7) return `${diffDays} day${diffDays !== 1 ? 's' : ''} ago`;
        return this.formatDate(dateString);
      },

      getRelativeTime(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);

        if (diffMins < 1) return 'Just now';
        if (diffMins < 60) return `${diffMins}m ago`;
        if (diffHours < 24) return `${diffHours}h ago`;
        if (diffDays < 7) return `${diffDays}d ago`;
        return this.formatDate(dateString);
      }
    };
  }
</script>
<script src="https://preline.co/assets/vendor/clipboard/dist/clipboard.min.js"></script>
<script src="https://preline.co/assets/js/hs-copy-clipboard-helper.js"></script>
{% endblock script %}