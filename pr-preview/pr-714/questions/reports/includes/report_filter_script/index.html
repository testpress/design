<script>
  function report_filter_components() {
    return {
      showFilterReport: false,
      showMobileFilterReport: false,
      exams: JSON.parse('[{"id":1,"name":"Dinesh","profile_image":"https://static.testpress.in/static/img/default_small_image.png","rank":1,"first_attempt_correct":"14","first_attempt_incorrect":"4","first_attempt_trophies":"55","first_attempt_score":"52","attempts":[{"id":1,"date":"12 Sep, 2023","score":"10.00","correct":"4","incorrect":"2","trophies":"55"},{"id":2,"date":"11 Sep, 2023","score":"11.00","correct":"5","incorrect":"1","trophies":"5"},{"id":3,"date":"09 Sep, 2023","score":"20.00","correct":"7","incorrect":"3","trophies":"0"},{"id":4,"date":"07 Sep, 2023","score":"30.00","correct":"14","incorrect":"7","trophies":"0"},{"id":5,"date":"01 Sep, 2023","score":"5.00","correct":"4","incorrect":"3","trophies":"0"},{"id":1,"date":"01 Sep, 2023","score":"0.00","correct":"4","incorrect":"4","trophies":"0"}]},{"id":2,"name":"Kumar","profile_image":"https://static.testpress.in/static/img/default_small_image.png","rank":2,"first_attempt_correct":"10","first_attempt_incorrect":"4","first_attempt_trophies":"35","first_attempt_score":"42","attempts":[]},{"id":3,"name":"Shanmugam","profile_image":"https://static.testpress.in/static/img/default_small_image.png","rank":3,"first_attempt_correct":"11","first_attempt_incorrect":"8","first_attempt_trophies":"15","first_attempt_score":"4","attempts":[]},{"id":4,"name":"Anil","profile_image":"https://static.testpress.in/static/img/default_small_image.png","rank":4,"first_attempt_correct":"6","first_attempt_incorrect":"1","first_attempt_trophies":"12","first_attempt_score":"14","attempts":[]},{"id":5,"name":"Vimal","profile_image":"https://static.testpress.in/static/img/default_small_image.png","rank":5,"first_attempt_correct":"1","first_attempt_incorrect":"0","first_attempt_trophies":"5","first_attempt_score":"4","attempts":[]}]'),
      subjects: JSON.parse('[{"id":1,"name":"Physics","parent":null},{"id":2,"name":"Chemistry","parent":null},{"id":3,"name":"Math","parent":null},{"id":4,"name":"Computer Science","parent":null},{"id":5,"name":"English","parent":null},{"id":6,"name":"Tamil","parent":null},{"id":7,"name":"Hindi","parent":null}]'),
      chapters: JSON.parse('[{"id":1,"title":"Current Affairs 2023","subchapters":[{"id":10,"name":"Jan","contents":[{"id":101,"name":"JAN 1st week CA","type":"VIDEO","is_locked":"False","is_completed":"True","selected":"True","duration":"01:15:15"},{"id":102,"name":"Jan 1st week One liners","type":"ATTACHMENT","is_locked":"False","is_completed":"False"},{"id":103,"name":"Jan 1st week CA 2022","type":"PDF","is_locked":"True","is_completed":"False"}]},{"id":11,"name":"Feb","nestedsubchapter":[{"id":20,"name":"Day 1","contents":[{"id":201,"name":"Feb 1st week Current Affairs","type":"VIDEO","is_locked":"True","is_completed":"False","duration":"20:20"},{"id":202,"name":"Bank Feb 1st Week CA - 2023","type":"ATTACHMENT","is_locked":"True","is_completed":"False"},{"id":203,"name":"Feb 2nd week Current Affairs","type":"PDF","is_locked":"True","is_completed":"False"}]},{"id":21,"name":"Day 2","contents":[{"id":204,"name":"Bank Feb 2nd Week CA - 2023","type":"VIDEO","is_locked":"True","is_completed":"False","duration":"25:25"},{"id":205,"name":"Feb 3rd week Current Affairs","type":"ATTACHMENT","is_locked":"True","is_completed":"False"},{"id":206,"name":"Bank Feb 3rd Week CA - 2023","type":"PDF","is_locked":"True","is_completed":"False"}]}]}]},{"id":2,"title":"BOI 2023","contents":[{"id":301,"name":"BOI Set 1 - 2023","type":"NOTES","is_locked":"True","is_completed":"False"},{"id":302,"name":"BOI Set 2 - 2023","type":"ZOOM","is_locked":"True","is_completed":"False"},{"id":303,"name":"BOI Set 3 - 2023","type":"EXAM","is_locked":"False","is_completed":"True","number_of_questions":100}]},{"id":3,"title":"Current Affairs 2022","contents":[{"id":401,"name":"JAN 1st week CA","type":"VIDEO","is_locked":"True","is_completed":"False","duration":"02:15:15"},{"id":402,"name":"Jan 1st week One liners","type":"ZOOM","is_locked":"True","is_completed":"False"},{"id":403,"name":"Jan 1st week CA 2022","type":"EXAM","is_locked":"True","is_completed":"False","number_of_questions":100}]},{"id":4,"title":"Bank Extreme Circle - October 2022","subchapters":[{"id":30,"name":"EXTREME CIRCLE","contents":[{"id":501,"name":"DAY 1 EXTREME CIRCLE - RATIO & PROPORTION SET - 1","type":"VIDEO","is_locked":"False","is_completed":"False","duration":"03:15:15"},{"id":502,"name":"DAY 1 EXTREME CIRCLE - RATIO & PROPORTION SET - 2","type":"ATTACHMENT","is_locked":"True","is_completed":"False"},{"id":503,"name":"DAY 1 EXTREME CIRCLE - RATIO & PROPORTION SET - 3","type":"PDF","is_locked":"True","is_completed":"False"},{"id":504,"name":"DAY 1 EXTREME CIRCLE - RATIO & PROPORTION SET - 4","type":"ZOOM","is_locked":"True","is_completed":"False"},{"id":505,"name":"DAY 1 EXTREME CIRCLE - RATIO & PROPORTION SET - 5","type":"EXAM","is_locked":"False","is_completed":"False","number_of_questions":100}]},{"id":31,"name":"SBI PO Prelims 2022","nestedsubchapter":[{"id":40,"name":"Day 1","contents":[{"id":601,"name":"SBI PO Prelims 1 - 2022","type":"VIDEO","is_locked":"True","is_completed":"False","duration":"04:15:15"},{"id":602,"name":"SBI PO Prelims 2 - 2022","type":"ATTACHMENT","is_locked":"True","is_completed":"False"},{"id":603,"name":"SBI PO Prelims 3 - 2022","type":"PDF","is_locked":"True","is_completed":"False"},{"id":604,"name":"SBI PO Prelims 4 - 2022","type":"PDF","is_locked":"True","is_completed":"False"},{"id":605,"name":"SBI PO Prelims 5 - 2022","type":"PDF","is_locked":"True","is_completed":"False"}]},{"id":41,"name":"Day 2","contents":[{"id":606,"name":"SBI PO Prelims 6 - 2022","type":"VIDEO","is_locked":"True","is_completed":"False","duration":"02:15:15"},{"id":607,"name":"SBI PO Prelims 7 - 2022","type":"ATTACHMENT","is_locked":"True","is_completed":"False"},{"id":608,"name":"SBI PO Prelims 8 - 2022","type":"PDF","is_locked":"True","is_completed":"False"}]}]}]},{"id":5,"title":"Pooja Test","contents":[{"id":701,"name":"Pooja Workout Test 1 - 2022","type":"NOTES","is_locked":"True","is_completed":"False"},{"id":702,"name":"Pooja Workout Test 2 - 2022","type":"ZOOM","is_locked":"True","is_completed":"False"},{"id":703,"name":"Pooja Workout Test 3 - 2022","type":"EXAM","is_locked":"False","is_completed":"True","number_of_questions":100},{"id":704,"name":"Pooja Workout Test 4 - 2022","type":"VIDEO","is_locked":"True","is_completed":"False","duration":"04:15:15"},{"id":705,"name":"Pooja Workout Test 5 - 2022","type":"PDF","is_locked":"True","is_completed":"False"}]}]'),
      courses: JSON.parse('[{"id":1,"name":"General Studies Program","fee":"2,500.00","discount":"200.00","total":"2,300.00"},{"id":2,"name":"Free Learning Path - Beginners","fee":"0.00","discount":"0.00","total":"0.00"},{"id":3,"name":"UPSC Comprehensive Program - 2024","fee":"15,000.00","discount":"1,500.00","total":"13,500.00"},{"id":4,"name":"2023 Mains Crash Course","fee":"5,000.00","discount":"500.00","total":"4,500.00"}]'),
      reportees: JSON.parse('[{"id":1,"image_url":"https://images.unsplash.com/photo-1541101767792-f9b2b1c4f127?ixlib=rb-4.0.3&auto=format&fit=facearea&facepad=3&w=320&h=320&q=80","user_name":"Suresh@gmail.com","display_name":"Suresh Kumar","phone_number":"9876543210","assigned":14,"unassigned":8,"closed":19},{"id":2,"image_url":"https://images.unsplash.com/photo-1601935111741-ae98b2b230b0?ixlib=rb-4.0.3&auto=format&fit=facearea&facepad=2.5&w=320&h=320&q=80","user_name":"ramesh@gmail.com","display_name":"Ramesh Gupta","phone_number":"9876543210","assigned":12,"unassigned":15,"closed":10},{"id":3,"image_url":"https://images.unsplash.com/photo-1570654639102-bdd95efeca7a?ixlib=rb-4.0.3&auto=format&fit=facearea&facepad=2.5&w=320&h=320&q=80","user_name":"anita@gmail.com","display_name":"Anita Sharma","phone_number":"9876543210","assigned":18,"unassigned":11,"closed":20},{"id":4,"image_url":"https://images.unsplash.com/photo-1679412330254-90cb240038c5?ixlib=rb-4.0.3&auto=format&fit=facearea&facepad=2.5&w=320&h=320&q=80","user_name":"vikas@gmail.com","display_name":"Vikas Singh","phone_number":"9876543210","assigned":16,"unassigned":9,"closed":14},{"id":5,"image_url":"https://images.unsplash.com/photo-1568602471122-7832951cc4c5?ixlib=rb-4.0.3&auto=format&fit=facearea&facepad=2.5&w=320&h=320&q=80","user_name":"sanjay@gmail.com","display_name":"Sanjay Verma","phone_number":"9876543210","assigned":11,"unassigned":18,"closed":12},{"id":6,"image_url":"https://images.unsplash.com/photo-1659482634023-2c4fda99ac0c?ixlib=rb-4.0.3&auto=format&fit=facearea&facepad=2.5&w=320&h=320&q=80","user_name":"meena@gmail.com","display_name":"Meena Joshi","phone_number":"9876543210","assigned":13,"unassigned":17,"closed":15}]'),
      selected_filters: [],
      showExamFilter: false,
      showChapterFilter: false,
      showSubjectFilter: false,
      showStudentFilter: false,
      showCourseFilter: false,
      showDateRangeFilter: false,
      showReporteeFilter: false,
      showDateFilter: false,
      fromDate: null,
      toDate: null,
      active_filters: null,

      filterQuestionReport(key, value) {
        const currentUrl = new URL(window.location)
        const searchParams = new URLSearchParams(currentUrl.search)
        searchParams.set(key, value)
        currentUrl.search = searchParams.toString()
        window.location.href = currentUrl.href
      },

      initialize_selected_filter() {
        const searchParams = new URLSearchParams(window.location.search)
        const fromDate = searchParams.get('start_date')
        const toDate = searchParams.get('end_date')

        for (let [key, value] of searchParams) {
          let filterItem, type
          switch (key) {
            case 'exam':
              filterItem = this.exams.find((i) => i.id === parseInt(value))
              type = 'exam'
              break
            case 'subject':
              filterItem = this.subjects.find((i) => i.id === parseInt(value))
              type = 'subject'
              break
            case 'chapter':
              filterItem = this.chapters.find((i) => i.id === parseInt(value))
              type = 'chapter'
              break
            case 'course':
              filterItem = this.courses.find((i) => i.id === parseInt(value))
              type = 'course'
              break
            case 'reportee':
              filterItem = this.reportees.find((i) => i.id === parseInt(value))
              type = 'reportee'
              normalized_name = filterItem.display_name || filterItem.id
              filterItem.name = normalized_name
              break
          }
          if (filterItem) {
            filterItem.type = type
            this.selected_filters.push(filterItem)
          }
        }

        if (fromDate && toDate) {
          this.fromDate = fromDate
          this.toDate = toDate
          this.selected_filters.push({
            id: `${fromDate}_${toDate}`,
            type: 'date',
            name: `${fromDate} to ${toDate}`,
          })
        }

        this.active_filters = this.selected_filters.length
      },

      isItemSelected(item, type) {
        return this.selected_filters.some(
          (e) => e.id === item.id && e.type === type
        )
      },

      addToSelectedFilter(filter, type) {
        if (this.isItemSelected(filter, type)) return
        filter.type = type
        const normalized_name = filter.name || filter.display_name || filter.id
        filter.name = normalized_name
        if (type === 'date') {
          this.selected_filters = this.selected_filters.filter(
            (f) => f.type !== 'date'
          )
        }
        if (type === 'reportee') {
          this.selected_filters = this.selected_filters.filter(
            (f) => f.type !== 'reportee'
          )
        }
        this.selected_filters.push(filter)
        this.active_filters = this.selected_filters.length
      },

      removeSelectedFilter(filter) {
        if (filter.type === 'date') {
          this.selected_filters = this.selected_filters.filter(
            (f) => f.type !== 'date'
          )
          this.fromDate = null
          this.toDate = null
          const currentUrl = new URL(window.location)
          const searchParams = new URLSearchParams(currentUrl.search)
          searchParams.delete('start_date')
          searchParams.delete('end_date')
          currentUrl.search = searchParams.toString()
          window.location.href = currentUrl.href
          return
        }
        this.selected_filters = this.selected_filters.filter(
          (item) => item.id !== filter.id || item.type !== filter.type
        )
        this.active_filters = this.selected_filters.length
      },

      submitReportFilter() {
        const params = this.selected_filters
          .map((filter) => {
            if (filter.type === 'date') {
              const [startDate, endDate] = filter.id.split('_')
              return `start_date=${startDate}&end_date=${endDate}`
            }
            return `${filter.type}=${filter.id}`
          })
          .join('&')
        window.location.href = `${window.location.origin}${window.location.pathname}?${params}`
      },
      handleDateChange() {
        if (!(this.fromDate && this.toDate)) return
        const date_range = {
          id: `${this.fromDate}_${this.toDate}`,
          name: `${this.fromDate} â†’ ${this.toDate}`,
          type: 'date',
        }
        this.addToSelectedFilter(date_range, 'date')
        this.active_filters = this.selected_filters.length
      },

      getSearchParameterValue() {
        const searchParams = new URLSearchParams(window.location.search)
        for (let [key, value] of searchParams) if (key) return value
      },
    }
  }
</script>
