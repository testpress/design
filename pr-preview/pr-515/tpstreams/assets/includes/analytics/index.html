<div x-data="{ analytics_tab: 'overview', ...chartComponent() }" x-show="!disableAnalytics">
  <!-- Analytics Sub-tabs -->
  <div class="mt-4">
    <nav class="flex space-x-8" aria-label="Analytics Tabs">
      <button @click.prevent="analytics_tab = 'overview'"
        class="px-1 py-2 text-sm font-medium"
        :class="analytics_tab === 'overview' ? 'text-blue-600' : 'text-gray-500 hover:text-gray-700'">
        <span>Overview</span>
      </button>
      
      <button @click.prevent="analytics_tab = 'location'"
        class="px-1 py-2 text-sm font-medium"
        :class="analytics_tab === 'location' ? 'text-blue-600' : 'text-gray-500 hover:text-gray-700'">
        <span>Regions</span>
      </button>
      
      <button @click.prevent="analytics_tab = 'devices'"
        class="px-1 py-2 text-sm font-medium"
        :class="analytics_tab === 'devices' ? 'text-blue-600' : 'text-gray-500 hover:text-gray-700'">
        <span>Devices</span>
      </button>
    </nav>
  </div>

  <!-- Overview Tab Content -->
  <div x-show="analytics_tab === 'overview'">
    <div class="flex items-center justify-end mt-4">
      <button type="button"
        class="relative inline-flex items-center justify-center flex-shrink-0 w-10 h-5 rounded-full cursor-pointer group focus:outline-none focus:ring-2 focus:ring-blue-600 focus:ring-offset-2"
        role="switch" :aria-checked="showSeparate.toString()" @click="toggleCharts">
        <span class="sr-only">Use setting</span>
        <span aria-hidden="true" class="absolute w-full h-full bg-white rounded-md pointer-events-none"></span>
        <span aria-hidden="true"
          class="absolute h-4 mx-auto transition-colors duration-200 ease-in-out bg-gray-200 rounded-full pointer-events-none w-9"
          :class="{ 'bg-blue-600': showSeparate }"></span>
        <span aria-hidden="true"
          class="absolute left-0 inline-block w-5 h-5 transition-transform duration-200 ease-in-out transform translate-x-0 bg-white border border-gray-200 rounded-full shadow pointer-events-none ring-0"
          :class="{ 'translate-x-5': showSeparate }"></span>
      </button>
      <span class="ml-3 text-sm" id="annual-billing-label">
        <span class="font-medium text-gray-900">Split Charts</span>
      </span>
    </div>

    <div class="flex justify-center">
      <div id="views_chart" :hidden="!showSeparate" class="w-80 h-52 sm:w-[600px] sm:h-[400px] md:w-[700px] sm:w-[600px] sm:h-[400px] md:h-[400px] 2xl:w-[1000px] 2xl:h-[500px] mt-4"></div>
    </div>
    <div class="flex justify-center">
      <div id="minutes_watched_chart" :hidden="!showSeparate" class="w-80 h-52 sm:w-[600px] sm:h-[400px] md:w-[700px] sm:w-[600px] sm:h-[400px] md:h-[400px] 2xl:w-[1000px] 2xl:h-[500px] mt-4"></div>
    </div>
    <div class="flex justify-center">
      <div id="chart" :hidden="showSeparate" class="w-80 h-52 sm:w-[600px] sm:h-[400px] md:w-[700px] sm:w-[600px] sm:h-[400px] md:h-[400px] 2xl:w-[1000px] 2xl:h-[500px] mt-4"></div>
    </div>
  </div>

  <!-- Location Tab Content -->
  <div x-show="analytics_tab === 'location'">
    <div class="mt-6" x-data="locationAnalytics()" x-init="initMap()">
  <!-- Location Analytics Header -->
  <div class="flex items-center mb-4">
    <!-- Dynamic Title -->
    <div class="flex-1">
      <h3 class="text-lg font-semibold text-gray-800" x-show="location_tab === 'map'">Global Analytics - World Map</h3>
      <h3 class="text-lg font-semibold text-gray-800" x-show="location_tab === 'countries'">Countries Analytics</h3>
      <h3 class="text-lg font-semibold text-gray-800" x-show="location_tab === 'states' && selectedCountry" x-text="getCountryName(selectedCountry) + ' - States/Regions'"></h3>
      
      <p class="text-sm text-gray-600" x-show="location_tab === 'map'">Click on any country to view its states/regions</p>
      <p class="text-sm text-gray-600" x-show="location_tab === 'countries'">View breakdown by countries</p>
    </div>
    
    <!-- Location Dropdown -->
    <div class="relative mr-8" x-data="{ open: false }">
      <button @click="open = !open" type="button" class="py-2 px-3 pe-7 flex items-center gap-x-2 text-nowrap w-40 cursor-pointer bg-white border border-gray-200 rounded-lg text-start text-sm text-gray-800 hover:border-gray-300 focus:outline-hidden focus:border-gray-300 dark:bg-neutral-900 dark:border-neutral-800 dark:text-neutral-200 dark:hover:border-neutral-700 dark:focus:border-neutral-700">
        <span x-text="location_tab === 'map' ? 'Map View' : location_tab === 'countries' ? 'Countries' : 'States'"></span>
      </button>

      <div class="absolute top-1/2 end-2.5 -translate-y-1/2">
        <svg class="shrink-0 size-3.5 text-gray-500 dark:text-neutral-500" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m7 15 5 5 5-5"/><path d="m7 9 5-5 5 5"/></svg>
      </div>

      <div x-show="open" @click.away="open = false" x-transition:enter="transition ease-out duration-100" x-transition:enter-start="transform opacity-0 scale-95" x-transition:enter-end="transform opacity-100 scale-100" x-transition:leave="transition ease-in duration-75" x-transition:leave-start="transform opacity-100 scale-100" x-transition:leave-end="transform opacity-0 scale-95" class="absolute top-full left-0 z-50 mt-2 w-40 max-h-72 p-1 space-y-0.5 overflow-hidden overflow-y-auto bg-white rounded-xl shadow-xl dark:bg-neutral-900" role="menu" aria-orientation="vertical">
        <a @click.prevent="const scrollY = window.scrollY; location_tab = 'map'; initMapSafely(); open = false; $nextTick(() => window.scrollTo(0, scrollY))" class="py-2 px-4 w-full text-sm text-gray-800 cursor-pointer hover:bg-gray-100 rounded-lg focus:outline-hidden focus:bg-gray-100 dark:text-neutral-300 dark:hover:bg-neutral-800 dark:focus:bg-neutral-800 flex items-center justify-between" role="menuitem">
          <span>Map View</span>
          <svg x-show="location_tab === 'map'" class="shrink-0 size-3.5 text-gray-800 dark:text-neutral-200" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
        </a>
        <a @click.prevent="const scrollY = window.scrollY; location_tab = 'countries'; $nextTick(() => { initCountriesChart(); window.scrollTo(0, scrollY); }); open = false" class="py-2 px-4 w-full text-sm text-gray-800 cursor-pointer hover:bg-gray-100 rounded-lg focus:outline-hidden focus:bg-gray-100 dark:text-neutral-300 dark:hover:bg-neutral-800 dark:focus:bg-neutral-800 flex items-center justify-between" role="menuitem">
          <span>Countries</span>
          <svg x-show="location_tab === 'countries'" class="shrink-0 size-3.5 text-gray-800 dark:text-neutral-200" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
        </a>
        <a @click.prevent="const scrollY = window.scrollY; location_tab = 'states'; if(!selectedCountry) selectedCountry = 'IND'; $nextTick(() => { initStatesChart(); window.scrollTo(0, scrollY); }); open = false" class="py-2 px-4 w-full text-sm text-gray-800 cursor-pointer hover:bg-gray-100 rounded-lg focus:outline-hidden focus:bg-gray-100 dark:text-neutral-300 dark:hover:bg-neutral-800 dark:focus:bg-neutral-800 flex items-center justify-between" role="menuitem">
          <span>States</span>
          <svg x-show="location_tab === 'states'" class="shrink-0 size-3.5 text-gray-800 dark:text-neutral-200" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
        </a>
      </div>
    </div>
  </div>

  <!-- Location Analytics Container -->
  <div class="bg-white relative">
    <!-- Map View -->
    <div x-show="location_tab === 'map'" class="p-6">
      <div id="world-map" class="w-full h-[600px]"></div>
    </div>

    <!-- Countries Flow Chart -->
    <div x-show="location_tab === 'countries'" class="p-6">
      <div id="countries-chart" style="width: 800px; height: 500px;"></div>
    </div>

    <!-- States Flow Chart -->
    <div x-show="location_tab === 'states'" class="p-6">
      <div id="states-chart" style="width: 800px; height: 500px;"></div>
    </div>
  </div>
</div>

<script>
function locationAnalytics() {
  return {
    location_tab: 'map',
    map: null,
    countriesChart: null,
    statesChart: null,
    selectedCountry: null,
    resizeListenerAdded: false,
    countryStatesData: {
      'USA': [
        {value: 845, name: 'California'},
        {value: 623, name: 'Texas'},
        {value: 445, name: 'New York'},
        {value: 334, name: 'Florida'},
        {value: 261, name: 'Illinois'}
      ],
      'IND': [
        {value: 456, name: 'Maharashtra'},
        {value: 289, name: 'Karnataka'},
        {value: 234, name: 'Delhi'},
        {value: 189, name: 'Tamil Nadu'},
        {value: 156, name: 'Gujarat'},
        {value: 110, name: 'West Bengal'}
      ],
      'GBR': [
        {value: 334, name: 'London'},
        {value: 189, name: 'Manchester'},
        {value: 156, name: 'Birmingham'},
        {value: 123, name: 'Liverpool'},
        {value: 90, name: 'Leeds'}
      ],
      'AUS': [
        {value: 267, name: 'New South Wales'},
        {value: 189, name: 'Victoria'},
        {value: 156, name: 'Queensland'},
        {value: 123, name: 'Western Australia'},
        {value: 54, name: 'South Australia'}
      ],
      'BRA': [
        {value: 234, name: 'SÃ£o Paulo'},
        {value: 178, name: 'Rio de Janeiro'},
        {value: 123, name: 'Minas Gerais'},
        {value: 110, name: 'Bahia'}
      ],
      'CAN': [
        {value: 223, name: 'Ontario'},
        {value: 134, name: 'Quebec'},
        {value: 123, name: 'British Columbia'},
        {value: 87, name: 'Alberta'}
      ]
    },
    initMap() {
      // Prevent multiple Datamap instances - return early if map already exists
      if (this.map) {
        return;
      }
      
      // Use Alpine's $nextTick to ensure DOM is ready
      this.$nextTick(() => {
        // Check if we're on the map tab and container is visible
        if (this.location_tab !== 'map') {
          return; // Don't initialize if not on map tab
        }
        
        const mapElement = document.getElementById('world-map');
        
        // Ensure container exists and has dimensions
        if (!mapElement || !this.isContainerReady(mapElement)) {
          // Retry after a short delay if container not ready
          setTimeout(() => this.initMap(), 100);
          return;
        }
        
        // Check if libraries are loaded
        if (typeof Datamap === 'undefined' || typeof d3 === 'undefined') {
          console.log('Map libraries not loaded yet, retrying...');
          setTimeout(() => this.initMap(), 200);
          return;
        }
        
        // Clear any existing content
        mapElement.innerHTML = '';
        
        const data = {
          'USA': { fillKey: 'high', views: 2508 },
          'IND': { fillKey: 'high', views: 1434 },
          'GBR': { fillKey: 'medium', views: 892 },
          'AUS': { fillKey: 'medium', views: 789 },
          'BRA': { fillKey: 'medium', views: 645 },
          'CAN': { fillKey: 'medium', views: 567 }
        };

        // Initial fills - all grey
        const initialFills = {
          'high': '#d1d5db',
          'medium': '#d1d5db', 
          'low': '#d1d5db',
          defaultFill: '#f3f4f6'
        };

        // Final fills - actual colors
        const finalFills = {
          'high': '#1e40af',
          'medium': '#3b82f6',
          'low': '#93c5fd',
          defaultFill: '#f3f4f6'
        };

        this.map = new Datamap({
          element: mapElement,
          projection: 'mercator',
          responsive: true,
          height: 600,
          setProjection: function(element) {
            var projection = d3.geo.mercator()
              .center([0, 0])
              .scale(Math.min(element.offsetWidth / 4.5, element.offsetHeight / 4.5))
              .translate([element.offsetWidth / 2, element.offsetHeight / 1.5]);
            var path = d3.geo.path().projection(projection);
            return {path: path, projection: projection};
          },
          fills: initialFills, // Start with grey colors
          data: data,
          geographyConfig: {
            borderWidth: 1,
            borderColor: '#6b7280',
            popupTemplate: function(geography, data) {
              if (!data) return null;
              
              var countryName = geography.properties.NAME || 
                              geography.properties.name || 
                              geography.properties.NAME_LONG || 
                              geography.properties.ADMIN || 
                              geography.id || 
                              'Unknown';
              
              // Get country flag code - map to proper country codes
              var flagCode = geography.id.toLowerCase();
              var flagMapping = {
                'usa': 'us',
                'ind': 'in', 
                'gbr': 'gb',
                'aus': 'au',
                'bra': 'br',
                'can': 'ca'
              };
              var actualFlagCode = flagMapping[flagCode] || flagCode;
              
              return `<div class="bg-white rounded-xl shadow-xl p-4" style="min-width: 200px;">
                <div class="flex items-center mb-3">
                  <div class="me-3">
                    <div class="size-6 rounded-full bg-no-repeat bg-center bg-cover" style="background-image: url('https://flagcdn.com/w40/${actualFlagCode}.png')"></div>
                  </div>
                  <span class="text-base font-semibold text-gray-800">${countryName}</span>
                </div>
                <div class="space-y-2">
                  <div class="flex items-center justify-between">
                    <span class="text-sm text-gray-500">Views:</span>
                    <span class="text-sm font-medium text-gray-800">${data.views.toLocaleString()}</span>
                  </div>
                  <div class="pt-1 border-t border-gray-100">
                    <span class="text-xs text-gray-400">Click to view states</span>
                  </div>
                </div>
              </div>`;
            },
            highlightFillColor: false,
            highlightBorderColor: '#2563eb',
            highlightBorderWidth: 2,
          },
          done: (datamap) => {
            // Add click event
            datamap.svg.selectAll('.datamaps-subunit').on('click', (geography) => {
              const countryCode = geography.id;
              if (data[countryCode] && this.countryStatesData[countryCode]) {
                this.selectedCountry = countryCode;
                this.location_tab = 'states';
                this.$nextTick(() => this.initStatesChart());
              }
            });

            // Start color transition after 500ms
            setTimeout(() => {
              // Update fills to final colors
              datamap.options.fills = finalFills;
              
              // Animate all data countries simultaneously with smooth fade
              Object.keys(data).forEach((countryCode) => {
                const countryElement = datamap.svg.select('.datamaps-subunit.' + countryCode);
                if (!countryElement.empty()) {
                  const fillKey = data[countryCode].fillKey;
                  const finalColor = finalFills[fillKey];
                  
                  countryElement
                    .transition()
                    .duration(1500)
                    .ease('quad-in-out')
                    .style('fill', finalColor);
                }
              });
              
              // Animate other countries (without data) with smooth fade
              datamap.svg.selectAll('.datamaps-subunit')
                .filter(function(d) {
                  return !data[d.id];
                })
                .transition()
                .duration(1500)
                .ease('quad-in-out')
                .style('fill', finalFills.defaultFill);
              
            }, 300);
          }
        });
        
        // Initialize charts
        this.initCountriesChart();
        this.initStatesChart();
        
        // Add resize listener for map responsiveness (only once)
        if (!this.resizeListenerAdded) {
          window.addEventListener('resize', () => {
            if (this.map && this.location_tab === 'map') {
              this.map.resize();
            }
          });
          this.resizeListenerAdded = true;
        }
      });
    },
    
    // Helper method to check if container is ready
    isContainerReady(element) {
      const rect = element.getBoundingClientRect();
      const computedStyle = window.getComputedStyle(element);
      
      return (
        rect.width > 0 && 
        rect.height > 0 && 
        computedStyle.display !== 'none' &&
        computedStyle.visibility !== 'hidden'
      );
    },
    
    // Method to safely initialize map when tab changes
    initMapSafely() {
      this.$nextTick(() => {
        if (this.location_tab === 'map' && !this.map) {
          this.initMap();
        }
      });
    },
    
    initCountriesChart() {
      const chartElement = document.getElementById('countries-chart');
      if (chartElement && typeof echarts !== 'undefined') {
        // Dispose existing chart if it exists to ensure fresh animation
        if (this.countriesChart) {
          this.countriesChart.dispose();
        }
        
        this.countriesChart = echarts.init(chartElement);
        
        // Country flag mapping
        const countryFlags = {
          'United States': 'us',
          'India': 'in',
          'United Kingdom': 'gb',
          'Australia': 'au',
          'Brazil': 'br',
          'Canada': 'ca'
        };

        // Sort countries by value (highest to lowest)
        const sortedCountries = [
          {value: 2508, name: 'United States'},
          {value: 1434, name: 'India'},
          {value: 892, name: 'United Kingdom'},
          {value: 789, name: 'Australia'},
          {value: 645, name: 'Brazil'},
          {value: 567, name: 'Canada'}
        ].sort((a, b) => b.value - a.value);

        const option = {
          // Add smooth animation
          animation: true,
          animationDuration: 1000,
          animationEasing: 'cubicOut',
          tooltip: {
            trigger: 'axis',
            axisPointer: {
              type: 'shadow'
            },
            formatter: function(params) {
              return params[0].name + '<br/>' + 
                     'Views: ' + params[0].value.toLocaleString() + '<br/>' +
                     '<small style="color: #6b7280;">Click to view states</small>';
            }
          },
          grid: {
            left: '15%',
            right: '15%',
            top: '1%',
            bottom: '12%',
            containLabel: false
          },
          xAxis: {
            type: 'value',
            name: 'Views',
            nameLocation: 'middle',
            nameGap: 30,
            nameTextStyle: {
              color: '#6b7280',
              fontSize: 12,
              fontWeight: 'normal'
            },
            axisLine: {
              show: false
            },
            axisTick: {
              show: false
            },
            axisLabel: {
              color: '#6b7280',
              formatter: function(value) {
                if (value >= 1000) {
                  return (value / 1000).toFixed(value % 1000 === 0 ? 0 : 1) + 'k';
                }
                return value.toString();
              }
            },
            splitLine: {
              lineStyle: {
                color: '#f3f4f6'
              }
            }
          },
          yAxis: {
            type: 'category',
            data: sortedCountries.map(item => item.name),
            inverse: true,
            axisLine: {
              show: false
            },
            axisTick: {
              show: false
            },
            axisLabel: {
              show: false
            }
          },
          series: [{
            data: sortedCountries,
            type: 'bar',
            itemStyle: {
              color: '#2563eb',
              borderRadius: [0, 4, 4, 0]
            },
            barWidth: '60%',
            // Add animation for bars
            animation: true,
            animationDuration: 1000,
            animationEasing: 'cubicOut',
            animationDelay: function(idx) {
              return idx * 100;
            },
            label: {
              show: true,
              position: 'insideLeft',
              color: '#ffffff',
              fontSize: 12,
              fontWeight: 'bold',
              formatter: function(params) {
                return params.data.name;
              }
            }
          }, {
            data: sortedCountries,
            type: 'bar',
            itemStyle: {
              color: 'transparent'
            },
            barWidth: '60%',
            barGap: '-100%',
            // Add animation for labels
            animation: true,
            animationDuration: 1000,
            animationEasing: 'cubicOut',
            animationDelay: function(idx) {
              return idx * 100;
            },
            label: {
              show: true,
              position: 'right',
              color: '#6b7280',
              fontSize: 11,
              offset: [5, 0],
              verticalAlign: 'middle',
              align: 'left',
              formatter: function(params) {
                return params.value.toLocaleString();
              }
            },
            tooltip: {
              show: false
            }
          }, {
            name: 'flags',
            type: 'scatter',
            data: sortedCountries.map((country, index) => [0, index]),
            symbolSize: [24, 18],
            symbolOffset: [-50, 0],
            symbol: function(value, params) {
              const country = sortedCountries[params.dataIndex];
              return `image://https://flagcdn.com/w40/${countryFlags[country.name]}.png`;
            },
            tooltip: {
              show: false
            },
            animation: false
          }]
        };
        
        this.countriesChart.setOption(option);
        
        // Add click event to countries chart
        this.countriesChart.on('click', (params) => {
          const countryName = params.data.name;
          const countryCode = this.getCountryCode(countryName);
          if (countryCode && this.countryStatesData[countryCode]) {
            this.selectedCountry = countryCode;
            this.location_tab = 'states';
            this.$nextTick(() => this.initStatesChart());
          }
        });
      }
    },
    
    getCountryName(countryCode) {
      const countryNames = {
        'USA': 'United States',
        'IND': 'India',
        'GBR': 'United Kingdom',
        'AUS': 'Australia',
        'BRA': 'Brazil',
        'CAN': 'Canada'
      };
      return countryNames[countryCode] || countryCode;
    },

    getCountryCode(countryName) {
      const nameToCode = {
        'United States': 'USA',
        'India': 'IND',
        'United Kingdom': 'GBR',
        'Australia': 'AUS',
        'Brazil': 'BRA',
        'Canada': 'CAN'
      };
      return nameToCode[countryName] || null;
    },

    initStatesChart() {
      const chartElement = document.getElementById('states-chart');
      if (chartElement && typeof echarts !== 'undefined') {
        // Dispose existing chart if it exists
        if (this.statesChart) {
          this.statesChart.dispose();
        }
        
        this.statesChart = echarts.init(chartElement);
        
        // Get data for selected country or default to India's states
        const statesData = this.selectedCountry && this.countryStatesData[this.selectedCountry] 
          ? this.countryStatesData[this.selectedCountry]
          : this.countryStatesData['IND'];
        
        const option = {
          // Add smooth animation
          animation: true,
          animationDuration: 1000,
          animationEasing: 'cubicOut',
          tooltip: {
            trigger: 'axis',
            axisPointer: {
              type: 'shadow'
            },
            formatter: function(params) {
              return params[0].name + '<br/>' + 
                     'Views: ' + params[0].value.toLocaleString();
            }
          },
          grid: {
            left: '15%',
            right: '15%',
            top: '1%',
            bottom: '12%',
            containLabel: false
          },
          xAxis: {
            type: 'value',
            name: 'Views',
            nameLocation: 'middle',
            nameGap: 30,
            nameTextStyle: {
              color: '#6b7280',
              fontSize: 12,
              fontWeight: 'normal'
            },
            axisLine: {
              show: false
            },
            axisTick: {
              show: false
            },
            axisLabel: {
              color: '#6b7280',
              formatter: function(value) {
                if (value >= 1000) {
                  return (value / 1000).toFixed(value % 1000 === 0 ? 0 : 1) + 'k';
                }
                return value.toString();
              }
            },
            splitLine: {
              lineStyle: {
                color: '#f3f4f6'
              }
            }
          },
          yAxis: {
            type: 'category',
            data: statesData.map(item => item.name),
            inverse: true,
            axisLine: {
              show: false
            },
            axisTick: {
              show: false
            },
            axisLabel: {
              show: false
            }
          },
          series: [{
            data: statesData,
            type: 'bar',
            itemStyle: {
              color: '#2563eb',
              borderRadius: [0, 4, 4, 0]
            },
            barWidth: '60%',
            // Add animation for bars
            animation: true,
            animationDuration: 1000,
            animationEasing: 'cubicOut',
            animationDelay: function(idx) {
              return idx * 100;
            },
            label: {
              show: true,
              position: 'insideLeft',
              color: '#ffffff',
              fontSize: 12,
              fontWeight: 'bold',
              formatter: function(params) {
                return params.data.name;
              }
            }
          }, {
            data: statesData,
            type: 'bar',
            itemStyle: {
              color: 'transparent'
            },
            barWidth: '60%',
            barGap: '-100%',
            // Add animation for labels
            animation: true,
            animationDuration: 500,
            animationEasing: 'cubicOut',
            animationDelay: function(idx) {
              return idx * 50;
            },
            label: {
              show: true,
              position: 'right',
              color: '#6b7280',
              fontSize: 11,
              offset: [5, 0],
              verticalAlign: 'middle',
              align: 'left',
              formatter: function(params) {
                return params.value.toLocaleString();
              }
            },
            tooltip: {
              show: false
            }
          }]
        };
        
        this.statesChart.setOption(option);
      }
    }
  };
}
</script> 
  </div>

  <!-- Devices Tab Content -->
  <div x-show="analytics_tab === 'devices'">
    <div class="mt-6" x-data="deviceAnalytics()" x-init="initBrowserChart()">
  <!-- Device Analytics Header -->
  <div class="flex items-center mb-4">
    <!-- Dynamic Title -->
    <div class="flex-1">
      <h3 class="text-lg font-semibold text-gray-800" x-show="device_tab === 'browser'">Device Analytics - Browsers</h3>
      <h3 class="text-lg font-semibold text-gray-800" x-show="device_tab === 'os'">Device Analytics - Operating Systems</h3>
      <h3 class="text-lg font-semibold text-gray-800" x-show="device_tab === 'size'">Device Analytics - Screen Sizes</h3>
      
      <p class="text-sm text-gray-600" x-show="device_tab === 'browser'">View breakdown by web browsers</p>
      <p class="text-sm text-gray-600" x-show="device_tab === 'os'">View breakdown by operating systems</p>
      <p class="text-sm text-gray-600" x-show="device_tab === 'size'">View breakdown by device screen sizes</p>
    </div>
    
    <!-- Device Dropdown -->
    <div class="relative mr-8" x-data="{ open: false }">
      <button @click="open = !open" type="button" class="py-2 px-3 pe-7 flex items-center gap-x-2 text-nowrap w-48 cursor-pointer bg-white border border-gray-200 rounded-lg text-start text-sm text-gray-800 hover:border-gray-300 focus:outline-hidden focus:border-gray-300 dark:bg-neutral-900 dark:border-neutral-800 dark:text-neutral-200 dark:hover:border-neutral-700 dark:focus:border-neutral-700">
        <span x-text="device_tab === 'browser' ? 'Browser' : device_tab === 'os' ? 'Operating System' : 'Screen Size'"></span>
      </button>

      <div class="absolute top-1/2 end-2.5 -translate-y-1/2">
        <svg class="shrink-0 size-3.5 text-gray-500 dark:text-neutral-500" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m7 15 5 5 5-5"/><path d="m7 9 5-5 5 5"/></svg>
      </div>

      <div x-show="open" @click.away="open = false" x-transition:enter="transition ease-out duration-100" x-transition:enter-start="transform opacity-0 scale-95" x-transition:enter-end="transform opacity-100 scale-100" x-transition:leave="transition ease-in duration-75" x-transition:leave-start="transform opacity-100 scale-100" x-transition:leave-end="transform opacity-0 scale-95" class="absolute top-full left-0 z-50 mt-2 w-48 max-h-72 p-1 space-y-0.5 overflow-hidden overflow-y-auto bg-white rounded-xl shadow-xl dark:bg-neutral-900" role="menu" aria-orientation="vertical">
        <a @click.prevent="const scrollY = window.scrollY; device_tab = 'browser'; $nextTick(() => { initBrowserChart(); window.scrollTo(0, scrollY); }); open = false" class="py-2 px-4 w-full text-sm text-gray-800 cursor-pointer hover:bg-gray-100 rounded-lg focus:outline-hidden focus:bg-gray-100 dark:text-neutral-300 dark:hover:bg-neutral-800 dark:focus:bg-neutral-800 flex items-center justify-between" role="menuitem">
          <span>Browser</span>
          <svg x-show="device_tab === 'browser'" class="shrink-0 size-3.5 text-gray-800 dark:text-neutral-200" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
        </a>
        <a @click.prevent="const scrollY = window.scrollY; device_tab = 'os'; $nextTick(() => { initOSChart(); window.scrollTo(0, scrollY); }); open = false" class="py-2 px-4 w-full text-sm text-gray-800 cursor-pointer hover:bg-gray-100 rounded-lg focus:outline-hidden focus:bg-gray-100 dark:text-neutral-300 dark:hover:bg-neutral-800 dark:focus:bg-neutral-800 flex items-center justify-between" role="menuitem">
          <span>Operating System</span>
          <svg x-show="device_tab === 'os'" class="shrink-0 size-3.5 text-gray-800 dark:text-neutral-200" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
        </a>
        <a @click.prevent="const scrollY = window.scrollY; device_tab = 'size'; open = false; $nextTick(() => window.scrollTo(0, scrollY))" class="py-2 px-4 w-full text-sm text-gray-800 cursor-pointer hover:bg-gray-100 rounded-lg focus:outline-hidden focus:bg-gray-100 dark:text-neutral-300 dark:hover:bg-neutral-800 dark:focus:bg-neutral-800 flex items-center justify-between" role="menuitem">
          <span>Screen Size</span>
          <svg x-show="device_tab === 'size'" class="shrink-0 size-3.5 text-gray-800 dark:text-neutral-200" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
        </a>
      </div>
    </div>
  </div>

  <!-- Device Analytics Container -->
  <div class="bg-white relative">
    <!-- Browser Chart -->
    <div x-show="device_tab === 'browser'" class="p-6">
      <div class="flex justify-start">
        <div id="browser-chart" style="width: 800px; height: 500px;"></div>
      </div>
    </div>

    <!-- OS Chart -->
    <div x-show="device_tab === 'os'" class="p-6">
      <div class="flex justify-start">
        <div id="os-chart" style="width: 800px; height: 500px;"></div>
      </div>
    </div>

    <!-- Size Chart -->
    <div x-show="device_tab === 'size'" class="p-6">
      <!-- Circular Progress Design -->
      <div class="flex justify-start items-center min-h-[400px] pl-16">
        <div class="grid grid-cols-4 gap-20">
          <!-- Desktop -->
          <div class="flex flex-col items-center">
            <div class="relative mb-4">
              <!-- Background Circle -->
              <svg class="w-32 h-32 transform -rotate-90" viewBox="0 0 100 100">
                <circle cx="50" cy="50" r="40" stroke="#e5e7eb" stroke-width="8" fill="none"/>
                <circle cx="50" cy="50" r="40" stroke="#2563eb" stroke-width="8" fill="none" 
                        stroke-dasharray="251.2" 
                        stroke-dashoffset="125.6"
                        stroke-linecap="round"
                        class="transition-all duration-1000 ease-out"
                        style="animation: desktopProgress 2s ease-out forwards;"/>
              </svg>
              <!-- Icon in center -->
              <div class="absolute inset-0 flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-10 h-10 text-gray-600">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M9 17.25v1.007a3 3 0 0 1-.879 2.122L7.5 21h9l-.621-.621A3 3 0 0 1 15 18.257V17.25m6-12V15a2.25 2.25 0 0 1-2.25 2.25H5.25A2.25 2.25 0 0 1 3 15V5.25m18 0A2.25 2.25 0 0 0 18.75 3H5.25A2.25 2.25 0 0 0 3 5.25m18 0V12a2.25 2.25 0 0 1-2.25 2.25H5.25A2.25 2.25 0 0 1 3 12V5.25" />
                </svg>
              </div>
              <!-- Value on top -->
              <div class="absolute -top-10 left-1/2 transform -translate-x-1/2">
                <span class="text-xl font-bold text-gray-800">567</span>
              </div>
            </div>
            <h3 class="text-base font-medium text-gray-700">Desktop</h3>
          </div>

          <!-- Mobile -->
          <div class="flex flex-col items-center">
            <div class="relative mb-4">
              <!-- Background Circle -->
              <svg class="w-32 h-32 transform -rotate-90" viewBox="0 0 100 100">
                <circle cx="50" cy="50" r="40" stroke="#e5e7eb" stroke-width="8" fill="none"/>
                <circle cx="50" cy="50" r="40" stroke="#2563eb" stroke-width="8" fill="none" 
                        stroke-dasharray="251.2" 
                        stroke-dashoffset="167.5"
                        stroke-linecap="round"
                        class="transition-all duration-1000 ease-out"
                        style="animation: mobileProgress 2s ease-out forwards;"/>
              </svg>
              <!-- Icon in center -->
              <div class="absolute inset-0 flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-10 h-10 text-gray-600">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 1.5H8.25A2.25 2.25 0 0 0 6 3.75v16.5a2.25 2.25 0 0 0 2.25 2.25h7.5A2.25 2.25 0 0 0 18 20.25V3.75a2.25 2.25 0 0 0-2.25-2.25H13.5m-3 0V3h3V1.5m-3 0h3m-3 18.75h3" />
                </svg>
              </div>
              <!-- Value on top -->
              <div class="absolute -top-10 left-1/2 transform -translate-x-1/2">
                <span class="text-xl font-bold text-gray-800">334</span>
              </div>
            </div>
            <h3 class="text-base font-medium text-gray-700">Mobile</h3>
          </div>

          <!-- Tablet -->
          <div class="flex flex-col items-center">
            <div class="relative mb-4">
              <!-- Background Circle -->
              <svg class="w-32 h-32 transform -rotate-90" viewBox="0 0 100 100">
                <circle cx="50" cy="50" r="40" stroke="#e5e7eb" stroke-width="8" fill="none"/>
                <circle cx="50" cy="50" r="40" stroke="#2563eb" stroke-width="8" fill="none" 
                        stroke-dasharray="251.2" 
                        stroke-dashoffset="188.4"
                        stroke-linecap="round"
                        class="transition-all duration-1000 ease-out"
                        style="animation: tabletProgress 2s ease-out forwards;"/>
              </svg>
              <!-- Icon in center -->
              <div class="absolute inset-0 flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-10 h-10 text-gray-600">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5h3m-6.75 2.25h10.5a2.25 2.25 0 0 0 2.25-2.25v-15a2.25 2.25 0 0 0-2.25-2.25H6.75A2.25 2.25 0 0 0 4.5 4.5v15a2.25 2.25 0 0 0 2.25 2.25Z" />
                </svg>
              </div>
              <!-- Value on top -->
              <div class="absolute -top-10 left-1/2 transform -translate-x-1/2">
                <span class="text-xl font-bold text-gray-800">189</span>
              </div>
            </div>
            <h3 class="text-base font-medium text-gray-700">Tablet</h3>
          </div>

          <!-- Others -->
          <div class="flex flex-col items-center">
            <div class="relative mb-4">
              <!-- Background Circle -->
              <svg class="w-32 h-32 transform -rotate-90" viewBox="0 0 100 100">
                <circle cx="50" cy="50" r="40" stroke="#e5e7eb" stroke-width="8" fill="none"/>
                <circle cx="50" cy="50" r="40" stroke="#2563eb" stroke-width="8" fill="none" 
                        stroke-dasharray="251.2" 
                        stroke-dashoffset="236.3"
                        stroke-linecap="round"
                        class="transition-all duration-1000 ease-out"
                        style="animation: othersProgress 2s ease-out forwards;"/>
              </svg>
              <!-- Icon in center -->
              <div class="absolute inset-0 flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-10 h-10 text-gray-600">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 12a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0ZM12.75 12a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0ZM18.75 12a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Z" />
                </svg>
              </div>
              <!-- Value on top -->
              <div class="absolute -top-10 left-1/2 transform -translate-x-1/2">
                <span class="text-xl font-bold text-gray-800">67</span>
              </div>
            </div>
            <h3 class="text-base font-medium text-gray-700">Others</h3>
          </div>
        </div>
      </div>

      <!-- CSS Animations -->
      <style>
        @keyframes desktopProgress {
          from { stroke-dashoffset: 251.2; }
          to { stroke-dashoffset: 125.6; } /* 50% progress (567/1157 total) */
        }
        @keyframes mobileProgress {
          from { stroke-dashoffset: 251.2; }
          to { stroke-dashoffset: 167.5; } /* 33% progress (334/1157 total) */
        }
        @keyframes tabletProgress {
          from { stroke-dashoffset: 251.2; }
          to { stroke-dashoffset: 188.4; } /* 25% progress (189/1157 total) */
        }
        @keyframes othersProgress {
          from { stroke-dashoffset: 251.2; }
          to { stroke-dashoffset: 236.3; } /* 6% progress (67/1157 total) */
        }
      </style>
    </div>
  </div>
</div>

<script>
function deviceAnalytics() {
  return {
    device_tab: 'browser',
    browserChart: null,
    osChart: null,

    initBrowserChart() {
      const chartElement = document.getElementById('browser-chart');
      if (chartElement && typeof echarts !== 'undefined') {
        // Dispose existing chart if it exists to ensure fresh animation
        if (this.browserChart) {
          this.browserChart.dispose();
        }
        
        this.browserChart = echarts.init(chartElement);
        
        // Browser data sorted by value (highest to lowest)
        const browserData = [
          {value: 845, name: 'Chrome'},
          {value: 623, name: 'Safari'},
          {value: 456, name: 'Firefox'},
          {value: 234, name: 'Edge'},
          {value: 156, name: 'Opera'},
          {value: 89, name: 'Other'}
        ].sort((a, b) => b.value - a.value);
        
        // Browser logo mapping
        const browserLogos = {
          'Chrome': 'https://cdnjs.cloudflare.com/ajax/libs/browser-logos/75.0.1/chrome/chrome_64x64.png',
          'Safari': 'https://cdnjs.cloudflare.com/ajax/libs/browser-logos/75.0.1/safari/safari_64x64.png',
          'Firefox': 'https://cdnjs.cloudflare.com/ajax/libs/browser-logos/75.0.1/firefox/firefox_64x64.png',
          'Edge': 'https://cdnjs.cloudflare.com/ajax/libs/browser-logos/75.0.1/edge/edge_64x64.png',
          'Opera': 'https://cdnjs.cloudflare.com/ajax/libs/browser-logos/75.0.1/opera/opera_64x64.png',
        };
        
        const option = {
          // Add smooth animation
          animation: true,
          animationDuration: 1000,
          animationEasing: 'cubicOut',
          tooltip: {
            trigger: 'axis',
            axisPointer: {
              type: 'shadow'
            },
            formatter: function(params) {
              return params[0].name + '<br/>' + 
                     'Views: ' + params[0].value.toLocaleString();
            }
          },
          grid: {
            left: '15%',
            right: '15%',
            top: '1%',
            bottom: '12%',
            containLabel: false
          },
          xAxis: {
            type: 'value',
            name: 'Views',
            nameLocation: 'middle',
            nameGap: 30,
            nameTextStyle: {
              color: '#6b7280',
              fontSize: 12,
              fontWeight: 'normal'
            },
            axisLine: {
              show: false
            },
            axisTick: {
              show: false
            },
            axisLabel: {
              color: '#6b7280',
              formatter: function(value) {
                if (value >= 1000) {
                  return (value / 1000).toFixed(value % 1000 === 0 ? 0 : 1) + 'k';
                }
                return value.toString();
              }
            },
            splitLine: {
              lineStyle: {
                color: '#f3f4f6'
              }
            }
          },
          yAxis: {
            type: 'category',
            data: browserData.map(item => item.name),
            inverse: true,
            axisLine: {
              show: false
            },
            axisTick: {
              show: false
            },
            axisLabel: {
              show: false
            }
          },
          series: [{
            data: browserData,
            type: 'bar',
            itemStyle: {
              color: '#2563eb',
              borderRadius: [0, 4, 4, 0]
            },
            barWidth: '60%',
            // Add animation for bars
            animation: true,
            animationDuration: 1000,
            animationEasing: 'cubicOut',
            animationDelay: function(idx) {
              return idx * 100;
            },
            label: {
              show: true,
              position: 'insideLeft',
              color: '#ffffff',
              fontSize: 12,
              fontWeight: 'bold',
              formatter: function(params) {
                return params.data.name;
              }
            }
          }, {
            data: browserData,
            type: 'bar',
            itemStyle: {
              color: 'transparent'
            },
            barWidth: '60%',
            barGap: '-100%',
            // Add animation for labels
            animation: true,
            animationDuration: 1000,
            animationEasing: 'cubicOut',
            animationDelay: function(idx) {
              return idx * 100;
            },
            label: {
              show: true,
              position: 'right',
              color: '#6b7280',
              fontSize: 11,
              offset: [5, 0],
              verticalAlign: 'middle',
              align: 'left',
              formatter: function(params) {
                return params.value.toLocaleString();
              }
            },
            tooltip: {
              show: false
            }
          }, {
            // Browser logos as scatter series
            type: 'scatter',
            data: browserData.map((browser, index) => [0, index]),
            symbolSize: [32, 32],
            symbolOffset: [-50, 0],
            symbol: function(value, params) {
              const browser = browserData[params.dataIndex];
              const logoUrl = browserLogos[browser.name];
              return `image://${logoUrl}`;
            },
            tooltip: {
              show: false
            },
            animation: true,
            animationDuration: 1000,
            animationEasing: 'cubicOut',
            animationDelay: function(idx) {
              return idx * 100;
            }
          }]
        };
        
        this.browserChart.setOption(option);
      }
    },
    
    initOSChart() {
      const chartElement = document.getElementById('os-chart');
      if (chartElement && typeof echarts !== 'undefined') {
        // Dispose existing chart if it exists to ensure fresh animation
        if (this.osChart) {
          this.osChart.dispose();
        }
        
        this.osChart = echarts.init(chartElement);
        
        // OS data sorted by value (highest to lowest)
        const osData = [
          {value: 734, name: 'Windows'},
          {value: 623, name: 'macOS'},
          {value: 456, name: 'Android'},
          {value: 334, name: 'iOS'},
          {value: 189, name: 'Linux'},
          {value: 67, name: 'Other'}
        ].sort((a, b) => b.value - a.value);
        
        // OS logo mapping
        const osLogos = {
          'Windows': 'https://img.icons8.com/color/64/000000/windows-10.png',
          'macOS': 'https://img.icons8.com/color/64/000000/mac-os.png',
          'Android': 'https://img.icons8.com/color/64/000000/android-os.png',
          'iOS': 'https://img.icons8.com/color/64/000000/ios-logo.png',
          'Linux': 'https://img.icons8.com/color/64/000000/linux.png',
        };
        
        const option = {
          // Add smooth animation
          animation: true,
          animationDuration: 1000,
          animationEasing: 'cubicOut',
          tooltip: {
            trigger: 'axis',
            axisPointer: {
              type: 'shadow'
            },
            formatter: function(params) {
              return params[0].name + '<br/>' + 
                     'Views: ' + params[0].value.toLocaleString();
            }
          },
          grid: {
            left: '15%',
            right: '15%',
            top: '1%',
            bottom: '12%',
            containLabel: false
          },
          xAxis: {
            type: 'value',
            name: 'Views',
            nameLocation: 'middle',
            nameGap: 30,
            nameTextStyle: {
              color: '#6b7280',
              fontSize: 12,
              fontWeight: 'normal'
            },
            axisLine: {
              show: false
            },
            axisTick: {
              show: false
            },
            axisLabel: {
              color: '#6b7280',
              formatter: function(value) {
                if (value >= 1000) {
                  return (value / 1000).toFixed(value % 1000 === 0 ? 0 : 1) + 'k';
                }
                return value.toString();
              }
            },
            splitLine: {
              lineStyle: {
                color: '#f3f4f6'
              }
            }
          },
          yAxis: {
            type: 'category',
            data: osData.map(item => item.name),
            inverse: true,
            axisLine: {
              show: false
            },
            axisTick: {
              show: false
            },
            axisLabel: {
              show: false
            }
          },
          series: [{
            data: osData,
            type: 'bar',
            itemStyle: {
              color: '#2563eb',
              borderRadius: [0, 4, 4, 0]
            },
            barWidth: '60%',
            // Add animation for bars
            animation: true,
            animationDuration: 1000,
            animationEasing: 'cubicOut',
            animationDelay: function(idx) {
              return idx * 100;
            },
            label: {
              show: true,
              position: 'insideLeft',
              color: '#ffffff',
              fontSize: 12,
              fontWeight: 'bold',
              formatter: function(params) {
                return params.data.name;
              }
            }
          }, {
            data: osData,
            type: 'bar',
            itemStyle: {
              color: 'transparent'
            },
            barWidth: '60%',
            barGap: '-100%',
            // Add animation for labels
            animation: true,
            animationDuration: 1000,
            animationEasing: 'cubicOut',
            animationDelay: function(idx) {
              return idx * 100;
            },
            label: {
              show: true,
              position: 'right',
              color: '#6b7280',
              fontSize: 11,
              offset: [5, 0],
              verticalAlign: 'middle',
              align: 'left',
              formatter: function(params) {
                return params.value.toLocaleString();
              }
            },
            tooltip: {
              show: false
            }
          }, {
            // OS logos as scatter series
            type: 'scatter',
            data: osData.map((os, index) => [0, index]),
            symbolSize: [32, 32],
            symbolOffset: [-50, 0],
            symbol: function(value, params) {
              const os = osData[params.dataIndex];
              const logoUrl = osLogos[os.name];
              return `image://${logoUrl}`;
            },
            tooltip: {
              show: false
            },
            animation: true,
            animationDuration: 1000,
            animationEasing: 'cubicOut',
            animationDelay: function(idx) {
              return idx * 100;
            }
          }]
        };
        
        this.osChart.setOption(option);
      }
    }
  };
}
</script> 
  </div>
</div>  