<div x-data="{ analytics_tab: 'overview', ...chartComponent() }" x-show="!disableAnalytics">

  <!-- Overview Section (kept as is) -->
  <div>
    <div class="flex items-center justify-end mt-4">
      <button type="button"
        class="relative inline-flex items-center justify-center flex-shrink-0 w-10 h-5 rounded-full cursor-pointer group focus:outline-none focus:ring-2 focus:ring-blue-600 focus:ring-offset-2"
        role="switch" :aria-checked="showSeparate.toString()" @click="toggleCharts">
        <span class="sr-only">Use setting</span>
        <span aria-hidden="true" class="absolute w-full h-full bg-white rounded-md pointer-events-none"></span>
        <span aria-hidden="true"
          class="absolute h-4 mx-auto transition-colors duration-200 ease-in-out bg-gray-200 rounded-full pointer-events-none w-9"
          :class="{ 'bg-blue-600': showSeparate }"></span>
        <span aria-hidden="true"
          class="absolute left-0 inline-block w-5 h-5 transition-transform duration-200 ease-in-out transform translate-x-0 bg-white border border-gray-200 rounded-full shadow pointer-events-none ring-0"
          :class="{ 'translate-x-5': showSeparate }"></span>
      </button>
      <span class="ml-3 text-sm" id="annual-billing-label">
        <span class="font-medium text-gray-900">Split Charts</span>
      </span>
    </div>

    <div class="flex justify-center">
      <div id="views_chart" :hidden="!showSeparate" class="w-80 h-52 sm:w-[600px] sm:h-[400px] md:w-[700px] sm:w-[600px] sm:h-[400px] md:h-[400px] 2xl:w-[1000px] 2xl:h-[500px] mt-4"></div>
    </div>
    <div class="flex justify-center">
      <div id="minutes_watched_chart" :hidden="!showSeparate" class="w-80 h-52 sm:w-[600px] sm:h-[400px] md:w-[700px] sm:w-[600px] sm:h-[400px] md:h-[400px] 2xl:w-[1000px] 2xl:h-[500px] mt-4"></div>
    </div>
    <div class="flex justify-center">
      <div id="chart" :hidden="showSeparate" class="w-80 h-52 sm:w-[600px] sm:h-[400px] md:w-[700px] sm:w-[600px] sm:h-[400px] md:h-[400px] 2xl:w-[1000px] 2xl:h-[500px] mt-4"></div>
    </div>
  </div>

  <!-- New Analytics Boxes Section -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-8 mb-8 px-20">
    
    <!-- Regions Box -->
    <div class="bg-white rounded-lg border border-gray-200 shadow-sm relative" style="width: 450px; height: 400px;" x-data="locationAnalytics()" x-init="initMap()">
  <!-- Location Analytics Container -->
  <div class="relative px-3 pt-0 pb-2 h-full flex flex-col">
    <!-- Header with Title and Tabs -->
    <div class="flex items-center justify-between mb-2 pt-1 pl-3">
      <!-- Title -->
      <h3 class="text-lg font-semibold text-gray-800">Locations</h3>
      
      <!-- Location Tabs -->
      <div class="flex space-x-3">
        <button @click="location_tab = 'map'; setTimeout(() => initMapSafely(), 50)" 
                class="text-xs font-medium transition-colors cursor-pointer px-2 py-1"
                :class="location_tab === 'map' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-500 hover:text-gray-700'">
          Map
        </button>
        <button @click="location_tab = 'countries'; setTimeout(() => initCountriesChart(), 50)" 
                class="text-xs font-medium transition-colors cursor-pointer px-2 py-1"
                :class="location_tab === 'countries' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-500 hover:text-gray-700'">
          Countries
        </button>
        <button @click="location_tab = 'states'; if(!selectedCountry) selectedCountry = 'IND'; setTimeout(() => initStatesChart(), 50)" 
                class="text-xs font-medium transition-colors cursor-pointer px-2 py-1"
                :class="location_tab === 'states' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-500 hover:text-gray-700'">
          States
        </button>
      </div>
    </div>
    <!-- Content Area -->
    <div class="flex-1 flex items-end justify-center">
      <!-- Map View -->
      <div x-show="location_tab === 'map'" class="w-full h-[350px]">
        <div id="world-map" class="w-full h-full"></div>
      </div>

      <!-- Countries Flow Chart -->
      <div x-show="location_tab === 'countries'" class="w-full h-[350px] flex flex-col">
        <!-- Column Headers -->
        <div class="flex justify-between items-center px-4 pt-2 pb-0">
          <h4 class="text-sm font-medium text-gray-600">Country</h4>
          <h4 class="text-sm font-medium text-gray-600 pr-2">Views</h4>
        </div>
        <!-- Chart Container -->
        <div class="flex-1">
          <div id="countries-chart" class="w-full h-full"></div>
        </div>
      </div>

      <!-- States Flow Chart -->
      <div x-show="location_tab === 'states'" class="w-full h-[350px] flex flex-col">
        <!-- Column Headers -->
        <div class="flex justify-between items-center px-4 pt-2 pb-0">
          <h4 class="text-sm font-medium text-gray-600">State</h4>
          <h4 class="text-sm font-medium text-gray-600 pr-2">Views</h4>
        </div>
        <!-- Chart Container -->
        <div class="flex-1">
          <div id="states-chart" class="w-full h-full"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
function locationAnalytics() {
  return {
    location_tab: 'map',
    map: null,
    countriesChart: null,
    statesChart: null,
    selectedCountry: null,
    resizeListenerAdded: false,
    resizeTimeout: null,
    countryStatesData: {
      'USA': [
        {value: 845, name: 'California'},
        {value: 623, name: 'Texas'},
        {value: 445, name: 'New York'},
        {value: 334, name: 'Florida'},
        {value: 261, name: 'Illinois'}
      ],
      'IND': [
        {value: 456, name: 'Maharashtra'},
        {value: 289, name: 'Karnataka'},
        {value: 234, name: 'Delhi'},
        {value: 189, name: 'Tamil Nadu'},
        {value: 156, name: 'Gujarat'},
        {value: 110, name: 'West Bengal'}
      ],
      'GBR': [
        {value: 334, name: 'London'},
        {value: 189, name: 'Manchester'},
        {value: 156, name: 'Birmingham'},
        {value: 123, name: 'Liverpool'},
        {value: 90, name: 'Leeds'}
      ],
      'AUS': [
        {value: 267, name: 'New South Wales'},
        {value: 189, name: 'Victoria'},
        {value: 156, name: 'Queensland'},
        {value: 123, name: 'Western Australia'},
        {value: 54, name: 'South Australia'}
      ],
      'BRA': [
        {value: 234, name: 'SÃ£o Paulo'},
        {value: 178, name: 'Rio de Janeiro'},
        {value: 123, name: 'Minas Gerais'},
        {value: 110, name: 'Bahia'}
      ],
      'CAN': [
        {value: 223, name: 'Ontario'},
        {value: 134, name: 'Quebec'},
        {value: 123, name: 'British Columbia'},
        {value: 87, name: 'Alberta'}
      ]
    },
    initMap() {
      // Prevent multiple Datamap instances - return early if map already exists
      if (this.map) {
        return;
      }
      
      // Use Alpine's $nextTick to ensure DOM is ready
      this.$nextTick(() => {
        // Check if we're on the map tab and container is visible
        if (this.location_tab !== 'map') {
          return; // Don't initialize if not on map tab
        }
        
        const mapElement = document.getElementById('world-map');
        
        // Ensure container exists and has dimensions
        if (!mapElement || !this.isContainerReady(mapElement)) {
          // Retry after a short delay if container not ready
          setTimeout(() => this.initMap(), 100);
          return;
        }
        
        // Check if libraries are loaded
        if (typeof Datamap === 'undefined' || typeof d3 === 'undefined') {
          console.log('Map libraries not loaded yet, retrying...');
          setTimeout(() => this.initMap(), 200);
          return;
        }
        
        // Clear any existing content
        mapElement.innerHTML = '';
        
        const data = {
          'USA': { fillKey: 'high', views: 2508 },
          'IND': { fillKey: 'high', views: 1434 },
          'GBR': { fillKey: 'medium', views: 892 },
          'AUS': { fillKey: 'medium', views: 789 },
          'BRA': { fillKey: 'medium', views: 645 },
          'CAN': { fillKey: 'medium', views: 567 }
        };

        // Use final colors directly - no transition needed
        const mapFills = {
          'high': '#1e40af',
          'medium': '#3b82f6',
          'low': '#93c5fd',
          defaultFill: '#f3f4f6'
        };

        this.map = new Datamap({
          element: mapElement,
          projection: 'mercator',
          responsive: true,
          aspectRatio: 0.6,
          setProjection: function(element) {
            // Calculate truly adaptive scale for full map visibility
            var containerWidth = element.offsetWidth;
            var containerHeight = element.offsetHeight;
            
            // For Mercator projection, use more conservative scaling to prevent cropping
            var baseScale = Math.min(containerWidth / 6, containerHeight / 3.8);
            
            // Add extra padding to ensure full visibility including northern regions
            var paddingFactor = 0.9;
            var scale = baseScale * paddingFactor;
            
            // Ensure minimum scale for very small screens
            scale = Math.max(scale, 45);
            
            var projection = d3.geo.mercator()
              .center([0, 10])  // Slight southern offset to show more of the north
              .scale(scale)
              .translate([containerWidth / 2, containerHeight * 0.55]); // Move map slightly down
            var path = d3.geo.path().projection(projection);
            return {path: path, projection: projection};
          },
          fills: mapFills, // Use final colors directly
          data: data,
          geographyConfig: {
            borderWidth: 1,
            borderColor: '#6b7280',
            popupTemplate: function(geography, data) {
              if (!data) return null;
              
              var countryName = geography.properties.NAME || 
                              geography.properties.name || 
                              geography.properties.NAME_LONG || 
                              geography.properties.ADMIN || 
                              geography.id || 
                              'Unknown';
              
              // Get country flag code - map to proper country codes
              var flagCode = geography.id.toLowerCase();
              var flagMapping = {
                'usa': 'us',
                'ind': 'in', 
                'gbr': 'gb',
                'aus': 'au',
                'bra': 'br',
                'can': 'ca'
              };
              var actualFlagCode = flagMapping[flagCode] || flagCode;
              
              // Detect browser zoom level and adjust popup size accordingly
              var zoomLevel = window.devicePixelRatio || 1;
              var screenWidth = window.innerWidth;
              
              // Calculate responsive popup dimensions based on zoom and screen size
              var baseWidth = 100;
              var basePadding = 10;
              var baseFontSize = 12;
              var baseSmallFontSize = 10;
              var baseFlagSize = 12;
              
              // Adjust for zoom level - smaller popup when zoomed in
              var zoomAdjustment = Math.max(0.7, Math.min(1.2, 1 / Math.sqrt(zoomLevel)));
              
              // Adjust for screen size
              var screenAdjustment = screenWidth < 640 ? 0.85 : screenWidth < 1024 ? 0.95 : 1;
              
              var finalAdjustment = zoomAdjustment * screenAdjustment;
              
              var popupWidth = Math.round(baseWidth * finalAdjustment);
              var popupPadding = Math.round(basePadding * finalAdjustment);
              var fontSize = Math.round(baseFontSize * finalAdjustment);
              var smallFontSize = Math.round(baseSmallFontSize * finalAdjustment);
              var flagSize = Math.round(baseFlagSize * finalAdjustment);
              
              return `<div class="bg-white rounded-xl shadow-xl" style="min-width: ${popupWidth}px; padding: ${popupPadding}px; min-height: 60px; z-index: 9999;">
                <div class="flex items-center">
                  <div class="me-3">
                    <div class="rounded-full bg-no-repeat bg-center bg-cover" style="width: ${flagSize}px; height: ${flagSize}px; background-image: url('https://flagcdn.com/w40/${actualFlagCode}.png')"></div>
                  </div>
                  <span class="font-semibold text-gray-800" style="font-size: ${fontSize}px;">${countryName}</span>
                </div>
                <div class="space-y-2">
                    <span class="text-gray-500" style="font-size: ${smallFontSize}px;">Views:</span>
                    <span class="font-medium text-gray-800" style="font-size: ${smallFontSize}px;">${data.views.toLocaleString()}</span>
                </div>
              </div>`;
            },
            highlightFillColor: false,
            highlightBorderColor: '#2563eb',
            highlightBorderWidth: 2,
          },
          done: (datamap) => {
            // Add click event
            datamap.svg.selectAll('.datamaps-subunit').on('click', (geography) => {
              const countryCode = geography.id;
              if (data[countryCode] && this.countryStatesData[countryCode]) {
                this.selectedCountry = countryCode;
                this.location_tab = 'states';
                this.$nextTick(() => this.initStatesChart());
              }
            });
          }
        });
        
        // Initialize charts
        this.initCountriesChart();
        this.initStatesChart();
        
        // Add resize listener for map responsiveness (only once)
        if (!this.resizeListenerAdded) {
          // Window resize listener
          window.addEventListener('resize', () => {
            // Debounce resize events
            clearTimeout(this.resizeTimeout);
            this.resizeTimeout = setTimeout(() => {
              if (this.map && this.location_tab === 'map') {
                // For Datamap, we need to reinitialize rather than just resize
                this.refreshMap();
              }
              if (this.countriesChart) this.countriesChart.resize();
              if (this.statesChart) this.statesChart.resize();
            }, 150);
          });
          
          // Also add ResizeObserver for better container size detection
          if (window.ResizeObserver) {
            const resizeObserver = new ResizeObserver((entries) => {
              clearTimeout(this.resizeTimeout);
              this.resizeTimeout = setTimeout(() => {
                if (this.map && this.location_tab === 'map') {
                  this.refreshMap();
                }
              }, 150);
            });
            resizeObserver.observe(mapElement);
          }
          
          this.resizeListenerAdded = true;
        }
      });
    },
    
    // Helper method to check if container is ready
    isContainerReady(element) {
      const rect = element.getBoundingClientRect();
      const computedStyle = window.getComputedStyle(element);
      
      return (
        rect.width > 0 && 
        rect.height > 0 && 
        computedStyle.display !== 'none' &&
        computedStyle.visibility !== 'hidden'
      );
    },
    
    // Method to safely initialize map when tab changes
    initMapSafely() {
      this.$nextTick(() => {
        if (this.location_tab === 'map' && !this.map) {
          this.initMap();
        }
      });
    },
    
    // Method to refresh map on resize
    refreshMap() {
      if (this.map && this.location_tab === 'map') {
        const mapElement = document.getElementById('world-map');
        if (mapElement && this.isContainerReady(mapElement)) {
          // Store current state
          const wasMapInitialized = !!this.map;
          
          // Dispose current map
          if (this.map) {
            this.map = null;
          }
          
          // Clear container
          mapElement.innerHTML = '';
          
          // Reinitialize with new dimensions
          if (wasMapInitialized) {
            this.initMap();
          }
        }
      }
    },
    
    initCountriesChart() {
      const chartElement = document.getElementById('countries-chart');
      if (chartElement && typeof echarts !== 'undefined') {
        // Wait for container to be visible and have dimensions
        const waitForContainer = () => {
          const rect = chartElement.getBoundingClientRect();
          if (rect.width === 0 || rect.height === 0) {
            setTimeout(waitForContainer, 50);
            return;
          }
          
          // Dispose existing chart if it exists to ensure fresh animation
          if (this.countriesChart) {
            this.countriesChart.dispose();
          }
          
          this.countriesChart = echarts.init(chartElement);
          this.setupCountriesChart();
        };
        
        waitForContainer();
      }
    },

    generateAlignedGraphics(chart, data) {
      if (!chart) return [];
      
      const chartHeight = chart.getHeight();
      const gridTopPercent = 5; // from grid.top: '5%'
      const gridBottomPercent = 15; // from grid.bottom: '15%'
      
      // Calculate usable height in pixels
      const topOffset = (gridTopPercent / 100) * chartHeight;
      const bottomOffset = (gridBottomPercent / 100) * chartHeight;
      const usableHeight = chartHeight - topOffset - bottomOffset;
      
      // Calculate height per bar
      const barHeight = usableHeight / data.length;
      
      return data.map((item, index) => {
        // Calculate Y position: start from top offset + half bar height + index * bar height
        const yPosition = topOffset + (barHeight / 2) + (index * barHeight);
        
        return {
          type: 'text',
          left: '87%',
          top: yPosition,
          style: {
            text: item.value.toLocaleString(),
            fontSize: 12,
            fill: '#6b7280',
            textAlign: 'right'
          }
        };
      });
    },

    setupCountriesChart() {
      if (!this.countriesChart) return;
        
      // Add resize listener for responsiveness
      if (!this.resizeListenerAdded) {
        window.addEventListener('resize', () => {
          if (this.countriesChart) this.countriesChart.resize();
          if (this.statesChart) this.statesChart.resize();
        });
        this.resizeListenerAdded = true;
      }
      
      // Country flag mapping
      const countryFlags = {
        'United States': 'us',
        'India': 'in',
        'United Kingdom': 'gb',
        'Australia': 'au',
        'Brazil': 'br',
        'Canada': 'ca'
      };

      // Sort countries by value (highest to lowest)
      const sortedCountries = [
        {value: 2508, name: 'United States'},
        {value: 1434, name: 'India'},
        {value: 892, name: 'United Kingdom'},
        {value: 789, name: 'Australia'},
        {value: 645, name: 'Brazil'},
        {value: 567, name: 'Canada'}
      ].sort((a, b) => b.value - a.value);

      const option = {
        // Add smooth animation
        animation: true,
        animationDuration: 1000,
        animationEasing: 'cubicOut',
        tooltip: {
          trigger: 'axis',
          axisPointer: {
            type: 'shadow'
          },
          formatter: function(params) {
            return params[0].name + '<br/>' + 
                   'Views: ' + params[0].value.toLocaleString() + '<br/>' +
                   '<small style="color: #6b7280;">Click to view states</small>';
          }
        },
        grid: {
          left: '5%',
          right: '15%',
          top: '5%',
          bottom: '15%',
          containLabel: false
        },
        graphic: this.generateAlignedGraphics(this.countriesChart, sortedCountries),
        xAxis: {
          type: 'value',
          show: false
        },
        yAxis: {
          type: 'category',
          data: sortedCountries.map(item => item.name),
          inverse: true,
          show: false
        },
        series: [{
          data: sortedCountries,
          type: 'bar',
          itemStyle: {
            color: '#fef3c7',
            borderRadius: [0, 4, 4, 0]
          },
          barWidth: '60%',
          // Add animation for bars
          animation: true,
          animationDuration: 1000,
          animationEasing: 'cubicOut',
          animationDelay: function(idx) {
            return idx * 100;
          },
          label: {
            show: true,
            position: 'insideLeft',
            color: '#374151',
            fontSize: 12,
            fontWeight: 'normal',
            offset: [10, 0],
            rich: {
              us: {
                backgroundColor: {
                  image: 'https://flagcdn.com/16x12/us.png'
                },
                width: 16,
                height: 12,
                borderRadius: 2
              },
              in: {
                backgroundColor: {
                  image: 'https://flagcdn.com/16x12/in.png'
                },
                width: 16,
                height: 12,
                borderRadius: 2
              },
              gb: {
                backgroundColor: {
                  image: 'https://flagcdn.com/16x12/gb.png'
                },
                width: 16,
                height: 12,
                borderRadius: 2
              },
              au: {
                backgroundColor: {
                  image: 'https://flagcdn.com/16x12/au.png'
                },
                width: 16,
                height: 12,
                borderRadius: 2
              },
              br: {
                backgroundColor: {
                  image: 'https://flagcdn.com/16x12/br.png'
                },
                width: 16,
                height: 12,
                borderRadius: 2
              },
              ca: {
                backgroundColor: {
                  image: 'https://flagcdn.com/16x12/ca.png'
                },
                width: 16,
                height: 12,
                borderRadius: 2
              }
            },
            formatter: function(params) {
              const flagCodes = {
                'United States': 'us',
                'India': 'in',
                'United Kingdom': 'gb',
                'Australia': 'au',
                'Brazil': 'br',
                'Canada': 'ca'
              };
              const code = flagCodes[params.data.name];
              return code ? `{${code}|}   ${params.data.name}` : params.data.name;
            }
          }
        }]
      };
      
      this.countriesChart.setOption(option);
      
      // Add click event to countries chart
      this.countriesChart.on('click', (params) => {
        const countryName = params.data.name;
        const countryCode = this.getCountryCode(countryName);
        if (countryCode && this.countryStatesData[countryCode]) {
          this.selectedCountry = countryCode;
          this.location_tab = 'states';
          this.$nextTick(() => this.initStatesChart());
        }
      });
      
      // Final resize to ensure proper dimensions
      setTimeout(() => {
        if (this.countriesChart) this.countriesChart.resize();
      }, 100);
    },
    
    getCountryName(countryCode) {
      const countryNames = {
        'USA': 'United States',
        'IND': 'India',
        'GBR': 'United Kingdom',
        'AUS': 'Australia',
        'BRA': 'Brazil',
        'CAN': 'Canada'
      };
      return countryNames[countryCode] || countryCode;
    },

    getCountryCode(countryName) {
      const nameToCode = {
        'United States': 'USA',
        'India': 'IND',
        'United Kingdom': 'GBR',
        'Australia': 'AUS',
        'Brazil': 'BRA',
        'Canada': 'CAN'
      };
      return nameToCode[countryName] || null;
    },

    initStatesChart() {
      const chartElement = document.getElementById('states-chart');
      if (chartElement && typeof echarts !== 'undefined') {
        // Wait for container to be visible and have dimensions
        const waitForContainer = () => {
          const rect = chartElement.getBoundingClientRect();
          if (rect.width === 0 || rect.height === 0) {
            setTimeout(waitForContainer, 50);
            return;
          }
          
          // Dispose existing chart if it exists
          if (this.statesChart) {
            this.statesChart.dispose();
          }
          
          this.statesChart = echarts.init(chartElement);
          this.setupStatesChart();
        };
        
        waitForContainer();
      }
    },

    setupStatesChart() {
      if (!this.statesChart) return;
        
      // Ensure resize listener is added
      if (!this.resizeListenerAdded) {
        window.addEventListener('resize', () => {
          if (this.countriesChart) this.countriesChart.resize();
          if (this.statesChart) this.statesChart.resize();
        });
        this.resizeListenerAdded = true;
      }
      
      // Get data for selected country or default to India's states
      const statesData = this.selectedCountry && this.countryStatesData[this.selectedCountry] 
        ? this.countryStatesData[this.selectedCountry]
        : this.countryStatesData['IND'];
      
      // Get country flag for the selected country
      const countryFlagCodes = {
        'USA': 'us',
        'IND': 'in', 
        'GBR': 'gb',
        'AUS': 'au',
        'BRA': 'br',
        'CAN': 'ca'
      };
      
      const selectedCountryCode = this.selectedCountry || 'IND';
      const flagCode = countryFlagCodes[selectedCountryCode];
      
      const option = {
        // Add smooth animation
        animation: true,
        animationDuration: 1000,
        animationEasing: 'cubicOut',
        tooltip: {
          trigger: 'axis',
          axisPointer: {
            type: 'shadow'
          },
          formatter: function(params) {
            return params[0].name + '<br/>' + 
                   'Views: ' + params[0].value.toLocaleString();
          }
        },
        grid: {
          left: '5%',
          right: '15%',
          top: '5%',
          bottom: '15%',
          containLabel: false
        },
        graphic: this.generateAlignedGraphics(this.statesChart, statesData),
        xAxis: {
          type: 'value',
          show: false
        },
        yAxis: {
          type: 'category',
          data: statesData.map(item => item.name),
          inverse: true,
          show: false
        },
        series: [{
          data: statesData,
          type: 'bar',
          itemStyle: {
            color: '#fef3c7',
            borderRadius: [0, 4, 4, 0]
          },
          barWidth: '60%',
          // Add animation for bars
          animation: true,
          animationDuration: 1000,
          animationEasing: 'cubicOut',
          animationDelay: function(idx) {
            return idx * 100;
          },
          label: {
            show: true,
            position: 'insideLeft',
            color: '#374151',
            fontSize: 12,
            fontWeight: 'normal',
            offset: [10, 0],
            rich: {
              flag: {
                backgroundColor: {
                  image: `https://flagcdn.com/16x12/${flagCode}.png`
                },
                width: 16,
                height: 12,
                borderRadius: 2
              }
            },
            formatter: function(params) {
              return `{flag|}   ${params.data.name}`;
            }
          }
        }]
      };
      
      this.statesChart.setOption(option);
      
      // Final resize to ensure proper dimensions
      setTimeout(() => {
        if (this.statesChart) this.statesChart.resize();
      }, 100);
    }
  };
}
</script> 

    <!-- Devices Box -->
    <div class="bg-white rounded-lg border border-gray-200 shadow-sm overflow-hidden relative" style="width: 450px; height: 400px;" x-data="deviceAnalytics()" x-init="$nextTick(() => setTimeout(() => initBrowserChart(), 100))">
  <!-- Load Iconify -->
  <script src="https://code.iconify.design/iconify-icon/3.0.0/iconify-icon.min.js"></script>
  
  <!-- Device Analytics Container -->
  <div class="relative overflow-hidden px-3 pt-0 pb-2 h-full flex flex-col">
    <!-- Header with Title and Tabs -->
    <div class="flex items-center justify-between mb-2 pt-1 pl-3">
      <!-- Title -->
      <h3 class="text-lg font-semibold text-gray-800">Devices</h3>
      
      <!-- Device Tabs -->
      <div class="flex space-x-3">
        <button @click="device_tab = 'browser'; setTimeout(() => initBrowserChart(), 50)" 
                class="text-xs font-medium transition-colors cursor-pointer px-2 py-1"
                :class="device_tab === 'browser' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-500 hover:text-gray-700'">
          Browsers
        </button>
        <button @click="device_tab = 'os'; setTimeout(() => initOSChart(), 50)" 
                class="text-xs font-medium transition-colors cursor-pointer px-2 py-1"
                :class="device_tab === 'os' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-500 hover:text-gray-700'">
          OS
        </button>
        <button @click="device_tab = 'size'" 
                class="text-xs font-medium transition-colors cursor-pointer px-2 py-1"
                :class="device_tab === 'size' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-500 hover:text-gray-700'">
          Screen Size
        </button>
      </div>
    </div>
    <!-- Content Area -->
    <div class="flex-1 flex items-end justify-center">
      <!-- Browser Chart -->
      <div x-show="device_tab === 'browser'" class="w-full h-[350px] flex flex-col">
        <!-- Column Headers -->
        <div class="flex justify-between items-center px-4 pt-2 pb-0">
          <h4 class="text-sm font-medium text-gray-600">Browser</h4>
          <h4 class="text-sm font-medium text-gray-600 pr-2">Views</h4>
        </div>
        <!-- Chart Container -->
        <div class="flex-1">
          <div id="browsers-chart" class="w-full h-full"></div>
        </div>
      </div>

      <!-- OS Chart -->
      <div x-show="device_tab === 'os'" class="w-full h-[350px] flex flex-col">
        <!-- Column Headers -->
        <div class="flex justify-between items-center px-4 pt-2 pb-0">
          <h4 class="text-sm font-medium text-gray-600">Operating System</h4>
          <h4 class="text-sm font-medium text-gray-600 pr-2">Views</h4>
        </div>
        <!-- Chart Container -->
        <div class="flex-1">
          <div id="os-chart" class="w-full h-full"></div>
        </div>
      </div>

      <!-- Size Chart -->
              <div x-show="device_tab === 'size'" class="w-full h-[350px] flex items-center justify-center">
          <!-- Circular Progress Design -->
          <div class="grid grid-cols-2 gap-x-4 gap-y-12 w-full max-w-lg px-8">
          <!-- Desktop -->
          <div class="flex flex-col items-center">
            <div class="relative mb-1">
              <!-- Background Circle -->
              <svg class="w-20 h-20 transform -rotate-90" viewBox="0 0 100 100">
                <circle cx="50" cy="50" r="40" stroke="#e5e7eb" stroke-width="8" fill="none"/>
                <circle cx="50" cy="50" r="40" stroke="#2563eb" stroke-width="8" fill="none" 
                        stroke-dasharray="251.2" 
                        stroke-dashoffset="125.6"
                        stroke-linecap="round"
                        class="transition-all duration-1000 ease-out"
                        style="animation: desktopProgress 2s ease-out forwards;"/>
              </svg>
              <!-- Icon in center -->
              <div class="absolute inset-0 flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 text-gray-600">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M9 17.25v1.007a3 3 0 0 1-.879 2.122L7.5 21h9l-.621-.621A3 3 0 0 1 15 18.257V17.25m6-12V15a2.25 2.25 0 0 1-2.25 2.25H5.25A2.25 2.25 0 0 1 3 15V5.25m18 0A2.25 2.25 0 0 0 18.75 3H5.25A2.25 2.25 0 0 0 3 5.25m18 0V12a2.25 2.25 0 0 1-2.25 2.25H5.25A2.25 2.25 0 0 1 3 12V5.25" />
                </svg>
              </div>
              <!-- Value on top -->
              <div class="absolute -top-5 left-1/2 transform -translate-x-1/2">
                <span class="text-sm font-normal text-gray-800">567</span>
              </div>
            </div>
            <h3 class="text-xs font-normal text-gray-700">Desktop</h3>
          </div>

          <!-- Mobile -->
          <div class="flex flex-col items-center">
            <div class="relative mb-1">
              <!-- Background Circle -->
              <svg class="w-20 h-20 transform -rotate-90" viewBox="0 0 100 100">
                <circle cx="50" cy="50" r="40" stroke="#e5e7eb" stroke-width="8" fill="none"/>
                <circle cx="50" cy="50" r="40" stroke="#2563eb" stroke-width="8" fill="none" 
                        stroke-dasharray="251.2" 
                        stroke-dashoffset="167.5"
                        stroke-linecap="round"
                        class="transition-all duration-1000 ease-out"
                        style="animation: mobileProgress 2s ease-out forwards;"/>
              </svg>
              <!-- Icon in center -->
              <div class="absolute inset-0 flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 text-gray-600">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 1.5H8.25A2.25 2.25 0 0 0 6 3.75v16.5a2.25 2.25 0 0 0 2.25 2.25h7.5A2.25 2.25 0 0 0 18 20.25V3.75a2.25 2.25 0 0 0-2.25-2.25H13.5m-3 0V3h3V1.5m-3 0h3m-3 18.75h3" />
                </svg>
              </div>
              <!-- Value on top -->
              <div class="absolute -top-5 left-1/2 transform -translate-x-1/2">
                <span class="text-sm font-normal text-gray-800">334</span>
              </div>
            </div>
            <h3 class="text-xs font-normal text-gray-700">Mobile</h3>
          </div>

          <!-- Tablet -->
          <div class="flex flex-col items-center">
            <div class="relative mb-1">
              <!-- Background Circle -->
              <svg class="w-20 h-20 transform -rotate-90" viewBox="0 0 100 100">
                <circle cx="50" cy="50" r="40" stroke="#e5e7eb" stroke-width="8" fill="none"/>
                <circle cx="50" cy="50" r="40" stroke="#2563eb" stroke-width="8" fill="none" 
                        stroke-dasharray="251.2" 
                        stroke-dashoffset="188.4"
                        stroke-linecap="round"
                        class="transition-all duration-1000 ease-out"
                        style="animation: tabletProgress 2s ease-out forwards;"/>
              </svg>
              <!-- Icon in center -->
              <div class="absolute inset-0 flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 text-gray-600">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5h3m-6.75 2.25h10.5a2.25 2.25 0 0 0 2.25-2.25v-15a2.25 2.25 0 0 0-2.25-2.25H6.75A2.25 2.25 0 0 0 4.5 4.5v15a2.25 2.25 0 0 0 2.25 2.25Z" />
                </svg>
              </div>
              <!-- Value on top -->
              <div class="absolute -top-5 left-1/2 transform -translate-x-1/2">
                <span class="text-sm font-normal text-gray-800">189</span>
              </div>
            </div>
            <h3 class="text-xs font-normal text-gray-700">Tablet</h3>
          </div>

          <!-- Others -->
          <div class="flex flex-col items-center">
            <div class="relative mb-2">
              <!-- Background Circle -->
              <svg class="w-20 h-20 transform -rotate-90" viewBox="0 0 100 100">
                <circle cx="50" cy="50" r="40" stroke="#e5e7eb" stroke-width="8" fill="none"/>
                <circle cx="50" cy="50" r="40" stroke="#2563eb" stroke-width="8" fill="none" 
                        stroke-dasharray="251.2" 
                        stroke-dashoffset="236.3"
                        stroke-linecap="round"
                        class="transition-all duration-1000 ease-out"
                        style="animation: othersProgress 2s ease-out forwards;"/>
              </svg>
              <!-- Icon in center -->
              <div class="absolute inset-0 flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 text-gray-600">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 12a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0ZM12.75 12a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0ZM18.75 12a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Z" />
                </svg>
              </div>
              <!-- Value on top -->
              <div class="absolute -top-5 left-1/2 transform -translate-x-1/2">
                <span class="text-sm font-normal text-gray-800">67</span>
              </div>
            </div>
            <h3 class="text-xs font-normal text-gray-700">Others</h3>
          </div>
        </div>
      </div>

      <!-- CSS Animations -->
      <style>
        @keyframes desktopProgress {
          from { stroke-dashoffset: 251.2; }
          to { stroke-dashoffset: 125.6; } /* 50% progress (567/1157 total) */
        }
        @keyframes mobileProgress {
          from { stroke-dashoffset: 251.2; }
          to { stroke-dashoffset: 167.5; } /* 33% progress (334/1157 total) */
        }
        @keyframes tabletProgress {
          from { stroke-dashoffset: 251.2; }
          to { stroke-dashoffset: 188.4; } /* 25% progress (189/1157 total) */
        }
        @keyframes othersProgress {
          from { stroke-dashoffset: 251.2; }
          to { stroke-dashoffset: 236.3; } /* 6% progress (67/1157 total) */
        }
      </style>
    </div>
  </div>
</div>

<script>
function deviceAnalytics() {
  return {
    device_tab: 'browser',
    browserChart: null,
    osChart: null,
    resizeListenerAdded: false,

    initBrowserChart() {
      const chartElement = document.getElementById('browsers-chart');
      if (chartElement && typeof echarts !== 'undefined') {
        // Wait for container to be visible and have dimensions
        const waitForContainer = () => {
          const rect = chartElement.getBoundingClientRect();
          if (rect.width === 0 || rect.height === 0) {
            setTimeout(waitForContainer, 50);
            return;
          }
          
          // Dispose existing chart if it exists to ensure fresh animation
          if (this.browserChart) {
            this.browserChart.dispose();
          }
          
          this.browserChart = echarts.init(chartElement);
          
          // Preload icons to reduce delay
          this.preloadBrowserIcons().then(() => {
            this.setupBrowserChart();
          });
        };
        
        waitForContainer();
      }
    },
    
    preloadBrowserIcons() {
      return new Promise((resolve) => {
        const iconUrls = [
          'https://cdnjs.cloudflare.com/ajax/libs/browser-logos/75.0.1/chrome/chrome_16x16.png',
          'https://cdnjs.cloudflare.com/ajax/libs/browser-logos/75.0.1/safari/safari_16x16.png',
          'https://cdnjs.cloudflare.com/ajax/libs/browser-logos/75.0.1/firefox/firefox_16x16.png',
          'https://cdnjs.cloudflare.com/ajax/libs/browser-logos/75.0.1/edge/edge_16x16.png',
          'https://cdnjs.cloudflare.com/ajax/libs/browser-logos/75.0.1/opera/opera_16x16.png'
        ];
        
        let loadedCount = 0;
        const totalIcons = iconUrls.length;
        
        // If all icons load quickly, proceed
        iconUrls.forEach(url => {
          const img = new Image();
          img.onload = img.onerror = () => {
            loadedCount++;
            if (loadedCount === totalIcons) {
              resolve();
            }
          };
          img.src = url;
        });
        
        // Don't wait more than 1 second for icons
        setTimeout(resolve, 1000);
      });
    },

    generateAlignedGraphics(chart, data) {
      if (!chart) return [];
      
      const chartHeight = chart.getHeight();
      const gridTopPercent = 5; // from grid.top: '5%'
      const gridBottomPercent = 15; // from grid.bottom: '15%'
      
      // Calculate usable height in pixels
      const topOffset = (gridTopPercent / 100) * chartHeight;
      const bottomOffset = (gridBottomPercent / 100) * chartHeight;
      const usableHeight = chartHeight - topOffset - bottomOffset;
      
      // Calculate height per bar
      const barHeight = usableHeight / data.length;
      
      return data.map((item, index) => {
        // Calculate Y position: start from top offset + half bar height + index * bar height
        const yPosition = topOffset + (barHeight / 2) + (index * barHeight);
        
        return {
          type: 'text',
          left: '87%',
          top: yPosition,
          style: {
            text: item.value.toLocaleString(),
            fontSize: 12,
            fill: '#6b7280',
            textAlign: 'right'
          }
        };
      });
    },
    
    setupBrowserChart() {
      if (!this.browserChart) return;
        
      // Add resize listener for responsiveness
      if (!this.resizeListenerAdded) {
        window.addEventListener('resize', () => {
          if (this.browserChart) this.browserChart.resize();
          if (this.osChart) this.osChart.resize();
        });
        this.resizeListenerAdded = true;
      }
        
      // Browser data sorted by value (highest to lowest)
      const browserData = [
        {value: 845, name: 'Chrome'},
        {value: 623, name: 'Safari'},
        {value: 456, name: 'Firefox'},
        {value: 234, name: 'Edge'},
        {value: 156, name: 'Opera'},
        {value: 89, name: 'Other'}
      ].sort((a, b) => b.value - a.value);
      
      // Browser icon mapping for iconify
      const browserIcons = {
        'Chrome': 'logos:chrome',
        'Safari': 'logos:safari',
        'Firefox': 'logos:firefox',
        'Edge': 'logos:microsoft-edge',
        'Opera': 'logos:opera',
        'Other': 'material-symbols:more-horiz'
      };
      
      const option = {
        // Add smooth animation
        animation: true,
        animationDuration: 1000,
        animationEasing: 'cubicOut',
        tooltip: {
          trigger: 'axis',
          axisPointer: {
            type: 'shadow'
          },
          formatter: function(params) {
            return params[0].name + '<br/>' + 
                   'Views: ' + params[0].value.toLocaleString();
          }
        },
        grid: {
          left: '5%',
          right: '15%',
          top: '5%',
          bottom: '15%',
          containLabel: false
        },
        graphic: this.generateAlignedGraphics(this.browserChart, browserData),
        xAxis: {
          type: 'value',
          show: false
        },
        yAxis: {
          type: 'category',
          data: browserData.map(item => item.name),
          inverse: true,
          show: false
        },
        series: [{
          data: browserData,
          type: 'bar',
          itemStyle: {
            color: '#fef3c7',
            borderRadius: [0, 4, 4, 0]
          },
          barWidth: '60%',
          // Add animation for bars
          animation: true,
          animationDuration: 1000,
          animationEasing: 'cubicOut',
          animationDelay: function(idx) {
            return idx * 100;
          },
          label: {
            show: true,
            position: 'insideLeft',
            color: '#374151',
            fontSize: 12,
            fontWeight: 'normal',
            offset: [10, 0],
            rich: {
              chrome: {
                backgroundColor: {
                  image: 'https://cdnjs.cloudflare.com/ajax/libs/browser-logos/75.0.1/chrome/chrome_16x16.png'
                },
                width: 16,
                height: 16,
                borderRadius: 2
              },
              safari: {
                backgroundColor: {
                  image: 'https://cdnjs.cloudflare.com/ajax/libs/browser-logos/75.0.1/safari/safari_16x16.png'
                },
                width: 16,
                height: 16,
                borderRadius: 2
              },
              firefox: {
                backgroundColor: {
                  image: 'https://cdnjs.cloudflare.com/ajax/libs/browser-logos/75.0.1/firefox/firefox_16x16.png'
                },
                width: 16,
                height: 16,
                borderRadius: 2
              },
              edge: {
                backgroundColor: {
                  image: 'https://cdnjs.cloudflare.com/ajax/libs/browser-logos/75.0.1/edge/edge_16x16.png'
                },
                width: 16,
                height: 16,
                borderRadius: 2
              },
              opera: {
                backgroundColor: {
                  image: 'https://cdnjs.cloudflare.com/ajax/libs/browser-logos/75.0.1/opera/opera_16x16.png'
                },
                width: 16,
                height: 16,
                borderRadius: 2
              }
            },
            formatter: function(params) {
              const browserCodes = {
                'Chrome': 'chrome',
                'Safari': 'safari',
                'Firefox': 'firefox',
                'Edge': 'edge',
                'Opera': 'opera'
              };
              const code = browserCodes[params.data.name];
              return code ? `{${code}|}   ${params.data.name}` : params.data.name;
            }
          }
        }]
      };
      
      this.browserChart.setOption(option);
      
      // Final resize to ensure proper dimensions
      setTimeout(() => {
        if (this.browserChart) this.browserChart.resize();
      }, 100);
    },
    
    initOSChart() {
      const chartElement = document.getElementById('os-chart');
      if (chartElement && typeof echarts !== 'undefined') {
        // Wait for container to be visible and have dimensions
        const waitForContainer = () => {
          const rect = chartElement.getBoundingClientRect();
          if (rect.width === 0 || rect.height === 0) {
            setTimeout(waitForContainer, 50);
            return;
          }
          
          // Dispose existing chart if it exists to ensure fresh animation
          if (this.osChart) {
            this.osChart.dispose();
          }
          
          this.osChart = echarts.init(chartElement);
          
          // Preload icons to reduce delay
          this.preloadOSIcons().then(() => {
            this.setupOSChart();
          });
        };
        
        waitForContainer();
      }
    },
    
    preloadOSIcons() {
      return new Promise((resolve) => {
        const iconUrls = [
          'https://img.icons8.com/color/16/000000/windows-10.png',
          'https://img.icons8.com/color/16/000000/mac-os.png',
          'https://img.icons8.com/color/16/000000/android-os.png',
          'https://img.icons8.com/color/16/000000/ios-logo.png',
          'https://img.icons8.com/color/16/000000/linux.png'
        ];
        
        let loadedCount = 0;
        const totalIcons = iconUrls.length;
        
        // If all icons load quickly, proceed
        iconUrls.forEach(url => {
          const img = new Image();
          img.onload = img.onerror = () => {
            loadedCount++;
            if (loadedCount === totalIcons) {
              resolve();
            }
          };
          img.src = url;
        });
        
        // Don't wait more than 1 second for icons
        setTimeout(resolve, 1000);
      });
    },
    
    setupOSChart() {
      if (!this.osChart) return;
        
      // Ensure resize listener is added
      if (!this.resizeListenerAdded) {
        window.addEventListener('resize', () => {
          if (this.browserChart) this.browserChart.resize();
          if (this.osChart) this.osChart.resize();
        });
        this.resizeListenerAdded = true;
      }
      
      // OS data sorted by value (highest to lowest)
      const osData = [
        {value: 734, name: 'Windows'},
        {value: 623, name: 'macOS'},
        {value: 456, name: 'Android'},
        {value: 334, name: 'iOS'},
        {value: 189, name: 'Linux'},
        {value: 67, name: 'Other'}
      ].sort((a, b) => b.value - a.value);
      
      // OS icon mapping for iconify
      const osIcons = {
        'Windows': 'logos:microsoft-windows',
        'macOS': 'logos:apple',
        'Android': 'logos:android-icon',
        'iOS': 'logos:apple',
        'Linux': 'logos:linux-tux',
        'Other': 'material-symbols:more-horiz'
      };
      
      const option = {
        // Add smooth animation
        animation: true,
        animationDuration: 1000,
        animationEasing: 'cubicOut',
        tooltip: {
          trigger: 'axis',
          axisPointer: {
            type: 'shadow'
          },
          formatter: function(params) {
            return params[0].name + '<br/>' + 
                   'Views: ' + params[0].value.toLocaleString();
          }
        },
        grid: {
          left: '5%',
          right: '15%',
          top: '5%',
          bottom: '15%',
          containLabel: false
        },
        graphic: this.generateAlignedGraphics(this.osChart, osData),
        xAxis: {
          type: 'value',
          show: false
        },
        yAxis: {
          type: 'category',
          data: osData.map(item => item.name),
          inverse: true,
          show: false
        },
        series: [{
          data: osData,
          type: 'bar',
          itemStyle: {
            color: '#fef3c7',
            borderRadius: [0, 4, 4, 0]
          },
          barWidth: '60%',
          // Add animation for bars
          animation: true,
          animationDuration: 1000,
          animationEasing: 'cubicOut',
          animationDelay: function(idx) {
            return idx * 100;
          },
          label: {
            show: true,
            position: 'insideLeft',
            color: '#374151',
            fontSize: 12,
            fontWeight: 'normal',
            offset: [10, 0],
            rich: {
              windows: {
                backgroundColor: {
                  image: 'https://img.icons8.com/color/16/000000/windows-10.png'
                },
                width: 16,
                height: 16,
                borderRadius: 2
              },
              macos: {
                backgroundColor: {
                  image: 'https://img.icons8.com/color/16/000000/mac-os.png'
                },
                width: 16,
                height: 16,
                borderRadius: 2
              },
              android: {
                backgroundColor: {
                  image: 'https://img.icons8.com/color/16/000000/android-os.png'
                },
                width: 16,
                height: 16,
                borderRadius: 2
              },
              ios: {
                backgroundColor: {
                  image: 'https://img.icons8.com/color/16/000000/ios-logo.png'
                },
                width: 16,
                height: 16,
                borderRadius: 2
              },
              linux: {
                backgroundColor: {
                  image: 'https://img.icons8.com/color/16/000000/linux.png'
                },
                width: 16,
                height: 16,
                borderRadius: 2
              }
            },
            formatter: function(params) {
              const osCodes = {
                'Windows': 'windows',
                'macOS': 'macos',
                'Android': 'android',
                'iOS': 'ios',
                'Linux': 'linux'
              };
              const code = osCodes[params.data.name];
              return code ? `{${code}|}   ${params.data.name}` : params.data.name;
            }
          }
        }]
      };
      
      this.osChart.setOption(option);
      
      // Final resize to ensure proper dimensions
      setTimeout(() => {
        if (this.osChart) this.osChart.resize();
      }, 100);
    }
  };
}
</script> 

  </div>
</div>

  