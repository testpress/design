<div class="bg-white rounded-lg border border-gray-200 shadow-sm relative" style="width: 450px; height: 400px;" x-data="locationAnalytics()" x-init="initMap()">
  <!-- Location Analytics Container -->
  <div class="relative px-3 pt-0 pb-2 h-full flex flex-col">
    <!-- Header with Title and Tabs -->
    <div class="flex items-center justify-between mb-2 pt-1 pl-3">
      <!-- Title -->
      <h3 class="text-lg font-semibold text-gray-800">Locations</h3>
      
      <!-- Location Tabs -->
      <div class="flex space-x-3">
        <button @click="location_tab = 'map'; setTimeout(() => initMapSafely(), 50)" 
                class="text-xs font-medium transition-colors cursor-pointer px-2 py-1"
                :class="location_tab === 'map' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-500 hover:text-gray-700'">
          Map
        </button>
        <button @click="location_tab = 'countries'; setTimeout(() => initCountriesChart(), 50)" 
                class="text-xs font-medium transition-colors cursor-pointer px-2 py-1"
                :class="location_tab === 'countries' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-500 hover:text-gray-700'">
          Countries
        </button>
        <button @click="location_tab = 'states'; if(!selectedCountry) selectedCountry = 'IND'; setTimeout(() => initStatesChart(), 50)" 
                class="text-xs font-medium transition-colors cursor-pointer px-2 py-1"
                :class="location_tab === 'states' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-500 hover:text-gray-700'">
          States
        </button>
      </div>
    </div>
    <!-- Content Area -->
    <div class="flex-1 flex items-end justify-center">
      <!-- Map View -->
      <div x-show="location_tab === 'map'" class="w-full h-[350px]">
        <div id="world-map" class="w-full h-full"></div>
      </div>

      <!-- Countries Flow Chart -->
      <div x-show="location_tab === 'countries'" class="w-full h-[350px] flex flex-col">
        <!-- Column Headers -->
        <div class="flex justify-between items-center px-4 pt-2 pb-0">
          <h4 class="text-sm font-medium text-gray-600">Country</h4>
          <h4 class="text-sm font-medium text-gray-600 pr-2">Views</h4>
        </div>
        <!-- Chart Container -->
        <div class="flex-1">
          <div id="countries-chart" class="w-full h-full"></div>
        </div>
      </div>

      <!-- States Flow Chart -->
      <div x-show="location_tab === 'states'" class="w-full h-[350px] flex flex-col">
        <!-- Column Headers -->
        <div class="flex justify-between items-center px-4 pt-2 pb-0">
          <h4 class="text-sm font-medium text-gray-600">State</h4>
          <h4 class="text-sm font-medium text-gray-600 pr-2">Views</h4>
        </div>
        <!-- Chart Container -->
        <div class="flex-1">
          <div id="states-chart" class="w-full h-full"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
function locationAnalytics() {
  return {
    location_tab: 'map',
    map: null,
    countriesChart: null,
    statesChart: null,
    selectedCountry: null,
    resizeListenerAdded: false,
    resizeTimeout: null,
    countryStatesData: {
      'USA': [
        {value: 845, name: 'California'},
        {value: 623, name: 'Texas'},
        {value: 445, name: 'New York'},
        {value: 334, name: 'Florida'},
        {value: 261, name: 'Illinois'}
      ],
      'IND': [
        {value: 456, name: 'Maharashtra'},
        {value: 289, name: 'Karnataka'},
        {value: 234, name: 'Delhi'},
        {value: 189, name: 'Tamil Nadu'},
        {value: 156, name: 'Gujarat'},
        {value: 110, name: 'West Bengal'}
      ],
      'GBR': [
        {value: 334, name: 'London'},
        {value: 189, name: 'Manchester'},
        {value: 156, name: 'Birmingham'},
        {value: 123, name: 'Liverpool'},
        {value: 90, name: 'Leeds'}
      ],
      'AUS': [
        {value: 267, name: 'New South Wales'},
        {value: 189, name: 'Victoria'},
        {value: 156, name: 'Queensland'},
        {value: 123, name: 'Western Australia'},
        {value: 54, name: 'South Australia'}
      ],
      'BRA': [
        {value: 234, name: 'SÃ£o Paulo'},
        {value: 178, name: 'Rio de Janeiro'},
        {value: 123, name: 'Minas Gerais'},
        {value: 110, name: 'Bahia'}
      ],
      'CAN': [
        {value: 223, name: 'Ontario'},
        {value: 134, name: 'Quebec'},
        {value: 123, name: 'British Columbia'},
        {value: 87, name: 'Alberta'}
      ]
    },
    initMap() {
      // Prevent multiple Datamap instances - return early if map already exists
      if (this.map) {
        return;
      }
      
      // Use Alpine's $nextTick to ensure DOM is ready
      this.$nextTick(() => {
        // Check if we're on the map tab and container is visible
        if (this.location_tab !== 'map') {
          return; // Don't initialize if not on map tab
        }
        
        const mapElement = document.getElementById('world-map');
        
        // Ensure container exists and has dimensions
        if (!mapElement || !this.isContainerReady(mapElement)) {
          // Retry after a short delay if container not ready
          setTimeout(() => this.initMap(), 100);
          return;
        }
        
        // Check if libraries are loaded
        if (typeof Datamap === 'undefined' || typeof d3 === 'undefined') {
          console.log('Map libraries not loaded yet, retrying...');
          setTimeout(() => this.initMap(), 200);
          return;
        }
        
        // Clear any existing content
        mapElement.innerHTML = '';
        
        const data = {
          'USA': { fillKey: 'high', views: 2508 },
          'IND': { fillKey: 'high', views: 1434 },
          'GBR': { fillKey: 'medium', views: 892 },
          'AUS': { fillKey: 'medium', views: 789 },
          'BRA': { fillKey: 'medium', views: 645 },
          'CAN': { fillKey: 'medium', views: 567 }
        };

        // Use final colors directly - no transition needed
        const mapFills = {
          'high': '#1e40af',
          'medium': '#3b82f6',
          'low': '#93c5fd',
          defaultFill: '#f3f4f6'
        };

        this.map = new Datamap({
          element: mapElement,
          projection: 'mercator',
          responsive: true,
          aspectRatio: 0.6,
          setProjection: function(element) {
            // Calculate truly adaptive scale for full map visibility
            var containerWidth = element.offsetWidth;
            var containerHeight = element.offsetHeight;
            
            // For Mercator projection, use more conservative scaling to prevent cropping
            var baseScale = Math.min(containerWidth / 6, containerHeight / 3.8);
            
            // Add extra padding to ensure full visibility including northern regions
            var paddingFactor = 0.9;
            var scale = baseScale * paddingFactor;
            
            // Ensure minimum scale for very small screens
            scale = Math.max(scale, 45);
            
            var projection = d3.geo.mercator()
              .center([0, 10])  // Slight southern offset to show more of the north
              .scale(scale)
              .translate([containerWidth / 2, containerHeight * 0.55]); // Move map slightly down
            var path = d3.geo.path().projection(projection);
            return {path: path, projection: projection};
          },
          fills: mapFills, // Use final colors directly
          data: data,
          geographyConfig: {
            borderWidth: 1,
            borderColor: '#6b7280',
            popupTemplate: function(geography, data) {
              if (!data) return null;
              
              var countryName = geography.properties.NAME || 
                              geography.properties.name || 
                              geography.properties.NAME_LONG || 
                              geography.properties.ADMIN || 
                              geography.id || 
                              'Unknown';
              
              // Get country flag code - map to proper country codes
              var flagCode = geography.id.toLowerCase();
              var flagMapping = {
                'usa': 'us',
                'ind': 'in', 
                'gbr': 'gb',
                'aus': 'au',
                'bra': 'br',
                'can': 'ca'
              };
              var actualFlagCode = flagMapping[flagCode] || flagCode;
              
              // Detect browser zoom level and adjust popup size accordingly
              var zoomLevel = window.devicePixelRatio || 1;
              var screenWidth = window.innerWidth;
              
              // Calculate responsive popup dimensions based on zoom and screen size
              var baseWidth = 100;
              var basePadding = 10;
              var baseFontSize = 12;
              var baseSmallFontSize = 10;
              var baseFlagSize = 12;
              
              // Adjust for zoom level - smaller popup when zoomed in
              var zoomAdjustment = Math.max(0.7, Math.min(1.2, 1 / Math.sqrt(zoomLevel)));
              
              // Adjust for screen size
              var screenAdjustment = screenWidth < 640 ? 0.85 : screenWidth < 1024 ? 0.95 : 1;
              
              var finalAdjustment = zoomAdjustment * screenAdjustment;
              
              var popupWidth = Math.round(baseWidth * finalAdjustment);
              var popupPadding = Math.round(basePadding * finalAdjustment);
              var fontSize = Math.round(baseFontSize * finalAdjustment);
              var smallFontSize = Math.round(baseSmallFontSize * finalAdjustment);
              var flagSize = Math.round(baseFlagSize * finalAdjustment);
              
              return `<div class="bg-white rounded-xl shadow-xl" style="min-width: ${popupWidth}px; padding: ${popupPadding}px; min-height: 60px; z-index: 9999;">
                <div class="flex items-center">
                  <div class="me-3">
                    <div class="rounded-full bg-no-repeat bg-center bg-cover" style="width: ${flagSize}px; height: ${flagSize}px; background-image: url('https://flagcdn.com/w40/${actualFlagCode}.png')"></div>
                  </div>
                  <span class="font-semibold text-gray-800" style="font-size: ${fontSize}px;">${countryName}</span>
                </div>
                <div class="space-y-2">
                    <span class="text-gray-500" style="font-size: ${smallFontSize}px;">Views:</span>
                    <span class="font-medium text-gray-800" style="font-size: ${smallFontSize}px;">${data.views.toLocaleString()}</span>
                </div>
              </div>`;
            },
            highlightFillColor: false,
            highlightBorderColor: '#2563eb',
            highlightBorderWidth: 2,
          },
          done: (datamap) => {
            // Add click event
            datamap.svg.selectAll('.datamaps-subunit').on('click', (geography) => {
              const countryCode = geography.id;
              if (data[countryCode] && this.countryStatesData[countryCode]) {
                this.selectedCountry = countryCode;
                this.location_tab = 'states';
                this.$nextTick(() => this.initStatesChart());
              }
            });
          }
        });
        
        // Initialize charts
        this.initCountriesChart();
        this.initStatesChart();
        
        // Add resize listener for map responsiveness (only once)
        if (!this.resizeListenerAdded) {
          // Window resize listener
          window.addEventListener('resize', () => {
            // Debounce resize events
            clearTimeout(this.resizeTimeout);
            this.resizeTimeout = setTimeout(() => {
              if (this.map && this.location_tab === 'map') {
                // For Datamap, we need to reinitialize rather than just resize
                this.refreshMap();
              }
              if (this.countriesChart) this.countriesChart.resize();
              if (this.statesChart) this.statesChart.resize();
            }, 150);
          });
          
          // Also add ResizeObserver for better container size detection
          if (window.ResizeObserver) {
            const resizeObserver = new ResizeObserver((entries) => {
              clearTimeout(this.resizeTimeout);
              this.resizeTimeout = setTimeout(() => {
                if (this.map && this.location_tab === 'map') {
                  this.refreshMap();
                }
              }, 150);
            });
            resizeObserver.observe(mapElement);
          }
          
          this.resizeListenerAdded = true;
        }
      });
    },
    
    // Helper method to check if container is ready
    isContainerReady(element) {
      const rect = element.getBoundingClientRect();
      const computedStyle = window.getComputedStyle(element);
      
      return (
        rect.width > 0 && 
        rect.height > 0 && 
        computedStyle.display !== 'none' &&
        computedStyle.visibility !== 'hidden'
      );
    },
    
    // Method to safely initialize map when tab changes
    initMapSafely() {
      this.$nextTick(() => {
        if (this.location_tab === 'map' && !this.map) {
          this.initMap();
        }
      });
    },
    
    // Method to refresh map on resize
    refreshMap() {
      if (this.map && this.location_tab === 'map') {
        const mapElement = document.getElementById('world-map');
        if (mapElement && this.isContainerReady(mapElement)) {
          // Store current state
          const wasMapInitialized = !!this.map;
          
          // Dispose current map
          if (this.map) {
            this.map = null;
          }
          
          // Clear container
          mapElement.innerHTML = '';
          
          // Reinitialize with new dimensions
          if (wasMapInitialized) {
            this.initMap();
          }
        }
      }
    },
    
    initCountriesChart() {
      const chartElement = document.getElementById('countries-chart');
      if (chartElement && typeof echarts !== 'undefined') {
        // Wait for container to be visible and have dimensions
        const waitForContainer = () => {
          const rect = chartElement.getBoundingClientRect();
          if (rect.width === 0 || rect.height === 0) {
            setTimeout(waitForContainer, 50);
            return;
          }
          
          // Dispose existing chart if it exists to ensure fresh animation
          if (this.countriesChart) {
            this.countriesChart.dispose();
          }
          
          this.countriesChart = echarts.init(chartElement);
          this.setupCountriesChart();
        };
        
        waitForContainer();
      }
    },

    generateAlignedGraphics(chart, data) {
      if (!chart) return [];
      
      const chartHeight = chart.getHeight();
      const gridTopPercent = 5; // from grid.top: '5%'
      const gridBottomPercent = 15; // from grid.bottom: '15%'
      
      // Calculate usable height in pixels
      const topOffset = (gridTopPercent / 100) * chartHeight;
      const bottomOffset = (gridBottomPercent / 100) * chartHeight;
      const usableHeight = chartHeight - topOffset - bottomOffset;
      
      // Calculate height per bar
      const barHeight = usableHeight / data.length;
      
      return data.map((item, index) => {
        // Calculate Y position: start from top offset + half bar height + index * bar height
        const yPosition = topOffset + (barHeight / 2) + (index * barHeight);
        
        return {
          type: 'text',
          left: '87%',
          top: yPosition,
          style: {
            text: item.value.toLocaleString(),
            fontSize: 12,
            fill: '#6b7280',
            textAlign: 'right'
          }
        };
      });
    },

    setupCountriesChart() {
      if (!this.countriesChart) return;
        
      // Add resize listener for responsiveness
      if (!this.resizeListenerAdded) {
        window.addEventListener('resize', () => {
          if (this.countriesChart) this.countriesChart.resize();
          if (this.statesChart) this.statesChart.resize();
        });
        this.resizeListenerAdded = true;
      }
      
      // Country flag mapping
      const countryFlags = {
        'United States': 'us',
        'India': 'in',
        'United Kingdom': 'gb',
        'Australia': 'au',
        'Brazil': 'br',
        'Canada': 'ca'
      };

      // Sort countries by value (highest to lowest)
      const sortedCountries = [
        {value: 2508, name: 'United States'},
        {value: 1434, name: 'India'},
        {value: 892, name: 'United Kingdom'},
        {value: 789, name: 'Australia'},
        {value: 645, name: 'Brazil'},
        {value: 567, name: 'Canada'}
      ].sort((a, b) => b.value - a.value);

      const option = {
        // Add smooth animation
        animation: true,
        animationDuration: 1000,
        animationEasing: 'cubicOut',
        tooltip: {
          trigger: 'axis',
          axisPointer: {
            type: 'shadow'
          },
          formatter: function(params) {
            return params[0].name + '<br/>' + 
                   'Views: ' + params[0].value.toLocaleString() + '<br/>' +
                   '<small style="color: #6b7280;">Click to view states</small>';
          }
        },
        grid: {
          left: '5%',
          right: '15%',
          top: '5%',
          bottom: '15%',
          containLabel: false
        },
        graphic: this.generateAlignedGraphics(this.countriesChart, sortedCountries),
        xAxis: {
          type: 'value',
          show: false
        },
        yAxis: {
          type: 'category',
          data: sortedCountries.map(item => item.name),
          inverse: true,
          show: false
        },
        series: [{
          data: sortedCountries,
          type: 'bar',
          itemStyle: {
            color: '#fef3c7',
            borderRadius: [0, 4, 4, 0]
          },
          barWidth: '60%',
          // Add animation for bars
          animation: true,
          animationDuration: 1000,
          animationEasing: 'cubicOut',
          animationDelay: function(idx) {
            return idx * 100;
          },
          label: {
            show: true,
            position: 'insideLeft',
            color: '#374151',
            fontSize: 12,
            fontWeight: 'normal',
            offset: [10, 0],
            rich: {
              us: {
                backgroundColor: {
                  image: 'https://flagcdn.com/16x12/us.png'
                },
                width: 16,
                height: 12,
                borderRadius: 2
              },
              in: {
                backgroundColor: {
                  image: 'https://flagcdn.com/16x12/in.png'
                },
                width: 16,
                height: 12,
                borderRadius: 2
              },
              gb: {
                backgroundColor: {
                  image: 'https://flagcdn.com/16x12/gb.png'
                },
                width: 16,
                height: 12,
                borderRadius: 2
              },
              au: {
                backgroundColor: {
                  image: 'https://flagcdn.com/16x12/au.png'
                },
                width: 16,
                height: 12,
                borderRadius: 2
              },
              br: {
                backgroundColor: {
                  image: 'https://flagcdn.com/16x12/br.png'
                },
                width: 16,
                height: 12,
                borderRadius: 2
              },
              ca: {
                backgroundColor: {
                  image: 'https://flagcdn.com/16x12/ca.png'
                },
                width: 16,
                height: 12,
                borderRadius: 2
              }
            },
            formatter: function(params) {
              const flagCodes = {
                'United States': 'us',
                'India': 'in',
                'United Kingdom': 'gb',
                'Australia': 'au',
                'Brazil': 'br',
                'Canada': 'ca'
              };
              const code = flagCodes[params.data.name];
              return code ? `{${code}|}   ${params.data.name}` : params.data.name;
            }
          }
        }]
      };
      
      this.countriesChart.setOption(option);
      
      // Add click event to countries chart
      this.countriesChart.on('click', (params) => {
        const countryName = params.data.name;
        const countryCode = this.getCountryCode(countryName);
        if (countryCode && this.countryStatesData[countryCode]) {
          this.selectedCountry = countryCode;
          this.location_tab = 'states';
          this.$nextTick(() => this.initStatesChart());
        }
      });
      
      // Final resize to ensure proper dimensions
      setTimeout(() => {
        if (this.countriesChart) this.countriesChart.resize();
      }, 100);
    },
    
    getCountryName(countryCode) {
      const countryNames = {
        'USA': 'United States',
        'IND': 'India',
        'GBR': 'United Kingdom',
        'AUS': 'Australia',
        'BRA': 'Brazil',
        'CAN': 'Canada'
      };
      return countryNames[countryCode] || countryCode;
    },

    getCountryCode(countryName) {
      const nameToCode = {
        'United States': 'USA',
        'India': 'IND',
        'United Kingdom': 'GBR',
        'Australia': 'AUS',
        'Brazil': 'BRA',
        'Canada': 'CAN'
      };
      return nameToCode[countryName] || null;
    },

    initStatesChart() {
      const chartElement = document.getElementById('states-chart');
      if (chartElement && typeof echarts !== 'undefined') {
        // Wait for container to be visible and have dimensions
        const waitForContainer = () => {
          const rect = chartElement.getBoundingClientRect();
          if (rect.width === 0 || rect.height === 0) {
            setTimeout(waitForContainer, 50);
            return;
          }
          
          // Dispose existing chart if it exists
          if (this.statesChart) {
            this.statesChart.dispose();
          }
          
          this.statesChart = echarts.init(chartElement);
          this.setupStatesChart();
        };
        
        waitForContainer();
      }
    },

    setupStatesChart() {
      if (!this.statesChart) return;
        
      // Ensure resize listener is added
      if (!this.resizeListenerAdded) {
        window.addEventListener('resize', () => {
          if (this.countriesChart) this.countriesChart.resize();
          if (this.statesChart) this.statesChart.resize();
        });
        this.resizeListenerAdded = true;
      }
      
      // Get data for selected country or default to India's states
      const statesData = this.selectedCountry && this.countryStatesData[this.selectedCountry] 
        ? this.countryStatesData[this.selectedCountry]
        : this.countryStatesData['IND'];
      
      // Get country flag for the selected country
      const countryFlagCodes = {
        'USA': 'us',
        'IND': 'in', 
        'GBR': 'gb',
        'AUS': 'au',
        'BRA': 'br',
        'CAN': 'ca'
      };
      
      const selectedCountryCode = this.selectedCountry || 'IND';
      const flagCode = countryFlagCodes[selectedCountryCode];
      
      const option = {
        // Add smooth animation
        animation: true,
        animationDuration: 1000,
        animationEasing: 'cubicOut',
        tooltip: {
          trigger: 'axis',
          axisPointer: {
            type: 'shadow'
          },
          formatter: function(params) {
            return params[0].name + '<br/>' + 
                   'Views: ' + params[0].value.toLocaleString();
          }
        },
        grid: {
          left: '5%',
          right: '15%',
          top: '5%',
          bottom: '15%',
          containLabel: false
        },
        graphic: this.generateAlignedGraphics(this.statesChart, statesData),
        xAxis: {
          type: 'value',
          show: false
        },
        yAxis: {
          type: 'category',
          data: statesData.map(item => item.name),
          inverse: true,
          show: false
        },
        series: [{
          data: statesData,
          type: 'bar',
          itemStyle: {
            color: '#fef3c7',
            borderRadius: [0, 4, 4, 0]
          },
          barWidth: '60%',
          // Add animation for bars
          animation: true,
          animationDuration: 1000,
          animationEasing: 'cubicOut',
          animationDelay: function(idx) {
            return idx * 100;
          },
          label: {
            show: true,
            position: 'insideLeft',
            color: '#374151',
            fontSize: 12,
            fontWeight: 'normal',
            offset: [10, 0],
            rich: {
              flag: {
                backgroundColor: {
                  image: `https://flagcdn.com/16x12/${flagCode}.png`
                },
                width: 16,
                height: 12,
                borderRadius: 2
              }
            },
            formatter: function(params) {
              return `{flag|}   ${params.data.name}`;
            }
          }
        }]
      };
      
      this.statesChart.setOption(option);
      
      // Final resize to ensure proper dimensions
      setTimeout(() => {
        if (this.statesChart) this.statesChart.resize();
      }, 100);
    }
  };
}
</script> 