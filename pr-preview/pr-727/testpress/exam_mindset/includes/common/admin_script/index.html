<script>
  const allTemplates = [{"id":"t1","name":"Confidence Check","text":"How confident are you about your preparation for this exam?","response_type":"scale","reflection_type":"pre"},{"id":"t2","name":"Time Pressure","text":"How much time pressure do you anticipate feeling during this exam?","response_type":"scale","reflection_type":"pre"},{"id":"t3","name":"Focus Goal","text":"What is one strategy you will use to maintain focus?","response_type":"text","reflection_type":"pre"},{"id":"t4","name":"Perceived Difficulty","text":"How difficult did you find this exam?","response_type":"scale","reflection_type":"post"},{"id":"t5","name":"Time Pressure","text":"How much time pressure did you feel during this exam?","response_type":"scale","reflection_type":"post"},{"id":"t6","name":"Focus Reflection","text":"How would you rate your focus level during the exam?","response_type":"scale","reflection_type":"post"},{"id":"t7","name":"Strategy Reflection","text":"What is one exam-taking strategy you will change for the next exam?","response_type":"text","reflection_type":"post"}];
  const reflectionData = {"preExamQuestions":[{"id":1,"order":1,"text":"How confident are you about your preparation for this exam?","response_type":"scale","is_required":true,"template_id":"t1"}],"postExamQuestions":[{"id":2,"order":1,"text":"How difficult did you find this exam?","response_type":"scale","is_required":false,"template_id":"t4"},{"id":3,"order":2,"text":"How would you rate your focus level during the exam?","response_type":"scale","is_required":true,"template_id":"t6"}],"mistakeReasons":[{"id":1,"order":1,"name":"Calculation Error","category":"Test Skill","description":"Made a mistake in math.","is_active":true},{"id":2,"order":2,"name":"Misread Question","category":"Comprehension","description":"Didn't read the question text fully.","is_active":true},{"id":3,"order":3,"name":"Forgot Formula","category":"Conceptual","description":"","is_active":false}]};

  function mindsetAdmin() {
    return {
      preExamQuestions: reflectionData.preExamQuestions.map(q => ({
        ...q,
        is_active: q.is_required,
        description: q.description || '',
        scale_type: q.scale_type || 'positive'
      })),
      postExamQuestions: reflectionData.postExamQuestions.map(q => ({
        ...q,
        is_active: q.is_required,
        description: q.description || '',
        scale_type: q.scale_type || 'positive'
      })),
      mistakeReasons: reflectionData.mistakeReasons,
      allTemplates: allTemplates,
      is_enabled: true,
      navigationTab: 'pre',
      openAddTemplateModal: false,
      openAddQuestionModal: false,
      openEditModal: false,
      openDeleteModal: false,
      editRow: {},
      newQuestion: { text: '', description: '', response_type: 'scale', scale_type: 'positive' },
      rowToDelete: null,
      selectedTemplates: [],
      isPreMandatory: false,
      isPostMandatory: false,
      get currentQuestions() {
        return this.navigationTab === 'pre'
          ? this.preExamQuestions
          : this.postExamQuestions;
      },
      get currentReasons() {
        return this.mistakeReasons;
      },
      get availableTemplates() {
        const addedTemplateIds = new Set(
          this.currentQuestions.map(q => q.template_id)
        );
        return this.allTemplates.filter(t =>
          t.reflection_type === this.navigationTab && !addedTemplateIds.has(t.id)
        );
      },
      initSortable() {
        const initSelectOnModalOpen = (modalProp, refName) => {
          this.$watch(modalProp, (value) => {
            if (value) {
              this.$nextTick(() => {
                if (window.HSSelect) {
                  HSSelect.autoInit(this.$refs[refName]);
                }
              });
            }
          });
        };
        initSelectOnModalOpen('openAddQuestionModal', 'addQuestionModal');
        initSelectOnModalOpen('openEditModal', 'editQuestionModal');
        this.$watch('navigationTab', () => {
          this.$nextTick(() => {
            this.makeSortable();
            if (window.HSDropdown) HSDropdown.autoInit();
            if (window.HSOverlay) HSOverlay.autoInit();
          });
        });
        this.makeSortable();
      },
      makeSortable() {
        const initTable = (selector) => {
          const table = document.querySelector(selector);
          if (table && !table.sortable) {
            table.sortable = new Sortable(table, {
              animation: 150,
              ghostClass: 'bg-gray-100',
              handle: '.cursor-grab'
            });
          }
        };
        initTable('#sortable-pre');
        initTable('#sortable-post');
        initTable('#sortable-mistake');
      },
      openAddFromTemplate() {
        this.selectedTemplates = [];
        this.openAddTemplateModal = true;
      },
      saveFromTemplates() {
        const list = (this.navigationTab === 'pre')
          ? this.preExamQuestions
          : this.postExamQuestions;
        const maxId = list.length ? Math.max(...list.map(r => r.id)) : 0;
        this.selectedTemplates.forEach((templateId, i) => {
          const template = this.allTemplates.find(t => t.id === templateId);
          if (template) {
            list.push({
              id: maxId + i + 1,
              order: list.length + 1,
              text: template.text,
              description: '',
              response_type: template.response_type,
              scale_type: 'positive',
              is_active: true,
              template_id: template.id
            });
          }
        });
        this.closeAllModals();
      },
      openAddQuestion() {
        this.newQuestion = {
          text: '',
          description: '',
          response_type: 'scale',
          scale_type: 'positive'
        };
        this.openAddQuestionModal = true;
      },
      saveNewQuestion() {
        if (!this.newQuestion.text.trim()) return;
        const list = (this.navigationTab === 'pre')
          ? this.preExamQuestions
          : this.postExamQuestions;
        const maxId = list.length ? Math.max(...list.map(r => r.id)) : 0;
        list.push({
          id: maxId + 1,
          ...this.newQuestion,
          order: list.length + 1,
          is_active: true
        });
        this.closeAllModals();
      },
      openEdit(row) {
        this.editRow = { ...row };
        if (
          this.editRow.response_type === 'scale' &&
          !this.editRow.scale_type
        ) {
          this.editRow.scale_type = 'positive';
        }
        this.openEditModal = true;
      },
      saveEdit() {
        if (!this.editRow.text.trim()) return;
        let list = (this.navigationTab === 'pre')
          ? this.preExamQuestions
          : this.postExamQuestions;
        const index = list.findIndex(r => r.id === this.editRow.id);
        if (index !== -1) {
          list.splice(index, 1, { ...this.editRow });
        }
        this.closeAllModals();
      },
      openDelete(row) {
        this.rowToDelete = row;
        this.openDeleteModal = true;
      },
      confirmDelete() {
        if (this.navigationTab === 'mistake') {
          const index = this.mistakeReasons.findIndex(r => r.id === this.rowToDelete.id);
          if (index !== -1) this.mistakeReasons.splice(index, 1);
        } else {
          let list = (this.navigationTab === 'pre')
            ? this.preExamQuestions
            : this.postExamQuestions;
          const index = list.findIndex(r => r.id === this.rowToDelete.id);
          if (index !== -1) list.splice(index, 1);
        }
        this.closeAllModals();
      },
      closeAllModals() {
        this.openAddTemplateModal = false;
        this.openAddQuestionModal = false;
        this.openEditModal = false;
        this.openDeleteModal = false;
        this.editRow = {};
        this.newQuestion = { text: '', description: '', response_type: 'scale', scale_type: 'positive' };
        this.rowToDelete = null;
        this.selectedTemplates = [];
      }
    };
  }
</script>