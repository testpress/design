<script>


  var params = URLSearchParams && new URLSearchParams(document.location.search.substring(1));
  var url = params && params.get("url") && decodeURIComponent(params.get("url"));
  var currentSectionIndex = (params && params.get("loc")) ? params.get("loc") : undefined;

  // Load the opf
  var book = ePub(url || "https://s3.amazonaws.com/moby-dick/moby-dick.epub");
  var rendition = book.renderTo("viewer", {
    width: "100%",
    height: "100%",
    spread: "always"
  });

  rendition.display(currentSectionIndex);
  rendition.hooks.content.register(function(contents) {
  let doc = contents.document;
  let style = doc.createElement("style");
  style.innerHTML = `
    body {
      padding-left: 20px;
      padding-right: 20px;
    }
  `;
  doc.head.appendChild(style);
});


  book.ready.then(function() {
    

    var next = document.getElementById("next");

    next.addEventListener("click", function(e){
      book.package.metadata.direction === "rtl" ? rendition.prev() : rendition.next();
      e.preventDefault();
    }, false);

    var prev = document.getElementById("prev");
    prev.addEventListener("click", function(e){
      book.package.metadata.direction === "rtl" ? rendition.next() : rendition.prev();
      e.preventDefault();
    }, false);

    var keyListener = function(e){

      // Left Key
      if ((e.keyCode || e.which) == 37) {
        book.package.metadata.direction === "rtl" ? rendition.next() : rendition.prev();
      }

      // Right Key
      if ((e.keyCode || e.which) == 39) {
        book.package.metadata.direction === "rtl" ? rendition.prev() : rendition.next();
      }

    };

    rendition.on("keyup", keyListener);
    document.addEventListener("keyup", keyListener, false);
    document.getElementById("preview-loader").classList.add("hidden");
    document.getElementById("ebook-preview").classList.remove("hidden");
  })

  var title = document.getElementById("title");

  function toggleModalVisibility(modal_button_id, should_show) {
    if (should_show) {
      let modal = new HSOverlay(document.querySelector(`#${modal_button_id}`));
      console.log(modal)
      modal.open()
    } else {
      const {
        element
      } = HSOverlay.getInstance(`#${modal_button_id}`, true);
      element.close()
    }
  }


rendition.on("rendered", function(section) {
    var current = book.navigation && book.navigation.get(section.href);
    const comboBox = window.HSComboBox.getInstance("#toc-container");
   const fullScreenOverlay = document.getElementById("full-screen-render");

    if (current) {
        var $toc = document.getElementById("toc");
        var tocHtml = "";

        var items = book.navigation.toc; // Assuming this contains your TOC data

        for (var i = 0; i < items.length; ++i) {
            let selected = items[i].href === current.href;

            tocHtml += `
                <div data-hs-combo-box-output-item tabindex="${i + 1}"
                     class="toc-link hover:cursor-pointer flex items-center gap-x-2 py-2 px-3 rounded-lg text-sm text-gray-600 hover:bg-gray-100 focus:outline-hidden focus:bg-gray-100 dark:text-neutral-400 dark:hover:bg-neutral-700 dark:hover:text-neutral-400 dark:focus:bg-neutral-700 dark:focus:text-neutral-400 
                     ${selected ? 'bg-gray-100' : ''}" 
                     data-href="${items[i].href}">
                  <a href="#" class="flex items-center gap-x-2 w-full ">
                    <span class="hidden" data-hs-combo-box-output-item-field="alt" data-hs-combo-box-output-item-hide-if-empty="" data-hs-combo-box-search-text="" style="display: none;"></span>
                    <span class="hidden" data-hs-combo-box-output-item-field="category" data-hs-combo-box-search-text="Overlays">Overlays</span>
                    <span data-hs-combo-box-output-item-field="title" data-hs-combo-box-search-text="${items[i].label}" data-hs-combo-box-value="">${items[i].label}</span>
                  </a>
                </div>`;
        }

        // Set the inner HTML of the TOC
        $toc.innerHTML = tocHtml;

        // Add event listeners to prevent page reload and navigate via rendition.display()
        document.querySelectorAll(".toc-link").forEach(link => {
            link.addEventListener("click", function(event) {
                event.preventDefault();
                let parentDiv = this.closest("[data-href]");
                let sectionHref = parentDiv.getAttribute("data-href");

                if (sectionHref) {
                    rendition.display(sectionHref);
                    toggleModalVisibility("hs-pro-dnnd", false);
                    fullScreenOverlay.classList.add("hidden");
                }
            });
        });

    }
});

// Debounce function to optimize search handling
function debounce(func, delay) {
    let timer;
    return function (...args) {
        clearTimeout(timer);
        timer = setTimeout(() => func.apply(this, args), delay);
    };
}

// Function to filter TOC items based on search query
function filterTOC(searchQuery) {
    console.log("ðŸ”Ž Searching for:", searchQuery);

    const tocItems = document.querySelectorAll("#toc div[data-hs-combo-box-output-item]");
    let hasResults = false;

    tocItems.forEach((item) => {
        const title = item.querySelector("[data-hs-combo-box-output-item-field='title']");
        if (title) {
            const text = title.textContent.trim().toLowerCase();
            const match = text.includes(searchQuery.toLowerCase());

            if (match) {
                item.style.display = ""; // Show matching item
                hasResults = true;
            } else {
                item.style.display = "none"; // Hide non-matching items
            }
        }
    });

    // If no results, show a "No Results" message
    const noResultsDiv = document.getElementById("no-results");
    const tocContentsDiv = document.getElementById("toc-contents");
    if (!hasResults) {
    noResultsDiv.classList.remove("hidden"); // Show "No Results" message
    tocContentsDiv.classList.add("hidden"); // Hide TOC contents
} else {
    noResultsDiv.classList.add("hidden"); // Hide "No Results" message
    tocContentsDiv.classList.remove("hidden"); // Show TOC contents
}
}

// Attach event listener with debounce to the search input
document.addEventListener("DOMContentLoaded", () => {
    const searchInput = document.querySelector("input[role='combobox']");
    if (searchInput) {
        searchInput.addEventListener("input", debounce((e) => {
            filterTOC(e.target.value);
        }, 300)); // 300ms delay to optimize performance
    }
});



  rendition.on("relocated", function(location){
    console.log(location);

    var next = book.package.metadata.direction === "rtl" ?  document.getElementById("prev") : document.getElementById("next");
    var prev = book.package.metadata.direction === "rtl" ?  document.getElementById("next") : document.getElementById("prev");

    if (location.atEnd) {
      next.style.visibility = "hidden";
    } else {
      next.style.visibility = "visible";
    }

    if (location.atStart) {
      prev.style.visibility = "hidden";
    } else {
      prev.style.visibility = "visible";
    }

  });

  rendition.on("layout", function(layout) {
    let viewer = document.getElementById("viewer");

    if (layout.spread) {
      viewer.classList.remove('single');
    } else {
      viewer.classList.add('single');
    }
  });

  window.addEventListener("unload", function () {
    console.log("unloading");
    this.book.destroy();
  });
  
</script> 