<script src="https://preline.co/pro/assets/vendor/lodash/lodash.min.js"></script>
<script src="https://preline.co/pro/assets/vendor/apexcharts/dist/apexcharts.min.js"></script>
<script src="https://preline.co/pro/assets/js/hs-apexcharts-helpers.js"></script>

<script>
  function renderDonutChart(
    chartId,
    seriesData,
    seriesLabels,
    chartColors,
    chartHeight = 230,
    chartWidth = 230
  ) {
    const chartEl = document.querySelector(chartId);
    if (!chartEl) {
      console.warn(`Chart element ${chartId} not found.`);
      return;
    }
    chartEl.innerHTML = '';
    const options = (mode) => ({
      chart: {
        height: chartHeight,
        width: chartWidth,
        type: 'donut',
        zoom: { enabled: false }
      },
      plotOptions: { pie: { donut: { size: '76%' } } },
      series: seriesData,
      labels: seriesLabels,
      legend: { show: false },
      dataLabels: { enabled: false },
      stroke: { width: 5 },
      grid: { padding: { top: -12, bottom: -11, left: -12, right: -12 } },
      states: {
        hover: { filter: { type: 'none', value: 0 } },
        active: { allowMultipleDataPointsSelection: false }
      },
      tooltip: {
        enabled: true,
        custom: ({ seriesIndex, w }) => {
          if (seriesIndex < 0 || !w.globals.labels[seriesIndex]) return '';
          const label = w.globals.labels[seriesIndex];
          const value = w.globals.series[seriesIndex];
          const total = w.globals.series.reduce((a, b) => a + b, 0);
          const percentage = ((value / total) * 100).toFixed(1);
          const color = w.globals.colors[seriesIndex];
          return `
  <div class="border border-gray-300 bg-white w-36 text-gray-900 shadow-xl">
    <div class="px-2 py-1.5 font-semibold text-[13px] flex items-center">
      <span>${label}</span>
      <span class="ms-auto">${percentage}%</span>
    </div>
    <div class="border-t border-gray-200"></div>
    <div class="space-y-1.5 p-2">
      <div class="flex items-center gap-x-2 text-xs text-gray-600">
        <span class="w-3 h-3 rounded-sm inline-block" style="background:${color}"></span>
        <span>Count</span>
        <span class="ms-auto">${value}</span>
      </div>
    </div>
  </div>
          `;
        }
      }
    });
    const theme = { colors: chartColors, stroke: { colors: ['#ffffff'] } };
    buildChart(chartId, options, theme, theme);
  }

  function renderPieChart(
    chartId,
    seriesData,
    seriesLabels,
    chartColors,
    chartHeight = 310,
    chartWidth = 310
  ) {
    const chartEl = document.querySelector(chartId);
    if (!chartEl) {
      console.warn(`Chart element ${chartId} not found.`);
      return;
    }
    chartEl.innerHTML = '';

    const options = (mode) => ({
      chart: {
        height: chartHeight,
        width: chartWidth,
        type: 'pie',
        zoom: { enabled: false }
      },
      plotOptions: {
        pie: {
          expandOnClick: true,
          donut: {
            labels: {
              show: false
            }
          }
        }
      },
      series: seriesData,
      labels: seriesLabels,
      legend: { show: false },
      dataLabels: { enabled: false },
      stroke: { width: 2, colors: ['#ffffff'] },
      grid: {
        padding: { top: 10, bottom: 10, left: 10, right: 10 }
      },
      states: {
        hover: {
          filter: { type: 'darken', value: 0.95 }
        },
        active: {
          allowMultipleDataPointsSelection: false,
          filter: { type: 'darken', value: 0.85 }
        }
      },
      tooltip: {
        enabled: true,
        custom: ({ seriesIndex, w }) => {
          if (seriesIndex < 0 || !w.globals.labels[seriesIndex]) return '';
          const label = w.globals.labels[seriesIndex];
          const value = w.globals.series[seriesIndex];
          const total = w.globals.series.reduce((a, b) => a + b, 0);
          const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
          const color = w.globals.colors[seriesIndex];

          return `
  <div class="border border-gray-300 bg-white w-36 text-gray-900 shadow-xl">
    <div class="px-2 py-1.5 font-semibold text-[13px] flex items-center">
      <span class="break-words whitespace-normal w-full block">${label}</span>
      <span class="ms-auto">${percentage}%</span>
    </div>
    <div class="border-t border-gray-200"></div>
    <div class="space-y-1.5 p-2">
      <div class="flex items-center gap-x-2 text-xs text-gray-600">
        <span class="w-3 h-3 rounded-sm inline-block" style="background:${color}"></span>
        <span>Count</span>
        <span class="ms-auto">${value}</span>
      </div>
    </div>
  </div>
          `;
        }
      }
    });

    const theme = {
      colors: chartColors,
      stroke: {
        colors: ['#ffffff']
      }
    };

    buildChart(chartId, options, theme, theme);
  }

  function renderBubbleChart(chartId, seriesData, chartColors, actualPercentages) {
    const chartEl = document.querySelector(chartId);
    if (!chartEl) {
      console.warn(`Chart element ${chartId} not found.`);
      return;
    }

    chartEl.innerHTML = '';

    const textColors = (chartColors || [])
      .slice(0, seriesData.length)
      .map((hex) => {
        if (!hex) return '#1f2937';
        const h = hex.replace('#', '');
        const r = parseInt(h.substring(0, 2), 16);
        const g = parseInt(h.substring(2, 4), 16);
        const b = parseInt(h.substring(4, 6), 16);
        const brightness = (r * 299 + g * 587 + b * 114) / 1000;
        return brightness > 160 ? '#1f2937' : '#ffffff';
      });

    const options = () => ({
      chart: {
        height: '100%',
        type: 'bubble',
        toolbar: { show: false },
        zoom: { enabled: false }
      },
      series: seriesData,
      dataLabels: {
        style: {
          fontSize: '18px',
          fontFamily: 'Inter, ui-sans-serif',
          fontWeight: '600',
          colors: textColors
        },
        formatter: (_value, opts) => {
          const idx = opts.seriesIndex;
          return actualPercentages && actualPercentages[idx] != null
            ? `${actualPercentages[idx]}%`
            : '';
        }
      },
      fill: { opacity: 1 },
      legend: { show: false },
      plotOptions: {
        bubble: {
          zScaling: false,
          minBubbleRadius: 40
        }
      },
      grid: {
        show: false,
        padding: { top: 0, bottom: 0, left: 0, right: 0 }
      },
      xaxis: {
        min: 0,
        max: 15,
        labels: { show: false },
        axisBorder: { show: false },
        axisTicks: { show: false }
      },
      yaxis: {
        min: 0,
        max: 15,
        labels: { show: false }
      },
      tooltip: { 
        enabled: true,
        custom: ({ seriesIndex, w }) => {
          const name = w.config.series[seriesIndex].name;
          const percent = actualPercentages[seriesIndex];
          return `<div class="p-2 bg-white border border-gray-200 shadow-lg rounded-lg">
                    <div class="text-xs font-bold">${name}</div>
                    <div class="text-[10px] text-gray-500">${percent}% of total mistakes</div>
                  </div>`;
        }
      },
      states: { hover: { filter: { type: 'none' } } }
    });

    buildChart(
      chartId,
      options,
      { colors: chartColors, markers: { strokeColors: 'rgb(255, 255, 255)' } },
      { colors: chartColors, markers: { strokeColors: 'rgb(38, 38, 38)' } }
    );
  }
</script>