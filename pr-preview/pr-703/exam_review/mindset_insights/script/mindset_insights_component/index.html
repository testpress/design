<script>
  const COLOR_PALETTE = [
    '#3B82F6', // blue-500
    '#6366F1', // indigo-500
    '#8B5CF6', // purple-500
    '#EC4899', // pink-500
    '#F43F5E', // rose-500
    '#F97316', // orange-500
    '#EAB308', // yellow-500
    '#22C55E', // green-500
    '#10B981', // emerald-500
    '#14B8A6', // teal-500
    '#06B6D4', // cyan-500
    '#64748B', // slate-500
    '#9CA3AF', // gray-400
    '#F87171', // red-400
    '#A78BFA', // violet-400
  ];

  class ColorMapper {
    constructor(baseLabels = []) {
      this.mapping = {};
      this.colorIndex = 0;
      baseLabels.forEach(label => {
        this.getColor(label);
      });
    }

    getColor(label) {
      if (!this.mapping[label]) {
        this.mapping[label] = COLOR_PALETTE[this.colorIndex % COLOR_PALETTE.length];
        this.colorIndex++;
      }
      return this.mapping[label];
    }

    getColorsForLabels(labels = []) {
      return labels.map(label => this.getColor(label));
    }
  }
</script>

<script>
  function mindsetInsightsComponent() {
    return {
      data: {"preTestAnswers":{"scale_based":[{"id":"anxiety","score":1,"label":"How anxious are you feeling?","type":"negative","scaleMin":1,"scaleMax":5},{"id":"confidence","score":5,"label":"Confidence","type":"positive","scaleMin":1,"scaleMax":5},{"id":"focus","score":2,"label":"How focused are you feeling right now?","type":"positive","scaleMin":1,"scaleMax":5},{"id":"rested","score":3,"label":"How well-rested are you?","type":"positive","scaleMin":1,"scaleMax":5}],"text_based":[{"id":"pre_notes","label":"Any additional thoughts before you start?","response":"I reviewed Chapter 3 last night, but I'm still worried about the graph questions..."},{"id":"strategy_goal","label":"What is your primary goal or strategy for this exam?","response":"To manage my time better on the math section and not get stuck."}]},"postTestAnswers":{"scale_based":[{"id":"anxiety_during","score":2,"label":"Did you feel anxious while taking the exam?","type":"negative","scaleMin":1,"scaleMax":5},{"id":"rushed","score":5,"label":"Did you feel time was running out / you felt rushed?","type":"negative","scaleMin":1,"scaleMax":5},{"id":"clarity","score":3,"label":"How clear were the questions to you?","type":"positive","scaleMin":1,"scaleMax":5},{"id":"difficulty_perception","score":4,"label":"How difficult did you find this exam overall?","type":"negative","scaleMin":1,"scaleMax":5},{"id":"focus_during","score":2,"label":"How well were you able to maintain focus?","type":"positive","scaleMin":1,"scaleMax":5}],"text_based":[{"id":"held_back","label":"What held you back from performing your best?","response":"I felt the time was rushing fast and I messed up in the graph problems."},{"id":"improve_note","label":"What stood out about how you could improve?","response":"I need to practice more math problems, especially graphs and interpreting axes."},{"id":"overall_feedback","label":"Any other feedback about the exam experience?","response":"Consider a few practice graph templates in the prep materials."}]},"errorReasons":{"totalErrors":28,"totalIncorrect":35,"summary":{"ids":["rushed","calculation","lack_knowledge","time_pressure","didnt_understand","misread","careless","wrong_strategy","guessed","others"],"labels":["Rushed","Calculation Error","Lack of Knowledge","Time Pressure","Didn't Understand Question","Misread the Question","Careless Mistake","Used Wrong Strategy","Guessed","Others"],"series":[6,5,4,3,3,2,2,1,1,1]},"bySection":[{"id":"english","name":"English","totalIncorrect":15,"ids":["didnt_understand","misread","rushed","lack_knowledge","guessed","others"],"labels":["Didn't Understand Question","Misread the Question","Rushed","Lack of Knowledge","Guessed","Others"],"series":[3,2,2,1,1,1],"errors":10,"bySubject":[{"id":"rc","name":"Reading Comprehension","ids":["didnt_understand","rushed"],"labels":["Didn't Understand Question","Rushed"],"series":[2,1],"errors":3},{"id":"grammar","name":"Grammar","ids":["lack_knowledge","misread"],"labels":["Lack of Knowledge","Misread the Question"],"series":[1,1],"errors":2},{"id":"vocab","name":"Vocabulary","ids":["guessed","others"],"labels":["Guessed","Others"],"series":[1,1],"errors":2},{"id":"para_jumbles","name":"Para Jumbles","ids":["misread","didnt_understand"],"labels":["Misread the Question","Didn't Understand Question"],"series":[1,1],"errors":2},{"id":"cloze_test","name":"Cloze Test","ids":["rushed"],"labels":["Rushed"],"series":[1],"errors":1}]},{"id":"maths","name":"Maths","totalIncorrect":20,"ids":["calculation","rushed","time_pressure","lack_knowledge","careless","wrong_strategy"],"labels":["Calculation Error","Rushed","Time Pressure","Lack of Knowledge","Careless Mistake","Used Wrong Strategy"],"series":[5,4,3,3,2,1],"errors":18,"bySubject":[{"id":"arithmetic","name":"Arithmetic","ids":["calculation","rushed","time_pressure"],"labels":["Calculation Error","Rushed","Time Pressure"],"series":[2,2,1],"errors":5},{"id":"algebra","name":"Algebra","ids":["calculation","lack_knowledge"],"labels":["Calculation Error","Lack of Knowledge"],"series":[1,2],"errors":3},{"id":"geometry","name":"Geometry","ids":["lack_knowledge","wrong_strategy"],"labels":["Lack of Knowledge","Used Wrong Strategy"],"series":[1,1],"errors":2},{"id":"data_interp","name":"Data Interpretation","ids":["rushed","time_pressure","careless"],"labels":["Rushed","Time Pressure","Careless Mistake"],"series":[2,1,1],"errors":4},{"id":"number_system","name":"Number System","ids":["calculation","time_pressure"],"labels":["Calculation Error","Time Pressure"],"series":[1,1],"errors":2},{"id":"trigonometry","name":"Trigonometry","ids":["calculation","careless"],"labels":["Calculation Error","Careless Mistake"],"series":[1,1],"errors":2}]}]},"pathway":{"topErrors":[{"id":"rushed","label":"Rushed","count":6,"exampleQuestions":["Q7 - data interpretation","Q15 - paragraph summary"],"suggestedStrategy":"test_skill","suggestedImprovement":"focusing on timing discipline and exam strategy"},{"id":"lack_knowledge","label":"Lack of Knowledge","count":4,"exampleQuestions":["Q3 - algebraic simplification","Q19 - grammar rule"],"suggestedStrategy":"conceptual","suggestedImprovement":"revising weak concepts and practicing targeted questions"},{"id":"didnt_understand","label":"Didn't Understand Question","count":3,"exampleQuestions":["Q28 - data interpretation set"],"suggestedStrategy":"comprehension","suggestedImprovement":"slowing down to interpret questions carefully"}]},"improvementStrategies":{"test_skill":{"name":"Boost Exam-Taking Skills","guidance":"Focus on pacing during the exam, double-check work for small errors, and avoid rushing at the end. Practice timed quizzes to build consistency under pressure.","description":"Improving exam behavior and time management can significantly increase accuracy without needing major concept revision.","studentBehavior":"Try short timed sections and celebrate small wins (e.g., finishing one section without rushing). When you notice time slipping, pause and choose 1 quick step: simplify the problem, mark it to return, or estimate an answer."},"conceptual":{"name":"Strengthen Concept Mastery","guidance":"Review foundational ideas behind the topics where mistakes occurred. Practice similar question types to reinforce core strategies and problem-solving methods.","description":"Better command of required knowledge leads to more confident and reliable performance.","studentBehavior":"Break down the concept into 2–3 core rules and practice 5 focused problems. Keep notes of repeated patterns that help you solve similar problems faster next time."},"comprehension":{"name":"Improve Question Understanding","guidance":"Slow down while reading, underline key words, and restate the problem in your own words. Look out for small hints or constraints in the question.","description":"Careful reading helps avoid avoidable errors and ensures the right strategy is applied.","studentBehavior":"Before solving, spend 6–8 seconds paraphrasing the question out loud or in writing and underline what the question specifically asks for. This habit prevents misapplied strategies."}},"strategyMap":{"rushed":"test_skill","didnt_understand":"comprehension","misread":"comprehension","time_pressure":"test_skill","calculation":"test_skill","lack_knowledge":"conceptual","careless":"test_skill","wrong_strategy":"conceptual","guessed":"test_skill","others":"test_skill"}},
      loading: {
        preTest: true,
        postTest: true,
        errors: true,
        pathway: true
      },

      preTestRatings: [],
      preTestNotes: [],
      postTestRatings: [],
      postTestNotes: [],
      sections: [],
      selectedSectionId: null,
      errorSummaryForChart: { labels: [], series: [], totalErrors: 0, totalIncorrect: 0, bySubject: [] },
      showReflectionReminderToast: false,
      selectedErrorReason: null,
      pathway: {
        topErrors: [],
        mindsetBarriers: [],
        totalErrors: 0
      },

      improvementStrategies: {},
      strategyMap: {},
      
      colorMapper: null,
      _bubbleRendered: false,

      init() {
        requestAnimationFrame(() => {
          const src = this.data || {};
          const overallLabels = src.errorReasons?.summary?.labels || [];
          this.colorMapper = new ColorMapper(overallLabels);
          this.processReflections(src);
          this.processErrorData(src);
          this.processPathway(src);
          if (this.sections.length > 0) {
            this.selectedSectionId = this.sections[0].section_id;
            this.changeSection(false);
          }
          this.loading.preTest = false;
          this.loading.postTest = false;
          this.loading.errors = false;
          this.loading.pathway = false;
          this.$nextTick(() => {
            this.renderErrorChart();
            this.renderPathwayCharts();
            this.renderSubjectErrorCharts();
          });
        });
      },

      get pendingReflectionsCount() {
        if (!this.errorSummaryForChart) return 0;
        return this.errorSummaryForChart.totalIncorrect - this.errorSummaryForChart.totalErrors;
      },

      processReflections(src) {
        const pre = src.preTestAnswers || {};
        this.preTestRatings = Array.isArray(pre.scale_based) ? pre.scale_based : [];
        this.preTestNotes = Array.isArray(pre.text_based) ? pre.text_based : [];
        const post = src.postTestAnswers || {};
        this.postTestRatings = Array.isArray(post.scale_based) ? post.scale_based : [];
        this.postTestNotes = Array.isArray(post.text_based) ? post.text_based : [];
      },

      processErrorData(src) {
        const errorReasons = src.errorReasons || { summary: null, bySection: [] };
        const summary = errorReasons.summary || {};
        const bySection = Array.isArray(errorReasons.bySection) ? errorReasons.bySection : [];
        this.pathway.totalErrors = errorReasons.totalErrors || 0;
        const overallTotalIncorrect = errorReasons.totalIncorrect || errorReasons.totalErrors || 0;
        this.sections = [];
        if (summary.series && summary.series.length > 0) {
          this.sections.push({
            section_id: 'overall',
            section_name: 'Overall',
            data: {
              ids: summary.ids,
              labels: summary.labels,
              series: summary.series,
              totalErrors: this.pathway.totalErrors,
              totalIncorrect: overallTotalIncorrect,
              bySubject: []
            }
          });
        }
        bySection.forEach(subject => {
          const subTopics = (subject.bySubject || []).map(sub => ({
            ...sub,
            colors: this.colorMapper.getColorsForLabels(sub.labels)
          }));
          if (subject.series && subject.series.length > 0) {
            this.sections.push({
              section_id: subject.id || subject.name,
              section_name: subject.name,
              data: {
                ids: subject.ids,
                labels: subject.labels,
                series: subject.series,
                totalErrors: subject.errors || 0,
                totalIncorrect: subject.totalIncorrect || subject.errors || 0,
                bySubject: subTopics
              }
            });
          }
        });
      },

      processPathway(src) {
        this.improvementStrategies = src.improvementStrategies || {};
        this.strategyMap = src.strategyMap || {};
        const srcPathway = src.pathway || { topErrors: [] };
        if (this.pathway.totalErrors > 0) {
          this.pathway.topErrors = (srcPathway.topErrors || [])
            .sort((a, b) => b.count - a.count)
            .slice(0, 3)
            .map(err => {
              return {
                id: err.id,
                reason: err.label,
                count: err.count,
                percentage: Math.round((err.count / this.pathway.totalErrors) * 100),
                improvementPhrase: err.suggestedImprovement || "reviewing your errors"
              };
            });
        }
      },

      changeSection(renderChart = true) {
        const selected = this.sections.find(s => s.section_id === this.selectedSectionId);
        if (!selected) {
          this.errorSummaryForChart = { labels: [], series: [], totalErrors: 0, totalIncorrect: 0, bySubject: [] };
          this.showReflectionReminderToast = false;
          return;
        }
        this.errorSummaryForChart = selected.data;
        
        const hasPendingReflections = this.errorSummaryForChart.totalErrors < this.errorSummaryForChart.totalIncorrect;
        this.showReflectionReminderToast = false;
        
        if (hasPendingReflections) {
          this.$nextTick(() => {
            const TOAST_ANIMATION_RETRIGGER_DELAY_MS = 50;
            setTimeout(() => {
              this.showReflectionReminderToast = true;
            }, TOAST_ANIMATION_RETRIGGER_DELAY_MS);
          });
        }

        if (renderChart) {
          this.$nextTick(() => {
            this.renderErrorChart();
            this.renderSubjectErrorCharts();
          });
        }
      },

      renderErrorChart() {
        const chartEl = document.querySelector('#error-reason-chart');
        if (!this.errorSummaryForChart.series?.length || !this.errorSummaryForChart.totalErrors) {
          if (chartEl) chartEl.innerHTML = '';
          return;
        }
        const chartColors = this.colorMapper.getColorsForLabels(this.errorSummaryForChart.labels);
        renderPieChart(
          '#error-reason-chart',
          this.errorSummaryForChart.series,
          this.errorSummaryForChart.labels,
          chartColors
        );
      },

      renderPathwayCharts() {
        const chartEl = document.querySelector('#hs-devices-bubble-chart');
        if (!chartEl) return;
        if (!this.pathway.topErrors?.length) {
          chartEl.innerHTML = '';
          return;
        }
        const topErrors = this.pathway.topErrors;
        const prelineSeries = [
          { name: "Top Error 1", data: [[8.5, 7.5, 90]] },
          { name: "Top Error 2", data: [[4.5, 7, 70]] },
          { name: "Top Error 3", data: [[6.2, 5.2, 40]] }
        ];
        const chartColors = [];
        const actualPercentages = [];
        topErrors.forEach((error, index) => {
          if (prelineSeries[index]) {
            prelineSeries[index].name = error.reason;
            chartColors[index] = this.colorMapper.getColor(error.reason);
            actualPercentages[index] = error.percentage;
          }
        });
        const finalSeries = prelineSeries.slice(0, topErrors.length);
        const finalColors = chartColors.slice(0, topErrors.length);
        const finalPercentages = actualPercentages.slice(0, topErrors.length);
        chartEl.innerHTML = '';
        renderBubbleChart('#hs-devices-bubble-chart', finalSeries, finalColors, finalPercentages);
        this._bubbleRendered = true;
      },

      renderSubjectErrorCharts() {
        const topics = this.errorSummaryForChart.bySubject || [];
        const currentChartIds = new Set(topics.map(t => `subject-chart-${t.id}`));
        document.querySelectorAll('[id^="subject-chart-"]').forEach(el => {
          if (!currentChartIds.has(el.id)) {
            el.innerHTML = '';
          }
        });
        if (topics.length === 0) return;
        topics.forEach(topic => {
          const chartId = `#subject-chart-${topic.id}`;
          const chartEl = document.querySelector(chartId);
          if (chartEl && topic.series && topic.series.length > 0) {
            renderPieChart(
              chartId,
              topic.series,
              topic.labels,
              topic.colors,
              160,
              160
            );
          }
        });
      },
      
      sanitizeScore(score, min = 1, max = 5) {
        const s = parseInt(score, 10) || 1;
        return Math.max(min, Math.min(max, s));
      },
      
      showQuestionsForReason(reasonLabel) {
        this.selectedErrorReason = reasonLabel;
        this.$nextTick(() => {
          const triggerBtn = document.getElementById('hs-pro-shflo-trigger');
          if (triggerBtn) {
            triggerBtn.click();
          }
        });
      }
    };
  }
</script>
