<script>
  const COLOR_PALETTE = [
    '#3B82F6',
    '#6366F1',
    '#8B5CF6',
    '#EC4899',
    '#F43F5E',
    '#F97316',
    '#EAB308',
    '#22C55E',
    '#10B981',
    '#14B8A6',
    '#06B6D4',
    '#64748B',
    '#9CA3AF',
    '#F87171',
    '#A78BFA',
  ];
  class ColorMapper {
    constructor(baseLabels = []) {
      this.mapping = {};
      this.colorIndex = 0;
      baseLabels.forEach(label => this.getColor(label));
    }
    getColor(label) {
      if (!this.mapping[label]) {
        this.mapping[label] = COLOR_PALETTE[this.colorIndex % COLOR_PALETTE.length];
        this.colorIndex++;
      }
      return this.mapping[label];
    }
    getColorsForLabels(labels = []) {
      return labels.map(label => this.getColor(label));
    }
  }

  const RECOMMENDATION_MAPPING = {
    'didnt_understand_question': "If you'd like, try pausing for a few seconds to restate the question in your own words before solving. Many students find that rephrasing clarifies what the question is *really* asking.",
    'didnt_know_strategy': "If you want, you could try identifying what kind of problem this is before solving it. Noting the pattern first often makes the right approach easier to spot.",
    'didnt_know_key_information': "If you'd like, note the exact fact or concept you were missing and do a quick refresher on just that one idea. Filling a single gap is often enough to unlock similar questions next time.",
    'used_wrong_strategy': "If you want, you could compare your approach with the solution's approach and ask: 'At what point did they choose differently?' Spotting that fork helps avoid repeating the same strategy next time.",
    'execution_mistake': "If you'd like, try adding a quick checkpoint during solving—after a calculation or step—to verify you're still on track. Small pauses can prevent small slips.",
    'missed_question_detail': "If you want, you could try scanning the question once specifically for constraints or qualifiers (like 'only', 'except', or units) before solving. Many students catch hidden details this way.",
    'misread_options': "If you'd like, try reading each option carefully and matching it back to what you *intended* to answer. This helps avoid choosing a nearby or look-alike option by accident.",
    'rushed': "If you want, consider slowing down slightly on the first read and speeding up only after you're clear on the question. Many students find this tradeoff improves accuracy without costing time.",
    'running_out_of_time': "If you'd like, you could try deciding earlier which questions to skip and return to. Protecting time for stronger questions often leads to better overall scores.",
    'didnt_answer': "If you want, you could set a soft time limit per question and make a best attempt before moving on. Even partial reasoning improves your odds compared to leaving it blank.",
    'marking_error': "If you'd like, try adding a final 'intent check'—quickly confirm that the option you clicked matches the one you solved for. This small habit prevents avoidable losses.",
    'other': "If you want, briefly note what caused the issue this time. Patterns become easier to fix once the reason is clear—even if it doesn't fit a standard category."
  };

  function consolidatedMindsetComponent() {
    return {
      data: {"totalErrors":42,"totalReflectedExams":12,"summary":{"ids":["didnt_understand_question","didnt_know_strategy","didnt_know_key_information","used_wrong_strategy","execution_mistake","missed_question_detail","misread_options","rushed","running_out_of_time","didnt_answer","marking_error","other"],"labels":["Didn't Understand Question","Didn't Know Strategy","Didn't Know Key Information","Used Wrong Strategy","Execution Mistake","Missed a Question Detail","Misread Options","Rushed","Running Out of Time","Didn't Answer","Marking Error","Other"],"series":[14,12,9,8,6,6,4,3,2,1,1,1],"examCounts":[5,4,6,3,7,4,2,2,1,1,1,1]},"topErrors":[{"id":"execution_mistake","label":"Execution Mistake","count":14,"examCount":5,"suggestedImprovement":"If you'd like, try adding a quick checkpoint during solving—after a calculation or step—to verify you're still on track. Small pauses can prevent small slips."},{"id":"didnt_know_key_information","label":"Didn't Know Key Information","count":12,"examCount":4,"suggestedImprovement":"If you'd like, note the exact fact or concept you were missing and do a quick refresher on just that one idea. Filling a single gap is often enough to unlock similar questions next time."},{"id":"missed_question_detail","label":"Missed a Question Detail","count":9,"examCount":6,"suggestedImprovement":"If you want, you could try scanning the question once specifically for constraints or qualifiers (like 'only', 'except', or units) before solving. Many students catch hidden details this way."}],"questions":[{"id":501,"reasonId":"execution_mistake","reasonLabel":"Execution Mistake","subject":"Physics","examName":"Physics - Rotational Motion","text":"A solid sphere of mass 2kg and radius 0.5m rotates about its axis. What is its Moment of Inertia?","correctIdx":1,"options":[{"text":"0.5 kg m²"},{"text":"0.2 kg m²"},{"text":"0.4 kg m²"},{"text":"1.0 kg m²"}],"explanation":"Moment of Inertia for a solid sphere is I = (2/5)MR². Substituting M=2, R=0.5 (or 1/2): I = (2/5) * 2 * (1/2)² = (4/5) * (1/4) = 1/5 = 0.2 kg m²."},{"id":502,"reasonId":"execution_mistake","reasonLabel":"Execution Mistake","subject":"Chemistry","examName":"Chemistry - Stoichiometry","text":"How many moles of O₂ are required to completely react with 2 moles of Butane (C₄H₁₀)?","correctIdx":2,"options":[{"text":"6.5"},{"text":"8"},{"text":"13"},{"text":"10"}],"explanation":"Reaction: 2C₄H₁₀ + 13O₂ → 8CO₂ + 10H₂O. The stoichiometry shows 2 moles of Butane require 13 moles of Oxygen. Common error is forgetting to balance the oxygen for both CO2 and H2O."},{"id":503,"reasonId":"execution_mistake","reasonLabel":"Execution Mistake","subject":"Math","examName":"Math - Calculus","text":"Evaluate d/dx (sin²(x)).","correctIdx":0,"options":[{"text":"sin(2x)"},{"text":"cos²(x)"},{"text":"2sin(x)"},{"text":"-sin(2x)"}],"explanation":"Using chain rule: d/dx(sin(x)²) = 2sin(x) * d/dx(sin(x)) = 2sin(x)cos(x). By double angle identity, 2sin(x)cos(x) = sin(2x)."},{"id":504,"reasonId":"execution_mistake","reasonLabel":"Execution Mistake","subject":"Physics","examName":"Physics - Current Electricity","text":"Three resistors of 2Ω, 3Ω, and 6Ω are connected in parallel. What is the equivalent resistance?","correctIdx":1,"options":[{"text":"11Ω"},{"text":"1Ω"},{"text":"0.5Ω"},{"text":"1.5Ω"}],"explanation":"1/Req = 1/2 + 1/3 + 1/6. LCM is 6. 1/Req = (3+2+1)/6 = 6/6 = 1. So Req = 1Ω. A common execution error is summing them (series) or flipping the fraction incorrectly."},{"id":505,"reasonId":"execution_mistake","reasonLabel":"Execution Mistake","subject":"Chemistry","examName":"Chemistry - Solutions","text":"Calculate the molarity of a solution containing 4g of NaOH in 250ml of solution.","correctIdx":3,"options":[{"text":"0.1 M"},{"text":"1.0 M"},{"text":"0.2 M"},{"text":"0.4 M"}],"explanation":"Molar mass of NaOH = 40g/mol. Moles = 4/40 = 0.1 mol. Volume = 0.25 L. Molarity = 0.1 / 0.25 = 0.4 M."},{"id":301,"reasonId":"didnt_know_key_information","reasonLabel":"Didn't Know Key Information","subject":"Chemistry","examName":"Chemistry - Solutions","text":"Which of the following colligative properties is used to determine the molar mass of proteins and polymers?","correctIdx":2,"options":[{"text":"Relative lowering of Vapor Pressure"},{"text":"Elevation in Boiling Point"},{"text":"Osmotic Pressure"},{"text":"Depression in Freezing Point"}],"explanation":"Osmotic pressure is preferred for macromolecules because it has a measurable magnitude even at room temperature and molarity is used instead of molality."},{"id":302,"reasonId":"didnt_know_key_information","reasonLabel":"Didn't Know Key Information","subject":"Biology","examName":"Biology - Genetics","text":"In a DNA molecule, which bond holds the nitrogenous bases together?","correctIdx":1,"options":[{"text":"Phosphodiester bond"},{"text":"Hydrogen bond"},{"text":"Glycosidic bond"},{"text":"Peptide bond"}],"explanation":"The nitrogenous bases of the two strands of DNA are paired through Hydrogen bonds (A=T has 2, G≡C has 3). Phosphodiester bonds connect the sugar-phosphate backbone."},{"id":303,"reasonId":"didnt_know_key_information","reasonLabel":"Didn't Know Key Information","subject":"Physics","examName":"Physics - Modern Physics","text":"What is the relationship between half-life (T) and mean life (τ) of a radioactive substance?","correctIdx":0,"options":[{"text":"T = 0.693 × τ"},{"text":"τ = 0.693 × T"},{"text":"T = τ"},{"text":"T = τ²"}],"explanation":"Half-life T = ln(2)/λ = 0.693/λ. Mean life τ = 1/λ. Therefore, T = 0.693 × τ. This is a key formula in radioactivity."},{"id":304,"reasonId":"didnt_know_key_information","reasonLabel":"Didn't Know Key Information","subject":"Math","examName":"Math - Coordinate Geometry","text":"What is the eccentricity of a rectangular hyperbola?","correctIdx":2,"options":[{"text":"1"},{"text":"0"},{"text":"√2"},{"text":"2"}],"explanation":"For a rectangular hyperbola (x² - y² = a²), the asymptotes are perpendicular. The eccentricity e is always √2."},{"id":305,"reasonId":"didnt_know_key_information","reasonLabel":"Didn't Know Key Information","subject":"Chemistry","examName":"Chemistry - Periodic Table","text":"Which element has the highest electron gain enthalpy (most negative)?","correctIdx":1,"options":[{"text":"Fluorine"},{"text":"Chlorine"},{"text":"Oxygen"},{"text":"Nitrogen"}],"explanation":"Chlorine has the highest electron gain enthalpy. Fluorine is smaller, so inter-electronic repulsion makes adding an electron slightly harder than in Chlorine."},{"id":601,"reasonId":"missed_question_detail","reasonLabel":"Missed a Detail","subject":"Chemistry","examName":"Chemistry - Organic","text":"Which of the following compounds does NOT undergo Cannizzaro reaction?","correctIdx":0,"options":[{"text":"Acetaldehyde (CH₃CHO)"},{"text":"Formaldehyde (HCHO)"},{"text":"Benzaldehyde (C₆H₅CHO)"},{"text":"Chloral (CCl₃CHO)"}],"explanation":"Cannizzaro reaction is given by aldehydes lacking alpha-hydrogens. Acetaldehyde (CH₃CHO) has 3 alpha-hydrogens, so it undergoes Aldol Condensation instead. The question asked for 'NOT'."},{"id":602,"reasonId":"missed_question_detail","reasonLabel":"Missed a Detail","subject":"Math","examName":"Math - Matrices","text":"If A is a skew-symmetric matrix of order 3, then determinant of A is?","correctIdx":2,"options":[{"text":"±1"},{"text":"Non-zero"},{"text":"Zero"},{"text":"Cannot be determined"}],"explanation":"The determinant of a skew-symmetric matrix of *odd* order is always zero. The detail 'order 3' is crucial here."},{"id":603,"reasonId":"missed_question_detail","reasonLabel":"Missed a Detail","subject":"Physics","examName":"Physics - Thermodynamics","text":"Work done in a cyclic process is equal to:","correctIdx":3,"options":[{"text":"Zero"},{"text":"Infinity"},{"text":"Heat absorbed"},{"text":"Area inside the P-V loop"}],"explanation":"While change in internal energy is zero, work done is the Area inside the P-V loop. Students often confuse 'cyclic process means dU=0' with 'Work=0'."},{"id":604,"reasonId":"missed_question_detail","reasonLabel":"Missed a Detail","subject":"Biology","examName":"Biology - Botany","text":"Which of the following is NOT a feature of Monocots?","correctIdx":1,"options":[{"text":"Parallel venation"},{"text":"Tap root system"},{"text":"Trimerous flowers"},{"text":"Scattered vascular bundles"}],"explanation":"Monocots have a Fibrous root system, not a Tap root system (which is a Dicot feature). The question asked for what is *NOT* a feature."},{"id":605,"reasonId":"missed_question_detail","reasonLabel":"Missed a Detail","subject":"Math","examName":"Math - Functions","text":"Find the domain of f(x) = √(1 - x²).","correctIdx":1,"options":[{"text":"(-1, 1)"},{"text":"[-1, 1]"},{"text":"R - (-1, 1)"},{"text":"(0, 1)"}],"explanation":"For the square root to be defined, 1 - x² ≥ 0, which implies x² ≤ 1, so -1 ≤ x ≤ 1. The square brackets denote inclusion of -1 and 1, which is the correct detail often missed."}]},
      chartData: { labels: [], series: [], ids: [], examCounts: [] },
      pathway: { topErrors: [], totalErrors: 0 },
      colorMapper: null,
      isQuizOpen: false,
      questions: [],
      currentIndex: 0,
      selectedIdx: null,
      hasAnswered: false,
      selectedReasonId: null,
      selectedReasonLabel: '',
      touchStartX: 0,
      showSummary: false,
      correctAnswers: 0,
      userAnswers: [],

      init() {
        const src = this.data || {};
        this.pathway.totalErrors = src.totalErrors || 0;
        this.chartData = src.summary || { labels: [], series: [], ids: [], examCounts: [] };
        this.colorMapper = new ColorMapper(this.chartData.labels);
        this.processTopErrors(src.topErrors);
        this.$nextTick(() => this.renderCharts());
      },

      startPractice(reasonId) {
        this.selectedReasonId = reasonId;
        const reasonIdx = this.chartData.ids.indexOf(reasonId);
        this.selectedReasonLabel = reasonIdx !== -1 ? this.chartData.labels[reasonIdx] : 'Practice';
        
        const allQuestions = this.data.questions || [];
        this.questions = allQuestions
          .filter(q => q.reasonId === reasonId)
          .slice(0, 10);

        if (this.questions.length > 0) {
          this.currentIndex = 0;
          this.hasAnswered = false;
          this.selectedIdx = null;
          this.showSummary = false;
          this.correctAnswers = 0;
          this.userAnswers = [];
          this.isQuizOpen = true;
          document.body.style.overflow = 'hidden';
        } else {
          alert("No practice questions found for this reason.");
        }
      },

      selectOption(idx) {
        if (this.hasAnswered) return;
        this.selectedIdx = idx;
        this.hasAnswered = true;
        this.userAnswers[this.currentIndex] = idx;
      },

      nextQuestion() {
        if (this.currentIndex < this.questions.length - 1) {
          this.currentIndex++;
          const nextAnswer = this.userAnswers[this.currentIndex];
          this.selectedIdx = nextAnswer !== undefined ? nextAnswer : null;
          this.hasAnswered = nextAnswer !== undefined;
          const container = this.$refs.quizBody;
          if (container) container.scrollTop = 0;
        } else {
          this.calculateScore();
          this.showSummary = true;
          this.$nextTick(() => {
            this.renderPracticeQuizChart();
          });
        }
      },

      previousQuestion() {
        if (this.currentIndex > 0) {
          this.currentIndex--;
          const previousAnswer = this.userAnswers[this.currentIndex];
          this.selectedIdx = previousAnswer !== undefined ? previousAnswer : null;
          this.hasAnswered = previousAnswer !== undefined;
          const container = this.$refs.quizBody;
          if (container) container.scrollTop = 0;
        }
      },

      calculateScore() {
        this.correctAnswers = 0;
        this.questions.forEach((question, index) => {
          const userAnswer = this.userAnswers[index];
          if (userAnswer === question.correctIdx) {
            this.correctAnswers++;
          }
        });
      },

      retakeQuiz() {
        this.currentIndex = 0;
        this.hasAnswered = false;
        this.selectedIdx = null;
        this.showSummary = false;
        this.correctAnswers = 0;
        this.userAnswers = [];
        const container = this.$refs.quizBody;
        if (container) container.scrollTop = 0;
      },

      closeQuiz() {
        this.isQuizOpen = false;
        document.body.style.overflow = 'auto';
        setTimeout(() => {
          this.questions = [];
          this.currentIndex = 0;
          this.selectedIdx = null;
          this.hasAnswered = false;
          this.showSummary = false;
          this.correctAnswers = 0;
          this.userAnswers = [];
        }, 500);
      },

      handleTouchStart(e) { this.touchStartX = e.changedTouches[0].screenX; },
      handleTouchEnd(e) {
        const diff = this.touchStartX - e.changedTouches[0].screenX;
        if (diff > 50 && this.hasAnswered) {
           this.nextQuestion();
        } else if (diff < -50) {
           this.previousQuestion();
        }
      },

      processTopErrors(topErrors) {
        const top3Items = (topErrors || []).slice(0, 3);
        const top3TotalCount = top3Items.reduce((sum, err) => sum + (err.count || 0), 0);
        this.pathway.topErrors = top3Items.map(err => ({
          ...err,
          reason: err.label,
          percentage: top3TotalCount > 0 ? Math.round((err.count / top3TotalCount) * 100) : 0,
          recommendation: err.suggestedImprovement || RECOMMENDATION_MAPPING[err.id] || "If you want, you could review these questions to see if a recurring pattern emerges."
        }));
      },

      renderCharts() {
        renderPieChart('#consolidated-error-chart', this.chartData.series, this.chartData.labels, this.colorMapper.getColorsForLabels(this.chartData.labels), 280, 280);

        const topErrors = this.pathway.topErrors;
        if (!topErrors.length) return;

        const positions = [
          { x: 8.5, y: 7.5, s: 90},
          { x: 4.5, y: 7, s: 70 },
          { x: 6.2, y: 5.2, s: 40 }
        ];

        const bubbleSeries = topErrors.map((error, index) => ({
          name: error.reason,
          data: [[ 
            positions[index]?.x || 5, 
            positions[index]?.y || 5, 
            positions[index]?.s || error.percentage * 1.8
          ]]
        }));

        const chartColors = topErrors.map(error => this.colorMapper.getColor(error.reason));
        const actualPercentages = topErrors.map(error => error.percentage);

        renderBubbleChart('#consolidated-bubble-chart', bubbleSeries, chartColors, actualPercentages);
      },

      renderPracticeQuizChart() {
        const chartContainer = document.querySelector("#practice-quiz-pie-chart");
        if (chartContainer) {
          chartContainer.innerHTML = '';
        }

        let correct = 0;
        let incorrect = 0;

        this.questions.forEach((question, index) => {
          const userAnswer = this.userAnswers[index];
          if (userAnswer === question.correctIdx) {
            correct++;
          } else {
            incorrect++;
          }
        });

        const seriesData = [correct, incorrect];
        const seriesLabels = ['Correct', 'Incorrect'];

        const options = {
          chart: {
            height: 230,
            width: 230,
            type: 'donut',
            zoom: { enabled: false },
            animations: {
              enabled: false
            }
          },
          plotOptions: {
            pie: {
              donut: {
                size: '76%'
              }
            }
          },
          series: seriesData,
          labels: seriesLabels,
          legend: { show: false },
          dataLabels: { enabled: false },
          stroke: { width: 5 },
          colors: ['#22c55e', '#ef4444'],
          stroke: {
            colors: ['#ffffff']
          },
          states: {
            hover: {
              filter: { type: 'none', value: 0 }
            },
            active: {
              allowMultipleDataPointsSelection: false,
            }
          },
          tooltip: {
            enabled: true,
            custom: ({ seriesIndex, w }) => {
              const label = seriesLabels[seriesIndex];
              const value = seriesData[seriesIndex];
              const total = seriesData.reduce((a, b) => a + b, 0);
              const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
              const color = w.globals.colors[seriesIndex];

              return `
                <div class="border border-gray-300 bg-white w-36 text-gray-900 shadow-xl">
                  <div class="px-2 py-1.5 font-semibold text-[13px] flex items-center">
                    <span>${label}</span>
                    <span class="ms-auto">${percentage}%</span>
                  </div>
                  <div class="border-t border-gray-200"></div>
                  <div class="space-y-1.5 p-2">
                    <div class="flex items-center gap-x-2 text-xs text-gray-600">
                      <span class="w-3 h-3 rounded-sm inline-block" style="background:${color}"></span>
                      <span>Questions</span>
                      <span class="ms-auto">${value}</span>
                    </div>
                  </div>
                </div>
              `;
            }
          }
        };

        const chart = new ApexCharts(chartContainer, options);
        chart.render();
      }
    };
  }
</script>