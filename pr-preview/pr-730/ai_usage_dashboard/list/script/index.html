<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.js"></script>
<script src="https://preline.co/pro/assets/vendor/lodash/lodash.min.js"></script>
<script src="https://preline.co/pro/assets/vendor/apexcharts/dist/apexcharts.min.js"></script>
<script src="https://preline.co/pro/assets/js/hs-apexcharts-helpers.js"></script>

<script>
  // Initialize ECharts Daily Requests Chart
  (function () {
    // Declare chart instance globally for toggle function
    let dailyRequestsChart;

    // Wait for DOM to be fully loaded
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initDailyRequestsChart);
    } else {
      initDailyRequestsChart();
    }

    function initDailyRequestsChart() {
      const chartDom = document.getElementById('hs-pro-iresscch');
      if (!chartDom || typeof echarts === 'undefined') {
        console.warn('ECharts not loaded or chart container not found');
        return;
      }

      // Initialize chart
      dailyRequestsChart = echarts.init(chartDom);

      // Data for daily requests
      const dates = ['25 July', '26 July', '27 July', '28 July', '29 July', '30 July', '31 July', '1 Aug'];
      const academic = [120, 135, 145, 130, 150, 140, 160, 125];
      const nonAcademic = [12, 15, 18, 14, 16, 15, 20, 12];

      // Calculate total requests (academic + non-academic)
      const totalRequests = academic.map((val, idx) => val + nonAcademic[idx]);

      // Calculate daily costs (assuming average cost per request: ₹0.68 based on ₹12,450 / 18,400 requests)
      const costPerRequest = 12450 / 18400; // Approximately ₹0.68 per request
      const dailyCosts = totalRequests.map(total => Math.round(total * costPerRequest));

      // Calculate average daily cost
      const averageDailyCost = Math.round(dailyCosts.reduce((sum, cost) => sum + cost, 0) / dailyCosts.length);

      // Update the average cost display in sidebar
      const averageCostElement = document.getElementById('average-daily-cost');
      if (averageCostElement) {
        averageCostElement.textContent = '₹' + averageDailyCost.toLocaleString('en-IN');
      }

      // Define colors map for tooltip (Tailwind 400)
      const seriesColors = {
        'Total Requests': '#60a5fa', // blue-400
        'Academic': '#34d399', // emerald-400
        'Non-Academic': '#f87171' // red-400
      };

      const option = {
        tooltip: {
          trigger: 'axis',
          backgroundColor: 'rgba(255, 255, 255, 0.95)',
          borderColor: '#e5e7eb',
          borderWidth: 1,
          textStyle: {
            color: '#1f2937',
            fontSize: 13
          },
          formatter: function (params) {
            let result = params[0].axisValue + '<br/>';
            params.forEach(function (item) {
              // Get color from seriesColors map
              const seriesColor = seriesColors[item.seriesName] || item.color || '#000';
              const marker = '<span style="display:inline-block;margin-right:4px;border-radius:4px;width:10px;height:10px;background-color:' + seriesColor + ';"></span>';
              result += marker + item.seriesName + ': ' + item.value + '<br/>';
            });

            return result;
          }
        },
        grid: {
          left: '6%',
          right: '2%',
          bottom: '8%',
          top: '8%',
          containLabel: false
        },
        graphic: [
          {
            type: 'rect',
            left: '8%',
            right: '4%',
            top: '5%',
            bottom: '8%',
            style: {
              fill: '#eff6ff'
            },
            z: -1
          }
        ],
        xAxis: {
          type: 'category',
          boundaryGap: false,
          data: dates,
          axisLine: {
            show: false
          },
          axisTick: {
            show: false
          },
          axisLabel: {
            color: '#475569',
            fontSize: 12,
            fontWeight: 400
          }
        },
        yAxis: {
          type: 'value',

          axisLine: {
            show: false
          },
          axisTick: {
            show: false
          },
          axisLabel: {
            color: '#475569',
            fontSize: 12,
            fontWeight: 400
          },
          splitLine: {
            lineStyle: {
              color: '#cbd5e1',
              type: 'dashed',
              width: 1
            }
          }
        },
        series: [
          {
            name: 'Total Requests',
            type: 'line',
            data: totalRequests,
            smooth: true,
            lineStyle: {
              color: '#60a5fa', // blue-400
              width: 3
            },
            itemStyle: {
              color: '#ffffff',
              borderWidth: 3,
              borderColor: '#60a5fa' // blue-400
            },
            symbol: 'circle',
            symbolSize: 10,
            showSymbol: true,
            areaStyle: {
              color: {
                type: 'linear',
                x: 0,
                y: 0,
                x2: 0,
                y2: 1,
                colorStops: [{
                  offset: 0,
                  color: 'rgba(96, 165, 250, 0.3)' // blue-400
                }, {
                  offset: 1,
                  color: 'rgba(96, 165, 250, 0.05)' // blue-400
                }]
              }
            }
          },
          {
            name: 'Academic',
            type: 'line',
            data: academic,
            smooth: true,
            lineStyle: {
              color: '#34d399', // emerald-400
              width: 2.5
            },
            itemStyle: {
              color: '#ffffff',
              borderWidth: 3,
              borderColor: '#34d399' // emerald-400
            },
            symbol: 'circle',
            symbolSize: 10,
            showSymbol: true
          },
          {
            name: 'Non-Academic',
            type: 'line',
            data: nonAcademic,
            smooth: true,
            lineStyle: {
              color: '#f87171', // red-400
              width: 2.5
            },
            itemStyle: {
              color: '#ffffff',
              borderWidth: 3,
              borderColor: '#f87171' // red-400
            },
            symbol: 'circle',
            symbolSize: 10,
            showSymbol: true
          }
        ]
      };

      dailyRequestsChart.setOption(option);
      window.dailyRequestsChart = dailyRequestsChart; // Store globally for toggle

      // Responsive resize with debouncing
      let resizeTimer;
      window.addEventListener('resize', function () {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(function () {
          dailyRequestsChart.resize();
        }, 100);
      });

      // Cleanup on page unload
      window.addEventListener('beforeunload', function () {
        dailyRequestsChart.dispose();
      });
    }
  })();

  // Toggle series visibility on legend click
  function toggleSeries(seriesName) {
    if (window.dailyRequestsChart) {
      const option = window.dailyRequestsChart.getOption();
      const seriesIndex = option.series.findIndex(s => s.name === seriesName);

      if (seriesIndex !== -1) {
        // Get current series config
        const currentSeries = option.series[seriesIndex];
        const isVisible = !currentSeries.lineStyle || !currentSeries.lineStyle.opacity || currentSeries.lineStyle.opacity === 1;

        // Toggle visibility by setting opacity
        if (!currentSeries.lineStyle) {
          currentSeries.lineStyle = {};
        }
        if (!currentSeries.itemStyle) {
          currentSeries.itemStyle = {};
        }

        currentSeries.lineStyle.opacity = isVisible ? 0.3 : 1;
        currentSeries.itemStyle.opacity = isVisible ? 0.3 : 1;

        // Also toggle areaStyle opacity for Total Requests
        if (currentSeries.areaStyle) {
          currentSeries.areaStyle.opacity = isVisible ? 0.1 : 0.3;
        }

        // Update chart
        window.dailyRequestsChart.setOption(option);

        // Toggle legend opacity
        const legendId = {
          'Total Requests': 'legend-total',
          'Academic': 'legend-academic',
          'Non-Academic': 'legend-non-academic'
        }[seriesName];

        const legendElement = document.getElementById(legendId);
        if (legendElement) {
          const currentOpacity = legendElement.style.opacity;
          legendElement.style.opacity = currentOpacity === '0.3' ? '1' : '0.3';
        }
      }
    }
  }
</script>

<script>
  window.addEventListener('load', () => {
    // Apex Daily Active Users Chart
    (function () {
      buildChart('#hs-daily-active-users-chart', (mode) => ({
        chart: {
          height: 350,
          type: 'area',
          toolbar: {
            show: false
          },
          zoom: {
            enabled: false
          }
        },
        series: [
          {
            name: 'Active Users',
            data: [156, 234, 189, 201, 178, 145, 144, 198, 167, 178, 156, 128]
          }
        ],
        legend: {
          show: false
        },
        dataLabels: {
          enabled: false
        },
        stroke: {
          curve: 'smooth',
          width: 2
        },
        fill: {
          type: 'gradient',
          gradient: {
            type: 'vertical',
            shadeIntensity: 1,
            opacityFrom: 0.2,
            opacityTo: 0.8
          }
        },
        xaxis: {
          type: 'category',
          tickPlacement: 'on',
          categories: [
            '25 Jul',
            '26 Jul',
            '27 Jul',
            '28 Jul',
            '29 Jul',
            '30 Jul',
            '31 Jul',
            '1 Aug',
            '2 Aug',
            '3 Aug',
            '4 Aug',
            '5 Aug'
          ],
          axisBorder: {
            show: false
          },
          axisTicks: {
            show: false
          },
          crosshairs: {
            stroke: {
              dashArray: 0
            },
            dropShadow: {
              show: false
            }
          },
          tooltip: {
            enabled: false
          },
          labels: {
            style: {
              colors: '#a8a29e',
              fontSize: '13px',
              fontFamily: 'Inter, ui-sans-serif',
              fontWeight: 400
            },
            formatter: (title) => title ? title.slice(0, 3) : title
          }
        },
        yaxis: {
          labels: {
            align: 'left',
            minWidth: 0,
            maxWidth: 140,
            style: {
              colors: '#a8a29e',
              fontSize: '12px',
              fontFamily: 'Inter, ui-sans-serif',
              fontWeight: 400
            },
            formatter: (value) => value >= 1000 ? `${value / 1000}k` : value
          }
        },
        tooltip: {
          y: {
            formatter: (value) => `${value >= 1000 ? `${value / 1000}k` : value} users`
          },
          custom: function (props) {
            const { categories } = props.ctx.opts.xaxis;
            const { dataPointIndex } = props;
            const title = categories[dataPointIndex];
            const newTitle = `${title}`;

            return buildTooltip(props, {
              title: newTitle,
              mode,
              valuePrefix: '',
              hasCategory: false,
              hasTextLabel: true,
              wrapperExtClasses: 'min-w-32.5',
              labelDivider: ':',
              labelExtClasses: 'ms-2'
            });
          }
        },
        responsive: [{
          breakpoint: 568,
          options: {
            chart: {
              height: 300
            },
            labels: {
              style: {
                colors: '#a8a29e',
                fontSize: '11px',
                fontFamily: 'Inter, ui-sans-serif',
                fontWeight: 400
              },
              offsetX: -2,
              formatter: (title) => title.slice(0, 3)
            },
            yaxis: {
              labels: {
                align: 'left',
                minWidth: 0,
                maxWidth: 140,
                style: {
                  colors: '#a8a29e',
                  fontSize: '11px',
                  fontFamily: 'Inter, ui-sans-serif',
                  fontWeight: 400
                },
                formatter: (value) => value >= 1000 ? `${value / 1000}k` : value
              }
            }
          },
        }]
      }), {
        colors: ['#16a34a'],
        fill: {
          gradient: {
            shadeIntensity: .1,
            opacityFrom: .5,
            opacityTo: 0,
            stops: [50, 100, 100, 100]
          }
        },
        grid: {
          strokeDashArray: 2,
          borderColor: '#e5e5e5'
        },
        xaxis: {
          labels: {
            style: {
              colors: '#a8a29e',
            }
          }
        },
        yaxis: {
          labels: {
            style: {
              colors: '#a8a29e'
            }
          }
        }
      }, {
        colors: ['#22c55e'],
        fill: {
          gradient: {
            shadeIntensity: .1,
            opacityFrom: .5,
            opacityTo: 0,
            stops: [50, 100, 100, 100]
          }
        },
        grid: {
          strokeDashArray: 2,
          borderColor: '#44403c'
        },
        xaxis: {
          labels: {
            style: {
              colors: '#a3a3a3',
            }
          }
        },
        yaxis: {
          labels: {
            style: {
              colors: '#a3a3a3'
            }
          }
        }
      });
    })();

    // Apex Daily AI Costs Bar Chart
    (function () {
      buildChart('#hs-daily-ai-costs-chart', (mode) => ({
        chart: {
          type: 'bar',
          height: 350,
          toolbar: {
            show: false
          },
          zoom: {
            enabled: false
          }
        },
        series: [
          {
            name: 'Costs',
            data: [1250, 1380, 1450, 1620, 1780, 1950, 2100]
          }
        ],
        fill: {
          pattern: {
            width: 6,
            height: 6,
            strokeWidth: 2
          }
        },
        grid: {
          strokeDashArray: 3,
        },
        plotOptions: {
          bar: {
            horizontal: false,
            columnWidth: '95%',
            borderRadius: 2,
          }
        },
        legend: {
          show: false
        },
        dataLabels: {
          enabled: false
        },
        stroke: {
          show: true,
          width: 3,
          colors: ['transparent']
        },
        xaxis: {
          categories: [
            '1 Aug',
            '2 Aug',
            '3 Aug',
            '4 Aug',
            '5 Aug',
            '6 Aug',
            '7 Aug'
          ],
          axisBorder: {
            show: false
          },
          axisTicks: {
            show: false
          },
          crosshairs: {
            show: false
          },
          labels: {
            style: {
              colors: '#a8a29e',
              fontSize: '13px',
              fontFamily: 'Inter, ui-sans-serif',
              fontWeight: 400
            },
            offsetX: -2
          }
        },
        yaxis: {
          labels: {
            align: 'left',
            minWidth: 0,
            maxWidth: 140,
            style: {
              colors: '#a8a29e',
              fontSize: '13px',
              fontFamily: 'Inter, ui-sans-serif',
              fontWeight: 400
            },
            formatter: (value) => value >= 1000 ? `₹${value / 1000}k` : `₹${value}`
          }
        },
        tooltip: {
          custom: function (props) {
            const { categories } = props.ctx.opts.xaxis;
            const { dataPointIndex } = props;

            return buildTooltip(props, {
              title: categories[dataPointIndex],
              mode,
              hasCategory: false,
              hasTextLabel: true,
              wrapperExtClasses: 'min-w-28',
              labelDivider: ':',
              labelExtClasses: 'ms-2'
            });
          }
        },
        states: {
          hover: {
            filter: {
              type: 'darken',
              value: 0.9
            }
          }
        },
        responsive: [{
          breakpoint: 568,
          options: {
            chart: {
              height: 300
            },
            stroke: {
              width: 8
            },
            labels: {
              style: {
                colors: '#a8a29e',
                fontSize: '11px',
                fontFamily: 'Inter, ui-sans-serif',
                fontWeight: 400
              },
              offsetX: -2
            },
            yaxis: {
              labels: {
                align: 'left',
                minWidth: 0,
                maxWidth: 140,
                style: {
                  colors: '#a8a29e',
                  fontSize: '11px',
                  fontFamily: 'Inter, ui-sans-serif',
                  fontWeight: 400
                },
                formatter: (value) => value >= 1000 ? `₹${value / 1000}k` : `₹${value}`
              }
            },
          },
        }]
      }), {
        colors: ['#3b82f6'],
        grid: {
          strokeDashArray: 2,
          borderColor: '#e5e5e5'
        },
        xaxis: {
          labels: {
            style: {
              colors: '#a8a29e'
            }
          }
        },
        yaxis: {
          labels: {
            style: {
              colors: '#a8a29e'
            }
          }
        }
      }, {
        colors: ['#60a5fa'],
        grid: {
          strokeDashArray: 2,
          borderColor: '#44403c'
        },
        xaxis: {
          labels: {
            style: {
              colors: '#a3a3a3',
            }
          }
        },
        yaxis: {
          labels: {
            style: {
              colors: '#a3a3a3'
            }
          }
        }
      });
    })();
  });
</script>