<script>
  function examComponent() {
    return {
      exam: {
        name: "Real CAT 2025 - Take Home Mock Test 01",
        sections: [
          {
            name: "Quantitative Aptitude",
            duration: 10,
            questions: [
              {
                q_no: 1,
                type: "mcq",
                mark: "1.00",
                negative: "0.25",
                text: "If the cost price of 15 items is equal to the selling price of 12 items, what is the profit percentage?",
                options: ["20%", "25%", "30%", "15%"]
              },
              {
                q_no: 2,
                type: "mcq",
                mark: "1.00",
                negative: "0.25",
                text: "A train 240 m long passes a pole in 24 seconds. What is the speed of the train in km/hr?",
                options: ["36", "54", "72", "90"]
              },
              {
              q_no: 3,
              type: "essay",
              mark: "5.00",
              negative: "0.00",
              text: "Explain the impact of globalization on rural economies in India."
            },
            {
              q_no: 5,
              type: "gap_fill",
              mark: "5.00",
              negative: "0.00",
              text_with_blanks: `
            The [BLANK_1] Revolution was a turning point. It began in [BLANK_2] and changed [BLANK_3]. People moved to [BLANK_4] areas, and innovations like the steam engine revolutionized [BLANK_5].
            `
            }
            ]
          },
          {
            name: "Verbal Ability & Reading Comprehension",
            duration: 10,
            questions: [
              {
                q_no: 1,
                type: "mcq",
                mark: "1.00",
                negative: "0.25",
                text: "Choose the most appropriate word to fill in the blank: Despite the odds, she remained ___ throughout the ordeal.",
                options: ["placid", "desperate", "resilient", "apathetic"]
              },
              {
                q_no: 2,
                type: "mcq",
                mark: "1.00",
                negative: "0.25",
                text: "Identify the grammatically correct sentence.",
                options: [
                  "Each of the players have a unique skill.",
                  "Neither the manager nor his assistants was available.",
                  "He don’t like going to the gym.",
                  "There is many reasons for this conclusion."
                ]
              }
            ]
          },
          {
            name: "Data Interpretation & Logical Reasoning",
            duration: 10,
            questions: [
                {
                  q_no: 1,
                  type: "mcq",
                  mark: "1.00",
                  negative: "0.25",
                  text: "Five friends—A, B, C, D, and E—are sitting in a row. A is to the immediate right of B but not next to E. Who is sitting in the middle if C is at one end?",
                  options: ["A", "B", "D", "E"]
                },
                {
                  q_no: 2,
                  type: "mcq",
                  mark: "1.00",
                  negative: "0.25",
                  text: "In a certain code, if BOOK is coded as 43 and PEN as 35, then what is the code for COPY?",
                  options: ["56", "62", "59", "65"]
                }
              ]
          },
        ],
      },

      currentSectionIndex: 0,
      currentQuestionIndex: 0,
      totalSeconds: 0,
      interval: null,
      isLocked: false,
      selectedOption: null,
      essayDraft: '',
      show_exam_ended_modal :false,
      responses: {},
      gapFillAnswers: [],

      get currentSection() {
        return this.exam.sections[this.currentSectionIndex];
      },

      get currentQuestion() {
        return this.currentSection.questions[this.currentQuestionIndex];
      },

      get formattedTime() {
        const mins = Math.floor(this.totalSeconds / 60).toString().padStart(2, '0');
        const secs = (this.totalSeconds % 60).toString().padStart(2, '0');
        return `${mins}:${secs}`;
      },

      startTimer() {
        this.totalSeconds = this.currentSection.duration * 60;
        this.isLocked = true;

        if (this.interval) clearInterval(this.interval);
        this.interval = setInterval(() => {
          if (this.totalSeconds > 0) {
            this.totalSeconds--;
          } else {
            clearInterval(this.interval);
            this.moveToNextSection();
          }
        }, 1000);
      },

      selectSection(index) {
        if (index !== this.currentSectionIndex && this.isLocked) return;
        this.currentSectionIndex = index;
        this.currentQuestionIndex = 0;
        this.startTimer();
        this.goToQuestion(0);
      },

      isActive(index) {
        return this.currentSectionIndex === index;
      },

      goToQuestion(index) {
        this.currentQuestionIndex = index;
        const sectionKey = this.currentSection.name;
        const questionKey = this.currentQuestion.q_no;

        if (!this.responses[sectionKey]) this.responses[sectionKey] = {};
        if (!this.responses[sectionKey][questionKey]) {
          this.responses[sectionKey][questionKey] = { selected: null, visited: true, markedForReview: false };
        } else {
          this.responses[sectionKey][questionKey].visited = true;
        }
        if (this.currentQuestion.type === 'mcq') {
          const saved = this.responses[sectionKey][questionKey]?.selected;
          this.selectedOption = saved ?? null;
        }

        if (this.currentQuestion.type === 'essay') {
          const saved = this.responses[sectionKey][questionKey]?.text;
          this.essayDraft = saved ?? '';
        }
        if (this.currentQuestion.type === 'gap_fill') {
          const sectionKey = this.currentSection.name;
          const questionKey = this.currentQuestion.q_no;

          const blankCount = (this.currentQuestion.text_with_blanks.match(/\[BLANK_\d+\]/g) || []).length;

          const saved = this.responses[sectionKey]?.[questionKey]?.answers;
          this.gapFillAnswers = saved ? [...saved] : Array(blankCount).fill('');
        }
      },

      saveAnswer(optionIndex) {
        const sectionKey = this.currentSection.name;
        const questionKey = this.currentQuestion.q_no;

        if (!this.responses[sectionKey]) this.responses[sectionKey] = {};

        this.responses[sectionKey][questionKey] = {
          selected: optionIndex,
          markedForReview: false,
          visited: true
        };
      },

      saveEssayAnswer() {
        if(this.essayDraft == ''){
          this.essayDraft =  null;
        }
        const sectionKey = this.currentSection.name;
        const questionKey = this.currentQuestion.q_no;

        if (!this.responses[sectionKey]) this.responses[sectionKey] = {};
        this.responses[sectionKey][questionKey] = {
          text: this.essayDraft,
          markedForReview: false,
          visited: true
        };
      },

      saveGapFillAnswer() {
        const sectionKey = this.currentSection.name;
        const questionKey = this.currentQuestion.q_no;

        if (!this.responses[sectionKey]) this.responses[sectionKey] = {};
        this.responses[sectionKey][questionKey] = {
          answers: [...this.gapFillAnswers],
          visited: true
        };
      },

      saveCurrentAnswer() {
        const type = this.currentQuestion.type;

        if (type === 'mcq') {
          this.saveAnswer(this.selectedOption);
        } else if (type === 'essay') {
          this.saveEssayAnswer();
        } else if (type === 'gap_fill') {
          this.saveGapFillAnswer();
        }
      },


      getGapFillHTML() {
      const text = this.currentQuestion.text_with_blanks;
      const blanks = (text.match(/\[BLANK_\d+\]/g) || []).length;

      // Ensure gapFillAnswers array is initialized
      if (this.gapFillAnswers.length !== blanks) {
        this.gapFillAnswers = Array(blanks).fill('');
      }

      const parts = text.split(/\[BLANK_\d+\]/g);

      // Build HTML string using Alpine-compatible bindings
      return parts.map((part, index) => {
        const input = index < blanks
          ? `<input x-model='gapFillAnswers[${index}]' type='text' class='inline-block h-6 min-w-36 align-middle w-20 px-2 py-1 text-sm border border-gray-300 rounded-md placeholder:text-gray-400 focus:border-emerald-500 focus:ring-emerald-500' placeholder='answer here' />`
          : '';
        return `${part}${input}`;
      }).join('');
    },

      markForReview() {
        const sectionKey = this.currentSection.name;
        const questionKey = this.currentQuestion.q_no;

        if (!this.responses[sectionKey]) this.responses[sectionKey] = {};
        if (!this.responses[sectionKey][questionKey]) {
          this.responses[sectionKey][questionKey] = { selected: null, visited: true };
        }
        this.responses[sectionKey][questionKey].markedForReview = true;
      },

      getQuestionStatus(sectionName, q_no) {
        const resp = this.responses[sectionName]?.[q_no];
        if (!resp) return 'not_visited';
        if (resp.markedForReview) return 'review';
        if (
          resp.selected != null ||          // for MCQ
          resp.text != null ||              // for Essay
          (resp.answers && resp.answers.length > 0) // for Gap Fill
        )
          return 'answered';

        return 'visited';
      },

      get currentSectionStats() {
        const sectionKey = this.currentSection.name;
        const total = this.currentSection.questions.length;
        let answered = 0, visited = 0, notVisited = 0, review = 0;

        for (let q of this.currentSection.questions) {
          const status = this.getQuestionStatus(sectionKey, q.q_no);
          if (status === 'answered') answered++;
          else if (status === 'review') review++;
          else if (status === 'visited') visited++;
          else if (status === 'not_visited') notVisited++;
        }

        return { total, answered, visited, notVisited, review };
      },

      moveToNextSection() {
        if (this.currentSectionIndex < this.exam.sections.length - 1) {
          this.currentSectionIndex++;
          this.currentQuestionIndex = 0;
          this.startTimer();
          this.goToQuestion(0);
        } else {
          this.isLocked = false;
          this.show_exam_ended_modal = true;
        }
      },

      clearResponse() {
        const sectionKey = this.currentSection.name;
        const questionKey = this.currentQuestion.q_no;

        if (this.responses[sectionKey]?.[questionKey]) {
          this.responses[sectionKey][questionKey].selected = null;
          this.responses[sectionKey][questionKey].text = null;
          this.responses[sectionKey][questionKey].answers = [];
          this.essayDraft = null;
          this.selectedOption = null;
          this.gapFillAnswers = [];
        }
      }

    }
  }
</script>
