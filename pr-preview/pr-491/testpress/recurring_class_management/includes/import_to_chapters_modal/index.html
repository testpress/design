<div x-cloak 
        x-show="showImportModal" 
        x-transition:enter="ease-out duration-300"
        x-transition:enter-start="opacity-0"
        x-transition:enter-end="opacity-100"
        x-transition:leave="ease-in duration-200"
        x-transition:leave-start="opacity-100"
        x-transition:leave-end="opacity-0"
        class="fixed inset-0 z-[80] overflow-x-hidden overflow-y-auto pointer-events-none" 
        role="dialog" 
        aria-modal="true"
        aria-labelledby="import-modal-title">
  <div class="ease-out transition-all sm:max-w-lg sm:w-full m-3 sm:mx-auto h-[calc(100%-56px)] min-h-[calc(100%-56px)] flex items-center"
       x-show="showImportModal" 
       x-transition:enter="ease-out duration-300" 
       x-transition:enter-start="opacity-0 scale-95"
       x-transition:enter-end="opacity-100 scale-100" 
       x-transition:leave="ease-in duration-200"
       x-transition:leave-start="opacity-100 scale-100" 
       x-transition:leave-end="opacity-0 scale-95">
    <div class="w-full max-h-full flex flex-col bg-white rounded-xl pointer-events-auto shadow-xl"
         @click.away="showImportModal = false">

      <div class="py-2.5 px-4 flex justify-between items-center border-b border-gray-200">
        <h3 id="import-modal-title" class="font-medium text-gray-800">
          Import to Chapters
        </h3>
        <button type="button" 
                @click="showImportModal = false"
                class="size-8 shrink-0 flex justify-center items-center rounded-full border border-transparent bg-gray-100 text-gray-800 hover:bg-gray-200 disabled:opacity-50 disabled:pointer-events-none focus:outline-none focus:bg-gray-200" 
                aria-label="Close">
          <span class="sr-only">Close</span>
          <svg class="shrink-0 size-4" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M18 6 6 18"/>
            <path d="m6 6 12 12"/>
          </svg>
        </button>
      </div>

      <div class="p-4 space-y-5">
        <div x-show="selectedSeries" class="rounded-lg bg-emerald-50 p-3 border border-emerald-200">
          <p class="text-sm text-emerald-800">
            Import "<span x-text="selectedSeries ? selectedSeries.title : ''"></span>" to course chapters
          </p>
        </div>

        <div>
          <label for="course-selector" class="block mb-2 text-sm font-medium text-gray-800">Select Course</label>
          <div class="relative" @click.away="showCourseDropdown = false">
            <button type="button" 
                    @click="showCourseDropdown = !showCourseDropdown"
                    id="course-selector"
                    aria-expanded="false"
                    aria-haspopup="listbox"
                    class="py-2 sm:py-2.5 px-3 block w-full border border-gray-200 rounded-lg sm:text-sm text-left bg-white text-gray-800 placeholder:text-gray-400 focus:border-emerald-500 focus:ring-emerald-500 disabled:opacity-50 disabled:pointer-events-none">
              <div class="flex items-center justify-between">
                <span class="block truncate" x-text="selectedCourses.length === 0 ? 'Choose a course' : selectedCourses.length + ' course(s) selected'"></span>
                <svg class="shrink-0 size-4 text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="m6 9 6 6 6-6"/>
                </svg>
              </div>
            </button>

            <div x-show="showCourseDropdown" 
                 x-transition:enter="transition ease-out duration-100"
                 x-transition:enter-start="transform opacity-0 scale-95" 
                 x-transition:enter-end="transform opacity-100 scale-100"
                 x-transition:leave="transition ease-in duration-75" 
                 x-transition:leave-start="transform opacity-100 scale-100"
                 x-transition:leave-end="transform opacity-0 scale-95"
                 class="absolute z-10 mt-1 max-h-60 w-full overflow-auto rounded-lg bg-white py-1 shadow-xl border border-gray-200 text-sm"
                 role="listbox">
              <template x-for="course in courses" :key="course.id">
                <div class="relative cursor-pointer select-none py-2 px-3 hover:bg-emerald-50 transition-colors" 
                     @click="toggleCourseSelection(course.id)"
                     role="option"
                     :aria-selected="selectedCourses.includes(course.id)">
                  <div class="flex items-center">
                    <input type="checkbox" 
                           :checked="selectedCourses.includes(course.id)"
                           class="size-4 text-emerald-600 focus:ring-emerald-500 border-gray-300 rounded mr-3">
                    <span class="font-normal block truncate" x-text="course.name"></span>
                  </div>
                </div>
              </template>
            </div>
          </div>
        </div>

        <div x-show="selectedCourses.length > 0">
          <label for="chapter-selector" class="block mb-2 text-sm font-medium text-gray-800">Select Chapters</label>
          <div class="relative" @click.away="showChapterDropdown = false">
            <button type="button" 
                    @click="showChapterDropdown = !showChapterDropdown"
                    id="chapter-selector"
                    aria-expanded="false"
                    aria-haspopup="listbox"
                    class="py-2 sm:py-2.5 px-3 block w-full border border-gray-200 rounded-lg sm:text-sm text-left bg-white text-gray-800 placeholder:text-gray-400 focus:border-emerald-500 focus:ring-emerald-500 disabled:opacity-50 disabled:pointer-events-none">
              <div class="flex items-center justify-between">
                <span class="block truncate" x-text="selectedChapters.length === 0 ? 'Choose chapters' : selectedChapters.length + ' chapter(s) selected'"></span>
                <svg class="shrink-0 size-4 text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="m6 9 6 6 6-6"/>
                </svg>
              </div>
            </button>

            <div x-show="showChapterDropdown" 
                 x-transition:enter="transition ease-out duration-100"
                 x-transition:enter-start="transform opacity-0 scale-95" 
                 x-transition:enter-end="transform opacity-100 scale-100"
                 x-transition:leave="transition ease-in duration-75" 
                 x-transition:leave-start="transform opacity-100 scale-100"
                 x-transition:leave-end="transform opacity-0 scale-95"
                 class="absolute z-10 mt-1 max-h-60 w-full overflow-auto rounded-lg bg-white py-1 shadow-xl border border-gray-200 text-sm"
                 role="listbox">
              <template x-for="chapter in filteredChapters" :key="chapter.id">
                <div class="relative cursor-pointer select-none py-2 px-3 hover:bg-emerald-50 transition-colors" 
                     @click="toggleChapterSelection(chapter.id)"
                     role="option"
                     :aria-selected="selectedChapters.includes(chapter.id)">
                  <div class="flex items-center">
                    <input type="checkbox" 
                           :checked="selectedChapters.includes(chapter.id)"
                           class="size-4 text-emerald-600 focus:ring-emerald-500 border-gray-300 rounded mr-3">
                    <div class="flex-1">
                      <span class="font-normal block truncate" x-text="chapter.title"></span>
                      <span class="text-gray-500 text-xs block truncate" x-text="chapter.course"></span>
                    </div>
                  </div>
                </div>
              </template>

              <div x-show="filteredChapters.length === 0" class="relative cursor-default select-none py-2 px-3 text-gray-500">
                No chapters available
              </div>
            </div>
          </div>

          <div x-show="selectedChapters.length > 0" class="mt-3 rounded-lg bg-emerald-50 p-3 border border-emerald-200">
            <div class="flex items-center">
              <div class="flex-shrink-0">
                <svg class="size-5 text-emerald-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M9 12l2 2 4-4"/>
                  <path d="M21 12c0 4.97-4.03 9-9 9s-9-4.03-9-9 4.03-9 9-9c1.09 0 2.13.2 3.1.55"/>
                </svg>
              </div>
              <div class="ml-3">
                <p class="text-sm font-medium text-emerald-800">
                  <span x-text="selectedChapters.length"></span> chapter(s) selected for import
                </p>
              </div>
            </div>
          </div>
        </div>

        <div x-show="selectedChapters.length > 0" class="space-y-4">
          <div class="border-t border-gray-200 pt-4">
            <h4 class="text-sm font-medium text-gray-800 mb-3">Import Configuration</h4>            
            <div class="grid grid-cols-2 gap-4 mb-4">
              <div>
                <label for="session-start" class="block text-sm font-medium text-gray-700 mb-1">
                  Start Session Number
                </label>
                <input type="number" 
                       id="session-start"
                       x-model="sessionStartNumber"
                       min="1"
                       placeholder="1"
                       class="py-2 px-3 block w-full border border-gray-200 rounded-lg text-sm focus:border-emerald-500 focus:ring-emerald-500 disabled:opacity-50 disabled:pointer-events-none">
              </div>
              <div>
                <label for="session-end" class="block text-sm font-medium text-gray-700 mb-1">
                  End Session Number
                </label>
                <input type="number" 
                       id="session-end"
                       x-model="sessionEndNumber"
                       min="1"
                       placeholder="Leave blank for all"
                       class="py-2 px-3 block w-full border border-gray-200 rounded-lg text-sm focus:border-emerald-500 focus:ring-emerald-500 disabled:opacity-50 disabled:pointer-events-none">
              </div>
            </div>
            <div class="space-y-3">
              <div class="flex items-center">
                <input id="include-past-sessions" 
                       type="checkbox" 
                       x-model="includePastSessions"
                       class="size-4 text-emerald-600 focus:ring-emerald-500 border-gray-300 rounded mr-3">
                <label for="include-past-sessions" class="text-sm font-medium text-gray-700">Include past sessions</label>
              </div>
              <div class="flex items-center">
                <input id="continue-importing" 
                       type="checkbox" 
                       x-model="continueImporting"
                       class="size-4 text-emerald-600 focus:ring-emerald-500 border-gray-300 rounded mr-3">
                <label for="continue-importing" class="text-sm font-medium text-gray-700">Continue importing future sessions</label>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="p-4 flex justify-end gap-x-2">
        <div class="flex-1 flex justify-end items-center gap-2">
          <button type="button" 
                  @click="showImportModal = false"
                  class="py-2 px-3 text-nowrap inline-flex justify-center items-center text-start whitespace-nowrap bg-white border border-gray-200 text-gray-800 text-sm font-medium rounded-lg shadow-sm hover:bg-gray-50 disabled:opacity-50 disabled:pointer-events-none">
            Cancel
          </button>

          <button type="button"
                  @click="importToChapters()" 
                  :disabled="selectedChapters.length === 0" 
                  class="py-2 px-3 text-nowrap inline-flex justify-center items-center gap-x-2 text-start whitespace-nowrap bg-emerald-600 border border-emerald-600 text-white text-sm font-medium rounded-lg shadow-sm hover:bg-emerald-700 disabled:opacity-50 disabled:pointer-events-none focus:outline-none focus:ring-1 focus:ring-emerald-300">
            <svg class="shrink-0 size-4" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
              <polyline points="17 8 12 3 7 8"/>
              <line x1="12" x2="12" y1="3" y2="15"/>
            </svg>
            Import Series
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
